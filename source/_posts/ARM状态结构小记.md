---
title: ARM状态结构小记
date: 2017-09-08 22:05:16
categories: pwn
tags: arm
---

> 在系统学习ARM寄存器结构和功能之前，有必要先了解一下ARM的工作模式和工作状态。

## 一、 ARM的工作状态

两种状态为：

- ARM状态（32位）
- Thumb状态（16位）

用BX Rn指令来进行两种状态的切换： 
其中BX是跳转指令，Rn是寄存器，如果Rn的位0为1（最低位），则进入Thumb状态；如果Rn的位为0，这进入ARM状态。（ARM指令的后两位始终为0，没有被使用；而Thumb指令的后一位始终为0，没有被使用，因此采用位0来表示ARM指令与Thumb指令的切换标志位。）

例如下面两个指令就可以实现从ARM状态切换到Thumb状态，第一条指令将r6寄存器最低位置为1，接着 `bx  r6` 就切换到了Thumb状态。

```
   ……
   0x00008cfc <+12>:    add r6, pc, #1
   0x00008d00 <+16>:    bx  r6
   0x00008d04 <+20>:    ...
   0x00008d06 <+22>:    ...
   0x00008d08 <+24>:    ...
   ……1234567
```

注：ARM和Thumb两种状态之间的切换不影响处理器的工作模式和寄存器的内容；ARM处理器在处理异常时，不过处理器处于什么状态，则都将切换到ARM状态。



对于 ARM 指令来说，所有的指令长度都是 32 位，并且执行周期大多为单周期，指令都是有条件执行的。 
而 Thumb 指令的特点如下：

- 指令执行条件经常不回使用。
- 源寄存器与目标寄存器经常是相同的。
- 使用的寄存器数量比较少。
- 常数的值比较小。
- 内核中的桶式移动器（barrel shifter）经常是不使用的。

也就是说 16 位的 Thumb 指令一般可以完成 和 32 位 ARM 指令相同的任务。Thumb指令是ARM指令的子集，只要遵循一定的调用规则就可以互相调用。 
Thumb指令与ARM指令的时间效率和空间效率关系为：

- 存储空间约为ARM代码的60％～70％
- 指令数比ARM代码多约30％～40％
- 存储器为32位时ARM代码比Thumb代码快约40％
- 存储器为16位时Thumb比ARM代码快约40～50％
- 使用Thumb代码，存储器的功耗会降低约30％

## 二、 ARM的工作模式

七种工作模式为：

- usr 用户模式：正常用户模式，程序正常执行模式
- sys 系统模式：(基本上等同于usr)（System）运行特权操作系统任务
- svc 特权模式：（Supervisor）也叫操作系统保护模式，处理软件中断swi  reset
- abt 中止模式：（Abort mode）{数据、指令} 处理存储器故障、实现虚拟存储器和存储器保护
- und 未定义指令模式：（Undefined）处理未定义的指令陷阱，支持硬件协处理器的软件仿真
- irq 外部中断模式：处理普通中断
- fiq 快速中断模式：（Fast Interrupt Request）处理快速中断，支持高速数据传送或通道处理

上述七种工作模式中，除了用户模式之外的其他6种处理器模式称为特权模式。

特权模式下，程序可以访问所有的系统资源，也可以任意地进行处理器模式的切换。

特权模式中，除系统模式外，其他5种模式又称为异常模式。

大多数的用户程序运行在用户模式下，此时，应用程序不能够访问一些受操作系统保护的系统资源，应用程序也不能直接进行处理器模式的切换。

用户模式下，当需要进行处理器模式切换时，应用程序可以产生异常处理，在异常处理中进行处理器模式的切换。

## 三、 关于状态和模式的切换

处理器模式可以通过软件进行切换，也可以通过外部中断或者异常处理过程进行切换。

当应用程序发生异常中断时，处理器进入相应的异常模式。在每一种异常模式下都有一组寄存器，供相应的异常处理程序使用，这样就可以保证在进入异常模式时，用户模式下的寄存器不被破坏。

系统模式并不是通过异常进入的，它和用户模式具有完全一样的寄存器。但是系统模式属于特权模式，可以访问所有的系统资源，也可以直接进行处理器模式切换。它主要供操作系统任务使用。通常操作系统的任务需要访问所有的系统资源，同时该任务仍然使用用户模式的寄存器组，而不是使用异常模式下相应的寄存器组，这样可以保证当异常中断发生时任务状态不被破坏。

Thumb指令低密度及窄存储器时性能高的特点使得其在大多数基于 C 代码的系统汇中有非常广泛的应用，但是有些场合中系统只能使用 ARM 指令，比如：

1. 如果对于速度有比较高的要求，ARM指令在宽存储器中会提供更高的性能。
2. 某些功能只能由 ARM 指令来实现，例如访问 CPSR 寄存器来使能/禁止 中断或改变处理器工作模式；访问协处理器CP15；执行 C 代码不支持的 DSP 算术指令；异常中断（Exception）处理。

另外，在进入异常中断后，内核会自动切换到 ARM 状态。即在异常中断处理程序人口的一些指令是ARM指令，然后根据需要，程序可以切换到 Thumb 工作状态，在异常中断处理程序返回前，程序在切换到 ARM 工作状态。

注：当处理器处于Thumb状态时发生异常（如irq、fiq、und、abt、svc等），则异常处理返回时，自动切换到Thumb状态。需要了解的是，ARM 处理器总是 从 ARM 工作状态开始执行的。因此，如果要在调试器重新运行 Thumb 程序，必须为 该 Thumb 程序添加一个 ARM程序头，然后再切换到Thumb工作状态调用该 Thumb程序。